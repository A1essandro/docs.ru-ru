---
title: 'Начало работы с хранилищем очередей Azure, с помощью F #'
description: Очереди Azure предоставляют надежного асинхронного обмена сообщениями между компонентами приложения. Облака обмена сообщениями позволяет независимо масштабировать компоненты приложения.
author: sylvanc
ms.author: phcart
ms.date: 09/20/2016
ms.topic: conceptual
ms.prod: dotnet-fsharp
ms.devlang: fsharp
ms.openlocfilehash: bd49fd0f0e8d91449443051ab9a4ffc2d2638e11
ms.sourcegitcommit: 03ee570f6f528a7d23a4221dcb26a9498edbdf8c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
---
# <a name="get-started-with-azure-queue-storage-using-f"></a>Начало работы с хранилищем очередей Azure, с помощью F # #

Azure хранилище очередей обеспечивает обмен сообщениями между компонентами приложения облака. В разработке приложений для масштабирования, часто разделены компоненты приложения, так что их можно легко масштабировать независимо друг от друга. Хранилище очередей обеспечивает асинхронный обмен сообщениями для взаимодействия между компонентами приложения, ли они выполняются в облаке, на рабочем столе, на локальном сервере или на мобильном устройстве. Хранилище очередей также поддерживает управление асинхронных задач и построения потоков рабочего процесса.

### <a name="about-this-tutorial"></a>О этого учебника

Этот учебник показывает способы написания кода F # для некоторых типичных задач, с помощью хранилища очередей Azure. Рассмотренные задачи включают создание и удаление очередей и добавление, чтение и удаление сообщений очереди.

Концептуальный обзор хранилища очередей, см. в разделе [руководство по .NET для хранилища очереди](/azure/storage/storage-dotnet-how-to-use-queues).

## <a name="prerequisites"></a>Предварительные требования

Чтобы использовать это руководство, необходимо сначала [создать учетную запись хранилища Azure](/azure/storage/storage-create-storage-account).
Кроме того, потребуется ключ доступа хранилища для этой учетной записи.

## <a name="create-an-f-script-and-start-f-interactive"></a>Создание скрипта F # и начала F #, интерактивный

Примеры в этой статье используется в F # приложения или скрипта F #. Чтобы создать скрипт F #, создайте файл с `.fsx` расширение, например `queues.fsx`, в среде разработки F #.

Затем используйте [диспетчера пакетов](package-management.md) такие как [Paket](https://fsprojects.github.io/Paket/) или [NuGet](https://www.nuget.org/) установка `WindowsAzure.Storage` пакета и ссылка `WindowsAzure.Storage.dll` в скрипте с помощью `#r`директивы.

### <a name="add-namespace-declarations"></a>Добавьте объявления пространств имен

Добавьте следующие `open` инструкции в начало `queues.fsx` файла:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L1-L3)]

### <a name="get-your-connection-string"></a>Получение строки подключения

Для этого учебника потребуется строку подключения хранилища Azure. Дополнительные сведения о строках соединения см. в разделе [Настройка строки подключения хранилища](/azure/storage/storage-configure-connection-string).

Учебник вы введете строки подключения в скрипте, следующим образом:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L9-L9)]

Однако это **не рекомендуется** для реальных проектах. Ключ учетной записи хранилища аналогична корневой пароль для учетной записи хранилища. Всегда будьте внимательны защитить ключ учетной записи хранилища. Избегайте распространением их другим пользователям, жестко запрограммированные ее или сохранить в текстовый файл, доступный другим пользователям. Можно повторно создать ключ с помощью портала Azure, если вы считаете, что он был скомпрометирован.

Для реальных приложений для сохранения строки подключения хранилища рекомендуется в файле конфигурации. Чтобы получить строку подключения из файла конфигурации, это можно сделать:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L11-L13)]

С помощью диспетчера конфигурации Azure является необязательным. Можно также использовать интерфейс API, например .NET Framework `ConfigurationManager` типа.

### <a name="parse-the-connection-string"></a>Синтаксический анализ строки соединения

Чтобы обработать строку подключения, используйте:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L19-L20)]

Будет возвращен `CloudStorageAccount`.

### <a name="create-the-queue-service-client"></a>Создание клиента службы очередей

`CloudQueueClient` Позволяет получить очереди, хранящиеся в очереди хранилища. Вот один из способов создания клиента службы.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L26-L26)]

Теперь вы готовы написать код, который считывает и записывает данные в очереди хранилища.

## <a name="create-a-queue"></a>Создание очереди

В этом примере показано, как создать очередь, если он еще не существует:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L32-L36)]

## <a name="insert-a-message-into-a-queue"></a>Вставлять сообщения в очереди

Чтобы вставить сообщение в существующую очередь, сначала создайте `CloudQueueMessage`. Затем вызовите `AddMessage` метод. Объект `CloudQueueMessage` могут создаваться из любой строки (в формате UTF-8) или `byte` массива следующим образом:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L42-L44)]

## <a name="peek-at-the-next-message"></a>Просмотр следующего сообщения

Можно считывать сообщения в начале очереди, не удаляя его из очереди, путем вызова `PeekMessage` метод.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L50-L52)]

## <a name="get-the-next-message-for-processing"></a>Получение следующего сообщения для обработки

Сообщения в начале очереди для обработки можно получить, вызвав `GetMessage` метод.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L58-L59)]

Позднее указать успешную обработку сообщения с помощью `DeleteMessage`.

## <a name="change-the-contents-of-a-queued-message"></a>Изменение содержимого сообщения из очереди

Можно изменить содержимое получено сообщение на месте в очереди. Если сообщение представляет рабочей задачи, можно использовать эту функцию для обновления состояния рабочих задач. Следующий код обновляет новое содержимое сообщения в очереди и задает время ожидания видимости для расширения другой 60 секунд. Сохраняет состояние работ, сопряженные с сообщением и предоставляет клиенту другой минуту, чтобы продолжить работу с сообщения. Этот метод можно использовать для отслеживания многоэтапной рабочих процессов в очередь сообщения, без необходимости начать заново с самого начала, при выполнении шага обработки происходит сбой из-за сбоя оборудования или программного обеспечения. Как правило будет хранить значение числа повторов и если сообщение будет предпринята повторная попытка больше, чем определенное число раз, следует удалить его. Это обеспечивает защиту от сообщений, который срабатывает каждый раз, когда оно обрабатывается, происходит ошибка приложения.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L65-L69)]

## <a name="de-queue-the-next-message"></a>Отмена следующего сообщения в очередь

Код исключении из очереди сообщения из очереди в два этапа. При вызове `GetMessage`, вы получаете следующее сообщение в очереди. Сообщение, возвращенное из `GetMessage` становится невидимым для любого другого кода, чтение сообщений из этой очереди. По умолчанию это сообщение будет невидимым в течение 30 секунд. Чтобы завершить удаление сообщения из очереди, необходимо вызвать `DeleteMessage`. Это двухэтапный процесс удаления сообщения подтверждает, что если код не может обработать сообщение из-за сбоя оборудования или программного обеспечения, другой экземпляр кода можно получить то же сообщение и повторите попытку. Вызовы кода `DeleteMessage` сразу после обработки сообщения.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L75-L76)]

## <a name="use-async-workflows-with-common-queue-storage-apis"></a>Использование асинхронных рабочих процессов с хранилищем общих очередей API-интерфейсы

В этом примере показано, как использовать это асинхронный рабочий процесс с хранилищем общих очередей API-интерфейсы.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L82-L91)]

## <a name="additional-options-for-de-queuing-messages"></a>Дополнительные параметры для удаляется из очереди сообщений

Существует два способа, можно настроить получение сообщений из очереди.
Во-первых можно получить пакет сообщений (не более 32). Во-вторых можно установить более длинный или короткий невидимости тайм-аута, позволяя вашему коду больше или меньше времени для полной обработки каждого сообщения. Следующий пример кода использует `GetMessages` для получения 20 сообщений в одном вызова и затем обрабатывает каждое сообщение. Также устанавливает время ожидания невидимости до пяти минут для каждого сообщения. Обратите внимание, что начинается за 5 минут для всех сообщений, в то же время, переданный после имеют 5 минут после вызова `GetMessages`, все сообщения, которые не были удалены становятся видимыми.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L97-L99)]

## <a name="get-the-queue-length"></a>Получает длину очереди

Можно получить приблизительное количество сообщений в очереди. `FetchAttributes` Метод запрашивает у службы очередей для получения атрибутов очереди, включая количество сообщений. `ApproximateMessageCount` Свойство возвращает последнее значение, полученное по `FetchAttributes` метод без вызова службы очередей.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L105-L106)]

## <a name="delete-a-queue"></a>Удаление очереди

Чтобы удалить все содержащиеся в нем сообщения и очереди, вызовите `Delete` метод объекта очереди.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L112-L113)]

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали основы очереди хранилища, перейдите по соответствующей ссылке для получения сведений о более сложных задач хранилища.

- [API-интерфейсов хранилища Azure для .NET](/dotnet/api/overview/azure/storage)
- [Тип поставщика хранилища Azure](https://github.com/fsprojects/AzureStorageTypeProvider)
- [Блог группы разработчиков хранилища Azure](https://blogs.msdn.microsoft.com/windowsazurestorage/)
- [Настройка строки подключения хранилища Azure](/azure/storage/common/storage-configure-connection-string)
- [Справочник по API REST служб хранилища Azure](/rest/api/storageservices/Azure-Storage-Services-REST-API-Reference)
