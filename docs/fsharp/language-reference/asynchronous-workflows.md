---
title: "Асинхронные рабочие потоки (F#)"
description: "Подробнее о поддержке в языке F # язык программирования для выполнения асинхронных вычислений, которые выполняются без блокировки других операций."
keywords: "visual f#, f#, функциональное программирование"
author: cartermp
ms.author: phcart
ms.date: 05/16/2016
ms.topic: language-reference
ms.prod: .net
ms.technology: devlang-fsharp
ms.devlang: fsharp
ms.assetid: ee2bb9bf-e04a-4fbe-bf58-46d07229e981
ms.openlocfilehash: e1cbdb452c8f77d97a0231a5ec75d752a98d2ed6
ms.sourcegitcommit: 655fd4f78741967f80c409cef98347fdcf77857d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2018
---
# <a name="asynchronous-workflows"></a><span data-ttu-id="2ff21-104">Асинхронные рабочие потоки</span><span class="sxs-lookup"><span data-stu-id="2ff21-104">Asynchronous Workflows</span></span>

> [!NOTE]
<span data-ttu-id="2ff21-105">Ссылка на справочник по API ведет на сайт MSDN.</span><span class="sxs-lookup"><span data-stu-id="2ff21-105">The API reference link will take you to MSDN.</span></span>  <span data-ttu-id="2ff21-106">Работа над справочником по API docs.microsoft.com не завершена.</span><span class="sxs-lookup"><span data-stu-id="2ff21-106">The docs.microsoft.com API reference is not complete.</span></span>

<span data-ttu-id="2ff21-107">В этом разделе описывается поддержка в языке F # для выполнения асинхронных вычислений, то есть, без блокировки других операций.</span><span class="sxs-lookup"><span data-stu-id="2ff21-107">This topic describes support in F# for performing computations asynchronously, that is, without blocking execution of other work.</span></span> <span data-ttu-id="2ff21-108">Например асинхронные вычисления можно использовать для написания приложений с интерфейсами пользователя, продолжать отвечать на запросы для пользователей, как приложение выполняет другую работу.</span><span class="sxs-lookup"><span data-stu-id="2ff21-108">For example, asynchronous computations can be used to write applications that have UIs that remain responsive to users as the application performs other work.</span></span>

## <a name="syntax"></a><span data-ttu-id="2ff21-109">Синтаксис</span><span class="sxs-lookup"><span data-stu-id="2ff21-109">Syntax</span></span>

```fsharp
async { expression }
```

## <a name="remarks"></a><span data-ttu-id="2ff21-110">Примечания</span><span class="sxs-lookup"><span data-stu-id="2ff21-110">Remarks</span></span>

<span data-ttu-id="2ff21-111">В предыдущем синтаксисе представлены вычисления `expression` настроена на запускаются асинхронно, то есть, без блокировки текущего потока вычислений при выполнении операции асинхронной спящего режима, ввода-вывода и других асинхронных операций.</span><span class="sxs-lookup"><span data-stu-id="2ff21-111">In the previous syntax, the computation represented by `expression` is set up to run asynchronously, that is, without blocking the current computation thread when asynchronous sleep operations, I/O, and other asynchronous operations are performed.</span></span> <span data-ttu-id="2ff21-112">Асинхронные вычисления часто запускаются в фоновом потоке, пока выполнение продолжается в текущем потоке.</span><span class="sxs-lookup"><span data-stu-id="2ff21-112">Asynchronous computations are often started on a background thread while execution continues on the current thread.</span></span> <span data-ttu-id="2ff21-113">Тип выражения — `Async<'T>`, где `'T` — тип, возвращаемый выражением при `return` используется ключевое слово.</span><span class="sxs-lookup"><span data-stu-id="2ff21-113">The type of the expression is `Async<'T>`, where `'T` is the type returned by the expression when the `return` keyword is used.</span></span> <span data-ttu-id="2ff21-114">Код в таком выражении называется *асинхронным блоком*, или *блоком async*.</span><span class="sxs-lookup"><span data-stu-id="2ff21-114">The code in such an expression is referred to as an *asynchronous block*, or *async block*.</span></span>

<span data-ttu-id="2ff21-115">Существует множество способов программирования асинхронно и [ `Async` ](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7) класс предоставляет методы, поддерживающие несколько сценариев.</span><span class="sxs-lookup"><span data-stu-id="2ff21-115">There are a variety of ways of programming asynchronously, and the [`Async`](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7) class provides methods that support several scenarios.</span></span> <span data-ttu-id="2ff21-116">Общий подход заключается в создании `Async` объектов, представляющих вычисление или вычисления, которые требуется выполнять асинхронно, а затем запустите этих вычислений с помощью одной из функций активации.</span><span class="sxs-lookup"><span data-stu-id="2ff21-116">The general approach is to create `Async` objects that represent the computation or computations that you want to run asynchronously, and then start these computations by using one of the triggering functions.</span></span> <span data-ttu-id="2ff21-117">Различные запускающие функции обеспечивают различные способы выполнения асинхронных вычислений и используемом один зависит от того, требуется ли использовать текущий поток, фоновый поток или объект задачи платформы .NET Framework и определения наличия продолжения функции, которые необходимо выполнить после завершения вычисления.</span><span class="sxs-lookup"><span data-stu-id="2ff21-117">The various triggering functions provide different ways of running asynchronous computations, and which one you use depends on whether you want to use the current thread, a background thread, or a .NET Framework task object, and whether there are continuation functions that should run when the computation finishes.</span></span> <span data-ttu-id="2ff21-118">Например, чтобы запустить асинхронное вычисление в текущем потоке, можно использовать [ `Async.StartImmediate` ](https://msdn.microsoft.com/library/2f71d1cc-187f-48cf-ac66-e7fda41c46e3).</span><span class="sxs-lookup"><span data-stu-id="2ff21-118">For example, to start an asynchronous computation on the current thread, you can use [`Async.StartImmediate`](https://msdn.microsoft.com/library/2f71d1cc-187f-48cf-ac66-e7fda41c46e3).</span></span> <span data-ttu-id="2ff21-119">При запуске асинхронное вычисление из потока пользовательского интерфейса, не блокируют основной цикл событий, обрабатывающий действия пользователя, такие как нажатия клавиш и действия мыши, поэтому приложение продолжает отвечать на запросы.</span><span class="sxs-lookup"><span data-stu-id="2ff21-119">When you start an asynchronous computation from the UI thread, you do not block the main event loop that processes user actions such as keystrokes and mouse activity, so your application remains responsive.</span></span>

## <a name="asynchronous-binding-by-using-let"></a><span data-ttu-id="2ff21-120">Асинхронные привязки с помощью let!</span><span class="sxs-lookup"><span data-stu-id="2ff21-120">Asynchronous Binding by Using let!</span></span>

<span data-ttu-id="2ff21-121">В асинхронном рабочем процессе некоторые выражения и операции являются синхронными, а некоторые — больше времени вычислений, которые должны возвращать результат асинхронно.</span><span class="sxs-lookup"><span data-stu-id="2ff21-121">In an asynchronous workflow, some expressions and operations are synchronous, and some are longer computations that are designed to return a result asynchronously.</span></span> <span data-ttu-id="2ff21-122">При асинхронном вызове метода вместо обычных `let` привязку, использовать `let!`.</span><span class="sxs-lookup"><span data-stu-id="2ff21-122">When you call a method asynchronously, instead of an ordinary `let` binding, you use `let!`.</span></span> <span data-ttu-id="2ff21-123">Эффект `let!` позволяет продолжать выполнение других вычислений или потоков во время вычисления.</span><span class="sxs-lookup"><span data-stu-id="2ff21-123">The effect of `let!` is to enable execution to continue on other computations or threads as the computation is being performed.</span></span> <span data-ttu-id="2ff21-124">После правой части `let!` возвращает привязки, остальная часть асинхронный рабочий процесс возобновляется выполнение.</span><span class="sxs-lookup"><span data-stu-id="2ff21-124">After the right side of the `let!` binding returns, the rest of the asynchronous workflow resumes execution.</span></span>

<span data-ttu-id="2ff21-125">В следующем коде показано различие между `let` и `let!`.</span><span class="sxs-lookup"><span data-stu-id="2ff21-125">The following code shows the difference between `let` and `let!`.</span></span> <span data-ttu-id="2ff21-126">Строки кода, использующего `let` просто создает асинхронное вычисление в виде объекта, который можно запустить позднее с помощью, например, `Async.StartImmediate` или [ `Async.RunSynchronously` ](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b).</span><span class="sxs-lookup"><span data-stu-id="2ff21-126">The line of code that uses `let` just creates an asynchronous computation as an object that you can run later by using, for example, `Async.StartImmediate` or [`Async.RunSynchronously`](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b).</span></span> <span data-ttu-id="2ff21-127">Строки кода, использующего `let!` запускает вычисление, а затем выполнение потока приостанавливается, пока не станет доступен результат, после чего выполнение продолжается.</span><span class="sxs-lookup"><span data-stu-id="2ff21-127">The line of code that uses `let!` starts the computation, and then the thread is suspended until the result is available, at which point execution continues.</span></span>

```fsharp
// let just stores the result as an asynchronous operation.
let (result1 : Async<byte[]>) = stream.AsyncRead(bufferSize)
// let! completes the asynchronous operation and returns the data.
let! (result2 : byte[])  = stream.AsyncRead(bufferSize)
```

<span data-ttu-id="2ff21-128">В дополнение к `let!`, можно использовать `use!` для выполнения асинхронной привязки.</span><span class="sxs-lookup"><span data-stu-id="2ff21-128">In addition to `let!`, you can use `use!` to perform asynchronous bindings.</span></span> <span data-ttu-id="2ff21-129">Разница между `let!` и `use!` является таким же, как разница между `let` и `use`.</span><span class="sxs-lookup"><span data-stu-id="2ff21-129">The difference between `let!` and `use!` is the same as the difference between `let` and `use`.</span></span> <span data-ttu-id="2ff21-130">Для `use!`, объект удаляется при закрытии текущей области видимости.</span><span class="sxs-lookup"><span data-stu-id="2ff21-130">For `use!`, the object is disposed of at the close of the current scope.</span></span> <span data-ttu-id="2ff21-131">Обратите внимание, что в текущем выпуске языка F #, `use!` не допускает значений будет инициализирована имеет значение null, даже если `use` does.</span><span class="sxs-lookup"><span data-stu-id="2ff21-131">Note that in the current release of the F# language, `use!` does not allow a value to be initialized to null, even though `use` does.</span></span>

## <a name="asynchronous-primitives"></a><span data-ttu-id="2ff21-132">Асинхронные примитивы</span><span class="sxs-lookup"><span data-stu-id="2ff21-132">Asynchronous Primitives</span></span>

<span data-ttu-id="2ff21-133">Вызывается метод, который выполняет одну асинхронную задачу и возвращает результат *асинхронного примитива*, и они предназначены специально для использования с `let!`.</span><span class="sxs-lookup"><span data-stu-id="2ff21-133">A method that performs a single asynchronous task and returns the result is called an *asynchronous primitive*, and these are designed specifically for use with `let!`.</span></span> <span data-ttu-id="2ff21-134">Несколько асинхронных примитивов определяются в основной библиотеке F #.</span><span class="sxs-lookup"><span data-stu-id="2ff21-134">Several asynchronous primitives are defined in the F# core library.</span></span> <span data-ttu-id="2ff21-135">Два метода для веб-приложений определенные в модуле [ `Microsoft.FSharp.Control.WebExtensions` ](https://msdn.microsoft.com/library/95ef17bc-ee3f-44ba-8a11-c90fcf4cf003): [ `WebRequest.AsyncGetResponse` ](https://msdn.microsoft.com/library/09a60c31-e6e2-4b5c-ad23-92a86e50060c) и [ `WebClient.AsyncDownloadString` ](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a).</span><span class="sxs-lookup"><span data-stu-id="2ff21-135">Two such methods for Web applications are defined in the module [`Microsoft.FSharp.Control.WebExtensions`](https://msdn.microsoft.com/library/95ef17bc-ee3f-44ba-8a11-c90fcf4cf003): [`WebRequest.AsyncGetResponse`](https://msdn.microsoft.com/library/09a60c31-e6e2-4b5c-ad23-92a86e50060c) and [`WebClient.AsyncDownloadString`](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a).</span></span> <span data-ttu-id="2ff21-136">Оба примитива загрузить данные из веб-страницы, заданный URL-адрес.</span><span class="sxs-lookup"><span data-stu-id="2ff21-136">Both primitives download data from a Web page, given a URL.</span></span> <span data-ttu-id="2ff21-137">`AsyncGetResponse` Создает `System.Net.WebResponse` объекта, и `AsyncDownloadString` создает строку, которая представляет HTML-код для веб-страницы.</span><span class="sxs-lookup"><span data-stu-id="2ff21-137">`AsyncGetResponse` produces a `System.Net.WebResponse` object, and `AsyncDownloadString` produces a string that represents the HTML for a Web page.</span></span>

<span data-ttu-id="2ff21-138">Несколько примитивов для асинхронных операций ввода-вывода, включаются в [ `Microsoft.FSharp.Control.CommonExtensions` ](https://msdn.microsoft.com/library/2edb67cb-6814-4a30-849f-b6dbdd042396) модуля.</span><span class="sxs-lookup"><span data-stu-id="2ff21-138">Several primitives for asynchronous I/O operations are included in the [`Microsoft.FSharp.Control.CommonExtensions`](https://msdn.microsoft.com/library/2edb67cb-6814-4a30-849f-b6dbdd042396) module.</span></span> <span data-ttu-id="2ff21-139">Эти методы расширения для `System.IO.Stream` класса [ `Stream.AsyncRead` ](https://msdn.microsoft.com/library/85698aaa-bdda-47e6-abed-3730f59fda5e) и [ `Stream.AsyncWrite` ](https://msdn.microsoft.com/library/1b0a2751-e42a-47e1-bd27-020224adc618).</span><span class="sxs-lookup"><span data-stu-id="2ff21-139">These extension methods of the `System.IO.Stream` class are [`Stream.AsyncRead`](https://msdn.microsoft.com/library/85698aaa-bdda-47e6-abed-3730f59fda5e) and [`Stream.AsyncWrite`](https://msdn.microsoft.com/library/1b0a2751-e42a-47e1-bd27-020224adc618).</span></span>

<span data-ttu-id="2ff21-140">Доступны дополнительные асинхронные примитивы в [F # PowerTools](https://fsprojects.github.io/VisualFSharpPowerTools/).</span><span class="sxs-lookup"><span data-stu-id="2ff21-140">Additional asynchronous primitives are available in the [F# PowerTools](https://fsprojects.github.io/VisualFSharpPowerTools/).</span></span> <span data-ttu-id="2ff21-141">Можно также написать собственные асинхронные примитивы, определив функцию, все тело заключается в асинхронном блоке.</span><span class="sxs-lookup"><span data-stu-id="2ff21-141">You can also write your own asynchronous primitives by defining a function whose complete body is enclosed in an async block.</span></span>

<span data-ttu-id="2ff21-142">Чтобы использовать асинхронные методы в платформе .NET Framework, предназначенные для других асинхронных моделей с моделью асинхронного программирования F #, создайте функцию, возвращающую F # `Async` объекта.</span><span class="sxs-lookup"><span data-stu-id="2ff21-142">To use asynchronous methods in the .NET Framework that are designed for other asynchronous models with the F# asynchronous programming model, you create a function that returns an F# `Async` object.</span></span> <span data-ttu-id="2ff21-143">Библиотеки F # содержит функции, позволяющие это легко сделать.</span><span class="sxs-lookup"><span data-stu-id="2ff21-143">The F# library has functions that make this easy to do.</span></span>

<span data-ttu-id="2ff21-144">Примером использования асинхронные рабочие потоки включено Существует множество других в документации по методам [асинхронный класс](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7).</span><span class="sxs-lookup"><span data-stu-id="2ff21-144">One example of using asynchronous workflows is included here; there are many others in the documentation for the methods of the [Async class](https://msdn.microsoft.com/library/03eb4d12-a01a-4565-a077-5e83f17cf6f7).</span></span>

<span data-ttu-id="2ff21-145">В этом примере показано, как использовать асинхронные рабочие процессы для выполнения вычислений в параллельном режиме.</span><span class="sxs-lookup"><span data-stu-id="2ff21-145">This example shows how to use asynchronous workflows to perform computations in parallel.</span></span>

<span data-ttu-id="2ff21-146">В следующем примере кода функция `fetchAsync` Возвращает HTML-текст, возвращаемый из веб-запроса.</span><span class="sxs-lookup"><span data-stu-id="2ff21-146">In the following code example, a function `fetchAsync` gets the HTML text returned from a Web request.</span></span> <span data-ttu-id="2ff21-147">`fetchAsync` Функция содержит асинхронный блок кода.</span><span class="sxs-lookup"><span data-stu-id="2ff21-147">The `fetchAsync` function contains an asynchronous block of code.</span></span> <span data-ttu-id="2ff21-148">Если привязка выполняется к результату асинхронного примитива, в этом случае [ `AsyncDownloadString` ](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a), позволяют!</span><span class="sxs-lookup"><span data-stu-id="2ff21-148">When a binding is made to the result of an asynchronous primitive, in this case [`AsyncDownloadString`](https://msdn.microsoft.com/library/8a85a9b7-f712-4cac-a0ce-0a797f8ea32a), let!</span></span> <span data-ttu-id="2ff21-149">используется вместо let.</span><span class="sxs-lookup"><span data-stu-id="2ff21-149">is used instead of let.</span></span>

<span data-ttu-id="2ff21-150">При использовании функции [ `Async.RunSynchronously` ](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b) для выполнения асинхронной операции и ожидать ее результата.</span><span class="sxs-lookup"><span data-stu-id="2ff21-150">You use the function [`Async.RunSynchronously`](https://msdn.microsoft.com/library/0a6663a9-50f2-4d38-8bf3-cefd1a51fd6b) to execute an asynchronous operation and wait for its result.</span></span> <span data-ttu-id="2ff21-151">Например, можно выполнять несколько асинхронных операций в параллельном режиме с помощью [ `Async.Parallel` ](https://msdn.microsoft.com/library/aa9b0355-2d55-4858-b943-cbe428de9dc4) работать вместе с `Async.RunSynchronously` функции.</span><span class="sxs-lookup"><span data-stu-id="2ff21-151">As an example, you can execute multiple asynchronous operations in parallel by using the [`Async.Parallel`](https://msdn.microsoft.com/library/aa9b0355-2d55-4858-b943-cbe428de9dc4) function together with the `Async.RunSynchronously` function.</span></span> <span data-ttu-id="2ff21-152">`Async.Parallel` Функция принимает список `Async` объектов, настраивает код для каждого `Async` объект задачи для запуска в параллельном режиме и возвращает `Async` , представляющий параллельные вычисления.</span><span class="sxs-lookup"><span data-stu-id="2ff21-152">The `Async.Parallel` function takes a list of the `Async` objects, sets up the code for each `Async` task object to run in parallel, and returns an `Async` object that represents the parallel computation.</span></span> <span data-ttu-id="2ff21-153">Как и в случае одной операции, вызовите `Async.RunSynchronously` для начала выполнения.</span><span class="sxs-lookup"><span data-stu-id="2ff21-153">Just as for a single operation, you call `Async.RunSynchronously` to start the execution.</span></span>

<span data-ttu-id="2ff21-154">`runAll` Функция запускает три асинхронных рабочих процесса и ожидает, пока все они будут завершены.</span><span class="sxs-lookup"><span data-stu-id="2ff21-154">The `runAll` function launches three asynchronous workflows in parallel and waits until they have all completed.</span></span>

[!code-fsharp[Main](../../../samples/snippets/fsharp/lang-ref-2/snippet8003.fs)]

## <a name="see-also"></a><span data-ttu-id="2ff21-155">См. также</span><span class="sxs-lookup"><span data-stu-id="2ff21-155">See Also</span></span>

[<span data-ttu-id="2ff21-156">Справочник по языку F#</span><span class="sxs-lookup"><span data-stu-id="2ff21-156">F# Language Reference</span></span>](index.md)

[<span data-ttu-id="2ff21-157">Выражения вычисления</span><span class="sxs-lookup"><span data-stu-id="2ff21-157">Computation Expressions</span></span>](computation-expressions.md)

[<span data-ttu-id="2ff21-158">Класс Control.Async</span><span class="sxs-lookup"><span data-stu-id="2ff21-158">Control.Async Class</span></span>](https://msdn.microsoft.com/visualfsharpdocs/conceptual/control.async-class-%5bfsharp%5d)
