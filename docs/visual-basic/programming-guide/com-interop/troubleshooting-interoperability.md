---
title: Устранение неполадок взаимодействия (Visual Basic)
ms.custom: ''
ms.date: 07/20/2015
ms.prod: .net
ms.reviewer: ''
ms.suite: ''
ms.technology:
- devlang-visual-basic
ms.topic: article
helpviewer_keywords:
- interop, deploying assemblies
- assemblies [Visual Basic]
- interop, installing assemblies that share components
- COM objects, troubleshooting
- interop, sharing components
- troubleshooting interoperability [Visual Basic]
- interoperability, troubleshooting
- COM interop [Visual Basic], troubleshooting
- assemblies [Visual Basic], deploying
- troubleshooting Visual Basic, interoperability
- interop assemblies
- interoperability, sharing components
- shared components, using with assemblies
ms.assetid: b324cc1e-b03c-4f39-aea6-6a6d5bfd0e37
caps.latest.revision: 21
author: dotnet-bot
ms.author: dotnetcontent
ms.openlocfilehash: 1fae8215543c50484dc5ea7fc24f292ba84e2699
ms.sourcegitcommit: 2042de78fcdceebb6b8ac4b7a292b93e8782cbf5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/27/2018
---
# <a name="troubleshooting-interoperability-visual-basic"></a>Устранение неполадок взаимодействия (Visual Basic)
При взаимодействии между COM и управляемым кодом [!INCLUDE[dnprdnshort](~/includes/dnprdnshort-md.md)], может появиться одно или несколько из следующих распространенных проблем.  
  
##  <a name="vbconinteroperabilitymarshalinganchor1"></a> Маршалинг взаимодействия  
 В некоторых случаях может потребоваться использование типов данных, которые не являются частью [!INCLUDE[dnprdnshort](~/includes/dnprdnshort-md.md)]. Сборки взаимодействия выполняют большую часть работы с объектами COM, но может возникнуть необходимость управления типы данных, которые используются, когда управляемые объекты предоставляются COM. Например, структуры в библиотеках класса необходимо указать `BStr` неуправляемый тип для строк, отправляемых в объекты COM, созданные Visual Basic 6.0 и более ранних версий. В таких случаях можно использовать <xref:System.Runtime.InteropServices.MarshalAsAttribute> атрибут, чтобы управляемые типы предоставлялись как неуправляемые типы.  
  
##  <a name="vbconinteroperabilitymarshalinganchor2"></a> Экспорт строк фиксированной длины в неуправляемый код  
 В Visual Basic 6.0 и более ранних версиях строки экспортировались COM-объекты как последовательности байтов без знака с нулем. Для обеспечения совместимости с другими языками Visual Basic .NET включает завершающий знак при экспорте строк. Лучший способ решить проблему несовместимости — экспортировать строки без завершающего знака как массивы `Byte` или `Char`.  
  
##  <a name="vbconinteroperabilitymarshalinganchor3"></a> Экспорт иерархий наследования  
 Управляемого класса выравниваются иерархий при представлении в виде COM-объектов. Например если определить базовый класс с элементом и затем унаследовать базовый класс в производном классе, который предоставляется как COM-объект, клиенты, использующие производный класс в COM-объекта будет невозможно использовать унаследованные члены. Члены базового класса из COM-объектов может осуществляться только как экземпляры базового класса, а затем только в том случае, если базовый класс также создан как COM-объектом.  
  
## <a name="overloaded-methods"></a>Перегруженные методы  
 Несмотря на то, что перегруженные методы можно создать с помощью Visual Basic, они не поддерживаются COM. Когда класс, содержащий перегруженные методы предоставляется как объект COM, новые имена методов создаются для перегруженных методов.  
  
 Например, рассмотрим класс, имеющий две перегрузки `Synch` метод. Когда класс предоставляется как объект COM, новые созданные имена методов могут быть `Synch` и `Synch_2`.  
  
 Переименование может вызвать две проблемы для потребителей COM-объекта.  
  
1.  Клиенты могут не ожидать созданных имен методов.  
  
2.  При добавлении новых перегрузок к классу или его базовым классом, можно изменить созданные имена методов в классе, в виде COM-объектом. Это может привести к проблемам с управлением версиями.  
  
 Чтобы решить обе проблемы, присвойте каждому методу уникальное имя вместо использования перегрузки, при разработке объектов, которые будут предоставлены в виде COM-объектов.  
  
##  <a name="vbconinteroperabilitymarshalinganchor4"></a> Использование объектов COM с помощью сборок взаимодействия  
 Сборки взаимодействия используются почти как если бы они были управляемым кодом, заменяющим объекты COM, которые они представляют. Тем не менее поскольку они являются оболочки и не фактические COM-объекты, существуют некоторые отличия в использовании сборок взаимодействия и обычных сборок. Эти различия касаются раскрытие классы и типы данных параметров и возвращаемых значений.  
  
##  <a name="vbconinteroperabilitymarshalinganchor5"></a> Классы, предоставляемые и как интерфейсы и классы  
 В отличие от классов в обычных сборок COM-классов, представлены в сборках взаимодействия и как интерфейс и класс, представляющий COM-классом. Имя интерфейса идентична COM-класса. Имя класса взаимодействия же, что и исходный класс COM, но со словом «Класс» добавлено. Например предположим, что у вас есть проект со ссылкой на сборку взаимодействия для COM-объекта. Если COM-класс называется `MyComClass`, IntelliSense и обозреватель объектов покажет интерфейс с именем `MyComClass` и класс с именем `MyComClassClass`.  
  
##  <a name="vbconinteroperabilitymarshalinganchor6"></a> Создание экземпляров класса .NET Framework  
 Как правило, создается экземпляр [!INCLUDE[dnprdnshort](~/includes/dnprdnshort-md.md)] класса с помощью `New` инструкции с именем класса. Наличие класса COM, представленного сборкой взаимодействия — это тот случай, в котором можно использовать `New` инструкции с интерфейсом. Если вы не используете COM-класс с `Inherits` инструкции, интерфейс можно использовать так же, как и класс. Следующий код демонстрирует создание `Command` объекта в проекте, который содержит ссылку на Microsoft ActiveX данных объектов 2.8 библиотеки COM-объекта:  
  
 [!code-vb[VbVbalrInterop#20](../../../visual-basic/programming-guide/com-interop/codesnippet/VisualBasic/troubleshooting-interoperability_1.vb)]  
  
 Однако при использовании COM-класс как основа для производного класса, необходимо использовать класс взаимодействия, представляющий класс COM, как показано в следующем коде:  
  
 [!code-vb[VbVbalrInterop#21](../../../visual-basic/programming-guide/com-interop/codesnippet/VisualBasic/troubleshooting-interoperability_2.vb)]  
  
> [!NOTE]
>  Сборки взаимодействия неявно реализуют интерфейсы, которые представляют COM-классов. Не следует использовать `Implements` приведет к инструкции для реализации этих интерфейсов или ошибку.  
  
##  <a name="vbconinteroperabilitymarshalinganchor7"></a> Типы данных параметров и возвращаемых значений  
 В отличие от элементов обычных сборок члены сборки взаимодействия могут иметь типы данных, которые отличаются от тех, которые используются в исходном объявлении объекта. Несмотря на то, что сборки взаимодействия неявно преобразуют типы COM в совместимые типы среды выполнения, следует уделять внимание типы данных, которые используются с обеих сторон для предотвращения ошибок во время выполнения. Например, в COM-объекты, созданные в Visual Basic 6.0 и более ранних версиях, значения типа `Integer` предполагается [!INCLUDE[dnprdnshort](~/includes/dnprdnshort-md.md)] эквивалентный тип `Short`. Рекомендуется использовать обозреватель объектов для проверки характеристик импортированных элементов перед их использованием.  
  
##  <a name="vbconinteroperabilitymarshalinganchor8"></a> Методы COM уровня модуля  
 Большинство объектов COM используются путем создания экземпляра класса COM с помощью `New` ключевое слово и затем вызывает методы этого объекта. Единственным исключением это правило включает в себя COM-объекты, содержащие `AppObj` или `GlobalMultiUse` COM-классов. Такие классы напоминают методы уровня модуля в классы Visual Basic .NET. Visual Basic 6.0 и более ранних версиях неявно создает экземпляры таких объектов при первом вызове одного из их методов. Например, в Visual Basic 6.0 можно добавить ссылку на библиотека объектов Microsoft DAO 3.6 и вызвать метод `DBEngine` без предварительного создания экземпляра:  
  
```vb  
Dim db As DAO.Database  
' Open the database.  
Set db = DBEngine.OpenDatabase("C:\nwind.mdb")  
' Use the database object.  
```  
  
 Visual Basic .NET необходимо всегда создавать экземпляры объектов COM, прежде чем использовать их методов. Чтобы использовать эти методы в Visual Basic, объявите переменную нужного класса и используйте ключевое слово new присвойте объект для переменной объекта. `Shared` Ключевое слово может использоваться для убедитесь, что только один экземпляр класса создается.  
  
 [!code-vb[VbVbalrInterop#23](../../../visual-basic/programming-guide/com-interop/codesnippet/VisualBasic/troubleshooting-interoperability_3.vb)]  
  
##  <a name="vbconinteroperabilitymarshalinganchor9"></a> Необработанные ошибки в обработчиках событий  
 Одна из распространенных проблем взаимодействия касается ошибок в обработчиках событий, которые обрабатывают события COM-объектов. Такие ошибки игнорируются, если только специально проверки на наличие ошибок с помощью `On Error` или `Try...Catch...Finally` инструкции. Например следующий пример — из проекта Visual Basic .NET, который содержит ссылку на Microsoft ActiveX данных объектов 2.8 библиотеки COM-объекта.  
  
 [!code-vb[VbVbalrInterop#24](../../../visual-basic/programming-guide/com-interop/codesnippet/VisualBasic/troubleshooting-interoperability_4.vb)]  
  
 В этом примере происходит ошибка, как ожидалось. Тем не менее если один и тот же пример без `Try...Catch...Finally` блока, ошибка обрабатывается, как если бы вы использовали `OnError Resume Next` инструкции. Без обработки ошибок деление на ноль вызовет неявную ошибку. Поскольку такие ошибки никогда не вызывают ошибку необработанного исключения, очень важно использовать определенные виды обработки исключений в обработчики событий, которые обрабатывают события из COM-объекты.  
  
### <a name="understanding-com-interop-errors"></a>Основные сведения об ошибках взаимодействия COM  
 Без обработки ошибок вызовы взаимодействия часто создают ошибки, которые предоставляют мало сведений. По возможности следует используйте структурированную обработку для предоставления дополнительных сведений о проблемах, при их возникновении ошибок. Это может быть особенно удобно при отладке приложений. Пример:  
  
 [!code-vb[VbVbalrInterop#25](../../../visual-basic/programming-guide/com-interop/codesnippet/VisualBasic/troubleshooting-interoperability_5.vb)]  
  
 Можно найти сведения, такие как описание ошибки, HRESULT и источник ошибок COM, проверив содержимое объекта исключения.  
  
##  <a name="vbconinteroperabilitymarshalinganchor10"></a> Создает элемент управления ActiveX  
 Большинство элементов управления ActiveX, которые работают с Visual Basic 6.0 работать с Visual Basic .NET без проблем. Большинство исключений — это контейнерные элементы управления или элементы управления, которые визуально содержат другие элементы управления. Ниже приведены некоторые примеры старых элементов управления, которые не работают с Visual Studio.  
  
-   Элемент управления Microsoft Forms 2.0 кадра  
  
-   Регулятор, также известный как элемент управления "Счетчик"  
  
-   Шеридан вкладок  
  
 Имеется только несколько временных решений проблемы с неподдерживаемыми элементами управления ActiveX. Если вы являетесь владельцем исходного кода, можно перенести существующие элементы управления в Visual Studio. В противном случае можно проверить с помощью поставщиков программного обеспечения для обновления. NET-совместимой версии элементов управления для замены неподдерживаемые элементы управления ActiveX.  
  
##  <a name="vbconinteroperabilitymarshalinganchor11"></a> Свойства ReadOnly передача ByRef элементов управления  
 Visual Basic .NET иногда вызывает ошибки COM, такие как «Ошибка 0x800A017F CTL_E_SETNOTSUPPORTED», при передаче `ReadOnly` свойства некоторых старых элементов управления ActiveX в качестве `ByRef` параметров для других процедур. Аналогично, процедура, вызванная в Visual Basic 6.0, не вызывает ошибку, и параметры обрабатываются так, как если бы они передавались по значению. Visual Basic .NET свидетельствует о том, что вы пытаетесь изменить свойство, которое не поддерживает свойство `Set` процедуры.  
  
 При наличии доступа к вызываемой процедуре можно предотвратить эту ошибку, используя `ByVal` ключевое слово для объявления параметров, которые принимают `ReadOnly` свойства. Пример:  
  
 [!code-vb[VbVbalrInterop#26](../../../visual-basic/programming-guide/com-interop/codesnippet/VisualBasic/troubleshooting-interoperability_6.vb)]  
  
 Если нет доступа к исходному коду для вызываемой процедуре, можно принудительно свойство передаваться по значению, добавив дополнительный набор квадратных скобок при вызове процедуры. Например в проект, который содержит ссылку на объект Microsoft ActiveX данных объектов 2.8 библиотеки COM, можно использовать:  
  
 [!code-vb[VbVbalrInterop#27](../../../visual-basic/programming-guide/com-interop/codesnippet/VisualBasic/troubleshooting-interoperability_7.vb)]  
  
##  <a name="vbconinteroperabilitymarshalinganchor12"></a> Развертывание сборок, предоставляющих взаимодействие  
 Развертывание сборок, которые предоставляют интерфейсы COM, связаны особые проблемы. Например о потенциальной проблеме происходит при одной и той же сборки COM ссылаться на отдельные приложения. Это проявляется при установке новой версии сборки, а другое приложение по-прежнему использует старую версию сборки. Если удалить сборку, которая использует библиотеку DLL, вы может оказаться недоступность для других сборок.  
  
 Во избежание этой проблемы следует устанавливать совместно используемые сборки в глобальный кэш сборок (GAC) и использовать MergeModule для этого компонента. Если не удается установить приложение в глобальном кэше СБОРОК, его следует установить в CommonFilesFolder в подкаталоге конкретной версии.  
  
 Сборки, которые не являются общими должны находиться рядом друг с другом в каталоге с вызывающим приложением.  
  
## <a name="see-also"></a>См. также  
 <xref:System.Runtime.InteropServices.MarshalAsAttribute>  
 [COM-взаимодействие](../../../visual-basic/programming-guide/com-interop/index.md)  
 [Tlbimp.exe (программа экспорта библиотек типов)](../../../framework/tools/tlbimp-exe-type-library-importer.md)  
 [Tlbexp.exe (программа экспорта библиотек типов)](http://msdn.microsoft.com/library/a487d61b-d166-467b-a7ca-d8b52fbff42d)  
 [Пошаговое руководство. Реализация наследования с использованием COM-объектов](../../../visual-basic/programming-guide/com-interop/walkthrough-implementing-inheritance-with-com-objects.md)  
 [Оператор Inherits](../../../visual-basic/language-reference/statements/inherits-statement.md)  
 [Глобальный кэш сборок](../../../framework/app-domains/gac.md)
