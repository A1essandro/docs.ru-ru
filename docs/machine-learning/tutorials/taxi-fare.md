---
title: Использование ML.NET для прогнозирования платы за проезд в такси в Нью-Йорке (регрессия)
description: Сведения об использовании ML.NET в сценарии с моделью регрессии.
author: aditidugar
ms.author: johalex
ms.date: 06/05/2018
ms.topic: tutorial
ms.custom: mvc
ms.openlocfilehash: 048ed1d38408c1ba4901c554cae33d5552c9e303
ms.sourcegitcommit: 5b0802832fb9ad684d34e69b8644a16a5b7c4810
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/06/2018
ms.locfileid: "34860707"
---
# <a name="tutorial-use-mlnet-to-predict-new-york-taxi-fares-regression"></a>Руководство. Использование ML.NET для прогнозирования платы за проезд в такси в Нью-Йорке (регрессия)

> [!NOTE]
> В этом разделе описано, как использовать платформу ML.NET, которая сейчас доступна в режиме предварительной версии. Этот материал может быть изменен. Дополнительные сведения см. в [обзоре ML.NET](https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet).

В этом руководства описано, как с помощью ML.NET создать [модель регрессии](../resources/glossary.md#regression) для прогнозирования платы за проезд в такси в городе Нью-Йорк.

В этом руководстве вы узнаете, как:
> [!div class="checklist"]
> * Определение проблемы
> * Выбор подходящей задачи машинного обучения
> * Анализ данных
> * Создание конвейера обучения
> * Загрузка и преобразование данных
> * Выбор алгоритма обучения
> * Обучение модели
> * Оценка модели
> * Использование модели для прогнозирования

## <a name="prerequisites"></a>Предварительные требования

* [Visual Studio 2017 15.6 или более поздней версии](https://www.visualstudio.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017) с установленной рабочей нагрузкой "Кроссплатформенная разработка .NET Core".

## <a name="understand-the-problem"></a>Определение проблемы

Рассматриваемая проблема основана на сценарии **прогнозирования платы за поездку на такси в городе Нью-Йорк**. На первый взгляд может показаться, что плата зависит только от расстояния. Но службы такси в Нью-Йорке изменяют плату с учетом еще нескольких факторов, таких как наличие дополнительных пассажиров или оплата кредитной картой вместо наличных.

## <a name="select-the-appropriate-machine-learning-task"></a>Выбор подходящей задачи машинного обучения

Для прогнозирования платы за проезд в такси прежде всего нужно выбрать правильную задачу машинного обучения. Вам нужно спрогнозировать реальное значение (значение цены в формате двойной точности) на основе других факторов в наборе данных. Для этого выберите задачу [**регрессии**](../resources/glossary.md#regression).

Процесс обучения модели определяет, какие факторы в наборе данных больше других влияют на окончательную плату за проезд.

## <a name="create-a-console-application"></a>Создание консольного приложения

1. Откройте Visual Studio 2017. Выберите **Файл** > **Создать** > **Проект** в меню. В диалоговом окне **Новый проект** выберите узел **Visual C#**, а затем — узел **.NET Core**. Выберите шаблон проекта **Консольное приложение (.NET Core)**. В текстовое поле **Имя** введите TaxiFarePrediction, а затем нажмите кнопку **ОК**.

2. Создайте каталог с именем *Data* в папке проекта, чтобы сохранить в нем файлы с наборами данных:

    В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите **Добавить** > **Новая папка**. Введите имя папки Data и нажмите клавишу "ВВОД".

3. Установите **пакет NuGet для Microsoft.ML**:

    В обозревателе решений щелкните проект правой кнопкой мыши и выберите **Управление пакетами NuGet**. Выберите nuget.org в качестве источника пакетов, перейдите на вкладку "Обзор", выполните поиск по фразе **Microsoft.ML**, выберите из списка этот пакет и нажмите кнопку **Установить**. Нажмите кнопку **ОК** в диалоговом окне **Предварительный просмотр изменений**, а затем нажмите кнопку **Принимаю** в диалоговом окне **Принятие условий лицензионного соглашения**, если вы согласны с указанными условиями лицензионного соглашения для выбранных пакетов.

### <a name="prepare-and-understand-your-data"></a>Анализ данных

1. Скачайте наборы данных [taxi-fare-train.csv](https://github.com/dotnet/machinelearning/blob/master/test/data/taxi-fare-train.csv) и [taxi-fare-test.csv](https://github.com/dotnet/machinelearning/blob/master/test/data/taxi-fare-test.csv), сохранив их в ранее созданную папку *Data*. Набор данных Taxi Trip обучает модель машинного обучения, а также позволяет оценить точность полученной модели. Эти наборы данных взяты из [наборов данных NYC TLC Taxi Trip](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml).

2. В обозревателе решений щелкните правой кнопкой мыши каждый из файлов \*.csv и выберите **Свойства**. В разделе **Дополнительно** для параметра **Копировать в выходной каталог** установите значение **Всегда**.

3. Откройте набор данных **taxi-fare-train.csv** в редакторе кода и просмотрите заголовки столбцов в первой строке. Теперь изучите каждый из столбцов. Разберитесь, какие данные в них хранятся, и определите, какие столбцы являются **признаками**, а в каком содержится **метка**.

**Метка** — это столбец, значения в котором вы хотите спрогнозировать. Выбранные **признаки** используются для прогнозирования метки.

* **vendor_id:** идентификатор поставщика такси — это признак.
* **rate_code:** тип оплаты для поездки на такси — это признак.
* **passenger_count:** число пассажиров в поездке — это признак.
* **trip_time_in_secs:** время, затраченное на поездку. Пока поездка не завершится, вы не сможете узнать ее продолжительность. Этот столбец можно исключить из модели.
* **trip_distance:** расстояние поездки — это признак.
* **payment_type:** метод оплаты (наличные или кредитная карта) — это признак.
* **fare_amount:** общая сумма, оплаченная за поездку на такси — это метка.

### <a name="create-classes-and-define-paths"></a>Создание классов и определение путей

Добавьте следующие новые операторы `using` в начало файла *Program.cs*:

[!code-csharp[AddUsings](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#1 "Add necessary usings")]

Также нужно создать три глобальные переменные для хранения путей к недавно скачанным файлам, а затем сохранить модель:

* `_datapath` содержит путь к набору данных, который используется для обучения модели;
* `_testdatapath` содержит путь к набору данных, который используется для оценки модели;
* `_modelpath` содержит путь к сохраненной обученной модели.

Добавьте следующий код прямо перед `Main`, чтобы указать ссылки на скачанные файлы:

[!code-csharp[InitializePaths](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#2 "Define variables to store the data file paths")]

Теперь создайте классы для входных данных и прогнозов.

1. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите пункты **Добавить** > **Новый элемент**.
1. В диалоговом окне **Добавление нового элемента** выберите **Класс** и измените значение поля **Имя** на *TaxiTrip.cs*. Теперь нажмите кнопку **Добавить**.
1. Добавьте в новый файл следующие операторы `using`:

[!code-csharp[AddUsings](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TaxiTrip.cs#1 "Add necessary usings")]

Удалите из файла *TaxiTrip.cs* существующее определение класса и добавьте следующий код с двумя классами `TaxiTrip` и `TaxiTripFarePrediction`:

[!code-csharp[DefineTaxiTrip](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TaxiTrip.cs#2 "Define the taxi trip and fare predictions classes")]

Класс `TaxiTrip` содержит входной набор данных и определения для каждого из столбцов в этом наборе данных. Класс `TaxiTripFarePrediction` используется для прогнозирования после обучения модели. Он имеет один параметр типа float (`FareAmount`) и к нему применен атрибут `Score` [ColumnName](xref:Microsoft.ML.Runtime.Api.ColumnNameAttribute).

Теперь вернитесь к файлу **Program.cs**. В `Main` замените `Console.WriteLine("Hello World!")` следующим кодом:

```csharp
PredictionModel<TaxiTrip, TaxiTripFarePrediction> model = Train();
```

Метод `Train` обучает модель. Создайте эту функцию сразу под `Main`, используя следующий код:

```csharp
public static PredictionModel<TaxiTrip, TaxiTripFarePrediction> Train()
{

}
```

## <a name="create-a-learning-pipeline"></a>Создание конвейера обучения

Конвейер обучения загружает все данные и алгоритмы, необходимые для обучения модели. Добавьте в метод `Train()` следующий код:

```csharp
var pipeline = new LearningPipeline();
```

## <a name="load-and-transform-your-data"></a>Загрузка и преобразование данных

Загрузите данные в конвейер. Укажите `_datapath`, созданный изначально, и разделитель для CSV-файла (,). Добавьте следующий код в метод `Train()` под последним шагом:

```csharp
pipeline.Add(new TextLoader(_datapath).CreateFrom<TaxiTrip>(separator:','));
```

В коде, который вы создаете, ссылки на столбцы следует указывать без символов подчеркивания. Скопируйте столбец `FareAmount` в новый столбец с именем Label с помощью функции `ColumnCopier()`. Этот столбец является **меткой**.

```csharp
pipeline.Add(new ColumnCopier(("FareAmount", "Label")));
```

С помощью функции **проектирования признаков** преобразуйте данные так, чтобы их можно было эффективно использовать для машинного обучения. Алгоритм, который обучает модель, принимает **числовые** признаки, поэтому категориальные данные (`VendorId`, `RateCode` и `PaymentType`) нужно преобразовать в числа. Функция `CategoricalOneHotVectorizer()` присваивает числовой ключ значениям в каждом из этих столбцов. Для преобразования данных добавьте следующий код:

```csharp
pipeline.Add(new CategoricalOneHotVectorizer("VendorId",
                                             "RateCode",
                                             "PaymentType"));
```

Последний шаг в процессе подготовки данных объединяет все **признаки** в один вектор с помощью функции `ColumnConcatenator()`. Этот обязательный шаг помогает алгоритму легко обрабатывать признаки. Добавьте следующий код:

```csharp
pipeline.Add(new ColumnConcatenator("Features",
                                    "VendorId",
                                    "RateCode",
                                    "PassengerCount",
                                    "TripDistance",
                                    "PaymentType"));
```

Обратите внимание, что столбец `trip_time_in_secs` не включается. Вы уже определили, что он не будет полезным признаком для прогнозирования.

> [!NOTE]
> Для успешного выполнения шагов следует добавлять в конвейер в том порядке, который указан выше.

## <a name="choose-a-learning-algorithm"></a>Выбор алгоритма обучения

После добавления данных в конвейер и их преобразования в правильный входной формат выберите алгоритм обучения (**средство обучения**). Обучающий алгоритм подготавливает модель. Для этой проблемы вы выбрали **задачу регрессии**, поэтому добавьте в конвейер средство обучения с именем `FastTreeRegressor()`, которое использует **градиентный бустинг**.

Градиентный бустинг — это метод машинного обучения для проблем регрессии. Он пошагово создает каждое дерево регрессии. Он также использует предварительно определенную функцию для оценки ошибки на каждом этапе и исправления ошибок для следующего этапа. Результатом является модель прогнозирования, фактически собранная из нескольких более слабых моделей прогнозирования. Дополнительные сведения о градиентном бустинге см. в статье [Boosted Decision Tree Regression](https://docs.microsoft.com/azure/machine-learning/studio-module-reference/boosted-decision-tree-regression) (Регрессия для дерева принятия решений с бустингом).

Добавьте следующий код в метод `Train()` после кода обработки данных, который вы добавили на предыдущем шаге:

```csharp
pipeline.Add(new FastTreeRegressor());
```

Все предыдущие шаги добавляются в конвейер как отдельные инструкции, но в C# реализован удобный синтаксис для инициализации коллекций, который упрощает создание и инициализацию конвейера. Замените весь код, который вы добавили ранее в метод `Train()`, следующим кодом:

[!code-csharp[CreatePipeline](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#3 "Create and initialize the learning pipeline")]

## <a name="train-the-model"></a>Обучение модели

Последним шагом является обучение модели. До этого момента действия в конвейере не выполнялись. Функция `pipeline.Train<T_Input, T_Output>()` принимает предварительно определенный тип класса `TaxiTrip` и возвращает тип `TaxiTripFarePrediction`. Добавьте этот готовый фрагмент кода в функцию `Train()`:

[!code-csharp[TrainMOdel](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#4 "Train your model")]

Вот и все! Вы успешно обучили модель машинного обучения, которая умеет прогнозировать плату за проезд в такси в городе Нью-Йорк. Теперь давайте посмотрим, насколько точная у вас модель и как ее правильно использовать.

## <a name="save-the-model"></a>Сохранение модели

Прежде чем как перейти к следующему шагу, сохраните модель в ZIP-файл, добавив следующий код в конце функции `Train()`:

[!code-csharp[SaveModel](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#5 "Save the model asynchronously and return the model")]

Когда вы добавляете инструкцию `await` в вызов `model.WriteAsync()`, метод `Train()` необходимо заменить асинхронным методом, который возвращает `Task`. Измените сигнатуру `Train`, как показано в следующем коде:

[!code-csharp[AsyncTraining](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#6 "Make the Train method async and return a task.")]

Когда вы изменяете тип возвращаемого значения для метода `Train`, необходимо добавить `await` в код, который вызывает `Train` в методе `Main`, как показано в следующем примере:

[!code-csharp[AwaitTraining](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#7 "Await the Train method")]

Добавление `await` в метод `Main`, означает, что метод `Main` должен включать модификатор `async` и возвращать `Task`:

[!code-csharp[AsyncMain](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#8 "Make the Main method async and return a task.")]

Также добавьте следующую инструкцию using в самое начало файла.

[!code-csharp[UsingTasks](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#9 "Add System.Threading.Tasks. to your usings.")]

Так как метод `async Main` реализован только в C# версии 7.1, а для этого проекта по умолчанию устанавливается версия языка C# 7.0, необходимо изменить версию до C# 7.1 или выше.
Для этого в **обозревателе решений** щелкните узел проекта правой кнопкой мыши и выберите пункт **Свойства**. Откройте вкладку **Сборка** и нажмите на кнопку **Дополнительно**. В раскрывающемся списке выберите **C# 7.1** (или более позднюю версию). Нажмите кнопку **OK**.

## <a name="evaluate-the-model"></a>Оценка модели

Оценка — это процесс проверки того, насколько хорошо работает модель. Очень важно, чтобы модель возвращала хорошие прогнозы по данным, которые не использовались для ее обучения. Для такой оценки можно, например, разделить данные на обучающий и тестовый наборы данных, как вы и сделали с помощью этого руководства. Теперь, когда вы завершили обучение модели по обучающему набору данных, вы можете проверить ее работу по тестовым данным.

Вернитесь к функции `Main` и добавьте следующий код под вызовом метода `Train()`:

[!code-csharp[Evaluate](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#10 "Evaluate the model.")]

Функция `Evaluate()` вычисляет модель. Создайте эту функцию под `Train()`. Добавьте следующий код:

```csharp
private static void Evaluate(PredictionModel<TaxiTrip, TaxiTripFarePrediction> model)
{

}
```

Загрузите тестовый данные с помощью функции `TextLoader()`. Добавьте в метод `Evaluate()` следующий код:

[!code-csharp[LoadTestData](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#12 "Load the test data.")]

Добавьте следующий код, чтобы оценить модель и создать для нее метрики:

[!code-csharp[EvaluateAndMeasure](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#13 "Evaluate the model and its predictions.")]

Одной из метрик оценки проблем регрессии является среднеквадратичное отклонение. Чем ниже это отклонение, тем лучше модель. Добавьте следующий код в функцию `Evaluate()`, чтобы вывести среднеквадратичное отклонение для вашей модели.

[!code-csharp[DisplayRMS](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#14 "Display the RMS metric.")]

Еще одной метрикой оценки проблем регрессии является коэффициент детерминации. Этот коэффициент может принимать значения от 0 до 1. Чем он ближе к 1, тем лучше модель. Добавьте следующий код в функцию `Evaluate()`, чтобы вывести коэффициент детерминации для вашей модели.

[!code-csharp[DisplayRSquared](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#15 "Display the RSquared metric.")]

## <a name="use-the-model-for-predictions"></a>Использование модели для прогнозирования

Теперь создайте класс для размещения сценариев тестирования, которые вы можете использовать для проверки правильности работы модели.

1. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите пункты **Добавить** > **Новый элемент**.
1. В диалоговом окне **Добавление нового элемента** выберите **Класс** и измените значение поля **Имя** на *TestTrips.cs*. Теперь нажмите кнопку **Добавить**.
1. Измените класс, чтобы он был статическим, как показано в следующем примере:

[!code-csharp[StaticClass](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TestTrips.cs#1 "Change class to be a static class.")]

Для этого руководства в этом классе используется один тестовый проход. Позже можно добавить другие сценарии и поэкспериментировать с этим примером. Добавьте в класс `TestTrips` следующий код:

[!code-csharp[TestData](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TestTrips.cs#2 "Create aq trip to predict its cost.")]

Фактическая плата за проезд составляет 29,5, но в качестве заполнителя следует указать 0. Алгоритм машинного обучения спрогнозирует плат за проезд.

Добавьте приведенный ниже код в функцию `Main`. Он выполняет проверку модели с помощью данных `TestTrip`:

[!code-csharp[Predict](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#16 "Try a prediction.")]

Запустите программу, чтобы узнать прогноз платы за такси для тестового примера.

Поздравляем! Вы успешно создали модель машинного обучения для прогнозирования платы за проезд в такси, оценили ее точность и протестировали ее работу. Исходный код для этого руководства можно найти в репозитории [dotnet/samples](https://github.com/dotnet/samples/tree/master/machine-learning/tutorials/TaxiFarePrediction).

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как:
> [!div class="checklist"]
> * Определение проблемы
> * Выбор подходящей задачи машинного обучения
> * Анализ данных
> * Создание конвейера обучения
> * Загрузка и преобразование данных
> * Выбор алгоритма обучения
> * Обучение модели
> * Оценка модели
> * Использование модели для прогнозирования

Извлеките наш репозиторий GitHub, чтобы продолжить обучение и получить дополнительные примеры.
> [!div class="nextstepaction"]
> [Репозиторий GitHub dotnet/machinelearning](https://github.com/dotnet/machinelearning/)
