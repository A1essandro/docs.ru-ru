---
title: Использование ML.NET для прогнозирования платы за проезд в такси в Нью-Йорке (регрессия)
description: Сведения об использовании ML.NET в сценарии с моделью регрессии.
author: aditidugar
ms.author: johalex
ms.date: 07/02/2018
ms.topic: tutorial
ms.custom: mvc
ms.openlocfilehash: 133b7ad17a98e4eea510f1704555b690b98e9091
ms.sourcegitcommit: c7f3e2e9d6ead6cc3acd0d66b10a251d0c66e59d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/09/2018
ms.locfileid: "44252848"
---
# <a name="tutorial-use-mlnet-to-predict-new-york-taxi-fares-regression"></a>Руководство. Использование ML.NET для прогнозирования платы за проезд в такси в Нью-Йорке (регрессия)

> [!NOTE]
> В этом разделе описано, как использовать платформу ML.NET, которая сейчас доступна в режиме предварительной версии. Этот материал может быть изменен. Дополнительные сведения см. в [обзоре ML.NET](https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet).

В этом руководства описано, как с помощью ML.NET создать [модель регрессии](../resources/glossary.md#regression) для прогнозирования платы за проезд в такси в городе Нью-Йорк.

В этом руководстве вы узнаете, как:
> [!div class="checklist"]
> * Определение проблемы
> * Выбор подходящей задачи машинного обучения
> * Подготовка и анализ данных
> * Создание конвейера обучения
> * Загрузка и преобразование данных
> * Выбор алгоритма обучения
> * Обучение модели
> * Оценка модели
> * Использование модели для прогнозирования

## <a name="prerequisites"></a>Предварительные требования

* [Visual Studio 2017 15.6 или более поздней версии](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017) с установленной рабочей нагрузкой "Кроссплатформенная разработка .NET Core".

## <a name="understand-the-problem"></a>Определение проблемы

Рассматриваемая проблема основана на сценарии прогнозирования платы за поездку на такси в Нью-Йорке. На первый взгляд может показаться, что плата зависит только от расстояния. Но службы такси в Нью-Йорке изменяют плату с учетом еще нескольких факторов, таких как наличие дополнительных пассажиров или оплата кредитной картой вместо наличных.

## <a name="select-the-appropriate-machine-learning-task"></a>Выбор подходящей задачи машинного обучения

Вы хотите спрогнозировать стоимость, которая является реальным значением, зависящим от других факторов в наборе данных. Для этого нужно выбрать задачу машинного обучения [регрессия](../resources/glossary.md#regression).

## <a name="create-a-console-application"></a>Создание консольного приложения

1. Откройте Visual Studio 2017. Выберите **Файл** > **Создать** > **Проект** в меню. В диалоговом окне **Новый проект** выберите узел **Visual C#**, а затем — узел **.NET Core**. Выберите шаблон проекта **Консольное приложение (.NET Core)**. В текстовое поле **Имя** введите TaxiFarePrediction, а затем нажмите кнопку **ОК**.

1. Создайте каталог с именем *Data* в папке проекта, чтобы хранить в нем наборы данных и файлы модели:

    В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите **Добавить** > **Новая папка**. Введите имя папки Data и нажмите клавишу "ВВОД".

1. Установите пакет NuGet для **Microsoft.ML**:

    В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите **Управление пакетами NuGet**. Выберите nuget.org в качестве источника пакетов, перейдите на вкладку **Обзор**, выполните поиск по фразе **Microsoft.ML**, выберите из списка этот пакет и нажмите кнопку **Установить**. Нажмите кнопку **ОК** в диалоговом окне **Предварительный просмотр изменений**, а затем нажмите кнопку **Принимаю** в диалоговом окне **Принятие условий лицензионного соглашения**, если вы согласны с указанными условиями лицензионного соглашения для выбранных пакетов.

## <a name="prepare-and-understand-the-data"></a>Подготовка и анализ данных

1. Скачайте наборы данных [taxi-fare-train.csv](https://github.com/dotnet/machinelearning/blob/master/test/data/taxi-fare-train.csv) и [taxi-fare-test.csv](https://github.com/dotnet/machinelearning/blob/master/test/data/taxi-fare-test.csv), сохранив их в созданной на предыдущем шаге папке *Data*. Эти наборы данных используются для обучения модели машинного обучения и последующей оценки точности этой модели. Эти наборы данных взяты из [наборов данных NYC TLC Taxi Trip](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml).

1. В **обозревателе решений** щелкните правой кнопкой мыши каждый из файлов \*.csv и выберите **Свойства**. В разделе **Дополнительно** для параметра **Копировать в выходной каталог** установите значение **Копировать более позднюю версию**.

1. Откройте набор данных **taxi-fare-train.csv** и просмотрите заголовки столбцов в первой строке. Теперь изучите каждый из столбцов. Разберитесь, какие данные в них хранятся, и определите, какие столбцы являются **признаками**, а в каком содержится **метка**.

**Метка** — это столбец, значения в котором вы хотите спрогнозировать. Выбранные **признаки** используются для прогнозирования метки.

Предоставленный набор данных содержит следующие столбцы:

* **vendor_id:** идентификатор поставщика такси — это признак.
* **rate_code:** тип оплаты для поездки на такси — это признак.
* **passenger_count:** число пассажиров в поездке — это признак.
* **trip_time_in_secs:** время, затраченное на поездку. Вам требуется спрогнозировать плату за одну поездку до того, как поездка будет завершена. На этот момент вам неизвестна продолжительность поездки. Таким образом, продолжительность поездки не является признаком и соответствующий столбец следует исключить из модели.
* **trip_distance:** расстояние поездки — это признак.
* **payment_type:** метод оплаты (наличные или кредитная карта) — это признак.
* **fare_amount:** общая сумма, оплаченная за поездку на такси — это метка.

## <a name="create-data-classes"></a>Создание классов данных

Создайте классы для входных данных и прогнозов:

1. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите пункты **Добавить** > **Новый элемент**.
1. В диалоговом окне **Добавление нового элемента** выберите **Класс** и измените значение поля **Имя** на *TaxiTrip.cs*. Теперь нажмите кнопку **Добавить**.
1. Добавьте следующие директивы `using` в новый файл.

   [!code-csharp[AddUsings](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TaxiTrip.cs#1 "Add necessary usings")]

Удалите из файла *TaxiTrip.cs* существующее определение класса и добавьте следующий код с двумя классами `TaxiTrip` и `TaxiTripFarePrediction`:

[!code-csharp[DefineTaxiTrip](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TaxiTrip.cs#2 "Define the taxi trip and fare predictions classes")]

Класс `TaxiTrip` содержит входные данные и определения для каждого из столбцов в этом наборе данных. Используйте атрибут [Column](xref:Microsoft.ML.Runtime.Api.ColumnAttribute), чтобы указать индексы исходных столбцов в наборе данных.

Класс `TaxiTripFarePrediction` представляет результаты прогнозирования. Он имеет одно поле типа float `FareAmount`, к которому применен атрибут `Score` [ColumnName](xref:Microsoft.ML.Runtime.Api.ColumnNameAttribute). В случае задачи регрессии столбец **Оценка** содержит прогнозируемые значения метки.

> [!NOTE]
> Используйте тип `float` для представления значений с плавающей запятой в классах данных ввода и прогнозирования.

## <a name="define-data-and-model-paths"></a>Определение путей к данным и модели

Вернитесь к файлу *Program.cs* и добавьте три поля, которые будут содержать пути к файлам с наборами данных и к файлу для сохранения модели.

* `_datapath` содержит путь к файлу с набором данных, используемым для обучения модели.
* `_testdatapath` содержит путь к файлу с набором данных, используемым для оценки модели.
* `_modelpath` содержит путь к файлу для сохранения обучаемой модели.

Добавьте прямо перед методом `Main` следующий код, чтобы указать эти пути.

[!code-csharp[InitializePaths](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#2 "Define variables to store the data file paths")]

Чтобы этот код компилировался, добавьте следующие директивы `using` вверху файла *Program.cs*.

[!code-csharp[AddUsingsForPaths](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#17 "Using statements for path definitions")]

## <a name="create-a-learning-pipeline"></a>Создание конвейера обучения

Добавьте дополнительные директивы `using` в начало файла *Program.cs*.

[!code-csharp[AddUsings](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#1 "Add necessary usings")]

В методе `Main` замените `Console.WriteLine("Hello World!")` следующим кодом:

```csharp
PredictionModel<TaxiTrip, TaxiTripFarePrediction> model = Train();
```

Метод `Train` обучает модель. Создайте этот метод сразу под `Main`, используя следующий код:

```csharp
public static PredictionModel<TaxiTrip, TaxiTripFarePrediction> Train()
{

}
```

Конвейер обучения загружает все данные и алгоритмы, необходимые для обучения модели. Добавьте в метод `Train` следующий код:

```csharp
var pipeline = new LearningPipeline();
```

## <a name="load-and-transform-data"></a>Загрузка и преобразование данных

Сначала нужно загрузить набор данных из набора данных для обучения. В нашем случае набор данных для обучения хранится в текстовом файле, путь к которому задан в поле `_datapath`. Этот файл содержит заголовок с именами столбцов, поэтому при загрузке данных первую строку следует игнорировать. Для разделения столбцов в этом файле используется запятая (","). Добавьте в метод `Train` следующий код:

```csharp
pipeline.Add(new TextLoader(_datapath).CreateFrom<TaxiTrip>(useHeader: true, separator: ','));
```

При выполнении следующих шагов ссылки на столбцы будут задаваться по именам, определенным в классе `TaxiTrip`.

При обучении и оценке модели значения в столбце **Label** по умолчанию рассматриваются как правильные значения для прогноза. Поскольку нам необходимо спрогнозировать плату за поездку на такси, скопируйте столбец `FareAmount` в столбец **Label**. Для этого откройте файл <xref:Microsoft.ML.Transforms.ColumnCopier> и добавьте следующий код:

```csharp
pipeline.Add(new ColumnCopier(("FareAmount", "Label")));
```

Алгоритм, который обучает модель, принимает **числовые** признаки, поэтому значения категориальных данных (`VendorId`, `RateCode` и `PaymentType`) нужно преобразовать в числа. Для этого используйте <xref:Microsoft.ML.Transforms.CategoricalOneHotVectorizer>, который присваивает разные числовые значения ключа разным значениям в каждом из столбцов, и добавьте следующий код:

```csharp
pipeline.Add(new CategoricalOneHotVectorizer("VendorId",
                                             "RateCode",
                                             "PaymentType"));
```

Последний шаг на этапе подготовки данных заключается в объединении всех столбцов признаков в столбце **Features** с помощью класса преобразования <xref:Microsoft.ML.Transforms.ColumnConcatenator>. По умолчанию алгоритм обучения обрабатывает только признаки, представленные в столбце **Features**. Добавьте следующий код:

```csharp
pipeline.Add(new ColumnConcatenator("Features",
                                    "VendorId",
                                    "RateCode",
                                    "PassengerCount",
                                    "TripDistance",
                                    "PaymentType"));
```

Обратите внимание, что не включается столбец `TripTime`, который соответствует столбцу `trip_time_in_secs` в файле набора данных. Вы уже определили, что он не будет полезным признаком для прогнозирования.

> [!NOTE]
> Для успешного выполнения шагов их следует добавлять в конвейер в том порядке, который указан выше.

## <a name="choose-a-learning-algorithm"></a>Выбор алгоритма обучения

После добавления данных в конвейер и их преобразования в правильный входной формат выберите алгоритм обучения (**средство обучения**). Алгоритм обучения осуществляет обучение модели. Для решения этой проблемы вы выбрали задачу **регрессии**, поэтому вы используете алгоритм обучения <xref:Microsoft.ML.Trainers.FastTreeRegressor>, который является одним из регрессионных алгоритмов обучения, предоставляемых ML.NET.

Алгоритм обучения <xref:Microsoft.ML.Trainers.FastTreeRegressor> использует метод градиентного бустинга. Градиентный бустинг — это метод машинного обучения для проблем регрессии. Он пошагово создает каждое дерево регрессии. Он также использует предварительно определенную функцию для оценки ошибки на каждом этапе и исправления ошибок для следующего этапа. Результатом является модель прогнозирования, фактически собранная из нескольких более слабых моделей прогнозирования. Дополнительные сведения о градиентном бустинге см. в статье [Boosted Decision Tree Regression](/azure/machine-learning/studio-module-reference/boosted-decision-tree-regression) (Регрессия для дерева принятия решений с бустингом).

Добавьте следующий код в метод `Train` после кода обработки данных, который вы добавили на предыдущем шаге:

```csharp
pipeline.Add(new FastTreeRegressor());
```

Все предыдущие шаги добавляются в конвейер как отдельные инструкции, но в C# реализован удобный синтаксис для инициализации коллекций, который упрощает создание и инициализацию конвейера. Замените весь код, который вы добавили ранее в метод `Train`, следующим кодом:

[!code-csharp[CreatePipeline](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#3 "Create and initialize the learning pipeline")]

## <a name="train-the-model"></a>Обучение модели

Последним шагом является обучение модели. До этого момента действия в конвейере не выполнялись. Метод `pipeline.Train<TInput, TOutput>` создает модель, которая принимает экземпляр типа `TInput` и возвращает экземпляр типа `TOutput`. Добавьте в метод `Train` следующий код:

[!code-csharp[TrainMOdel](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#4 "Train your model")]

Вот и все! Вы успешно обучили модель машинного обучения, которая умеет прогнозировать плату за проезд в такси в городе Нью-Йорк. Рассмотрим, каким образом можно оценить точность модели и использовать ее для прогнозирования величины платы за поездку на такси.

### <a name="save-the-model"></a>Сохранение модели

На этом этапе у вас есть модель, которую можно интегрировать с любыми существующими или новыми приложениями .NET. Чтобы сохранить модель в ZIP-файл, добавьте следующий код в конец метода `Train`:

[!code-csharp[SaveModel](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#5 "Save the model asynchronously and return the model")]

Когда вы добавляете инструкцию `await` в вызов `model.WriteAsync`, метод `Train` необходимо заменить асинхронным методом, который возвращает задачу. Измените сигнатуру `Train`, как показано в следующем коде:

[!code-csharp[AsyncTraining](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#6 "Make the Train method async and return a task.")]

Когда вы изменяете тип возвращаемого значения для метода `Train`, необходимо добавить `await` в код, который вызывает `Train` в методе `Main`, как показано в следующем примере:

[!code-csharp[AwaitTraining](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#7 "Await the Train method")]

Использование `await` в методе `Main` означает, что метод `Main` должен включать модификатор `async` и возвращать `Task`:

[!code-csharp[AsyncMain](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#8 "Make the Main method async and return a task.")]

Также добавьте следующую директиву `using` в самое начало файла.

[!code-csharp[UsingTasks](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#9 "Add System.Threading.Tasks. to your usings.")]

Так как метод `async Main` реализован только в C# версии 7.1, а для этого проекта по умолчанию устанавливается версия языка C# 7.0, необходимо изменить версию до C# 7.1 или выше. Для этого в **обозревателе решений** щелкните узел проекта правой кнопкой мыши и выберите пункт **Свойства**. Откройте вкладку **Сборка** и нажмите на кнопку **Дополнительно**. В раскрывающемся списке выберите **C# 7.1** (или более позднюю версию). Нажмите кнопку **OK**.

## <a name="evaluate-the-model"></a>Оценка модели

Оценка — это процесс проверки того, насколько хорошо модель позволяет спрогнозировать значения метки. Важно, чтобы модель возвращала хорошие прогнозы по данным, которые не использовались для ее обучения. Для такой оценки можно, например, разделить данные на обучающий и тестовый наборы данных, как вы и сделали в рамках этого руководства. Теперь, когда вы завершили обучение модели по обучающему набору данных, вы можете проверить ее работу по тестовым данным.

Вернитесь к методу `Main` и добавьте следующий код под вызовом метода `Train`:

[!code-csharp[Evaluate](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#10 "Evaluate the model.")]

Метод `Evaluate` осуществляет оценку модели. Чтобы создать этот метод, добавьте следующий код под методом `Train`:

```csharp
private static void Evaluate(PredictionModel<TaxiTrip, TaxiTripFarePrediction> model)
{

}
```

Добавьте следующий код в метод `Evaluate`, чтобы настроить загрузку тестовых данных:

[!code-csharp[LoadTestData](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#12 "Load the test data.")]

Добавьте следующий код, чтобы оценить модель и создать для нее метрики оценки:

[!code-csharp[EvaluateAndMeasure](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#13 "Evaluate the model and its predictions.")]

[Среднеквадратичное отклонение](../resources/glossary.md##root-of-mean-squared-error-rmse) является одной из метрик, используемых для оценки регрессионной модели. Чем ниже это отклонение, тем лучше модель. Чтобы отображать значение среднеквадратичного отклонения, добавьте следующий код в метод `Evaluate`:

[!code-csharp[DisplayRMS](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#14 "Display the RMS metric.")]

Также в качестве метрики для оценки регрессионных моделей используется [коэффициент детерминации](../resources/glossary.md#coefficient-of-determination). Коэффициент детерминации может иметь значения в диапазоне от 0 до 1. Чем ближе его значение к 1, тем лучше модель. Чтобы отображать значение коэффициента детерминации, добавьте следующий код в метод `Evaluate`:

[!code-csharp[DisplayRSquared](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#15 "Display the RSquared metric.")]

## <a name="use-the-model-for-predictions"></a>Использование модели для прогнозирования

Создание класса для размещения тестовых экземпляров данных:

1. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите пункты **Добавить** > **Новый элемент**.
1. В диалоговом окне **Добавление нового элемента** выберите **Класс** и измените значение поля **Имя** на *TestTrips.cs*. Теперь нажмите кнопку **Добавить**.
1. Измените класс, чтобы он был статическим, как показано в следующем примере:

   [!code-csharp[StaticClass](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TestTrips.cs#1 "Change class to be a static class.")]

Для этого руководства в этом классе используется один тестовый проход. Позже можно добавить другие сценарии и поэкспериментировать с этой моделью. Добавьте в класс `TestTrips` следующий код:

[!code-csharp[TestData](../../../samples/machine-learning/tutorials/TaxiFarePrediction/TestTrips.cs#2 "Create aq trip to predict its cost.")]

Фактическая плата за эту поездку составляет 29,5. Используйте в качестве заполнителя значение 0, поскольку модель будет прогнозировать величину платы.

Чтобы спрогнозировать величину платы за конкретную поездку, вернитесь к файлу *Program.cs* и добавьте следующий код в метод `Main`:

[!code-csharp[Predict](../../../samples/machine-learning/tutorials/TaxiFarePrediction/Program.cs#16 "Try a prediction.")]

Запустите программу, чтобы узнать прогноз платы за такси для тестового примера.

Поздравляем! Вы успешно создали модель машинного обучения для прогнозирования платы за проезд в такси, оценили ее точность и использовали ее для получения прогнозов. Исходный код для этого руководства можно найти в репозитории GitHub [dotnet/samples](https://github.com/dotnet/samples/tree/master/machine-learning/tutorials/TaxiFarePrediction).

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как:
> [!div class="checklist"]
> * Определение проблемы
> * Выбор подходящей задачи машинного обучения
> * Подготовка и анализ данных
> * Создание конвейера обучения
> * Загрузка и преобразование данных
> * Выбор алгоритма обучения
> * Обучение модели
> * Оценка модели
> * Использование модели для прогнозирования

Переходите к следующему руководству.
> [!div class="nextstepaction"]
> [Кластеризация ирисов Фишера](iris-clustering.md)
