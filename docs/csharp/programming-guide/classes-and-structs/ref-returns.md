---
title: "Возвращаемые ссылочные значения и ссылочные локальные переменные (руководство по языку C#)"
description: "Сведения о том, как определять и использовать возвращаемые ссылочные значения и ссылочные локальные переменные"
author: rpetrusha
ms.author: ronpet
ms.date: 01/23/2017
ms.topic: article
ms.prod: .net
ms.technology: devlang-csharp
ms.devlang: csharp
ms.openlocfilehash: a74563c0d24b6cd2a2fa8534787f078f3cc92674
ms.sourcegitcommit: cf22b29db780e532e1090c6e755aa52d28273fa6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2018
---
# <a name="ref-returns-and-ref-locals"></a><span data-ttu-id="453b3-103">Возвращаемые ссылочные значения и ссылочные локальные переменные</span><span class="sxs-lookup"><span data-stu-id="453b3-103">Ref returns and ref locals</span></span>

<span data-ttu-id="453b3-104">Начиная с версии 7, язык C# поддерживает значения, возвращаемые по ссылке (возвращаемые ссылочные значения).</span><span class="sxs-lookup"><span data-stu-id="453b3-104">Starting with C# 7, C# supports reference return values (ref returns).</span></span> <span data-ttu-id="453b3-105">Возвращаемое ссылочное значение позволяет методу вернуть вызывающей стороне ссылку на переменную, а не фиксированное значение.</span><span class="sxs-lookup"><span data-stu-id="453b3-105">A reference return value allows a method to return a reference to a variable, rather than a value, back to a caller.</span></span> <span data-ttu-id="453b3-106">После этого вызывающий может самостоятельно решить, как обрабатывать полученную переменную: по значению или по ссылке.</span><span class="sxs-lookup"><span data-stu-id="453b3-106">The caller can then choose to treat the returned variable as if it were returned by value or by reference.</span></span> <span data-ttu-id="453b3-107">Вызывающий может создать новую переменную и присвоить ей ссылку на полученное значение (локальная ссылочная переменная).</span><span class="sxs-lookup"><span data-stu-id="453b3-107">The caller can create a new variable that is itself a reference to the returned value, called a ref local.</span></span>

## <a name="what-is-a-reference-return-value"></a><span data-ttu-id="453b3-108">Что представляет собой возвращаемое ссылочное значение?</span><span class="sxs-lookup"><span data-stu-id="453b3-108">What is a reference return value?</span></span>

<span data-ttu-id="453b3-109">Большинство разработчиков прекрасно знакомы с передачей аргумента в вызываемый метод *по ссылке*.</span><span class="sxs-lookup"><span data-stu-id="453b3-109">Most developers are familiar with passing an argument to a called method *by reference*.</span></span> <span data-ttu-id="453b3-110">Список аргументов вызываемого метода включает переменную, переданную по ссылке, и вызывающий может отследить любые изменения этого значения в вызываемом методе.</span><span class="sxs-lookup"><span data-stu-id="453b3-110">A called method's argument list includes a variable passed by reference, and any changes made to its value by the called method are observed by the caller.</span></span> <span data-ttu-id="453b3-111">*Возвращаемое ссылочное значение* означает, что метод возвращает *ссылку* (или псевдоним) на некоторую переменную, в область действия которой входит этот метод и время существования которой должно продолжаться после того, как метод возвращает это значение.</span><span class="sxs-lookup"><span data-stu-id="453b3-111">A *reference return value* means that a method returns a *reference* (or an alias) to some variable whose scope includes the method and whose lifetime must extend beyond the return of the method.</span></span> <span data-ttu-id="453b3-112">Все изменения, которые вызывающий производит с возвращаемым значением метода, применяются к возвращенной переменной.</span><span class="sxs-lookup"><span data-stu-id="453b3-112">Modifications to the method's return value by the caller are made to the variable that is returned by the method.</span></span>

<span data-ttu-id="453b3-113">Если для метода объявлено *возвращаемое ссылочное значение*, значит он возвращает псевдоним переменной.</span><span class="sxs-lookup"><span data-stu-id="453b3-113">Declaring that a method returns a *reference return value* indicates that the method returns an alias to a variable.</span></span> <span data-ttu-id="453b3-114">Чаще всего это нужно для того, чтобы вызывающий код получил псевдоним для доступа к этой переменной, в том числе для ее изменения.</span><span class="sxs-lookup"><span data-stu-id="453b3-114">The design intent is often that the calling code should have access to that variable through the alias, including to modify it.</span></span> <span data-ttu-id="453b3-115">Следовательно, методы с возвращаемыми ссылочными значениями не могут иметь тип возвращаемого значения `void`.</span><span class="sxs-lookup"><span data-stu-id="453b3-115">It follows that methods returning by reference cannot have the return type `void`.</span></span>

<span data-ttu-id="453b3-116">Есть несколько ограничений для выражений, которые можно использовать в качестве возвращаемых ссылочных значений метода.</span><span class="sxs-lookup"><span data-stu-id="453b3-116">There are some restrictions on the expression that a method can return as a reference return value.</span></span> <span data-ttu-id="453b3-117">Сюда входит следующее.</span><span class="sxs-lookup"><span data-stu-id="453b3-117">These include:</span></span>

- <span data-ttu-id="453b3-118">Время существования возвращаемого значения должно превышать период выполнения метода.</span><span class="sxs-lookup"><span data-stu-id="453b3-118">The return value must have a lifetime that extends beyond the execution of the method.</span></span> <span data-ttu-id="453b3-119">Другими словами, нельзя возвращать ссылку на локальную переменную вызываемого метода.</span><span class="sxs-lookup"><span data-stu-id="453b3-119">In other words, it cannot be a local variable in the method that returns it.</span></span> <span data-ttu-id="453b3-120">Это может быть экземпляр статического поля или класса, а также переданный в метод аргумент.</span><span class="sxs-lookup"><span data-stu-id="453b3-120">It can be an instance or static field of a class, or it can be an argument passed to the method.</span></span> <span data-ttu-id="453b3-121">При попытке возвратить локальную переменную возникает ошибка компилятора CS8168 "Невозможно вернуть по ссылке локальный "obj", так как это не локальная переменная ref".</span><span class="sxs-lookup"><span data-stu-id="453b3-121">Attempting to return a local variable generates compiler error CS8168, "Cannot return local 'obj' by reference because it is not a ref local."</span></span>

- <span data-ttu-id="453b3-122">Возвращаемое значение не может быть литералом `null`.</span><span class="sxs-lookup"><span data-stu-id="453b3-122">The return value cannot be the literal `null`.</span></span> <span data-ttu-id="453b3-123">При попытке возвратить `null` возникает ошибка компилятора CS8156 "Выражение невозможно использовать в данном контексте, так как его невозможно вернуть по ссылке".</span><span class="sxs-lookup"><span data-stu-id="453b3-123">Attempting to return `null` generates compiler error CS8156, "An expression cannot be used in this context because it may not be returned by reference."</span></span>

   <span data-ttu-id="453b3-124">Метод с возвращаемым ссылочным значением может возвращать псевдоним для переменной с текущим значением null (которой не присвоены экземпляры) или [тип, допускающий значение null](../nullable-types/index.md).</span><span class="sxs-lookup"><span data-stu-id="453b3-124">A method with a ref return can return an alias to a variable whose value is currently the null (uninstantiated) value or a [nullable type](../nullable-types/index.md) for a value type.</span></span>
 
- <span data-ttu-id="453b3-125">Возвращаемое значение не может быть константой, элементом перечисления, полученным по значению, возвращаемым значением свойства, а также методом `class` или `struct`.</span><span class="sxs-lookup"><span data-stu-id="453b3-125">The return value cannot be a constant, an enumeration member, the by-value return value from a property, or a method of a `class` or `struct`.</span></span> <span data-ttu-id="453b3-126">При попытке возвратить такие значения возникает ошибка компилятора CS8156 "Выражение невозможно использовать в данном контексте, так как его невозможно вернуть по ссылке".</span><span class="sxs-lookup"><span data-stu-id="453b3-126">Attempting to return these generates compiler error CS8156, "An expression cannot be used in this context because it may not be returned by reference."</span></span>

<span data-ttu-id="453b3-127">Кроме того, так как асинхронный метод может вернуть значение до того, как будет завершено его выполнение и станет известно его возвращаемое значение, использовать возвращаемые ссылочные значения в асинхронных методах невозможно.</span><span class="sxs-lookup"><span data-stu-id="453b3-127">In addition, because an asynchronous method may return before it has finished execution, while its return value is still unknown, reference return values are not allowed on async methods.</span></span>
 
## <a name="defining-a-ref-return-value"></a><span data-ttu-id="453b3-128">Определение возвращаемого ссылочного значения</span><span class="sxs-lookup"><span data-stu-id="453b3-128">Defining a ref return value</span></span>

<span data-ttu-id="453b3-129">Чтобы определить возвращаемое ссылочное значение, необходимо добавить ключевое слово [ref](../../language-reference/keywords/ref.md) к типу возвращаемого значения в сигнатуре метода.</span><span class="sxs-lookup"><span data-stu-id="453b3-129">You define a ref return value by adding the [ref](../../language-reference/keywords/ref.md) keyword to the return type of the method signature.</span></span> <span data-ttu-id="453b3-130">Например, следующая сигнатура указывает, что свойство `GetContactInformation` возвращает вызывающему объекту ссылку на объект `Person`:</span><span class="sxs-lookup"><span data-stu-id="453b3-130">For example, the following signature indicates that the `GetContactInformation` property returns a reference to a `Person` object to the caller:</span></span>

```csharp
public ref Person GetContactInformation(string fname, string lname);
```

<span data-ttu-id="453b3-131">Кроме того, имени объекта, возвращаемого каждой инструкцией [return](../../language-reference/keywords/return.md) в теле метода, должно предшествовать ключевое слово [ref](../../language-reference/keywords/ref.md).</span><span class="sxs-lookup"><span data-stu-id="453b3-131">In addition, the name of the object returned by each [return](../../language-reference/keywords/return.md) statement in the method body must be preceded by the [ref](../../language-reference/keywords/ref.md) keyword.</span></span> <span data-ttu-id="453b3-132">Например, следующая инструкция `return` возвращает ссылку на объект `Person` с именем `p`:</span><span class="sxs-lookup"><span data-stu-id="453b3-132">For example, the following `return` statement returns a reference to a `Person` object named `p`:</span></span>

```csharp
return ref p;
```

## <a name="consuming-a-ref-return-value"></a><span data-ttu-id="453b3-133">Использование возвращаемого ссылочного значения</span><span class="sxs-lookup"><span data-stu-id="453b3-133">Consuming a ref return value</span></span>

<span data-ttu-id="453b3-134">Возвращаемое ссылочное значение является псевдонимом для другой переменной в области вызываемого метода.</span><span class="sxs-lookup"><span data-stu-id="453b3-134">The ref return value is an alias to another variable in the called method's scope.</span></span> <span data-ttu-id="453b3-135">Любое применение возвращаемого ссылочного значения можно рассматривать как применение псевдонима соответствующей переменной.</span><span class="sxs-lookup"><span data-stu-id="453b3-135">You can interpret any use of the ref return as using the variable it aliases:</span></span>

- <span data-ttu-id="453b3-136">Присваивая новое значение псевдониму, вы присваиваете это значение переменной, на которую он ссылается.</span><span class="sxs-lookup"><span data-stu-id="453b3-136">When you assign its value, you are assigning a value to the variable it aliases.</span></span>
- <span data-ttu-id="453b3-137">Считывая значение псевдонима, вы получаете значение переменной, на которую он ссылается.</span><span class="sxs-lookup"><span data-stu-id="453b3-137">When you read its value, you are reading the value of the variable it aliases.</span></span>
- <span data-ttu-id="453b3-138">Возвращая псевдоним *по ссылке*, вы возвращаете новый псевдоним для той же переменной.</span><span class="sxs-lookup"><span data-stu-id="453b3-138">If you return it *by reference* you are returning an alias to that same variable.</span></span>
- <span data-ttu-id="453b3-139">Передавая псевдоним другому методу *по ссылке*, вы передаете ссылку на переменную, на которую ссылается псевдоним.</span><span class="sxs-lookup"><span data-stu-id="453b3-139">If you pass it to another method *by reference* you are passing a reference to the variable it aliases.</span></span>
- <span data-ttu-id="453b3-140">Создавая для псевдонима [локальную ссылочную переменную](#ref-local), вы создаете новый псевдоним для той же переменной.</span><span class="sxs-lookup"><span data-stu-id="453b3-140">When you make a [ref local](#ref-local) alias, you make a new alias to the same variable.</span></span>


## <a name="ref-locals"></a><span data-ttu-id="453b3-141">Ссылочные локальные переменные</span><span class="sxs-lookup"><span data-stu-id="453b3-141">Ref locals</span></span>

<span data-ttu-id="453b3-142">Предположим, что для метода `GetContactInformation` объявлено возвращаемое ссылочное значение:</span><span class="sxs-lookup"><span data-stu-id="453b3-142">Assume the `GetContactInformation` method is declared as a ref return:</span></span>

```csharp
public ref Person GetContactInformation(string fname, string lname)
```

<span data-ttu-id="453b3-143">При назначении по значению считывается значение переменной и присваивается это значение новой переменной:</span><span class="sxs-lookup"><span data-stu-id="453b3-143">A by-value assignment reads the value of a variable and assigns it to a new variable:</span></span>

```csharp
Person p = contacts.GetContactInformation("Brandie", "Best");
```

<span data-ttu-id="453b3-144">В предыдущем назначении `p` объявлена как локальная переменная.</span><span class="sxs-lookup"><span data-stu-id="453b3-144">The preceding assignment declares `p` as a local variable.</span></span> <span data-ttu-id="453b3-145">Исходное значение копируется из значения, которое возвращает `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="453b3-145">Its initial value is copied from reading the value returned by `GetContactInformation`.</span></span> <span data-ttu-id="453b3-146">Все последующие назначения `p` не затронут значения переменной, которую возвращает `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="453b3-146">Any future assignments to `p` will not change the value of the variable returned by `GetContactInformation`.</span></span> <span data-ttu-id="453b3-147">Переменная `p` теперь не является псевдонимом для возвращаемой переменной.</span><span class="sxs-lookup"><span data-stu-id="453b3-147">The variable `p` is no longer an alias to the variable returned.</span></span>

<span data-ttu-id="453b3-148">Вы объявляете *локальную ссылочную переменную* и сохраняете в ней псевдоним для исходного значения.</span><span class="sxs-lookup"><span data-stu-id="453b3-148">You declare a *ref local* variable to copy the alias to the original value.</span></span> <span data-ttu-id="453b3-149">В следующем назначении `p` является псевдонимом для переменной, возвращаемой из `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="453b3-149">In the following assignment, `p` is an alias to the variable returned from `GetContactInformation`.</span></span>

```csharp
ref Person p = ref contacts.GetContactInformation("Brandie", "Best");
```

<span data-ttu-id="453b3-150">При дальнейшем применении `p` действует так же, как и возвращаемая из `GetContactInformation` переменная, так как `p` является псевдонимом для этой переменной.</span><span class="sxs-lookup"><span data-stu-id="453b3-150">Subsequent usage of `p` is the same as using the variable returned by `GetContactInformation` because `p` is an alias for that variable.</span></span> <span data-ttu-id="453b3-151">Любые изменения `p` затрагивают и переменную, возвращаемую из `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="453b3-151">Changes to `p` also change the variable returned from `GetContactInformation`.</span></span>

<span data-ttu-id="453b3-152">Обратите внимание, что ключевое слово `ref` используется перед объявлением локальной переменной *и* до вызова метода.</span><span class="sxs-lookup"><span data-stu-id="453b3-152">Note that the `ref` keyword is used both before the local variable declaration *and* before the method call.</span></span> <span data-ttu-id="453b3-153">Если ключевые слова `ref` не указаны одновременно в объявлении и присвоении переменной, возникает ошибка компилятора CS8172 "Невозможно инициализировать значением переменную по ссылке".</span><span class="sxs-lookup"><span data-stu-id="453b3-153">Failure to include both `ref` keywords in the variable declaration and assignment results in compiler error CS8172, "Cannot initialize a by-reference variable with a value."</span></span> 
 
## <a name="ref-returns-and-ref-locals-an-example"></a><span data-ttu-id="453b3-154">Пример использования возвращаемых ссылочных значений и ссылочных локальных переменных</span><span class="sxs-lookup"><span data-stu-id="453b3-154">Ref returns and ref locals: an example</span></span>

<span data-ttu-id="453b3-155">В следующем примере определяется класс `NumberStore`, в котором хранится массив целочисленных значений.</span><span class="sxs-lookup"><span data-stu-id="453b3-155">The following example defines a `NumberStore` class that stores an array of integer values.</span></span> <span data-ttu-id="453b3-156">Метод `FindNumber` возвращает по ссылке первое число, которое не меньше переданного в аргументе значения.</span><span class="sxs-lookup"><span data-stu-id="453b3-156">The `FindNumber` method returns by reference the first number that is greater than or equal to the number passed as an argument.</span></span> <span data-ttu-id="453b3-157">Если такое число не найдено, метод возвращает число с индексом 0.</span><span class="sxs-lookup"><span data-stu-id="453b3-157">If no number is greater than or equal to the argument, the method returns the number in index 0.</span></span> 

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#1)]

<span data-ttu-id="453b3-158">В следующем примере вызывается метод `NumberStore.FindNumber`, который извлекает первое значение не меньше 16.</span><span class="sxs-lookup"><span data-stu-id="453b3-158">The following example calls the `NumberStore.FindNumber` method to retrieve the first value that is greater than or equal to 16.</span></span> <span data-ttu-id="453b3-159">После этого вызывающий объект удваивает значение, возвращаемое методом.</span><span class="sxs-lookup"><span data-stu-id="453b3-159">The caller then doubles the value returned by the method.</span></span> <span data-ttu-id="453b3-160">Как видно из выходных данных этого примера, изменение отражается в значении элементов массива в экземпляре `NumberStore`.</span><span class="sxs-lookup"><span data-stu-id="453b3-160">As the output from the example shows, this change is reflected in the value of the array elements of the `NumberStore` instance.</span></span>

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#2)]

<span data-ttu-id="453b3-161">Без использования возвращаемых ссылочных значений такая операция обычно выполняется путем возврата индекса элемента массива вместе с его значением.</span><span class="sxs-lookup"><span data-stu-id="453b3-161">Without support for reference return values, such an operation is usually performed by returning the index of the array element along with its value.</span></span> <span data-ttu-id="453b3-162">После этого вызывающий объект использует индекс для изменения значения в отдельном вызове метода.</span><span class="sxs-lookup"><span data-stu-id="453b3-162">The caller can then use this index to modify the value in a separate method call.</span></span> <span data-ttu-id="453b3-163">Тем не менее вызывающий объект также может изменить индекс для доступа к другим значениям массива и их изменения.</span><span class="sxs-lookup"><span data-stu-id="453b3-163">However, the caller can also modify the index to access and possibly modify other array values.</span></span>  
 
## <a name="see-also"></a><span data-ttu-id="453b3-164">См. также</span><span class="sxs-lookup"><span data-stu-id="453b3-164">See also</span></span>

[<span data-ttu-id="453b3-165">Ключевое слово ref</span><span class="sxs-lookup"><span data-stu-id="453b3-165">ref keyword</span></span>](../../language-reference/keywords/ref.md)
