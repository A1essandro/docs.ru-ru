---
title: "Возвращаемые ссылочные значения и ссылочные локальные переменные (руководство по языку C#)"
description: "Сведения о том, как определять и использовать возвращаемые ссылочные значения и ссылочные локальные переменные"
author: rpetrusha
ms.author: ronpet
ms.date: 05/30/2017
ms.topic: article
ms.prod: .net
ms.technology: devlang-csharp
ms.devlang: csharp
ms.assetid: 18cf7a4b-29f0-4b14-85b8-80af754aabd8
ms.openlocfilehash: 1d8fb092b578602b5d4f791a3fd14f47dfae1ba6
ms.sourcegitcommit: 7e99f66ef09d2903e22c789c67ff5a10aa953b2f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2017
---
# <a name="ref-returns-and-ref-locals"></a><span data-ttu-id="02d08-103">Возвращаемые ссылочные значения и ссылочные локальные переменные</span><span class="sxs-lookup"><span data-stu-id="02d08-103">Ref returns and ref locals</span></span>

<span data-ttu-id="02d08-104">Начиная с версии 7, язык C# поддерживает значения, возвращаемые по ссылке (возвращаемые ссылочные значения).</span><span class="sxs-lookup"><span data-stu-id="02d08-104">Starting with C# 7, C# supports reference return values (ref returns).</span></span> <span data-ttu-id="02d08-105">Возвращаемое ссылочное значение позволяет вернуть вызывающему объекту ссылку на объект вместо значения.</span><span class="sxs-lookup"><span data-stu-id="02d08-105">A reference return value allows a method to return a reference to an object, rather than a value, back to a caller.</span></span> <span data-ttu-id="02d08-106">После этого вызывающий объект может по необходимости обрабатывать возвращенный объект по значению или по ссылке.</span><span class="sxs-lookup"><span data-stu-id="02d08-106">The caller can then choose to treat the returned object returned as if it were returned by value or by reference.</span></span> <span data-ttu-id="02d08-107">Значение, возвращаемое вызывающему объекту при обработке по ссылке, называется ссылочной локальной переменной.</span><span class="sxs-lookup"><span data-stu-id="02d08-107">A value returned by reference that the caller handles as a reference rather than a value is a ref local.</span></span>

## <a name="what-is-a-reference-return-value"></a><span data-ttu-id="02d08-108">Что представляет собой возвращаемое ссылочное значение?</span><span class="sxs-lookup"><span data-stu-id="02d08-108">What is a reference return value?</span></span>

<span data-ttu-id="02d08-109">Большинство разработчиков прекрасно знакомы с передачей аргумента в вызываемый метод *по ссылке*.</span><span class="sxs-lookup"><span data-stu-id="02d08-109">Most developers are familiar with passing an argument to a called method *by reference*.</span></span> <span data-ttu-id="02d08-110">Список аргументов вызываемого метода включает значение, переданное по ссылке. Таким образом, любые изменения этого значения в вызываемом методе будут возвращаться вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="02d08-110">A called method's argument list includes a value passed by reference, and any changes made to its value by the called method are returned to the caller.</span></span> <span data-ttu-id="02d08-111">*Возвращаемое ссылочное значение* определяется с точностью до наоборот:</span><span class="sxs-lookup"><span data-stu-id="02d08-111">A *reference return value* is the opposite:</span></span>

- <span data-ttu-id="02d08-112">По ссылке передается возвращаемое значение вызываемого метода, а не переданный в него аргумент.</span><span class="sxs-lookup"><span data-stu-id="02d08-112">The called method's return value, rather than an argument passed to it, is a reference.</span></span>

- <span data-ttu-id="02d08-113">Значение, возвращаемое вызываемым методом, может изменяться не этим методом, а вызывающим объектом.</span><span class="sxs-lookup"><span data-stu-id="02d08-113">The caller, rather than the called method, can modify the value returned by the method.</span></span>

- <span data-ttu-id="02d08-114">Таким образом, вместо отражения изменений аргумента в состоянии объекта на вызывающей стороне изменения возвращаемого методом значения, выполненные вызывающим объектом, отражаются в состоянии объекта, метод которого был вызван.</span><span class="sxs-lookup"><span data-stu-id="02d08-114">Instead of modifications to the argument that are reflected in state of the object on the caller, modifications to the method's return value by the caller are reflected in the state of the object whose method was called.</span></span>

<span data-ttu-id="02d08-115">Применение возвращаемых ссылочных значений позволяет сократить размер кода. Кроме того, в этом случае объект предоставляет доступ только к отдельным элементам данных (например, элементам массива), которые запрашиваются вызывающим объектом.</span><span class="sxs-lookup"><span data-stu-id="02d08-115">Reference return values can produce more compact code, as well as allow an object to expose only the individual data items, such as an array element, that are of interest to the caller.</span></span> <span data-ttu-id="02d08-116">Благодаря этому снижается вероятность того, что состояние объекта будет случайно изменено вызывающей стороной.</span><span class="sxs-lookup"><span data-stu-id="02d08-116">This reduces the likelihood that the caller will inadvertently modify the object's state.</span></span>

<span data-ttu-id="02d08-117">В отношении возвращаемых методом ссылочных значений действуют определенные ограничения.</span><span class="sxs-lookup"><span data-stu-id="02d08-117">There are some restrictions on the value that a method can return as a reference return value.</span></span> <span data-ttu-id="02d08-118">К ним относятся следующие методы.</span><span class="sxs-lookup"><span data-stu-id="02d08-118">These include:</span></span>

- <span data-ttu-id="02d08-119">Возвращаемое значение не может быть равно `void`.</span><span class="sxs-lookup"><span data-stu-id="02d08-119">The return value cannot be `void`.</span></span> <span data-ttu-id="02d08-120">При попытке определить метод с возвращаемым ссылочным значением `void` возникает ошибка компилятора CS1547 "Использование ключевого слова void в этом контексте недопустимо".</span><span class="sxs-lookup"><span data-stu-id="02d08-120">Attempting to define a method with a `void` reference return value generates compiler error CS1547, "Keyword 'void' cannot be used in this context."</span></span>
 
- <span data-ttu-id="02d08-121">Возвращаемое значение не может быть локальной переменной метода, который возвращает его. Область действия такого значения должна находиться за пределами возвращающего его метода.</span><span class="sxs-lookup"><span data-stu-id="02d08-121">The return value cannot be a local variable in the method that returns it; it must have a scope that is outside the method that returns it.</span></span> <span data-ttu-id="02d08-122">Это может быть экземпляр статического поля или класса, а также переданный в метод аргумент.</span><span class="sxs-lookup"><span data-stu-id="02d08-122">It can be an instance or static field of a class, or it can be an argument passed to the method.</span></span> <span data-ttu-id="02d08-123">При попытке возвратить локальную переменную возникает ошибка компилятора CS8168 "Невозможно вернуть по ссылке локальный "obj", так как это не локальная переменная ref".</span><span class="sxs-lookup"><span data-stu-id="02d08-123">Attempting to return a local variable generates compiler error CS8168, "Cannot return local 'obj' by reference because it is not a ref local."</span></span>

- <span data-ttu-id="02d08-124">Возвращаемое значение не может быть равно `null`.</span><span class="sxs-lookup"><span data-stu-id="02d08-124">The return value cannot be a `null`.</span></span> <span data-ttu-id="02d08-125">При попытке возвратить `null` возникает ошибка компилятора CS8156 "Выражение невозможно использовать в данном контексте, так как его невозможно вернуть по ссылке".</span><span class="sxs-lookup"><span data-stu-id="02d08-125">Attempting to return `null` generates compiler error CS8156, "An expression cannot be used in this context because it may not be returned by reference."</span></span>

   <span data-ttu-id="02d08-126">Если методу с возвращаемым ссылочным значением необходимо вернуть значение null, следует вернуть значение null (без экземпляров) для ссылочного типа или [тип, допускающий значение null](../nullable-types/index.md), для типа значения.</span><span class="sxs-lookup"><span data-stu-id="02d08-126">If a method with a ref return needs to return a null value, you can either return a null (uninstantiated) value for a reference type or a [nullable type](../nullable-types/index.md) for a value type.</span></span>
 
- <span data-ttu-id="02d08-127">Возвращаемое значение не может быть константой, элементом перечисления, а также свойством `class` или `struct`.</span><span class="sxs-lookup"><span data-stu-id="02d08-127">The return value cannot be a constant, an enumeration member, or a property of a `class` or `struct`.</span></span> <span data-ttu-id="02d08-128">При попытке возвратить такие значения возникает ошибка компилятора CS8156 "Выражение невозможно использовать в данном контексте, так как его невозможно вернуть по ссылке".</span><span class="sxs-lookup"><span data-stu-id="02d08-128">Attempting to return these generates compiler error CS8156, "An expression cannot be used in this context because it may not be returned by reference."</span></span>

<span data-ttu-id="02d08-129">Кроме того, так как асинхронный метод может вернуть значение до того, как будет завершено его выполнение и станет известно его возвращаемое значение, использовать возвращаемые ссылочные значения в асинхронных методах невозможно.</span><span class="sxs-lookup"><span data-stu-id="02d08-129">In addition, because an asynchronous method may return before it has finished execution, while its return value is still unknown, reference return values are not allowed on async methods.</span></span>
 
## <a name="defining-a-ref-return-value"></a><span data-ttu-id="02d08-130">Определение возвращаемого ссылочного значения</span><span class="sxs-lookup"><span data-stu-id="02d08-130">Defining a ref return value</span></span>

<span data-ttu-id="02d08-131">Чтобы определить возвращаемое ссылочное значение, необходимо добавить ключевое слово [ref](../../language-reference/keywords/ref.md) к типу возвращаемого значения в сигнатуре метода.</span><span class="sxs-lookup"><span data-stu-id="02d08-131">You define a ref return value by adding the [ref](../../language-reference/keywords/ref.md) keyword to the return type of the method signature.</span></span> <span data-ttu-id="02d08-132">Например, следующая сигнатура указывает, что свойство `GetContactInformation` возвращает вызывающему объекту ссылку на объект `Person`:</span><span class="sxs-lookup"><span data-stu-id="02d08-132">For example, the following signature indicates that the `GetContactInformation` property returns a reference to a `Person` object to the caller:</span></span>

```csharp
public ref Person GetContactInformation(string fname, string lname);
```

<span data-ttu-id="02d08-133">Кроме того, имени объекта, возвращаемого каждой инструкцией [return](../../language-reference/keywords/return.md) в теле метода, должно предшествовать ключевое слово [ref](../../language-reference/keywords/ref.md).</span><span class="sxs-lookup"><span data-stu-id="02d08-133">In addition, the name of the object returned by each [return](../../language-reference/keywords/return.md) statement in the method body must be preceded by the [ref](../../language-reference/keywords/ref.md) keyword.</span></span> <span data-ttu-id="02d08-134">Например, следующая инструкция `return` возвращает объект `Person` с именем `p` по ссылке:</span><span class="sxs-lookup"><span data-stu-id="02d08-134">For example, the following `return` statement returns a `Person` object named `p` by reference:</span></span>

```csharp
return ref p;
```

## <a name="consuming-a-ref-return-value"></a><span data-ttu-id="02d08-135">Использование возвращаемого ссылочного значения</span><span class="sxs-lookup"><span data-stu-id="02d08-135">Consuming a ref return value</span></span>

<span data-ttu-id="02d08-136">Вызывающий объект может обрабатывать возвращаемое ссылочное значение одним из двух способов:</span><span class="sxs-lookup"><span data-stu-id="02d08-136">A caller can handle a ref return value in either of two ways:</span></span>

- <span data-ttu-id="02d08-137">Как обычное возвращаемое методом значение.</span><span class="sxs-lookup"><span data-stu-id="02d08-137">As an ordinary value returned by value from a method.</span></span> <span data-ttu-id="02d08-138">Вызывающий объект может игнорировать тот факт, что это возвращаемое ссылочное значение.</span><span class="sxs-lookup"><span data-stu-id="02d08-138">The caller can choose to ignore that the return value is a reference return value.</span></span> <span data-ttu-id="02d08-139">В этом случае любые изменения значения, возвращаемого в результате вызова метода, не отражаются в состоянии вызываемого типа.</span><span class="sxs-lookup"><span data-stu-id="02d08-139">In this case, any changes made to the value returned by the method call are not reflected in the state of the called type.</span></span> <span data-ttu-id="02d08-140">Если возвращаемое значение имеет тип значения, любые изменения значения, возвращаемого в результате вызова метода, не отражаются в состоянии вызываемого типа.</span><span class="sxs-lookup"><span data-stu-id="02d08-140">If the returned value is a value type, any changes made to the value returned by the method call are not reflected in the state of the called type.</span></span>

- <span data-ttu-id="02d08-141">Как возвращаемое ссылочное значение.</span><span class="sxs-lookup"><span data-stu-id="02d08-141">As a reference return value.</span></span> <span data-ttu-id="02d08-142">Вызывающий объект должен определить переменную, которой будет присваиваться возвращаемое ссылочное значение, как [ссылочную локальную переменную](#ref-local). В этом случае любые изменения значения, возвращаемого в результате вызова метода, будут отражаться в состоянии вызываемого типа.</span><span class="sxs-lookup"><span data-stu-id="02d08-142">The caller must define the variable to which the reference return value is assigned as a [ref local](#ref-local), and any changes to the value returned by the method call are reflected in the state of the called type.</span></span> 

## <a name="ref-locals"></a><span data-ttu-id="02d08-143">Ссылочные локальные переменные</span><span class="sxs-lookup"><span data-stu-id="02d08-143">Ref locals</span></span>

<span data-ttu-id="02d08-144">Чтобы обрабатывать возвращаемое ссылочное значение как ссылку, вызывающий объект должен объявить значение как *ссылочную локальную переменную* с помощью ключевого слова `ref`.</span><span class="sxs-lookup"><span data-stu-id="02d08-144">To handle the reference return value as a reference, the caller must declare the value to be a *ref local* by using the `ref` keyword.</span></span> <span data-ttu-id="02d08-145">Например, если возвращаемое методом `Person.GetContactInfomation` значение будет использоваться в виде ссылки, а не значения, вызов метода должен выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="02d08-145">For example, if the value returned by the `Person.GetContactInfomation` method is to be consumed as a reference rather than a value, the method call appears as:</span></span>

```csharp
ref Person p = ref contacts.GetContactInformation("Brandie", "Best");
```

<span data-ttu-id="02d08-146">Обратите внимание, что ключевое слово `ref` используется перед объявлением локальной переменной *и* до вызова метода.</span><span class="sxs-lookup"><span data-stu-id="02d08-146">Note that the `ref` keyword is used both before the local variable declaration *and* before the method call.</span></span> <span data-ttu-id="02d08-147">Если ключевые слова `ref` не указаны одновременно в объявлении и присвоении переменной, возникает ошибка компилятора CS8172 "Невозможно инициализировать значением переменную по ссылке".</span><span class="sxs-lookup"><span data-stu-id="02d08-147">Failure to include both `ref` keywords in the variable declaration and assignment results in compiler error CS8172, "Cannot initialize a by-reference variable with a value."</span></span> 
 
<span data-ttu-id="02d08-148">Последующие изменения объекта `Person`, возвращаемого методом, будут отражаться в объекте `contacts`.</span><span class="sxs-lookup"><span data-stu-id="02d08-148">Subsequent changes to the `Person` object returned by the method are reflected in the `contacts` object.</span></span>

<span data-ttu-id="02d08-149">Если `p` не объявлено как локальная ссылочная переменная с помощью ключевого слова `ref`, любые изменения `p`, выполненные вызывающим объектом, не будут отражаться в объекте `contacts`.</span><span class="sxs-lookup"><span data-stu-id="02d08-149">If `p` is not defined as a ref local by using the `ref` keyword, any changes made to `p` by the caller are not reflected in the `contacts` object.</span></span>
 
## <a name="ref-returns-and-ref-locals-an-example"></a><span data-ttu-id="02d08-150">Пример использования возвращаемых ссылочных значений и ссылочных локальных переменных</span><span class="sxs-lookup"><span data-stu-id="02d08-150">Ref returns and ref locals: an example</span></span>

<span data-ttu-id="02d08-151">В следующем примере определяется класс `NumberStore`, в котором хранится массив целочисленных значений.</span><span class="sxs-lookup"><span data-stu-id="02d08-151">The following example defines a `NumberStore` class that stores an array of integer values.</span></span> <span data-ttu-id="02d08-152">Метод `FindNumber` возвращает по ссылке первое число, которое не меньше переданного в аргументе значения.</span><span class="sxs-lookup"><span data-stu-id="02d08-152">The `FindNumber` method returns by reference the first number that is greater than or equal to the number passed as an argument.</span></span> <span data-ttu-id="02d08-153">Если такое число не найдено, метод возвращает число с индексом 0.</span><span class="sxs-lookup"><span data-stu-id="02d08-153">If no number is greater than or equal to the argument, the method returns the number in index 0.</span></span> 

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#1)]

<span data-ttu-id="02d08-154">В следующем примере вызывается метод `NumberStore.FindNumber`, который извлекает первое значение не меньше 16.</span><span class="sxs-lookup"><span data-stu-id="02d08-154">The following example calls the `NumberStore.FindNumber` method to retrieve the first value that is greater than or equal to 16.</span></span> <span data-ttu-id="02d08-155">После этого вызывающий объект удваивает значение, возвращаемое методом.</span><span class="sxs-lookup"><span data-stu-id="02d08-155">The caller then doubles the value returned by the method.</span></span> <span data-ttu-id="02d08-156">Как видно из выходных данных этого примера, изменение отражается в значении элементов массива в экземпляре `NumberStore`.</span><span class="sxs-lookup"><span data-stu-id="02d08-156">As the output from the example shows, this change is reflected in the value of the array elements of the `NumberStore` instance.</span></span>

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#2)]

<span data-ttu-id="02d08-157">Без использования возвращаемых ссылочных значений такая операция обычно выполняется путем возврата индекса элемента массива вместе с его значением.</span><span class="sxs-lookup"><span data-stu-id="02d08-157">Without support for reference return values, such an operation is usually performed by returning the index of the array element along with its value.</span></span> <span data-ttu-id="02d08-158">После этого вызывающий объект использует индекс для изменения значения в отдельном вызове метода.</span><span class="sxs-lookup"><span data-stu-id="02d08-158">The caller can then use this index to modify the value in a separate method call.</span></span> <span data-ttu-id="02d08-159">Тем не менее вызывающий объект также может изменить индекс для доступа к другим значениям массива и их изменения.</span><span class="sxs-lookup"><span data-stu-id="02d08-159">However, the caller can also modify the index to access and possibly modify other array values.</span></span>  
 
## <a name="see-also"></a><span data-ttu-id="02d08-160">См. также</span><span class="sxs-lookup"><span data-stu-id="02d08-160">See also</span></span>

[<span data-ttu-id="02d08-161">Ключевое слово ref</span><span class="sxs-lookup"><span data-stu-id="02d08-161">ref keyword</span></span>](../../language-reference/keywords/ref.md)
