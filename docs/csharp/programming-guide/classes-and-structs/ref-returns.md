---
title: "Возвращаемые ссылочные значения и ссылочные локальные переменные (руководство по языку C#)"
description: "Сведения о том, как определять и использовать возвращаемые ссылочные значения и ссылочные локальные переменные"
author: rpetrusha
ms.author: ronpet
ms.date: 05/30/2017
ms.topic: article
ms.prod: .net
ms.technology: devlang-csharp
ms.devlang: csharp
ms.assetid: 18cf7a4b-29f0-4b14-85b8-80af754aabd8
ms.openlocfilehash: 1d8fb092b578602b5d4f791a3fd14f47dfae1ba6
ms.sourcegitcommit: 7e99f66ef09d2903e22c789c67ff5a10aa953b2f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2017
---
# <a name="ref-returns-and-ref-locals"></a>Возвращаемые ссылочные значения и ссылочные локальные переменные

Начиная с версии 7, язык C# поддерживает значения, возвращаемые по ссылке (возвращаемые ссылочные значения). Возвращаемое ссылочное значение позволяет вернуть вызывающему объекту ссылку на объект вместо значения. После этого вызывающий объект может по необходимости обрабатывать возвращенный объект по значению или по ссылке. Значение, возвращаемое вызывающему объекту при обработке по ссылке, называется ссылочной локальной переменной.

## <a name="what-is-a-reference-return-value"></a>Что представляет собой возвращаемое ссылочное значение?

Большинство разработчиков прекрасно знакомы с передачей аргумента в вызываемый метод *по ссылке*. Список аргументов вызываемого метода включает значение, переданное по ссылке. Таким образом, любые изменения этого значения в вызываемом методе будут возвращаться вызывающему объекту. *Возвращаемое ссылочное значение* определяется с точностью до наоборот:

- По ссылке передается возвращаемое значение вызываемого метода, а не переданный в него аргумент.

- Значение, возвращаемое вызываемым методом, может изменяться не этим методом, а вызывающим объектом.

- Таким образом, вместо отражения изменений аргумента в состоянии объекта на вызывающей стороне изменения возвращаемого методом значения, выполненные вызывающим объектом, отражаются в состоянии объекта, метод которого был вызван.

Применение возвращаемых ссылочных значений позволяет сократить размер кода. Кроме того, в этом случае объект предоставляет доступ только к отдельным элементам данных (например, элементам массива), которые запрашиваются вызывающим объектом. Благодаря этому снижается вероятность того, что состояние объекта будет случайно изменено вызывающей стороной.

В отношении возвращаемых методом ссылочных значений действуют определенные ограничения. К ним относятся следующие методы.

- Возвращаемое значение не может быть равно `void`. При попытке определить метод с возвращаемым ссылочным значением `void` возникает ошибка компилятора CS1547 "Использование ключевого слова void в этом контексте недопустимо".
 
- Возвращаемое значение не может быть локальной переменной метода, который возвращает его. Область действия такого значения должна находиться за пределами возвращающего его метода. Это может быть экземпляр статического поля или класса, а также переданный в метод аргумент. При попытке возвратить локальную переменную возникает ошибка компилятора CS8168 "Невозможно вернуть по ссылке локальный "obj", так как это не локальная переменная ref".

- Возвращаемое значение не может быть равно `null`. При попытке возвратить `null` возникает ошибка компилятора CS8156 "Выражение невозможно использовать в данном контексте, так как его невозможно вернуть по ссылке".

   Если методу с возвращаемым ссылочным значением необходимо вернуть значение null, следует вернуть значение null (без экземпляров) для ссылочного типа или [тип, допускающий значение null](../nullable-types/index.md), для типа значения.
 
- Возвращаемое значение не может быть константой, элементом перечисления, а также свойством `class` или `struct`. При попытке возвратить такие значения возникает ошибка компилятора CS8156 "Выражение невозможно использовать в данном контексте, так как его невозможно вернуть по ссылке".

Кроме того, так как асинхронный метод может вернуть значение до того, как будет завершено его выполнение и станет известно его возвращаемое значение, использовать возвращаемые ссылочные значения в асинхронных методах невозможно.
 
## <a name="defining-a-ref-return-value"></a>Определение возвращаемого ссылочного значения

Чтобы определить возвращаемое ссылочное значение, необходимо добавить ключевое слово [ref](../../language-reference/keywords/ref.md) к типу возвращаемого значения в сигнатуре метода. Например, следующая сигнатура указывает, что свойство `GetContactInformation` возвращает вызывающему объекту ссылку на объект `Person`:

```csharp
public ref Person GetContactInformation(string fname, string lname);
```

Кроме того, имени объекта, возвращаемого каждой инструкцией [return](../../language-reference/keywords/return.md) в теле метода, должно предшествовать ключевое слово [ref](../../language-reference/keywords/ref.md). Например, следующая инструкция `return` возвращает объект `Person` с именем `p` по ссылке:

```csharp
return ref p;
```

## <a name="consuming-a-ref-return-value"></a>Использование возвращаемого ссылочного значения

Вызывающий объект может обрабатывать возвращаемое ссылочное значение одним из двух способов:

- Как обычное возвращаемое методом значение. Вызывающий объект может игнорировать тот факт, что это возвращаемое ссылочное значение. В этом случае любые изменения значения, возвращаемого в результате вызова метода, не отражаются в состоянии вызываемого типа. Если возвращаемое значение имеет тип значения, любые изменения значения, возвращаемого в результате вызова метода, не отражаются в состоянии вызываемого типа.

- Как возвращаемое ссылочное значение. Вызывающий объект должен определить переменную, которой будет присваиваться возвращаемое ссылочное значение, как [ссылочную локальную переменную](#ref-local). В этом случае любые изменения значения, возвращаемого в результате вызова метода, будут отражаться в состоянии вызываемого типа. 

## <a name="ref-locals"></a>Ссылочные локальные переменные

Чтобы обрабатывать возвращаемое ссылочное значение как ссылку, вызывающий объект должен объявить значение как *ссылочную локальную переменную* с помощью ключевого слова `ref`. Например, если возвращаемое методом `Person.GetContactInfomation` значение будет использоваться в виде ссылки, а не значения, вызов метода должен выглядеть следующим образом:

```csharp
ref Person p = ref contacts.GetContactInformation("Brandie", "Best");
```

Обратите внимание, что ключевое слово `ref` используется перед объявлением локальной переменной *и* до вызова метода. Если ключевые слова `ref` не указаны одновременно в объявлении и присвоении переменной, возникает ошибка компилятора CS8172 "Невозможно инициализировать значением переменную по ссылке". 
 
Последующие изменения объекта `Person`, возвращаемого методом, будут отражаться в объекте `contacts`.

Если `p` не объявлено как локальная ссылочная переменная с помощью ключевого слова `ref`, любые изменения `p`, выполненные вызывающим объектом, не будут отражаться в объекте `contacts`.
 
## <a name="ref-returns-and-ref-locals-an-example"></a>Пример использования возвращаемых ссылочных значений и ссылочных локальных переменных

В следующем примере определяется класс `NumberStore`, в котором хранится массив целочисленных значений. Метод `FindNumber` возвращает по ссылке первое число, которое не меньше переданного в аргументе значения. Если такое число не найдено, метод возвращает число с индексом 0. 

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#1)]

В следующем примере вызывается метод `NumberStore.FindNumber`, который извлекает первое значение не меньше 16. После этого вызывающий объект удваивает значение, возвращаемое методом. Как видно из выходных данных этого примера, изменение отражается в значении элементов массива в экземпляре `NumberStore`.

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#2)]

Без использования возвращаемых ссылочных значений такая операция обычно выполняется путем возврата индекса элемента массива вместе с его значением. После этого вызывающий объект использует индекс для изменения значения в отдельном вызове метода. Тем не менее вызывающий объект также может изменить индекс для доступа к другим значениям массива и их изменения.  
 
## <a name="see-also"></a>См. также

[Ключевое слово ref](../../language-reference/keywords/ref.md)
