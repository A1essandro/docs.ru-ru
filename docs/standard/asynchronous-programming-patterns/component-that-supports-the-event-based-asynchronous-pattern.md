---
title: "Пошаговое руководство. Реализация компонента, поддерживающего асинхронную модель, основанную на событиях"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Event-based Asynchronous Pattern
- ProgressChangedEventArgs class
- BackgroundWorker component
- events [.NET Framework], asynchronous
- Asynchronous Pattern
- AsyncOperationManager class
- threading [.NET Framework], asynchronous features
- components [.NET Framework], asynchronous
- AsyncOperation class
- threading [Windows Forms], asynchronous features
- AsyncCompletedEventArgs class
ms.assetid: 61f676b5-936f-40f6-83ce-f22805ec9c2f
caps.latest.revision: "21"
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.openlocfilehash: 150e4b27cc149774895574ddd196de5f9bc2acd8
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2017
---
# <a name="walkthrough-implementing-a-component-that-supports-the-event-based-asynchronous-pattern"></a><span data-ttu-id="b29d7-102">Пошаговое руководство. Реализация компонента, поддерживающего асинхронную модель, основанную на событиях</span><span class="sxs-lookup"><span data-stu-id="b29d7-102">Walkthrough: Implementing a Component That Supports the Event-based Asynchronous Pattern</span></span>
<span data-ttu-id="b29d7-103">При создании класса с некоторыми операциями, которые могут привести к значительным задержкам, рассмотрите возможность предоставления асинхронных функциональных возможностей посредством реализации [Обзор асинхронной модели на основе событий](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span><span class="sxs-lookup"><span data-stu-id="b29d7-103">If you are writing a class with some operations that may incur noticeable delays, consider giving it asynchronous functionality by implementing the [Event-based Asynchronous Pattern Overview](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md).</span></span>  
  
 <span data-ttu-id="b29d7-104">В этом пошаговом руководстве показано, как создать компонент, реализующий асинхронную модель на основе событий.</span><span class="sxs-lookup"><span data-stu-id="b29d7-104">This walkthrough illustrates how to create a component that implements the Event-based Asynchronous Pattern.</span></span> <span data-ttu-id="b29d7-105">Он реализуется с помощью вспомогательных классов из <xref:System.ComponentModel?displayProperty=nameWithType> пространства имен, которое гарантирует правильность работы компонента в любой модели приложения, включая [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)], консольные приложения и приложения Windows Forms.</span><span class="sxs-lookup"><span data-stu-id="b29d7-105">It is implemented using helper classes from the <xref:System.ComponentModel?displayProperty=nameWithType> namespace, which ensures that the component works correctly under any application model, including [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)], Console applications and Windows Forms applications.</span></span> <span data-ttu-id="b29d7-106">Этот компонент также может быть разработан с <xref:System.Windows.Forms.PropertyGrid> управления и пользовательские конструкторы.</span><span class="sxs-lookup"><span data-stu-id="b29d7-106">This component is also designable with a <xref:System.Windows.Forms.PropertyGrid> control and your own custom designers.</span></span>  
  
 <span data-ttu-id="b29d7-107">После завершения работы, имеется приложение, вычисляющее простые числа в асинхронном режиме.</span><span class="sxs-lookup"><span data-stu-id="b29d7-107">When you are through, you will have an application that computes prime numbers asynchronously.</span></span> <span data-ttu-id="b29d7-108">Ваше приложение получит главной пользовательского потока пользовательского интерфейса и поток для каждого вычисления простого числа.</span><span class="sxs-lookup"><span data-stu-id="b29d7-108">Your application will have a main user interface (UI) thread and a thread for each prime number calculation.</span></span> <span data-ttu-id="b29d7-109">Несмотря на то, что тестирования, является ли большое число простым, занимает длительное время, основной поток пользовательского интерфейса не будет прерван, задержка и форма будет отвечать на запросы во время вычисления.</span><span class="sxs-lookup"><span data-stu-id="b29d7-109">Although testing whether a large number is prime can take a noticeable amount of time, the main UI thread will not be interrupted by this delay, and the form will be responsive during the calculations.</span></span> <span data-ttu-id="b29d7-110">Можно работать, как много вычислений, сколько пожелаете одновременно или выборочно отмену ожидающего выполнения вычисления.</span><span class="sxs-lookup"><span data-stu-id="b29d7-110">You will be able to run as many calculations as you like concurrently and selectively cancel pending calculations.</span></span>  
  
 <span data-ttu-id="b29d7-111">В данном пошаговом руководстве представлены следующие задачи.</span><span class="sxs-lookup"><span data-stu-id="b29d7-111">Tasks illustrated in this walkthrough include:</span></span>  
  
-   <span data-ttu-id="b29d7-112">Создание компонента</span><span class="sxs-lookup"><span data-stu-id="b29d7-112">Creating the Component</span></span>  
  
-   <span data-ttu-id="b29d7-113">Определение открытых асинхронных событий и делегатов</span><span class="sxs-lookup"><span data-stu-id="b29d7-113">Defining Public Asynchronous Events and Delegates</span></span>  
  
-   <span data-ttu-id="b29d7-114">Определение закрытых делегатов</span><span class="sxs-lookup"><span data-stu-id="b29d7-114">Defining Private Delegates</span></span>  
  
-   <span data-ttu-id="b29d7-115">Реализация открытых событий</span><span class="sxs-lookup"><span data-stu-id="b29d7-115">Implementing Public Events</span></span>  
  
-   <span data-ttu-id="b29d7-116">Реализация метода завершения</span><span class="sxs-lookup"><span data-stu-id="b29d7-116">Implementing the Completion Method</span></span>  
  
-   <span data-ttu-id="b29d7-117">Реализация рабочих методов</span><span class="sxs-lookup"><span data-stu-id="b29d7-117">Implementing the Worker Methods</span></span>  
  
-   <span data-ttu-id="b29d7-118">Реализация методов запуска и отмены</span><span class="sxs-lookup"><span data-stu-id="b29d7-118">Implementing Start and Cancel Methods</span></span>  
  
 <span data-ttu-id="b29d7-119">Скопируйте код из этой темы, в разделе [как: реализация компонента, поддерживающего асинхронную модель, основанную на событиях](../../../docs/standard/asynchronous-programming-patterns/component-that-supports-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="b29d7-119">To copy the code in this topic as a single listing, see [How to: Implement a Component That Supports the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/component-that-supports-the-event-based-asynchronous-pattern.md).</span></span>  
  
## <a name="creating-the-component"></a><span data-ttu-id="b29d7-120">Создание компонента</span><span class="sxs-lookup"><span data-stu-id="b29d7-120">Creating the Component</span></span>  
 <span data-ttu-id="b29d7-121">Первым шагом является создание компонента, который будет реализовать асинхронную модель на основе событий.</span><span class="sxs-lookup"><span data-stu-id="b29d7-121">The first step is to create the component that will implement the Event-based Asynchronous Pattern.</span></span>  
  
#### <a name="to-create-the-component"></a><span data-ttu-id="b29d7-122">Создание компонента</span><span class="sxs-lookup"><span data-stu-id="b29d7-122">To create the component</span></span>  
  
-   <span data-ttu-id="b29d7-123">Создайте класс с именем `PrimeNumberCalculator` , наследуемый от <xref:System.ComponentModel.Component>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-123">Create a class called `PrimeNumberCalculator` that inherits from <xref:System.ComponentModel.Component>.</span></span>  
  
## <a name="defining-public-asynchronous-events-and-delegates"></a><span data-ttu-id="b29d7-124">Определение открытых асинхронных событий и делегатов</span><span class="sxs-lookup"><span data-stu-id="b29d7-124">Defining Public Asynchronous Events and Delegates</span></span>  
 <span data-ttu-id="b29d7-125">Компонент взаимодействует с клиентами с помощью событий.</span><span class="sxs-lookup"><span data-stu-id="b29d7-125">Your component communicates to clients using events.</span></span> <span data-ttu-id="b29d7-126">*Имя_метода* `Completed` событие предупреждения клиентов до завершения асинхронной задачи и *имя_метода* `ProgressChanged` событие информирует клиентов о ходе выполнения асинхронной задачи.</span><span class="sxs-lookup"><span data-stu-id="b29d7-126">The *MethodName*`Completed` event alerts clients to the completion of an asynchronous task, and the *MethodName*`ProgressChanged` event informs clients of the progress of an asynchronous task.</span></span>  
  
#### <a name="to-define-asynchronous-events-for-clients-of-your-component"></a><span data-ttu-id="b29d7-127">Чтобы определить асинхронные события для клиентов пользовательского компонента:</span><span class="sxs-lookup"><span data-stu-id="b29d7-127">To define asynchronous events for clients of your component:</span></span>  
  
1.  <span data-ttu-id="b29d7-128">Импорт <xref:System.Threading?displayProperty=nameWithType> и <xref:System.Collections.Specialized?displayProperty=nameWithType> пространства имен в верхней части файла.</span><span class="sxs-lookup"><span data-stu-id="b29d7-128">Import the <xref:System.Threading?displayProperty=nameWithType> and <xref:System.Collections.Specialized?displayProperty=nameWithType> namespaces at the top of your file.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#11](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#11)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#11](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#11)]  
  
2.  <span data-ttu-id="b29d7-129">Прежде чем `PrimeNumberCalculator` определение класса объявить делегаты для событий выполнения и завершения.</span><span class="sxs-lookup"><span data-stu-id="b29d7-129">Before the `PrimeNumberCalculator` class definition, declare delegates for progress and completion events.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#7](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#7)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#7](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#7)]  
  
3.  <span data-ttu-id="b29d7-130">В `PrimeNumberCalculator` определения класса, объявите событие для отображения хода выполнения и завершения клиентам.</span><span class="sxs-lookup"><span data-stu-id="b29d7-130">In the `PrimeNumberCalculator` class definition, declare events for reporting progress and completion to clients.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#8](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#8)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#8](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#8)]  
  
4.  <span data-ttu-id="b29d7-131">После `PrimeNumberCalculator` определения класса, следует наследовать `CalculatePrimeCompletedEventArgs` класса для каждого вычисления для обработчика событий клиента для составления `CalculatePrimeCompleted`вычислению.</span><span class="sxs-lookup"><span data-stu-id="b29d7-131">After the `PrimeNumberCalculator` class definition, derive the `CalculatePrimeCompletedEventArgs` class for reporting the outcome of each calculation to the client's event handler for the `CalculatePrimeCompleted`.event.</span></span> <span data-ttu-id="b29d7-132">В дополнение к `AsyncCompletedEventArgs` свойства, этот класс позволяет клиенту определить, какое число было проверено, будь то основной и первый делитель, к которым — если он не является простым.</span><span class="sxs-lookup"><span data-stu-id="b29d7-132">In addition to the `AsyncCompletedEventArgs` properties, this class enables the client to determine what number was tested, whether it is prime, and what the first divisor is if it is not prime.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#6](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#6)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#6](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#6)]  
  
## <a name="checkpoint"></a><span data-ttu-id="b29d7-133">Контрольная точка</span><span class="sxs-lookup"><span data-stu-id="b29d7-133">Checkpoint</span></span>  
 <span data-ttu-id="b29d7-134">На этом этапе можно создать компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-134">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="b29d7-135">Чтобы проверить компонент</span><span class="sxs-lookup"><span data-stu-id="b29d7-135">To test your component</span></span>  
  
-   <span data-ttu-id="b29d7-136">Скомпилируйте компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-136">Compile the component.</span></span>  
  
     <span data-ttu-id="b29d7-137">Будут отображены два предупреждения компилятора:</span><span class="sxs-lookup"><span data-stu-id="b29d7-137">You will receive two compiler warnings:</span></span>  
  
    ```  
    warning CS0067: The event 'AsynchronousPatternExample.PrimeNumberCalculator.ProgressChanged' is never used  
    warning CS0067: The event 'AsynchronousPatternExample.PrimeNumberCalculator.CalculatePrimeCompleted' is never used  
    ```  
  
     <span data-ttu-id="b29d7-138">Эти предупреждения будут очищены в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="b29d7-138">These warnings will be cleared in the next section.</span></span>  
  
## <a name="defining-private-delegates"></a><span data-ttu-id="b29d7-139">Определение закрытых делегатов</span><span class="sxs-lookup"><span data-stu-id="b29d7-139">Defining Private Delegates</span></span>  
 <span data-ttu-id="b29d7-140">Асинхронные аспекты `PrimeNumberCalculator` компонент реализованы внутренне со специальным делегатом, который называется <xref:System.Threading.SendOrPostCallback>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-140">The asynchronous aspects of the `PrimeNumberCalculator` component are implemented internally with a special delegate known as a <xref:System.Threading.SendOrPostCallback>.</span></span> <span data-ttu-id="b29d7-141">Объект <xref:System.Threading.SendOrPostCallback> представляет метод обратного вызова, который выполняется на <xref:System.Threading.ThreadPool> потока.</span><span class="sxs-lookup"><span data-stu-id="b29d7-141">A <xref:System.Threading.SendOrPostCallback> represents a callback method that executes on a <xref:System.Threading.ThreadPool> thread.</span></span> <span data-ttu-id="b29d7-142">Метод обратного вызова должен иметь сигнатуру, которая принимает один параметр типа <xref:System.Object>, а значит, вам потребуется для передачи состояния вместе с делегатами в классе-оболочке.</span><span class="sxs-lookup"><span data-stu-id="b29d7-142">The callback method must have a signature that takes a single parameter of type <xref:System.Object>, which means you will need to pass state among delegates in a wrapper class.</span></span> <span data-ttu-id="b29d7-143">Для получения дополнительной информации см. <xref:System.Threading.SendOrPostCallback>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-143">For more information, see <xref:System.Threading.SendOrPostCallback>.</span></span>  
  
#### <a name="to-implement-your-components-internal-asynchronous-behavior"></a><span data-ttu-id="b29d7-144">Чтобы реализовать внутреннее асинхронное поведение компонента:</span><span class="sxs-lookup"><span data-stu-id="b29d7-144">To implement your component's internal asynchronous behavior:</span></span>  
  
1.  <span data-ttu-id="b29d7-145">Объявите и создайте <xref:System.Threading.SendOrPostCallback> делегирует в `PrimeNumberCalculator` класса.</span><span class="sxs-lookup"><span data-stu-id="b29d7-145">Declare and create the <xref:System.Threading.SendOrPostCallback> delegates in the `PrimeNumberCalculator` class.</span></span> <span data-ttu-id="b29d7-146">Создание <xref:System.Threading.SendOrPostCallback> объектов в вспомогательный метод вызывается `InitializeDelegates`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-146">Create the <xref:System.Threading.SendOrPostCallback> objects in a utility method called `InitializeDelegates`.</span></span>  
  
     <span data-ttu-id="b29d7-147">Вам потребуется два делегата: один для информирования о ходе выполнения для клиента и один для создания отчетов о завершении клиента.</span><span class="sxs-lookup"><span data-stu-id="b29d7-147">You will need two delegates: one for reporting progress to the client, and one for reporting completion to the client.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#9](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#9)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#9](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#9)]  
    [!code-csharp[System.ComponentModel.AsyncOperationManager#20](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#20)]
    [!code-vb[System.ComponentModel.AsyncOperationManager#20](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#20)]  
  
2.  <span data-ttu-id="b29d7-148">Вызовите `InitializeDelegates` метод в конструкторе компонента.</span><span class="sxs-lookup"><span data-stu-id="b29d7-148">Call the `InitializeDelegates` method in your component's constructor.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#21](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#21)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#21](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#21)]  
  
3.  <span data-ttu-id="b29d7-149">Объявление делегата в `PrimeNumberCalculator` класс, который обрабатывает ту работу, которая должна быть выполнена асинхронно.</span><span class="sxs-lookup"><span data-stu-id="b29d7-149">Declare a delegate in the `PrimeNumberCalculator` class that handles the actual work to be done asynchronously.</span></span> <span data-ttu-id="b29d7-150">Этот делегат оборачивает рабочий метод, который проверяет, является ли число простым.</span><span class="sxs-lookup"><span data-stu-id="b29d7-150">This delegate wraps the worker method that tests whether a number is prime.</span></span> <span data-ttu-id="b29d7-151">Этот делегат принимает <xref:System.ComponentModel.AsyncOperation> параметр, который будет использоваться для отслеживания времени существования асинхронной операции.</span><span class="sxs-lookup"><span data-stu-id="b29d7-151">The delegate takes an <xref:System.ComponentModel.AsyncOperation> parameter, which will be used to track the lifetime of the asynchronous operation.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#22](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#22)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#22](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#22)]  
  
4.  <span data-ttu-id="b29d7-152">Создайте коллекцию для управления временем жизни ожидающих асинхронных операций.</span><span class="sxs-lookup"><span data-stu-id="b29d7-152">Create a collection for managing lifetimes of pending asynchronous operations.</span></span> <span data-ttu-id="b29d7-153">Клиент должен способ отслеживания операций, как выполняются и завершения, и этот отслеживания можно сделать, требуя от клиента для передачи уникального токена или идентификатор задачи, если клиент осуществляет вызов асинхронного метода.</span><span class="sxs-lookup"><span data-stu-id="b29d7-153">The client needs a way to track operations as they are executed and completed, and this tracking is done by requiring the client to pass a unique token, or task ID, when the client makes the call to the asynchronous method.</span></span> <span data-ttu-id="b29d7-154">`PrimeNumberCalculator` Компонент должен хранить список каждый вызов путем сопоставления идентификатора задачи с соответствующим вызовом.</span><span class="sxs-lookup"><span data-stu-id="b29d7-154">The `PrimeNumberCalculator` component must keep track of each call by associating the task ID with its corresponding invocation.</span></span> <span data-ttu-id="b29d7-155">Если клиент передает идентификатор задачи, который не является уникальным, `PrimeNumberCalculator` компонент должен создать исключение.</span><span class="sxs-lookup"><span data-stu-id="b29d7-155">If the client passes a task ID that is not unique, the `PrimeNumberCalculator` component must raise an exception.</span></span>  
  
     <span data-ttu-id="b29d7-156">`PrimeNumberCalculator` Компонент сохраняет отслеживайте от идентификатор задачи, используя класс специальная коллекция с именем <xref:System.Collections.Specialized.HybridDictionary>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-156">The `PrimeNumberCalculator` component keeps track of task ID by using a special collection class called a <xref:System.Collections.Specialized.HybridDictionary>.</span></span> <span data-ttu-id="b29d7-157">В определении класса создайте <xref:System.Collections.Specialized.HybridDictionary> вызывается `userTokenToLifetime`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-157">In the class definition, create a <xref:System.Collections.Specialized.HybridDictionary> called `userTokenToLifetime`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#23](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#23)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#23](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#23)]  
  
## <a name="implementing-public-events"></a><span data-ttu-id="b29d7-158">Реализация открытых событий</span><span class="sxs-lookup"><span data-stu-id="b29d7-158">Implementing Public Events</span></span>  
 <span data-ttu-id="b29d7-159">Компоненты, реализующие асинхронную модель на основе событий взаимодействия с клиентами с помощью событий.</span><span class="sxs-lookup"><span data-stu-id="b29d7-159">Components that implement the Event-based Asynchronous Pattern communicate to clients using events.</span></span> <span data-ttu-id="b29d7-160">Эти события вызываются в соответствующем потоке с помощью <xref:System.ComponentModel.AsyncOperation> класса.</span><span class="sxs-lookup"><span data-stu-id="b29d7-160">These events are invoked on the proper thread with the help of the <xref:System.ComponentModel.AsyncOperation> class.</span></span>  
  
#### <a name="to-raise-events-to-your-components-clients"></a><span data-ttu-id="b29d7-161">Чтобы создать события в клиентах компонента:</span><span class="sxs-lookup"><span data-stu-id="b29d7-161">To raise events to your component's clients:</span></span>  
  
1.  <span data-ttu-id="b29d7-162">Реализуйте открытые события, для создания отчетов для клиентов.</span><span class="sxs-lookup"><span data-stu-id="b29d7-162">Implement public events for reporting to clients.</span></span> <span data-ttu-id="b29d7-163">Событие потребуется для отображения хода выполнения и одно для оповещения о завершении.</span><span class="sxs-lookup"><span data-stu-id="b29d7-163">You will need an event for reporting progress and one for reporting completion.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#24](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#24)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#24](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#24)]  
  
## <a name="implementing-the-completion-method"></a><span data-ttu-id="b29d7-164">Реализация метода завершения</span><span class="sxs-lookup"><span data-stu-id="b29d7-164">Implementing the Completion Method</span></span>  
 <span data-ttu-id="b29d7-165">Делегат завершения — метод, который будет вызывать базовый, свободнопоточный асинхронного поведения при завершении асинхронной операции при успешном завершении, ошибке или отмены.</span><span class="sxs-lookup"><span data-stu-id="b29d7-165">The completion delegate is the method that the underlying, free-threaded asynchronous behavior will invoke when the asynchronous operation ends by successful completion, error, or cancellation.</span></span> <span data-ttu-id="b29d7-166">Этот вызов происходит в произвольном потоке.</span><span class="sxs-lookup"><span data-stu-id="b29d7-166">This invocation happens on an arbitrary thread.</span></span>  
  
 <span data-ttu-id="b29d7-167">Этот метод является, где идентификатор задачи клиента удаляется из внутренней коллекции уникальных маркеров клиента.</span><span class="sxs-lookup"><span data-stu-id="b29d7-167">This method is where the client's task ID is removed from the internal collection of unique client tokens.</span></span> <span data-ttu-id="b29d7-168">Этот метод также завершает время существования конкретную асинхронную операцию, вызвав <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> метод соответствующего <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-168">This method also ends the lifetime of a particular asynchronous operation by calling the <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> method on the corresponding <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="b29d7-169">Этот вызов событие завершения в потоке, который подходит для модели приложения.</span><span class="sxs-lookup"><span data-stu-id="b29d7-169">This call raises the completion event on the thread that is appropriate for the application model.</span></span> <span data-ttu-id="b29d7-170">После <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> вызова этого экземпляра <xref:System.ComponentModel.AsyncOperation> больше не используется, и все последующие попытки использовать его будет создано исключение.</span><span class="sxs-lookup"><span data-stu-id="b29d7-170">After the <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> method is called, this instance of <xref:System.ComponentModel.AsyncOperation> can no longer be used, and any subsequent attempts to use it will throw an exception.</span></span>  
  
 <span data-ttu-id="b29d7-171">`CompletionMethod` Подписи должны содержаться все состояния, необходимые для описания результата асинхронной операции.</span><span class="sxs-lookup"><span data-stu-id="b29d7-171">The `CompletionMethod` signature must hold all state necessary to describe the outcome of the asynchronous operation.</span></span> <span data-ttu-id="b29d7-172">Она содержит состояние для числа, которое было проверено в этой определенной асинхронной операции, является ли число простым и значение первый делитель Если не простых чисел.</span><span class="sxs-lookup"><span data-stu-id="b29d7-172">It holds state for the number that was tested by this particular asynchronous operation, whether the number is prime, and the value of its first divisor if it is not a prime number.</span></span> <span data-ttu-id="b29d7-173">Она также содержит состояние, которое описывает любое исключение, которое было сформировано, и <xref:System.ComponentModel.AsyncOperation> соответствующий этой конкретной задачей.</span><span class="sxs-lookup"><span data-stu-id="b29d7-173">It also holds state describing any exception that occurred, and the <xref:System.ComponentModel.AsyncOperation> corresponding to this particular task.</span></span>  
  
#### <a name="to-complete-an-asynchronous-operation"></a><span data-ttu-id="b29d7-174">Для завершения асинхронной операции:</span><span class="sxs-lookup"><span data-stu-id="b29d7-174">To complete an asynchronous operation:</span></span>  
  
-   <span data-ttu-id="b29d7-175">Реализуйте метод завершения.</span><span class="sxs-lookup"><span data-stu-id="b29d7-175">Implement the completion method.</span></span> <span data-ttu-id="b29d7-176">Он принимает шесть параметров, которые используются для заполнения `CalculatePrimeCompletedEventArgs` , возвращаемый клиенту с помощью клиента `CalculatePrimeCompletedEventHandler`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-176">It takes six parameters, which it uses to populate a `CalculatePrimeCompletedEventArgs` that is returned to the client through the client's `CalculatePrimeCompletedEventHandler`.</span></span> <span data-ttu-id="b29d7-177">Удаляет маркер идентификатора задачи клиента из внутренней коллекции, после чего завершает время существования асинхронной операции с помощью вызова <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-177">It removes the client's task ID token from the internal collection, and it ends the asynchronous operation's lifetime with a call to <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A>.</span></span> <span data-ttu-id="b29d7-178"><xref:System.ComponentModel.AsyncOperation> Маршалирует вызов в поток или контекст, который подходит для модели приложения.</span><span class="sxs-lookup"><span data-stu-id="b29d7-178">The <xref:System.ComponentModel.AsyncOperation> marshals the call to the thread or context that is appropriate for the application model.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#26](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#26)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#26](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#26)]  
  
## <a name="checkpoint"></a><span data-ttu-id="b29d7-179">Контрольная точка</span><span class="sxs-lookup"><span data-stu-id="b29d7-179">Checkpoint</span></span>  
 <span data-ttu-id="b29d7-180">На этом этапе можно создать компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-180">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="b29d7-181">Чтобы проверить компонент</span><span class="sxs-lookup"><span data-stu-id="b29d7-181">To test your component</span></span>  
  
-   <span data-ttu-id="b29d7-182">Скомпилируйте компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-182">Compile the component.</span></span>  
  
     <span data-ttu-id="b29d7-183">Вы получите предупреждение компилятора:</span><span class="sxs-lookup"><span data-stu-id="b29d7-183">You will receive one compiler warning:</span></span>  
  
    ```  
    warning CS0169: The private field 'AsynchronousPatternExample.PrimeNumberCalculator.workerDelegate' is never used  
    ```  
  
     <span data-ttu-id="b29d7-184">Это предупреждение будет устранена в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="b29d7-184">This warning will be resolved in the next section.</span></span>  
  
## <a name="implementing-the-worker-methods"></a><span data-ttu-id="b29d7-185">Реализация рабочих методов</span><span class="sxs-lookup"><span data-stu-id="b29d7-185">Implementing the Worker Methods</span></span>  
 <span data-ttu-id="b29d7-186">На данный момент реализован асинхронный код поддержки для `PrimeNumberCalculator` компонента.</span><span class="sxs-lookup"><span data-stu-id="b29d7-186">So far, you have implemented the supporting asynchronous code for the `PrimeNumberCalculator` component.</span></span> <span data-ttu-id="b29d7-187">Теперь можно реализовать код, выполняющий работу.</span><span class="sxs-lookup"><span data-stu-id="b29d7-187">Now you can implement the code that does the actual work.</span></span> <span data-ttu-id="b29d7-188">Будет реализовывать три метода: `CalculateWorker`, `BuildPrimeNumberList`, и `IsPrime`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-188">You will implement three methods: `CalculateWorker`, `BuildPrimeNumberList`, and `IsPrime`.</span></span> <span data-ttu-id="b29d7-189">Вместе `BuildPrimeNumberList` и `IsPrime` составляют хорошо известного алгоритма вызывается решета Эратосфена, который определяет, является ли число простым путем нахождения всех простых чисел до квадратного корня из проверяемого числа.</span><span class="sxs-lookup"><span data-stu-id="b29d7-189">Together, `BuildPrimeNumberList` and `IsPrime` comprise a well-known algorithm called the Sieve of Eratosthenes, which determines if a number is prime by finding all the prime numbers up to the square root of the test number.</span></span> <span data-ttu-id="b29d7-190">Если делители не будут найдены, проверяемое число считается простым.</span><span class="sxs-lookup"><span data-stu-id="b29d7-190">If no divisors are found by that point, the test number is prime.</span></span>  
  
 <span data-ttu-id="b29d7-191">Этот компонент были написаны для максимальной эффективности, будет следует помнить простых чисел, обнаруженных при различных вызовах проверки различных чисел.</span><span class="sxs-lookup"><span data-stu-id="b29d7-191">If this component were written for maximum efficiency, it would remember all the prime numbers discovered by various invocations for different test numbers.</span></span> <span data-ttu-id="b29d7-192">Также будут проверены делители как 2, 3 и 5.</span><span class="sxs-lookup"><span data-stu-id="b29d7-192">It would also check for trivial divisors like 2, 3, and 5.</span></span> <span data-ttu-id="b29d7-193">Цель этого примера — продемонстрировать как длительные операции могут выполняться асинхронно, тем не менее, поэтому эти оптимизации остаются в качестве упражнения для вас.</span><span class="sxs-lookup"><span data-stu-id="b29d7-193">The intent of this example is to demonstrate how time-consuming operations can be executed asynchronously, however, so these optimizations are left as an exercise for you.</span></span>  
  
 <span data-ttu-id="b29d7-194">`CalculateWorker` Метод заключается в делегат и вызывается асинхронно с помощью вызова `BeginInvoke`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-194">The `CalculateWorker` method is wrapped in a delegate and is invoked asynchronously with a call to `BeginInvoke`.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="b29d7-195">Отчет о ходе выполнения реализуется в `BuildPrimeNumberList` метод.</span><span class="sxs-lookup"><span data-stu-id="b29d7-195">Progress reporting is implemented in the `BuildPrimeNumberList` method.</span></span> <span data-ttu-id="b29d7-196">На быстрых компьютерах `ProgressChanged` события могут возникать в течение короткого промежутка времени.</span><span class="sxs-lookup"><span data-stu-id="b29d7-196">On fast computers, `ProgressChanged` events can be raised in rapid succession.</span></span> <span data-ttu-id="b29d7-197">Клиентский поток, на котором эти события вызываются, должен иметь возможность обработки этой ситуации.</span><span class="sxs-lookup"><span data-stu-id="b29d7-197">The client thread, on which these events are raised, must be able to handle this situation.</span></span> <span data-ttu-id="b29d7-198">Код пользовательского интерфейса может быть перегружен сообщениями, с может справиться, приведет к зависанию.</span><span class="sxs-lookup"><span data-stu-id="b29d7-198">User interface code may be flooded with messages and unable to keep up, resulting in hanging behavior.</span></span> <span data-ttu-id="b29d7-199">Пример пользовательского интерфейса, обрабатывает такую ситуацию, в разделе [как: реализация клиента асинхронной модели на основе событий](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="b29d7-199">For an example user interface that handles this situation, see [How to: Implement a Client of the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span></span>  
  
#### <a name="to-execute-the-prime-number-calculation-asynchronously"></a><span data-ttu-id="b29d7-200">Чтобы асинхронно выполнить вычисление простого числа:</span><span class="sxs-lookup"><span data-stu-id="b29d7-200">To execute the prime number calculation asynchronously:</span></span>  
  
1.  <span data-ttu-id="b29d7-201">Реализуйте `TaskCanceled` вспомогательный метод.</span><span class="sxs-lookup"><span data-stu-id="b29d7-201">Implement the `TaskCanceled` utility method.</span></span> <span data-ttu-id="b29d7-202">Это проверяет коллекции времени существования задачи для определенного идентификатора задачи и возвращает `true` Если не найден идентификатор задачи.</span><span class="sxs-lookup"><span data-stu-id="b29d7-202">This checks the task lifetime collection for the given task ID, and returns `true` if the task ID is not found.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#32](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#32)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#32](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#32)]  
  
2.  <span data-ttu-id="b29d7-203">Выполните метод `CalculateWorker`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-203">Implement the `CalculateWorker` method.</span></span> <span data-ttu-id="b29d7-204">Он принимает два параметра: число для тестирования и содержится <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-204">It takes two parameters: a number to test, and an <xref:System.ComponentModel.AsyncOperation>.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#27](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#27)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#27](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#27)]  
  
3.  <span data-ttu-id="b29d7-205">Реализуйте расширение `BuildPrimeNumberList`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-205">Implement `BuildPrimeNumberList`.</span></span> <span data-ttu-id="b29d7-206">Он принимает два параметра: число, которое необходимо протестировать и <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-206">It takes two parameters: the number to test, and an <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="b29d7-207">Она использует <xref:System.ComponentModel.AsyncOperation> для отображения хода выполнения и добавочных результатов.</span><span class="sxs-lookup"><span data-stu-id="b29d7-207">It uses the <xref:System.ComponentModel.AsyncOperation> to report progress and incremental results.</span></span> <span data-ttu-id="b29d7-208">Это гарантирует, что обработчики событий клиента вызываются в правильном потоке или контексте для модели приложения.</span><span class="sxs-lookup"><span data-stu-id="b29d7-208">This assures that the client's event handlers are called on the proper thread or context for the application model.</span></span> <span data-ttu-id="b29d7-209">Когда `BuildPrimeNumberList` находит a простых чисел, сообщает это как добавочный результат в обработчик событий клиента для `ProgressChanged` события.</span><span class="sxs-lookup"><span data-stu-id="b29d7-209">When `BuildPrimeNumberList` finds a prime number, it reports this as an incremental result to the client's event handler for the `ProgressChanged` event.</span></span> <span data-ttu-id="b29d7-210">Для этого класса, производного от <xref:System.ComponentModel.ProgressChangedEventArgs>, который называется `CalculatePrimeProgressChangedEventArgs`, где содержится свойство с именем `LatestPrimeNumber`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-210">This requires a class derived from <xref:System.ComponentModel.ProgressChangedEventArgs>, called `CalculatePrimeProgressChangedEventArgs`, which has one added property called `LatestPrimeNumber`.</span></span>  
  
     <span data-ttu-id="b29d7-211">`BuildPrimeNumberList` Также периодически вызывает метод `TaskCanceled` метод и завершает работу, если метод возвращает `true`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-211">The `BuildPrimeNumberList` method also periodically calls the `TaskCanceled` method and exits if the method returns `true`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#5](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#5)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#5](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#5)]  
  
4.  <span data-ttu-id="b29d7-212">Реализуйте расширение `IsPrime`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-212">Implement `IsPrime`.</span></span> <span data-ttu-id="b29d7-213">Он принимает три параметра: список известных простых чисел, проверяемое число и выходной параметр для первого найденного делителя.</span><span class="sxs-lookup"><span data-stu-id="b29d7-213">It takes three parameters: a list of known prime numbers, the number to test, and an output parameter for the first divisor found.</span></span> <span data-ttu-id="b29d7-214">Получает список простых чисел, он определяет, является ли проверяемое число простым.</span><span class="sxs-lookup"><span data-stu-id="b29d7-214">Given the list of prime numbers, it determines if the test number is prime.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#28](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#28)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#28](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#28)]  
  
5.  <span data-ttu-id="b29d7-215">Производные `CalculatePrimeProgressChangedEventArgs` из <xref:System.ComponentModel.ProgressChangedEventArgs>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-215">Derive `CalculatePrimeProgressChangedEventArgs` from <xref:System.ComponentModel.ProgressChangedEventArgs>.</span></span> <span data-ttu-id="b29d7-216">Этот класс необходим для предоставления добавочных результатов для обработчика событий клиента для `ProgressChanged` события.</span><span class="sxs-lookup"><span data-stu-id="b29d7-216">This class is necessary for reporting incremental results to the client's event handler for the `ProgressChanged` event.</span></span> <span data-ttu-id="b29d7-217">Он имеет одно добавленное свойство с именем `LatestPrimeNumber`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-217">It has one added property called `LatestPrimeNumber`.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#29](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#29)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#29](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#29)]  
  
## <a name="checkpoint"></a><span data-ttu-id="b29d7-218">Контрольная точка</span><span class="sxs-lookup"><span data-stu-id="b29d7-218">Checkpoint</span></span>  
 <span data-ttu-id="b29d7-219">На этом этапе можно создать компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-219">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="b29d7-220">Чтобы проверить компонент</span><span class="sxs-lookup"><span data-stu-id="b29d7-220">To test your component</span></span>  
  
-   <span data-ttu-id="b29d7-221">Скомпилируйте компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-221">Compile the component.</span></span>  
  
     <span data-ttu-id="b29d7-222">Все, что осталось создать представляют собой методы для запуска и отмены асинхронных операций, `CalculatePrimeAsync` и `CancelAsync`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-222">All that remains to be written are the methods to start and cancel asynchronous operations, `CalculatePrimeAsync` and `CancelAsync`.</span></span>  
  
## <a name="implementing-the-start-and-cancel-methods"></a><span data-ttu-id="b29d7-223">Реализация методов запуска и отмены</span><span class="sxs-lookup"><span data-stu-id="b29d7-223">Implementing the Start and Cancel Methods</span></span>  
 <span data-ttu-id="b29d7-224">Следует запускать рабочий метод в своем собственном потоке путем вызова `BeginInvoke` на делегат, который инкапсулирует его.</span><span class="sxs-lookup"><span data-stu-id="b29d7-224">You start the worker method on its own thread by calling `BeginInvoke` on the delegate that wraps it.</span></span> <span data-ttu-id="b29d7-225">Для управления временем жизни конкретную асинхронную операцию, вызовите <xref:System.ComponentModel.AsyncOperationManager.CreateOperation%2A> метод <xref:System.ComponentModel.AsyncOperationManager> вспомогательного класса.</span><span class="sxs-lookup"><span data-stu-id="b29d7-225">To manage the lifetime of a particular asynchronous operation, you call the <xref:System.ComponentModel.AsyncOperationManager.CreateOperation%2A> method on the <xref:System.ComponentModel.AsyncOperationManager> helper class.</span></span> <span data-ttu-id="b29d7-226">Возвращает <xref:System.ComponentModel.AsyncOperation>, которая маршалирует вызовы обработчиков событий клиента в подходящий поток или контекст.</span><span class="sxs-lookup"><span data-stu-id="b29d7-226">This returns an <xref:System.ComponentModel.AsyncOperation>, which marshals calls on the client's event handlers to the proper thread or context.</span></span>  
  
 <span data-ttu-id="b29d7-227">Отмена либо операцию в очереди, вызвав <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> для соответствующей <xref:System.ComponentModel.AsyncOperation>.</span><span class="sxs-lookup"><span data-stu-id="b29d7-227">You cancel a particular pending operation by calling <xref:System.ComponentModel.AsyncOperation.PostOperationCompleted%2A> on its corresponding <xref:System.ComponentModel.AsyncOperation>.</span></span> <span data-ttu-id="b29d7-228">Завершен этой операции, а все последующие вызовы к его <xref:System.ComponentModel.AsyncOperation> вызовет исключение.</span><span class="sxs-lookup"><span data-stu-id="b29d7-228">This ends that operation, and any subsequent calls to its <xref:System.ComponentModel.AsyncOperation> will throw an exception.</span></span>  
  
#### <a name="to-implement-start-and-cancel-functionality"></a><span data-ttu-id="b29d7-229">Для начала реализации и Отмена функциональные возможности:</span><span class="sxs-lookup"><span data-stu-id="b29d7-229">To implement Start and Cancel functionality:</span></span>  
  
1.  <span data-ttu-id="b29d7-230">Выполните метод `CalculatePrimeAsync`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-230">Implement the `CalculatePrimeAsync` method.</span></span> <span data-ttu-id="b29d7-231">Убедитесь, что маркер, предоставленный клиентом (идентификатор задачи) является уникальным в рамках все токены, представляющие в данный момент ожидающих задач.</span><span class="sxs-lookup"><span data-stu-id="b29d7-231">Make sure the client-supplied token (task ID) is unique with respect to all the tokens representing currently pending tasks.</span></span> <span data-ttu-id="b29d7-232">Если клиент передает неуникальный маркер `CalculatePrimeAsync` вызывает исключение.</span><span class="sxs-lookup"><span data-stu-id="b29d7-232">If the client passes in a non-unique token, `CalculatePrimeAsync` raises an exception.</span></span> <span data-ttu-id="b29d7-233">В противном случае маркер добавляется в коллекцию Идентификаторов задач.</span><span class="sxs-lookup"><span data-stu-id="b29d7-233">Otherwise, the token is added to the task ID collection.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#3](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#3)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#3](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#3)]  
  
2.  <span data-ttu-id="b29d7-234">Выполните метод `CancelAsync`.</span><span class="sxs-lookup"><span data-stu-id="b29d7-234">Implement the `CancelAsync` method.</span></span> <span data-ttu-id="b29d7-235">Если `taskId` параметр существует в коллекции маркеров, он удаляется.</span><span class="sxs-lookup"><span data-stu-id="b29d7-235">If the `taskId` parameter exists in the token collection, it is removed.</span></span> <span data-ttu-id="b29d7-236">Это предотвращает отмененных задач, которые не начали выполнение.</span><span class="sxs-lookup"><span data-stu-id="b29d7-236">This prevents canceled tasks that have not started from running.</span></span> <span data-ttu-id="b29d7-237">Если задача выполняется, `BuildPrimeNumberList` метод завершает работу, когда обнаруживает, что идентификатор задачи был удален из коллекции жизненных циклов.</span><span class="sxs-lookup"><span data-stu-id="b29d7-237">If the task is running, the `BuildPrimeNumberList` method exits when it detects that the task ID has been removed from the lifetime collection.</span></span>  
  
     [!code-csharp[System.ComponentModel.AsyncOperationManager#4](../../../samples/snippets/csharp/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/CS/primenumbercalculatormain.cs#4)]
     [!code-vb[System.ComponentModel.AsyncOperationManager#4](../../../samples/snippets/visualbasic/VS_Snippets_Winforms/System.ComponentModel.AsyncOperationManager/VB/primenumbercalculatormain.vb#4)]  
  
## <a name="checkpoint"></a><span data-ttu-id="b29d7-238">Контрольная точка</span><span class="sxs-lookup"><span data-stu-id="b29d7-238">Checkpoint</span></span>  
 <span data-ttu-id="b29d7-239">На этом этапе можно создать компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-239">At this point, you can build the component.</span></span>  
  
#### <a name="to-test-your-component"></a><span data-ttu-id="b29d7-240">Чтобы проверить компонент</span><span class="sxs-lookup"><span data-stu-id="b29d7-240">To test your component</span></span>  
  
-   <span data-ttu-id="b29d7-241">Скомпилируйте компонент.</span><span class="sxs-lookup"><span data-stu-id="b29d7-241">Compile the component.</span></span>  
  
 <span data-ttu-id="b29d7-242">`PrimeNumberCalculator` Компонент теперь будет полным и готова к использованию.</span><span class="sxs-lookup"><span data-stu-id="b29d7-242">The `PrimeNumberCalculator` component is now complete and ready to use.</span></span>  
  
 <span data-ttu-id="b29d7-243">Пример клиента, который использует `PrimeNumberCalculator` компонента, в разделе [как: реализация клиента асинхронной модели на основе событий](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span><span class="sxs-lookup"><span data-stu-id="b29d7-243">For an example client that uses the `PrimeNumberCalculator` component, see [How to: Implement a Client of the Event-based Asynchronous Pattern](../../../docs/standard/asynchronous-programming-patterns/how-to-implement-a-client-of-the-event-based-asynchronous-pattern.md).</span></span>  
  
## <a name="next-steps"></a><span data-ttu-id="b29d7-244">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="b29d7-244">Next Steps</span></span>  
 <span data-ttu-id="b29d7-245">В этом примере можно сделать, написав `CalculatePrime`, является синхронным эквивалентом `CalculatePrimeAsync` метод.</span><span class="sxs-lookup"><span data-stu-id="b29d7-245">You can fill out this example by writing `CalculatePrime`, the synchronous equivalent of `CalculatePrimeAsync` method.</span></span> <span data-ttu-id="b29d7-246">Это сделает `PrimeNumberCalculator` компонент полностью совместим с асинхронной моделью, основанной на событиях.</span><span class="sxs-lookup"><span data-stu-id="b29d7-246">This will make the `PrimeNumberCalculator` component fully compliant with the Event-based Asynchronous Pattern.</span></span>  
  
 <span data-ttu-id="b29d7-247">Этот пример можно улучшить посредством сохранения списка всех простых чисел, обнаруженных при различных вызовах проверки различных чисел.</span><span class="sxs-lookup"><span data-stu-id="b29d7-247">You can improve this example by retaining the list of all the prime numbers discovered by various invocations for different test numbers.</span></span> <span data-ttu-id="b29d7-248">При таком подходе каждой задачи преимущества работы, выполненной предыдущих задач.</span><span class="sxs-lookup"><span data-stu-id="b29d7-248">Using this approach, each task will benefit from the work done by previous tasks.</span></span> <span data-ttu-id="b29d7-249">Следует соблюдать осторожность защитить этот список с `lock` регионов, чтобы доступ к списку различными потоками был сериализован.</span><span class="sxs-lookup"><span data-stu-id="b29d7-249">Be careful to protect this list with `lock` regions, so access to the list by different threads is serialized.</span></span>  
  
 <span data-ttu-id="b29d7-250">Этот пример также можно улучшить путем проверки на наличие делители: 2, 3 и 5.</span><span class="sxs-lookup"><span data-stu-id="b29d7-250">You can also improve this example by testing for trivial divisors, like 2, 3, and 5.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b29d7-251">См. также</span><span class="sxs-lookup"><span data-stu-id="b29d7-251">See Also</span></span>  
 [<span data-ttu-id="b29d7-252">Практическое руководство. Фоновое выполнение операции</span><span class="sxs-lookup"><span data-stu-id="b29d7-252">How to: Run an Operation in the Background</span></span>](../../../docs/framework/winforms/controls/how-to-run-an-operation-in-the-background.md)  
 [<span data-ttu-id="b29d7-253">Обзор асинхронной модели, основанной на событиях</span><span class="sxs-lookup"><span data-stu-id="b29d7-253">Event-based Asynchronous Pattern Overview</span></span>](../../../docs/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview.md)  
 [<span data-ttu-id="b29d7-254">НЕ в СБОРКЕ: Многопоточность в Visual Basic</span><span class="sxs-lookup"><span data-stu-id="b29d7-254">NOT IN BUILD: Multithreading in Visual Basic</span></span>](http://msdn.microsoft.com/en-us/c731a50c-09c1-4468-9646-54c86b75d269)  
 [<span data-ttu-id="b29d7-255">Практическое руководство. Реализация компонента, поддерживающего асинхронную модель на основе событий</span><span class="sxs-lookup"><span data-stu-id="b29d7-255">How to: Implement a Component That Supports the Event-based Asynchronous Pattern</span></span>](../../../docs/standard/asynchronous-programming-patterns/component-that-supports-the-event-based-asynchronous-pattern.md)  
 [<span data-ttu-id="b29d7-256">Многопоточное программирование с использованием асинхронной модели на основе событий</span><span class="sxs-lookup"><span data-stu-id="b29d7-256">Multithreaded Programming with the Event-based Asynchronous Pattern</span></span>](../../../docs/standard/asynchronous-programming-patterns/multithreaded-programming-with-the-event-based-asynchronous-pattern.md)
