---
title: Перенос устаревших монолитных приложений .NET Framework в контейнеры Windows
description: Архитектура микрослужб .NET для упакованных в контейнеры приложений .NET | Перенос устаревших монолитных приложений .NET Framework в контейнеры Windows
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.openlocfilehash: a12012f115629a79734c18c3bc75733ae2fc8195
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
ms.locfileid: "33578837"
---
# <a name="migrating-legacy-monolithic-net-framework-applications-to-windows-containers"></a><span data-ttu-id="d7f39-103">Перенос устаревших монолитных приложений .NET Framework в контейнеры Windows</span><span class="sxs-lookup"><span data-stu-id="d7f39-103">Migrating Legacy Monolithic .NET Framework Applications to Windows Containers</span></span>

<span data-ttu-id="d7f39-104">*С помощью контейнеров Windows можно улучшить возможности сред разработки и тестовых сред, а также развертывать приложения на основе устаревших технологий .NET Framework, таких как веб*-*формы. Такое использование контейнеров для устаревших приложений называется сценарием переноса без изменения.*</span><span class="sxs-lookup"><span data-stu-id="d7f39-104">*Windows Containers can be used as a way to improve development and test environments, and to deploy applications that are based on legacy .NET Framework technologies like Web* *Forms. Using containers for legacy applications in this way is referred to as a “lift and shift” scenario.*</span></span>

<span data-ttu-id="d7f39-105">В предыдущих разделах рассматривались преимущества архитектуры микрослужб, которая предусматривает распределение бизнес-приложений между разными контейнерами, в каждом из которых</span><span class="sxs-lookup"><span data-stu-id="d7f39-105">Earlier sections of this guide have championed a microservices architecture where business applications are distributed among different containers, each running a small, focused service.</span></span> <span data-ttu-id="d7f39-106">выполняется небольшая узконаправленная служба.</span><span class="sxs-lookup"><span data-stu-id="d7f39-106">That goal has many benefits.</span></span> <span data-ttu-id="d7f39-107">Такой подход настоятельно рекомендуется при разработке новых приложений.</span><span class="sxs-lookup"><span data-stu-id="d7f39-107">In new development, that approach is strongly recommended.</span></span> <span data-ttu-id="d7f39-108">Преимущества для критически важных корпоративных приложений также достаточно велики, чтобы оправдать затраты на переработку архитектуры и повторное внедрение.</span><span class="sxs-lookup"><span data-stu-id="d7f39-108">Enterprise-critical applications will also benefit enough to justify the cost of a rearchitecture and reimplementation.</span></span>

<span data-ttu-id="d7f39-109">Но эти затраты оправданны не для каждого приложения.</span><span class="sxs-lookup"><span data-stu-id="d7f39-109">But not every application will benefit enough to justify the cost.</span></span> <span data-ttu-id="d7f39-110">Это не означает, что для таких приложений использовать контейнеры невозможно.</span><span class="sxs-lookup"><span data-stu-id="d7f39-110">That does not mean that those applications cannot be used in container scenarios.</span></span>

<span data-ttu-id="d7f39-111">В этом разделе мы рассмотрим приложение для компании eShopOnContainers, показанное на рис. 7-1.</span><span class="sxs-lookup"><span data-stu-id="d7f39-111">In this section, we will explore an application for eShopOnContainers, shown in Figure 7-1.</span></span> <span data-ttu-id="d7f39-112">Оно будет использовать сотрудниками eShopOnContainers enterprise для просмотра и изменения каталога товаров.</span><span class="sxs-lookup"><span data-stu-id="d7f39-112">This application would be used by members of the eShopOnContainers enterprise team to view and edit the product catalog.</span></span>

![](./media/image1.png)

<span data-ttu-id="d7f39-113">**Рис. 7-1**.</span><span class="sxs-lookup"><span data-stu-id="d7f39-113">**Figure 7-1**.</span></span> <span data-ttu-id="d7f39-114">Приложение веб-форм ASP.NET (устаревшая технология) в контейнере Windows</span><span class="sxs-lookup"><span data-stu-id="d7f39-114">ASP.NET Web Forms application (legacy technology) on a Windows Container</span></span>

<span data-ttu-id="d7f39-115">Это приложение веб-форм, которое служит для просмотра и изменения записей каталога.</span><span class="sxs-lookup"><span data-stu-id="d7f39-115">This is a Web Forms application that is used to browse and modify the catalog entries.</span></span> <span data-ttu-id="d7f39-116">Из-за зависимости от веб-форм приложение не будет выполняться в .NET Core, если его не переделать так, чтобы вместо веб-форм использовался шаблон MVC ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="d7f39-116">The Web Forms dependency means this application will not run on .NET Core unless it is rewritten without Web Forms and instead uses ASP.NET Core MVC.</span></span> <span data-ttu-id="d7f39-117">Вы узнаете, как можно запускать подобные приложения в контейнерах без изменения.</span><span class="sxs-lookup"><span data-stu-id="d7f39-117">You will see how you can run applications like these in containers without changes.</span></span> <span data-ttu-id="d7f39-118">Вы также узнаете, как с минимальными изменениями обеспечить работу в гибридном режиме, в котором некоторые функциональные возможности перенесены в отдельную микрослужбу, но большинство оставлены в монолитном приложении.</span><span class="sxs-lookup"><span data-stu-id="d7f39-118">You will also see how you can make minimal changes to work in a hybrid mode where some functionality has been moved into a separate microservice, but most functionality remains in the monolithic application.</span></span>

## <a name="benefits-of-containerizing-a-monolithic-application"></a><span data-ttu-id="d7f39-119">Преимущества помещения монолитного приложения в контейнер</span><span class="sxs-lookup"><span data-stu-id="d7f39-119">Benefits of containerizing a monolithic application</span></span>

<span data-ttu-id="d7f39-120">Приложение Catalog.WebForms доступно в репозитории GitHub eShopOnContainers (<https://github.com/dotnet/eShopOnContainers>).</span><span class="sxs-lookup"><span data-stu-id="d7f39-120">The Catalog.WebForms application is available in the eShopOnContainers GitHub repository (<https://github.com/dotnet/eShopOnContainers>).</span></span> <span data-ttu-id="d7f39-121">Оно представляет собой автономное веб-приложение, обращающееся к хранилищу данных высокой доступности.</span><span class="sxs-lookup"><span data-stu-id="d7f39-121">This application is a standalone web application accessing a high-availability data store.</span></span> <span data-ttu-id="d7f39-122">Даже с учетом этого выполнение приложения в контейнере имеет свои преимущества.</span><span class="sxs-lookup"><span data-stu-id="d7f39-122">Even so, there are advantages to running the application in a container.</span></span> <span data-ttu-id="d7f39-123">Вы создаете образ для приложения.</span><span class="sxs-lookup"><span data-stu-id="d7f39-123">You create an image for the application.</span></span> <span data-ttu-id="d7f39-124">В дальнейшем каждое развертывание будет производиться в одной и той же среде.</span><span class="sxs-lookup"><span data-stu-id="d7f39-124">From that point forward, every deployment runs in the same environment.</span></span> <span data-ttu-id="d7f39-125">Каждый контейнер использует одну и ту же версию ОС, в нем установлены одни и те же версии зависимостей, используется одна и та же платформа, и для сборки применяется один и тот же процесс.</span><span class="sxs-lookup"><span data-stu-id="d7f39-125">Every container uses the same OS version, has the same version of dependencies installed, uses the same framework, and is built using the same process.</span></span> <span data-ttu-id="d7f39-126">Приложение, загруженное в Visual Studio 2017, показано на рис. 7-2.</span><span class="sxs-lookup"><span data-stu-id="d7f39-126">You can see the application loaded in Visual Studio 2017 in Figure 7-2.</span></span>

![](./media/image2.png)

<span data-ttu-id="d7f39-127">**Рис. 7-2**.</span><span class="sxs-lookup"><span data-stu-id="d7f39-127">**Figure 7-2**.</span></span> <span data-ttu-id="d7f39-128">Приложение веб-формы для управления каталогом в Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="d7f39-128">Catalog management Web Forms application in Visual Studio 2017</span></span>

<span data-ttu-id="d7f39-129">Кроме того, все разработчики могут запускать приложение в единообразной среде.</span><span class="sxs-lookup"><span data-stu-id="d7f39-129">In addition, developers can all run the application in this consistent environment.</span></span> <span data-ttu-id="d7f39-130">Проблемы, возникающие в определенных версиях, выявляются на этапе разработки, а не в промежуточной или рабочей среде.</span><span class="sxs-lookup"><span data-stu-id="d7f39-130">Issues that only appear with certain versions will appear immediately for developers rather than surfacing in a staging or production environment.</span></span> <span data-ttu-id="d7f39-131">Когда приложения выполняются в контейнерах, различия между средами разработки, используемыми разными группами разработчиков, не так важны.</span><span class="sxs-lookup"><span data-stu-id="d7f39-131">Differences between the development environments among the development team matter less once applications run in containers.</span></span>

<span data-ttu-id="d7f39-132">Наконец, упакованные в контейнеры приложения имеют более плоскую кривую горизонтального масштабирования.</span><span class="sxs-lookup"><span data-stu-id="d7f39-132">Finally, containerized applications have a flatter scale-out curve.</span></span> <span data-ttu-id="d7f39-133">Вы уже знаете, как можно создавать дополнительные контейнеры с приложениями в виртуальной машине или на физическом компьютере.</span><span class="sxs-lookup"><span data-stu-id="d7f39-133">You have learned how containerized apps enable more containers in a VM or more containers in a physical machine.</span></span> <span data-ttu-id="d7f39-134">Таким образом достигается более высокая плотность размещения и требуется меньше ресурсов.</span><span class="sxs-lookup"><span data-stu-id="d7f39-134">This translates to higher density and fewer required resources.</span></span>

<span data-ttu-id="d7f39-135">По этим причинам рекомендуется запускать уже имеющиеся монолитные приложения в контейнерах Docker с применением переноса без изменения.</span><span class="sxs-lookup"><span data-stu-id="d7f39-135">For all these reasons, consider running legacy monolithic apps in a Docker container using a “lift-and-shift” operation.</span></span> <span data-ttu-id="d7f39-136">Процедура переноса без изменения заключается в следующем: вы *берете* приложение с физического компьютера или из виртуальной машины и *перемещаете* его в контейнер.</span><span class="sxs-lookup"><span data-stu-id="d7f39-136">The phrase “lift and shift” describes the scope of the task: you *lift* the entire application from a physical or virtual machine, and *shift* it into a container.</span></span> <span data-ttu-id="d7f39-137">В идеальной ситуации, чтобы приложение работало в контейнере, в его код не нужно вносить никаких изменений.</span><span class="sxs-lookup"><span data-stu-id="d7f39-137">In ideal situations, you do not need to make any changes to the application code to run it in a container.</span></span>

## <a name="possible-migration-paths"></a><span data-ttu-id="d7f39-138">Возможные способы переноса</span><span class="sxs-lookup"><span data-stu-id="d7f39-138">Possible migration paths</span></span>

<span data-ttu-id="d7f39-139">Так как веб-приложение Catalog.Webforms является монолитным, оно содержит весь код, включая библиотеки доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="d7f39-139">As a monolithic application, the Catalog.Webforms application is one web application containing all the code, including the data access libraries.</span></span> <span data-ttu-id="d7f39-140">База данных размещается на отдельном компьютере с высоким уровнем доступности.</span><span class="sxs-lookup"><span data-stu-id="d7f39-140">The database runs on a separate high-availability machine.</span></span> <span data-ttu-id="d7f39-141">Эта конфигурация моделируется в образце кода с помощью макета службы каталога: для имитации переноса без изменения приложение Catalog.WebForms можно использовать с фиктивными данными.</span><span class="sxs-lookup"><span data-stu-id="d7f39-141">That configuration is simulated in the sample code by using a mock catalog service: you can run the Catalog.WebForms application against that fake data to simulate a pure lift-and-shift scenario.</span></span> <span data-ttu-id="d7f39-142">Этот пример демонстрирует простейший способ переноса, при котором существующие ресурсы переносятся в контейнер без внесения каких-либо изменений в код.</span><span class="sxs-lookup"><span data-stu-id="d7f39-142">This demonstrates the simplest migration path, where you move existing assets to run in a container without any code changes at all.</span></span> <span data-ttu-id="d7f39-143">Такой способ подходит для полнофункциональных приложений, которые отличаются минимальным взаимодействием с функциональными возможностями, переносимыми в микрослужбы.</span><span class="sxs-lookup"><span data-stu-id="d7f39-143">This path is appropriate for applications that are complete and that have minimal interaction with functionality that you are moving to microservices.</span></span>

<span data-ttu-id="d7f39-144">Но веб-сайт eShopOnContainers уже обращается к хранилищу данных с помощью микрослужб в различных целях.</span><span class="sxs-lookup"><span data-stu-id="d7f39-144">However, the eShopOnContainers website is already accessing the data storage using microservices for different scenarios.</span></span> <span data-ttu-id="d7f39-145">Чтобы использовать микрослужбу каталога вместо прямого доступа к хранилищу данных, можно внести небольшие изменения в редактор каталога.</span><span class="sxs-lookup"><span data-stu-id="d7f39-145">Some small additional changes can be made to the catalog editor to leverage the catalog microservice instead of accessing the catalog data storage directly.</span></span>

<span data-ttu-id="d7f39-146">Эти изменения демонстрируют пространство возможностей для ваших собственных приложений.</span><span class="sxs-lookup"><span data-stu-id="d7f39-146">These changes demonstrate the continuum for your own applications.</span></span> <span data-ttu-id="d7f39-147">Вы можете сделать что угодно: перенести приложение в контейнеры без изменений, внести небольшие изменения, позволяющие существующему приложению обращаться к некоторым новым микрослужбам, или полностью переписать приложение, чтобы интегрировать его в новую архитектуру на основе микрослужб.</span><span class="sxs-lookup"><span data-stu-id="d7f39-147">You can do anything from moving an existing application without change into containers, to making small changes that enable existing applications to access some of the new microservices, to completely rewriting an application to fully participate in a new microservice-based architecture.</span></span> <span data-ttu-id="d7f39-148">Правильный подход зависит от стоимости миграции и предоставляемых ею преимуществ.</span><span class="sxs-lookup"><span data-stu-id="d7f39-148">The right path depends on both the cost of the migration and the benefits from any migration.</span></span>

## <a name="application-tour"></a><span data-ttu-id="d7f39-149">Обзор приложения</span><span class="sxs-lookup"><span data-stu-id="d7f39-149">Application tour</span></span>

<span data-ttu-id="d7f39-150">Вы можете загрузить решение Catalog.WebForms и запустить его как автономное приложение.</span><span class="sxs-lookup"><span data-stu-id="d7f39-150">You can load the Catalog.WebForms solution and run the application as a standalone application.</span></span> <span data-ttu-id="d7f39-151">В этой конфигурации приложение возвращает данные не из постоянного хранилища в виде базы данных, а из фиктивной службы.</span><span class="sxs-lookup"><span data-stu-id="d7f39-151">In this configuration, instead of a persistent storage database, the application uses a fake service to return data.</span></span> <span data-ttu-id="d7f39-152">Приложение использует Autofac (<https://autofac.org/>) в качестве контейнера с инверсией управления (IOC).</span><span class="sxs-lookup"><span data-stu-id="d7f39-152">The application uses Autofac (<https://autofac.org/>) as an inversion of control (IOC) container.</span></span> <span data-ttu-id="d7f39-153">С помощью внедрения зависимостей (DI) можно настроить приложение так, чтобы оно использовало фиктивные данные или активную службу данных каталога.</span><span class="sxs-lookup"><span data-stu-id="d7f39-153">Using Dependency Injection (DI), you can configure the application to use the fake data or the live catalog data service.</span></span> <span data-ttu-id="d7f39-154">(Подробнее о внедрении зависимостей мы поговорим позднее.) Код запуска считывает параметр useFake из файлов web.config и настраивает контейнер Autofac для внедрения фиктивной службы данных или активной службы каталога.</span><span class="sxs-lookup"><span data-stu-id="d7f39-154">(We will explain more about DI shortly.) The startup code reads a useFake setting from the web.config files, and configures the Autofac container to inject either the fake data service or the live catalog service.</span></span> <span data-ttu-id="d7f39-155">Если при запуске приложения параметр useFake в файле web.config имеет значение false, в приложении Web Forms отображаются данные каталога.</span><span class="sxs-lookup"><span data-stu-id="d7f39-155">If you run the application with useFake set to false in the web.config file, you see the Web Forms application displaying the catalog data.</span></span>

<span data-ttu-id="d7f39-156">Большинство методов, используемых в этом приложении, должно быть хорошо знакомо тем, кто имеет опыт работы с Web Forms.</span><span class="sxs-lookup"><span data-stu-id="d7f39-156">Most of the techniques used in this application should be very familiar to anyone who has used Web Forms.</span></span> <span data-ttu-id="d7f39-157">Но в микрослужбе каталога представлены два механизма, которые могут оказаться новыми: внедрение зависимостей, которое упоминалось ранее, и работа с асинхронными хранилищами данных в Web Forms.</span><span class="sxs-lookup"><span data-stu-id="d7f39-157">However, the catalog microservice introduces two techniques that might be unfamiliar: Dependency Injection (DI), which was mentioned earlier, and working with asynchronous data stores in Web Forms.</span></span>

<span data-ttu-id="d7f39-158">Внедрение зависимостей преобразует стандартный объектно-ориентированный подход к написанию классов, при котором для классов выделяются все необходимые ресурсы.</span><span class="sxs-lookup"><span data-stu-id="d7f39-158">DI inverts the typical object-oriented strategy of writing classes that allocate all needed resources.</span></span> <span data-ttu-id="d7f39-159">Вместо этого классы запрашивают зависимости из контейнера службы.</span><span class="sxs-lookup"><span data-stu-id="d7f39-159">Instead, classes request their dependencies from a service container.</span></span> <span data-ttu-id="d7f39-160">Преимущество внедрения зависимостей заключается в том, что вы можете заменять внешние службы на заглушки (макеты) для тестирования или в иных целях.</span><span class="sxs-lookup"><span data-stu-id="d7f39-160">The advantage of DI is that you can replace external services with fakes (mocks) to support testing or other environments.</span></span>

<span data-ttu-id="d7f39-161">Контейнер с внедрением зависимостей использует конфигурацию appSettings в файле web.config для определения того, следует ли использовать фиктивные данные каталога или реальные данные из работающей службы.</span><span class="sxs-lookup"><span data-stu-id="d7f39-161">The DI container uses the web.config appSettings configuration to control whether to use the fake catalog data or the live data from the running service.</span></span> <span data-ttu-id="d7f39-162">Приложение регистрирует объект HttpModule, который создает контейнер и регистрирует предварительный обработчик для внедрения зависимостей.</span><span class="sxs-lookup"><span data-stu-id="d7f39-162">The application registers an HttpModule object that builds the container and registers a pre-request handler to inject dependencies.</span></span> <span data-ttu-id="d7f39-163">Код можно просмотреть в файле Modules/AutoFacHttpModule.cs. Выглядит он так.</span><span class="sxs-lookup"><span data-stu-id="d7f39-163">You can see that code in the Modules/AutoFacHttpModule.cs file, which looks like the following example:</span></span>

```cs
private static IContainer CreateContainer()
{
  // Configure AutoFac:
  // Register Containers:

  var settings = WebConfigurationManager.AppSettings;
  var useFake = settings["usefake"];
  bool fake = useFake == "true";
  var builder = new ContainerBuilder();

  if (fake)
  {
    builder.RegisterType<CatalogMockService>()
    .As<ICatalogService>();
  }
  else
  {
    builder.RegisterType<CatalogService>()
    .As<ICatalogService>();
    builder.RegisterType<RequestProvider>()
    .As<IRequestProvider>();
  }

  var container = builder.Build();
  return container;
}

private void InjectDependencies()
{
  if (HttpContext.Current.CurrentHandler is Page page)
  {
    // Get the code-behind class that we may have written
    var pageType = page.GetType().BaseType;

    // Determine if there is a constructor to inject, and grab it
    var ctor = (from c in pageType.GetConstructors()
                where c.GetParameters().Length > 0
                select c).FirstOrDefault();

    if (ctor != null)
    {
      // Resolve the parameters for the constructor
      var args = (from parm in ctor.GetParameters()
                  select Container.Resolve(parm.ParameterType))
                  .ToArray();

      // Execute the constructor method with the arguments resolved
      ctor.Invoke(page, args);
    }

    // Use the Autofac method to inject any
    // properties that can be filled by Autofac
    Container.InjectProperties(page);
  }
}
```

<span data-ttu-id="d7f39-164">Страницы приложения (Default.aspx.cs и EditPage.aspx.cs) определяют конструкторы, принимающие эти зависимости.</span><span class="sxs-lookup"><span data-stu-id="d7f39-164">The application’s pages (Default.aspx.cs and EditPage.aspx.cs) define constructors that take these dependencies.</span></span> <span data-ttu-id="d7f39-165">Обратите внимание на то, что конструктор по умолчанию по-прежнему доступен.</span><span class="sxs-lookup"><span data-stu-id="d7f39-165">Note that the default constructor is still present and accessible.</span></span> <span data-ttu-id="d7f39-166">Инфраструктуре требуется приведенный ниже код.</span><span class="sxs-lookup"><span data-stu-id="d7f39-166">The infrastructure needs the following code.</span></span>

```cs
protected _Default() { }

public _Default(ICatalogService catalog) => this.catalog = catalog;
```

<span data-ttu-id="d7f39-167">Все интерфейсы API представляют собой асинхронные методы.</span><span class="sxs-lookup"><span data-stu-id="d7f39-167">The catalog APIs are all asynchronous methods.</span></span> <span data-ttu-id="d7f39-168">Web Forms теперь поддерживают их для всех элементов управления данными.</span><span class="sxs-lookup"><span data-stu-id="d7f39-168">Web Forms now supports these for all data controls.</span></span> <span data-ttu-id="d7f39-169">Приложение Catalog.WebForms использует привязку модели для страниц списка и редактирования. В элементах управления на этих страницах определены свойства SelectMethod, UpdateMethod, InsertMethod и DeleteMethod, с помощью которых создается задача, возвращающая асинхронные операции.</span><span class="sxs-lookup"><span data-stu-id="d7f39-169">The Catalog.WebForms application uses model binding for the list and edit pages; controls on the pages define SelectMethod, UpdateMethod, InsertMethod, and DeleteMethod properties that specify Task-returning asynchronous operations.</span></span> <span data-ttu-id="d7f39-170">Элементы управления Web Forms могут определять, когда привязанные к ним методы являются асинхронными.</span><span class="sxs-lookup"><span data-stu-id="d7f39-170">Web Forms controls understand when the methods bound to a control are asynchronous.</span></span> <span data-ttu-id="d7f39-171">Единственным ограничением при работе с асинхронными методами выбора является отсутствие поддержки разбивки на страницы.</span><span class="sxs-lookup"><span data-stu-id="d7f39-171">The only restriction you encounter when using asynchronous select methods is that you cannot support paging.</span></span> <span data-ttu-id="d7f39-172">Сигнатура разбивки на страницы требует выходного параметра, но асинхронные методы не могут иметь таких параметров.</span><span class="sxs-lookup"><span data-stu-id="d7f39-172">The paging signature requires an out parameter, and asynchronous methods cannot have out parameters.</span></span> <span data-ttu-id="d7f39-173">Аналогичный подход применяется и на других страницах, которым требуются данные из службы каталога.</span><span class="sxs-lookup"><span data-stu-id="d7f39-173">This same technique is used on other pages that require data from the catalog service.</span></span>

<span data-ttu-id="d7f39-174">В конфигурации по умолчанию для приложения каталога на основе Web Forms используется макет службы catalog.api.</span><span class="sxs-lookup"><span data-stu-id="d7f39-174">The default configuration for the catalog Web Forms application uses a mock implementation of the catalog.api service.</span></span> <span data-ttu-id="d7f39-175">В этом макете используется жестко заданный набор данных, что упрощает ряд задач благодаря устранению зависимости от службы catalog.api в средах разработки.</span><span class="sxs-lookup"><span data-stu-id="d7f39-175">This mock uses a hard-coded dataset for its data, which simplifies some tasks by removing the dependency on the catalog.api service in development environments.</span></span>

## <a name="lifting-and-shifting"></a><span data-ttu-id="d7f39-176">Перенос без изменения</span><span class="sxs-lookup"><span data-stu-id="d7f39-176">Lifting and shifting</span></span>

<span data-ttu-id="d7f39-177">Visual Studio обеспечивает эффективную поддержку упаковки приложений в контейнеры.</span><span class="sxs-lookup"><span data-stu-id="d7f39-177">Visual Studio provides great support for containerizing an application.</span></span> <span data-ttu-id="d7f39-178">Щелкните узел проекта правой кнопкой мыши и выберите пункт **Добавить**, а затем пункт **Поддержка Docker**.</span><span class="sxs-lookup"><span data-stu-id="d7f39-178">You right-click the project node and then select **Add** and **Docker Support**.</span></span> <span data-ttu-id="d7f39-179">Шаблон проекта Docker добавляет в решение новый проект **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="d7f39-179">The Docker project template adds a new project to the solution called **docker-compose**.</span></span> <span data-ttu-id="d7f39-180">Этот проект содержит ресурсы Docker, которые компонуют (или создают) необходимые образы и запускают необходимые контейнеры, как показано на рис. 7-3.</span><span class="sxs-lookup"><span data-stu-id="d7f39-180">The project contains the Docker assets that compose (or build) the images you need, and starts running the necessary containers, as shown in Figure 7-3.</span></span>

<span data-ttu-id="d7f39-181">В простейшем сценарии переноса без изменения приложение представляет собой одиночную службу для приложения Web Forms.</span><span class="sxs-lookup"><span data-stu-id="d7f39-181">In the simplest lift-and-shift scenarios, the application will be the single service that you use for the Web Forms application.</span></span> <span data-ttu-id="d7f39-182">Шаблон также меняет запускаемый проект на **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="d7f39-182">The template also changes your startup project to point to the **docker-compose** project.</span></span> <span data-ttu-id="d7f39-183">Если нажать клавиши CTRL+F5 или F5, теперь создается образ Docker и запускается контейнер Docker.</span><span class="sxs-lookup"><span data-stu-id="d7f39-183">Pressing Ctrl+F5 or F5 now creates the Docker image and launches the Docker container.</span></span>

![](./media/image3.png)

<span data-ttu-id="d7f39-184">**Рис. 7-3**.</span><span class="sxs-lookup"><span data-stu-id="d7f39-184">**Figure 7-3**.</span></span> <span data-ttu-id="d7f39-185">Проект **docker-compose** в решении Web Forms</span><span class="sxs-lookup"><span data-stu-id="d7f39-185">The **docker-compose** project in the Web Forms solution</span></span>

<span data-ttu-id="d7f39-186">Перед запуском решения необходимо убедиться в том, что Docker настроен для использования контейнеров Windows.</span><span class="sxs-lookup"><span data-stu-id="d7f39-186">Before you run the solution, you must make sure that you configure Docker to use Windows Containers.</span></span> <span data-ttu-id="d7f39-187">Для этого щелкните значок Docker на панели задач Windows правой кнопкой мыши и выберите пункт **Switch to Windows Containers** (Переключиться на контейнеры Windows), как показано на рис. 7-4.</span><span class="sxs-lookup"><span data-stu-id="d7f39-187">To do that, you right-click the Docker taskbar icon in Windows and select **Switch to Windows Containers**, as shown in Figure 7-4.</span></span>

![](./media/image4.png)

<span data-ttu-id="d7f39-188">**Рис. 7-4**.</span><span class="sxs-lookup"><span data-stu-id="d7f39-188">**Figure 7-4**.</span></span> <span data-ttu-id="d7f39-189">Переключение на контейнеры Windows с помощью значка Docker на панели задач в Windows</span><span class="sxs-lookup"><span data-stu-id="d7f39-189">Switching to Windows Containers from the Docker taskbar icon in Windows</span></span>

<span data-ttu-id="d7f39-190">Если вместо этого в меню имеется пункт **Switch to Linux containers** (Переключиться на контейнеры Linux), в Docker уже используются контейнеры Windows.</span><span class="sxs-lookup"><span data-stu-id="d7f39-190">If the menu item says **Switch to Linux containers**, you are already running Docker with Windows Containers.</span></span>

<span data-ttu-id="d7f39-191">При запуске решения узел Docker перезапускается.</span><span class="sxs-lookup"><span data-stu-id="d7f39-191">Running the solution restarts the Docker host.</span></span> <span data-ttu-id="d7f39-192">При сборке решения выполняется сборка приложения и образа Docker для проекта Web Forms.</span><span class="sxs-lookup"><span data-stu-id="d7f39-192">When you build, you build the application and the Docker image for the Web Forms project.</span></span> <span data-ttu-id="d7f39-193">В первый раз это занимает немало времени.</span><span class="sxs-lookup"><span data-stu-id="d7f39-193">The first time you do this, it takes considerable time.</span></span> <span data-ttu-id="d7f39-194">Причина в том, что процесс сборки получает базовый образ Windows Server и дополнительный образ для ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d7f39-194">This is because the build process pulls down the base Windows Server image and the additional image for ASP.NET.</span></span> <span data-ttu-id="d7f39-195">Последующие циклы сборки и запуска происходят гораздо быстрее.</span><span class="sxs-lookup"><span data-stu-id="d7f39-195">Subsequent build and run cycles will be much faster.</span></span>

<span data-ttu-id="d7f39-196">Давайте подробнее рассмотрим файлы, добавляемые шаблоном проекта Docker.</span><span class="sxs-lookup"><span data-stu-id="d7f39-196">Let’s take a deeper look at the files added by the Docker project template.</span></span> <span data-ttu-id="d7f39-197">Он автоматически создал несколько файлов.</span><span class="sxs-lookup"><span data-stu-id="d7f39-197">It created several files for you.</span></span> <span data-ttu-id="d7f39-198">Visual Studio использует их для создания образа Docker и запуска контейнера.</span><span class="sxs-lookup"><span data-stu-id="d7f39-198">Visual Studio uses these files to create the Docker image and launch a container.</span></span> <span data-ttu-id="d7f39-199">Эти же файлы можно использовать в интерфейсе командной строки для выполнения команд Docker вручную.</span><span class="sxs-lookup"><span data-stu-id="d7f39-199">You can use the same files from the CLI to run Docker commands manually.</span></span>

<span data-ttu-id="d7f39-200">В приведенном ниже примере файла Dockerfile показаны основные параметры для сборки образа Docker на основе образа Windows ASP.NET, в котором выполняется сайт ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d7f39-200">The following Dockerfile example shows the basic settings for building a Docker image based on the Windows ASP.NET image that runs an ASP.NET site.</span></span>

```
FROM microsoft/aspnet

ARG source

WORKDIR /inetpub/wwwroot

COPY ${source:-obj/Docker/publish} .
```

<span data-ttu-id="d7f39-201">Этот файл Dockerfile очень похож на те, которые создаются для выполнения приложений ASP.NET Core в контейнерах Linux.</span><span class="sxs-lookup"><span data-stu-id="d7f39-201">This Dockerfile will look very similar to those created for running an ASP.NET Core application in Linux containers.</span></span> <span data-ttu-id="d7f39-202">Но есть некоторые существенные отличия.</span><span class="sxs-lookup"><span data-stu-id="d7f39-202">However, there are a few important differences.</span></span> <span data-ttu-id="d7f39-203">Самое важное из них заключается в том, что базовым образом является microsoft/aspnet. Это текущий образ Windows Server, включающий в себя платформу .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="d7f39-203">The most important difference is that the base image is microsoft/aspnet, which is the current Windows Server image that includes the .NET Framework.</span></span> <span data-ttu-id="d7f39-204">Кроме того, из исходного каталога копируются другие каталоги.</span><span class="sxs-lookup"><span data-stu-id="d7f39-204">Other differences are that the directories copied from your source directory are different.</span></span>

<span data-ttu-id="d7f39-205">Остальные файлы в проекте **docker-compose** представляют собой ресурсы Docker, необходимые для сборки и настройки контейнеров.</span><span class="sxs-lookup"><span data-stu-id="d7f39-205">The other files in the **docker-compose** project are the Docker assets needed to build and configure the containers.</span></span> <span data-ttu-id="d7f39-206">Visual Studio помещает различные файлы docker-compose.yml в один узел, чтобы показать, как они используются.</span><span class="sxs-lookup"><span data-stu-id="d7f39-206">Visual Studio puts the various docker-compose.yml files under one node to highlight how they are used.</span></span> <span data-ttu-id="d7f39-207">Основной файл docker-compose содержит директивы, общие для всех конфигураций.</span><span class="sxs-lookup"><span data-stu-id="d7f39-207">The base docker-compose file contains the directives that are common to all configurations.</span></span> <span data-ttu-id="d7f39-208">Файл docker-compose.override.yml содержит переменные среды и связанные с ними переопределения для конфигурации разработки.</span><span class="sxs-lookup"><span data-stu-id="d7f39-208">The docker-compose.override.yml file contains environment variables and related overrides for a developer configuration.</span></span> <span data-ttu-id="d7f39-209">Варианты с расширениями .vs.debug и .vs.release предоставляют параметры среды, которые позволяют Visual Studio подключаться к работающему контейнеру и управлять им.</span><span class="sxs-lookup"><span data-stu-id="d7f39-209">The variants with .vs.debug and .vs.release provide environment settings that enable Visual Studio to attach to and manage the running container.</span></span>

<span data-ttu-id="d7f39-210">Хотя при добавлении поддержки Docker в решение осуществляется интеграция с Visual Studio, вы также можете выполнять сборку и запуск из командной строки с помощью команды docker-compose up, как было показано в предыдущих разделах.</span><span class="sxs-lookup"><span data-stu-id="d7f39-210">While Visual Studio integration is part of adding Docker support to your solution, you can also build and run from the command line, using the docker-compose up command, as you saw in previous sections.</span></span>

## <a name="getting-data-from-the-existing-catalog-net-core-microservice"></a><span data-ttu-id="d7f39-211">Получение данных из существующей микрослужбы каталога .NET Core</span><span class="sxs-lookup"><span data-stu-id="d7f39-211">Getting data from the existing catalog .NET Core microservice</span></span>

<span data-ttu-id="d7f39-212">Приложение Web Forms можно настроить так, чтобы оно получало не фиктивные данные, а данные из микрослужбы каталога eShopOnContainers.</span><span class="sxs-lookup"><span data-stu-id="d7f39-212">You can configure the Web Forms application to use the eShopOnContainers catalog microservice to get data instead of using fake data.</span></span> <span data-ttu-id="d7f39-213">Для этого нужно изменить файл web.config и присвоить параметру useFake значение false.</span><span class="sxs-lookup"><span data-stu-id="d7f39-213">To do this, you edit the web.config file and set the value of the useFake key to false.</span></span> <span data-ttu-id="d7f39-214">Контейнер с внедрением зависимостей будет использовать класс, обращающийся к активной микрослужбе каталога, а не класс, возвращающий жестко заданные данные.</span><span class="sxs-lookup"><span data-stu-id="d7f39-214">The DI container will use the class that accesses the live catalog microservice instead of the class that returns the hard-coded data.</span></span> <span data-ttu-id="d7f39-215">Вносить другие изменения в код не требуется.</span><span class="sxs-lookup"><span data-stu-id="d7f39-215">No other code changes are needed.</span></span>

<span data-ttu-id="d7f39-216">Для обращения к активной службе каталога требуется изменить проект **docker-compose** так, чтобы он выполнял сборку образа службы каталога и запускал контейнер службы каталога.</span><span class="sxs-lookup"><span data-stu-id="d7f39-216">Accessing the live catalog service does mean you need to update the **docker-compose** project to build the catalog service image and launch the catalog service container.</span></span> <span data-ttu-id="d7f39-217">Docker CE для Windows поддерживает как контейнеры Linux, так и контейнеры Windows, но не одновременно.</span><span class="sxs-lookup"><span data-stu-id="d7f39-217">Docker CE for Windows supports both Linux containers and Windows Containers, but not at the same time.</span></span> <span data-ttu-id="d7f39-218">Чтобы запустить микрослужбу каталога, нужно выполнить сборку образа для запуска микрослужбы каталога на основе контейнера Windows.</span><span class="sxs-lookup"><span data-stu-id="d7f39-218">To run the catalog microservice, you need to build an image that runs the catalog microservice on top of a Windows-based container.</span></span> <span data-ttu-id="d7f39-219">При таком подходе для проекта микрослужб требуется файл Dockerfile, отличный от того, который был представлен в предыдущих разделах.</span><span class="sxs-lookup"><span data-stu-id="d7f39-219">This approach requires a different Dockerfile for the microservices project than you have seen in earlier sections.</span></span> <span data-ttu-id="d7f39-220">Файл Dockerfile.windows содержит параметры конфигурации для сборки образа контейнера API каталога, выполняющегося в контейнере Windows, например образа Docker Windows Nano.</span><span class="sxs-lookup"><span data-stu-id="d7f39-220">The Dockerfile.windows file contains the configuration settings to build the catalog API container image so that it runs on a Windows container—for example, to use a Windows Nano Docker image.</span></span>

<span data-ttu-id="d7f39-221">Микрослужба каталога использует базу данных SQL Server.</span><span class="sxs-lookup"><span data-stu-id="d7f39-221">The catalog microservice relies on the SQL Server database.</span></span> <span data-ttu-id="d7f39-222">Поэтому также требуется использовать образ Docker SQL Server на основе Windows.</span><span class="sxs-lookup"><span data-stu-id="d7f39-222">Therefore, you need to use a Windows-based SQL Server Docker image as well.</span></span>

<span data-ttu-id="d7f39-223">После внесения этих изменений проект docker-compose выполняет дополнительные действия при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="d7f39-223">After these changes, the docker-compose project does more to start the application.</span></span> <span data-ttu-id="d7f39-224">Теперь он запускает SQL Server с помощью образа SQL Server на основе Windows.</span><span class="sxs-lookup"><span data-stu-id="d7f39-224">The project now starts the SQL Server using the Windows based SQL Server image.</span></span> <span data-ttu-id="d7f39-225">Он запускает микрослужбу каталога в контейнере Windows.</span><span class="sxs-lookup"><span data-stu-id="d7f39-225">It starts the catalog microservice in a Windows container.</span></span> <span data-ttu-id="d7f39-226">Кроме того, он запускает контейнер редактора каталога Web Forms также в контейнере Windows.</span><span class="sxs-lookup"><span data-stu-id="d7f39-226">And it starts the Web Forms catalog editor container, also in a Windows container.</span></span> <span data-ttu-id="d7f39-227">Если какие-либо из этих образов требуют сборки, они сначала создаются.</span><span class="sxs-lookup"><span data-stu-id="d7f39-227">If any of the images need building, the images are created first.</span></span>

## <a name="development-and-production-environments"></a><span data-ttu-id="d7f39-228">Среда разработки и рабочая среда</span><span class="sxs-lookup"><span data-stu-id="d7f39-228">Development and production environments</span></span>

<span data-ttu-id="d7f39-229">Между конфигурацией для развертывания и рабочей конфигурацией есть ряд отличий.</span><span class="sxs-lookup"><span data-stu-id="d7f39-229">There are a couple of differences between the development configuration and a production configuration.</span></span> <span data-ttu-id="d7f39-230">В среде разработки приложение Web Forms, микрослужба каталога и SQL Server запускаются в контейнерах Windows в одном узле Docker.</span><span class="sxs-lookup"><span data-stu-id="d7f39-230">In the development environment, you run the Web Forms application, the catalog microservice, and SQL Server in Windows Containers, as part of the same Docker host.</span></span> <span data-ttu-id="d7f39-231">В предыдущих разделах упоминались образы SQL Server, развертываемые в том же узле Docker на основе Linux, что и другие службы .NET Core.</span><span class="sxs-lookup"><span data-stu-id="d7f39-231">In earlier sections, we mentioned SQL Server images deployed in the same Docker host as the other .NET Core-based services on a Linux-based Docker host.</span></span> <span data-ttu-id="d7f39-232">Преимущество выполнения нескольких микрослужб в одном узле Docker (или кластере) заключается в том, что уменьшается объем сетевого трафика и взаимодействие между контейнерами происходит с меньшими задержками.</span><span class="sxs-lookup"><span data-stu-id="d7f39-232">The advantage of running the multiple microservices in the same Docker host (or cluster) is that there is less network communication and the communication between containers has lower latency.</span></span>

<span data-ttu-id="d7f39-233">В среде разработки все контейнеры должны выполняться в одной операционной системе.</span><span class="sxs-lookup"><span data-stu-id="d7f39-233">In the development environment, you must run all the containers in the same OS.</span></span> <span data-ttu-id="d7f39-234">Docker CE для Windows не поддерживает одновременное выполнение контейнеров на основе Windows и Linux.</span><span class="sxs-lookup"><span data-stu-id="d7f39-234">Docker CE for Windows does not support running Windows- and Linux-based containers at the same time.</span></span> <span data-ttu-id="d7f39-235">В рабочей среде можно решить, должна ли микрослужба каталога выполняться в контейнере Windows в одном узле (или кластере) Docker вместе с приложением либо приложение Web Forms должно взаимодействовать с экземпляром микрослужбы каталога, выполняющимся в контейнере Linux в другом узле Docker.</span><span class="sxs-lookup"><span data-stu-id="d7f39-235">In production, you can decide if you want to run the catalog microservice in a Windows container in a single Docker host (or cluster), or have the Web Forms application communicate with an instance of the catalog microservice running in a Linux container on a different Docker host.</span></span> <span data-ttu-id="d7f39-236">Зависит это от требований к сетевой задержке.</span><span class="sxs-lookup"><span data-stu-id="d7f39-236">It depends on how you want to optimize for network latency.</span></span> <span data-ttu-id="d7f39-237">В большинстве случаев микрослужбы, от которых зависит приложение, желательно размещать в том же узле (или кластере) Docker, что позволяет упростить развертывание и сократить задержки при обмене данными.</span><span class="sxs-lookup"><span data-stu-id="d7f39-237">In most cases, you want the microservices that your applications depend on running in the same Docker host (or swarm) for ease of deployment and lower communication latency.</span></span> <span data-ttu-id="d7f39-238">В такой конфигурации значительные ресурсы сети расходуются только на взаимодействие между экземплярами микрослужб и серверами высокой доступности, на которых размещается постоянное хранилище данных.</span><span class="sxs-lookup"><span data-stu-id="d7f39-238">In those configurations, the only costly communications is between the microservice instances and the high-availability servers for the persistent data storage.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="d7f39-239">[Назад] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Далее] (../multi-container-microservice-net-applications/index.md)</span><span class="sxs-lookup"><span data-stu-id="d7f39-239">[Previous] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Next] (../multi-container-microservice-net-applications/index.md)</span></span>
