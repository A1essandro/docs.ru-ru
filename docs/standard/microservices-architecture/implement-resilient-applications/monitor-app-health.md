---
title: "Мониторинг работоспособности"
description: "Архитектура микрослужб .NET для контейнерных приложений .NET | Мониторинг работоспособности"
keywords: "Docker, микрослужбы, ASP.NET, контейнер"
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 12/11/2017
ms.prod: .net-core
ms.technology: dotnet-docker
ms.topic: article
ms.workload:
- dotnet
- dotnetcore
ms.openlocfilehash: 76821e27613335609527b867a6b94dac551f6235
ms.sourcegitcommit: e7f04439d78909229506b56935a1105a4149ff3d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/23/2017
---
# <a name="health-monitoring"></a>Мониторинг работоспособности

Мониторинг работоспособности позволяет практически в реальном времени получать сведения о состоянии ваших контейнеров и микрослужб. Мониторинг работоспособности очень важен для нескольких аспектов работы микрослужб и особенно важен, когда оркестраторы выполняют частичное многоэтапное обновление приложений, как описано ниже.

Приложения на основе микрослужб часто используют пульс или проверки работоспособности, чтобы системные мониторы, планировщики и оркестраторы могли отслеживать большое количество служб. Если службам не удается отправить сигнал "Я в порядке", то ваше приложение может подвергнуться риску при развертывании обновлений или просто может обнаружить ошибки слишком поздно, что приведет к каскадным сбоям, которые будет невозможно остановить, а они, в свою очередь, приведут к крупным сбоям.

В обычной модели службы отправляют отчеты о своем состоянии, и эти сведения агрегируются для создания общего представления о состоянии работоспособности приложения. При использовании оркестратора можно предоставить сведения работоспособности кластеру оркестратора, чтобы кластер мог предпринять необходимые действия. Если воспользоваться средствами создания отчетов о работоспособности высокого качества, специально адаптированных для вашего приложения, вы можете гораздо быстрее и эффективнее обнаруживать и устранять проблемы с вашим приложением.

## <a name="implementing-health-checks-in-aspnet-core-services"></a>Реализация проверки работоспособности в службах ASP.NET Core

При разработке микрослужбы или веб-приложения ASP.NET Core можно использовать библиотеку `HealthChecks` от службы технической поддержки ASP.NET. Предыдущий выпуск этой библиотеки доступен в [этом репозитории GitHub](https://github.com/dotnet-architecture/HealthChecks).

Эта библиотека проста в использовании и предоставляет функции, которые позволяют убедиться, что любой внешний ресурс, необходимый для вашего приложения (например, база данных SQL Server или удаленный API), работает правильно. При использовании этой библиотеки также можно определить критерии работоспособности ресурса, о которых мы расскажем ниже.

Чтобы использовать эту библиотеку, необходимо сначала использовать библиотеку в ваших микрослужбах. Во-вторых, вам понадобится клиентское приложение, которое запрашивает отчеты о работоспособности. Это клиентское приложение может представлять собой пользовательское приложение для создания отчетов или сам оркестратор, который может предпринимать необходимые действия в соответствии с состоянием работоспособности.

### <a name="using-the-healthchecks-library-in-your-back-end-aspnet-microservices"></a>Использование библиотеки HealthChecks в серверных микрослужбах ASP.NET

Вы видите, как библиотека HealthChecks используется в примере приложения eShopOnContainers. Для начала необходимо определить, что входит в состояние работоспособности для каждой микрослужбы. В примере приложения микрослужба находится в работоспособном состоянии, если API микрослужбы доступен через HTTP и соответствующая база данных SQL Server также доступна.

В будущем вы можете установить библиотеку HealthChecks в виде пакета NuGet. Но на момент написания этой статьи необходимо скачать и скомпилировать код как часть решения. Клонируйте код, доступный по ссылке https://github.com/dotnet-architecture/HealthChecks, и скопируйте в свое решение следующие папки:

  - src/common
  - src/Microsoft.AspNetCore.HealthChecks
  - src/Microsoft.Extensions.HealthChecks
  - src/Microsoft.Extensions.HealthChecks.SqlServer

Также можно было бы использовать дополнительные проверки, например Microsoft.Extensions.HealthChecks.AzureStorage для Azure, но так как эта версия eShopOnContainers никак не зависит от Azure, это не требуется. Вам не требуется выполнять проверки работоспособности ASP.NET, так как решение eShopOnContainers основано на ASP.NET Core.

На рис. 10-6 показана библиотека HealthChecks в Visual Studio, которую можно использовать при разработке любых микрослужб.

![](./media/image6.png)

**Рис. 10-6**. Исходный код библиотеки HealthChecks ASP.NET Core в решении Visual Studio

Как описано выше, первое, что нужно сделать в проекте любой микрослужбы, — добавить ссылку на три библиотеки HealthChecks. После этого необходимо добавить действия проверки работоспособности, которые нужно выполнить в этой микрослужбе. Эти действия по сути являются зависимостями от других микрослужб (HttpUrlCheck) или баз данных (сейчас SqlCheck\* для баз данных SQL Server). Вы добавляете действие в класс Startup для каждой микрослужбы ASP.NET или веб-приложения ASP.NET.

Каждую службу и каждое веб-приложение следует настроить, добавив все зависимости HTTP и баз данных для этой службы или этого приложения в качестве одного метода AddHealthCheck. Например, веб-приложение MVC eShopOnContainers зависит от многих служб и поэтому имеет несколько методов AddCheck для проверки работоспособности.

Например, в следующем коде вы увидите, как микрослужба каталога добавляет зависимость от своей базы данных SQL Server.

```csharp
// Startup.cs from Catalog.api microservice
//
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // Add framework services
        services.AddHealthChecks(checks =>
        {
            checks.AddSqlCheck("CatalogDb", Configuration["ConnectionString"]);
        });
        // Other services
    }
}
```

Однако у веб-приложения MVC eShopOnContainers есть несколько зависимостей от остальных микрослужб. Поэтому оно вызывает метод AddUrlCheck для каждой микрослужбы, как показано в следующем примере:

```csharp
// Startup.cs from the MVC web app
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddMvc();
        services.Configure<AppSettings>(Configuration);
        services.AddHealthChecks(checks =>
        {
            checks.AddUrlCheck(Configuration["CatalogUrl"]);
            checks.AddUrlCheck(Configuration["OrderingUrl"]);
            checks.AddUrlCheck(Configuration["BasketUrl"]);
            checks.AddUrlCheck(Configuration["IdentityUrl"]);
        });
    }
}
```

Таким образом, микрослужба не будет возвращать состояние "Работоспособно", пока все ее проверки работоспособности не завершатся успешно.

Если у микрослужбы нет зависимости от службы или от SQL Server, просто добавьте проверку Healthy("Ok"). Приведенный ниже код взят из микрослужбы basket.api в решении eShopOnContainers. (Микрослужба корзины использует кэш Redis, но библиотека еще не содержит поставщика проверки работоспособности Redis.)

```csharp
services.AddHealthChecks(checks =>
{
    checks.AddValueTaskCheck("HTTP Endpoint", () => new
        ValueTask<IHealthCheckResult>(HealthCheckResult.Healthy("Ok")));
});
```

Чтобы служба или веб-приложение предоставили конечную точку проверки работоспособности, в них необходимо включить метод расширения UseHealthChecks(\[*URL-адрес\_для\_проверки\_работоспособности*\]). Этот метод переходит на уровень WebHostBuilder основного метода класса Program службы ASP.NET Core или веб-приложения, сразу после UseKestrel, как показано в коде ниже.

```csharp
namespace Microsoft.eShopOnContainers.WebMVC
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var host = new WebHostBuilder()
                .UseKestrel()
                .UseHealthChecks("/hc")
                .UseContentRoot(Directory.GetCurrentDirectory())
                .UseIISIntegration()
                .UseStartup<Startup>()
                .Build();
            host.Run();
        }
    }
}
```

Процесс выглядит следующим образом: каждая микрослужба предоставляет конечную точку /hc. Эта конечная точка создается ПО промежуточного слоя ASP.NET Core для библиотеки HealthChecks. При вызове этой конечной точки она запускает все проверки работоспособности, которые были настроены в методе AddHealthChecks в классе Startup.

Метод UseHealthChecks получает в качестве параметра порт или путь. Это порт или путь к конечной точке, которая используется для проверки состояния работоспособности службы. Например, микрослужба каталога использует путь /hc.

### <a name="caching-health-check-responses"></a>Кэширование ответов проверки работоспособности

Поскольку вы не хотите создать атаку типа "отказ в обслуживании" (DoS) для своих служб или просто не хотите влиять на работоспособность службы, проверяя ресурсы слишком часто, вы можете кэшировать результаты проверки работоспособности и настроить длительность кэширования для каждой проверки.

По умолчанию длительность кэширования устанавливается в 5 минут, но вы можете изменить ее для каждой проверки работоспособности, как показано в следующем коде:

```csharp
checks.AddUrlCheck(Configuration["CatalogUrl"],1); // 1 min as cache duration
```

### <a name="querying-your-microservices-to-report-about-their-health-status"></a>Запрос состояния работоспособности у микрослужб

После настройки проверок работоспособности, как описано здесь, вы можете напрямую проверить работоспособность микрослужбы из браузера, если эта микрослужба запущена в Docker. (Для этого необходимо пробросить порт контейнера из узла Docker, чтобы вы могли обращаться к контейнеру через localhost или через внешний IP-адрес узла Docker.) На рис. 10-7 показаны запрос в веб-браузере и соответствующий ответ.

![](./media/image7.png)

**Рис. 10-7**. Проверка состояния работоспособности для одной службы из браузера

В этом тесте видно, что микрослужба catalog.api (которая запущена на порте 5101) находится в работоспособном состоянии. Она возвращает код HTTP 200 и сведения о состоянии в формате JSON. Это также означает, что внутри службы также осуществляется проверка работоспособности зависимой базы данных SQL Server для этой микрослужбы и что проверка работоспособности возвратила результат, свидетельствующий о нарушении работоспособности.

## <a name="using-watchdogs"></a>Использование наблюдателей

Наблюдатель — это отдельная служба, которая отслеживает работоспособность и загрузку различных служб и отправляет отчет о работоспособности микрослужб, опрашивая библиотеку HealthChecks, о которой мы рассказывали ранее. Это помогает предотвратить ошибки, которые не будут обнаружены для представления одной службы. В наблюдателях также можно размещать код, который может выполнять действия по исправлению для известных условий без вмешательства пользователя.

Пример eShopOnContainers включает веб-страницу с примерами отчетов о проверке работоспособности, как показано на рис. 10-8. Это простейший наблюдатель, который можно создать, так как он отображает состояние микрослужб и веб-приложений в eShopOnContainers. Обычно наблюдатель предпринимает необходимые действия при обнаружении состояний неработоспособности.

![](./media/image8.png)

**Рис. 10-8**. Пример отчета о проверке работоспособности в eShopOnContainers

ПО промежуточного слоя ASP.NET Core для библиотеки HealthChecks предоставляет по одной конечной точке проверки работоспособности для каждой микрослужбы. При этом будут выполнены все проверки работоспособности, определенные в этой конечной точке, и возвращено общее состояние работоспособности в зависимости от результатов этих проверок.

Библиотека HealthChecks является расширяемой. В нее могут быть добавлены новые проверки работоспособности или новые внешние ресурсы. Например, мы ожидаем, что в будущем в библиотеке появятся проверки работоспособности для кэша Redis и для других баз данных. Библиотека позволяет создавать отчеты о работоспособности для нескольких зависимых служб и приложений, и вы можете выполнять определенные действия в зависимости от этих проверок работоспособности.

## <a name="health-checks-when-using-orchestrators"></a>Проверка работоспособности при использовании оркестраторов

Для отслеживания доступности ваших микрослужб оркестраторы, такие как Docker Swarm, Kubernetes и Service Fabric, периодически выполняют проверки работоспособности, отправляя запросы для проверки микрослужб. Когда оркестратор определяет, что служба или контейнер неработоспособны, она перестает направлять запросы к этому экземпляру. Она также обычно создает новый экземпляр этого контейнера.

Например, большинство оркестраторов могут использовать проверки работоспособности для реализации развертываний без простоев. Оркестратор начинает направлять трафик к службе или контейнеру только после того, как состояние службы или контейнера изменится на работоспособное.

Мониторинг работоспособности особенно важен, когда оркестратор выполняет обновление приложения. Некоторые оркестраторы (например, Azure Service Fabric) обновляют службы поэтапно, например, они могут обновлять одну пятую поверхности кластера при каждом обновлении. Набор узлов, на которых выполняется обновление в один момент времени, называется *доменом обновления*. После того как каждый домен обновления был обновлен и стал доступен для пользователей, этот домен обновления должен пройти проверку работоспособности перед тем, как развертывание перейдет к следующему домену обновления.

Другой аспект работоспособности службы — метрики отчетов из службы. Это сложная функция модели работоспособности для некоторых оркестраторов, например Service Fabric. Метрики важны при использовании оркестраторов, так как они применяются для балансировки использования ресурсов. Метрики также могут быть индикатором работоспособности системы. Например, у вас может быть приложение с несколькими микрослужбами, и каждый экземпляр микрослужбы передает метрику "Количество запросов в секунду" (RPS). Если одна служба использует больше ресурсов (память, процессор и т. д.), чем другая служба, оркестратор может переместить экземпляры служб в кластере для равномерного использования ресурсов.

Обратите внимание, что в Azure Service Fabric есть собственная [модель мониторинга работоспособности](https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction), которая является более сложной по сравнению с простыми проверками.

## <a name="advanced-monitoring-visualization-analysis-and-alerts"></a>Расширенный мониторинг: визуализация, анализ и предупреждения

Последний компонент мониторинга — визуализация потока событий, отчеты о производительности службы и оповещения при обнаружении проблем. Для реализации этого компонента мониторинга можно использовать различные решения.

Можно использовать простые пользовательские приложения, которые отображают состояние служб, например пользовательскую страницу, о которой мы рассказывали при объяснении библиотеки [HealthChecks ASP.NET Core](https://github.com/aspnet/HealthChecks). Или можно использовать более сложные инструменты, такие как Azure Application Insights и Operations Management Suite, которые будут создавать оповещения на основе потока событий.

Наконец, если вы сохраняете все потоки событий, то для визуализации данных можно использовать Microsoft Power BI или решения сторонних поставщиков, например Kibana или Splunk.

## <a name="additional-resources"></a>Дополнительные ресурсы

-   **Проверка работоспособности ASP.NET Core** (ранний выпуск) [*https://github.com/aspnet/HealthChecks/*](https://github.com/aspnet/HealthChecks/)

-   **Общие сведения о мониторинге работоспособности в Service Fabric**
    [*https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction*](https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction)

-   **Azure Application Insights**
    [*https://azure.microsoft.com/services/application-insights/*](https://azure.microsoft.com/services/application-insights/)

-   **Microsoft Operations Management Suite**
    [*https://www.microsoft.com/en-us/cloud-platform/operations-management-suite*](https://www.microsoft.com/en-us/cloud-platform/operations-management-suite)

>[!div class="step-by-step"]
[Назад] (implement-circuit-breaker-pattern.md) [Далее] (../secure-net-microservices-web-applications/index.md)
