---
title: "Наблюдение за работоспособностью"
description: "Архитектура Микрослужбами .NET для приложений .NET в контейнерах | Наблюдение за работоспособностью"
keywords: "Docker, микрослужбы, ASP.NET, контейнер"
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.prod: .net-core
ms.technology: dotnet-docker
ms.topic: article
ms.openlocfilehash: cbbad72f06bcaa882bc50083d9103b0872f51754
ms.sourcegitcommit: bd1ef61f4bb794b25383d3d72e71041a5ced172e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/18/2017
---
# <a name="health-monitoring"></a>Наблюдение за работоспособностью

Наблюдение за работоспособностью можно разрешить почти реальном времени сведения о состоянии контейнеров и микрослужбами. Наблюдение за работоспособностью крайне важно для нескольких аспектов работы микрослужбами и особенно важна при orchestrators обновления частичное применение поэтапно, как описано ниже.

Микрослужбами-приложениях часто используют периодических сигналов или проверки работоспособности для включения их мониторы производительности планировщиков и orchestrators для отслеживания несколько служб. Если службы не удается отправить определенного рода сигнал «Я alive», по требованию или по расписанию, приложения могут появиться риски при развертывании обновлений, или он может просто определяйте слишком поздно и не удается остановить каскадных сбоев, которые могут быть сохранены в крупных сбоев.

В обычной модели службы отправлять отчеты о состоянии, и эти данные агрегируются для создания общего представления о состоянии работоспособности приложения. При использовании orchestrator, можете указать сведения о работоспособности кластер вашей orchestrator кластера смогут действовать соответствующим образом. Если инвестиций в отчет о работоспособности высокого качества, который настроен для вашего приложения, можно обнаружить и облегчает Устранение проблем для выполняющегося приложения.

## <a name="implementing-health-checks-in-aspnet-core-services"></a>Реализация работоспособности проверяет в службах ASP.NET Core

При разработке микрослужбу или веб-приложения ASP.NET Core, можно использовать библиотеку HealthChecks от службы технической поддержки ASP.NET. (По состоянию на май 2017 г., более раннего выпуска можно найти в GitHub).

Эта библиотека является простой в использовании и предоставляет возможности, позволяющие проверить работоспособность любого конкретного внешний ресурс, необходимый для приложения (например, база данных SQL Server или удаленного API). При использовании этой библиотеки, можно решить, значит ресурса работоспособно, как рассказывается ниже.

Чтобы использовать эту библиотеку, необходимо сначала использовать библиотеку в вашей микрослужбами. Во-вторых требуется клиентское приложение, которое запрашивает для отчетов о работоспособности. Интерфейс может быть пользовательского приложения для создания отчетов, или это может быть сам модуль, может реагировать соответствующим образом для состояния работоспособности.

### <a name="using-the-healthchecks-library-in-your-back-end-aspnet-microservices"></a>Использование библиотеки HealthChecks в вашей серверной части ASP.NET микрослужбами

Вы увидите, как библиотека HealthChecks используется в примере приложения eShopOnContainers. Чтобы начать, необходимо определить, что такое состояние для каждого микрослужбу. В примере приложения микрослужбами находятся в работоспособном состоянии, если микрослужбу API доступен через HTTP, и если его связанной базы данных SQL Server будет доступен.

В будущем можно установить библиотеку HealthChecks как пакет NuGet. Однако на момент написания этой статьи, необходимо загрузить и компиляции кода как часть решения. Клонировать код, найти по адресу https://github.com/aspnet/HealthChecks и скопируйте следующие папки решения.

  - src/Общие
  - src/Microsoft.AspNetCore.HealthChecks
  - src/Microsoft.Extensions.HealthChecks
  - src/Microsoft.Extensions.HealthChecks.SqlServer

Можно также использовать дополнительные проверки аналогичных для Azure (Microsoft.Extensions.HealthChecks.AzureStorage), однако, поскольку эта версия eShopOnContainers не имеет какой-либо зависимостью в Azure, он не требуется. Проверку работоспособности ASP.NET, не обязательно, поскольку eShopOnContainers основан на ASP.NET Core.

На рис. 10-6 показаны библиотеки HealthChecks в Visual Studio, можно будет использовать как стандартный блок любой микрослужбами.

![](./media/image6.png)

**На рис. 10-6**. ASP.NET Core HealthChecks библиотеки исходного кода в решении Visual Studio

Представленном выше, в первую очередь необходимо выполнить в каждом проекте микрослужбу является добавление ссылки на три HealthChecks библиотеки. После этого добавьте действия проверки работоспособности, которые необходимо выполнить в этом микрослужбы. Эти действия, по сути являются зависимостей от других микрослужбами (HttpUrlCheck) или баз данных (в настоящее время SqlCheck\* баз данных SQL Server). Можно добавить действие внутри класса при запуске каждого микрослужбу ASP.NET или веб-приложения ASP.NET.

Каждая служба или веб-приложения должны быть настроены, добавив его зависимостей HTTP или базы данных в качестве одного метода AddHealthCheck. Например веб-приложения MVC eShopOnContainers зависит от многих служб, поэтому имеет несколько методов AddCheck добавлен для проверки работоспособности.

Например в следующем коде вы увидите как микрослужбу каталога добавляет зависимость своей базы данных SQL Server.

```csharp
// Startup.cs from Catalog.api microservice
//
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // Add framework services
        services.AddHealthChecks(checks =>
        {
            checks.AddSqlCheck("CatalogDb", Configuration["ConnectionString"]);
        });
        // Other services
    }
}
```

Тем не менее веб-приложение MVC eShopOnContainers имеет несколько зависимостей от остальной части микрослужбами. Таким образом он вызывает один метод AddUrlCheck для каждого микрослужбу, как показано в следующем примере:

```csharp
// Startup.cs from the MVC web app
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddMvc();
        services.Configure<AppSettings>(Configuration);
        services.AddHealthChecks(checks =>
        {
            checks.AddUrlCheck(Configuration["CatalogUrl"]);
            checks.AddUrlCheck(Configuration["OrderingUrl"]);
            checks.AddUrlCheck(Configuration["BasketUrl"]);
            checks.AddUrlCheck(Configuration["IdentityUrl"]);
        });
    }
}
```

Таким образом микрослужбу не будет поддерживать «Исправен», пока все проверки работоспособны также.

Если микрослужбу имеет зависимость от службы или на сервере SQL Server, нужно просто добавить проверку Healthy("Ok"). Приведенный ниже код взят из микрослужбу basket.api eShopOnContainers. (Микрослужбу корзины использует кэш Redis, но библиотеке еще не содержит поставщик проверки работоспособности Redis).

```csharp
services.AddHealthChecks(checks =>
{
    checks.AddValueTaskCheck("HTTP Endpoint", () => new
        ValueTask<IHealthCheckResult>(HealthCheckResult.Healthy("Ok")));
});
```

Для службы или веб-приложения для предоставления конечной точки проверки работоспособности, он должен включить UseHealthChecks (\[*URL-адрес\_для\_работоспособности\_проверяет*\]) расширения метод. Этот метод переходит на WebHostBuilder уровне основного метода в класс программы ASP.NET Core службы или веб-приложения, сразу же после UseKestrel, как показано в приведенном ниже примере кода.

```csharp
namespace Microsoft.eShopOnContainers.WebMVC
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var host = new WebHostBuilder()
                .UseKestrel()
                .UseHealthChecks("/hc")
                .UseContentRoot(Directory.GetCurrentDirectory())
                .UseIISIntegration()
                .UseStartup<Startup>()
                .Build();
            host.Run();
        }
    }
}
```

Процесс выглядит следующим образом: каждый микрослужбу предоставляет / HC конечной точки. Этой конечной точки создается библиотекой HealthChecks по промежуточного слоя ASP.NET Core. Все проверки работоспособности, настроенные в методе AddHealthChecks в классе запуска выполняется при вызове этой конечной точки.

Метод UseHealthChecks ожидает, что порт или путь. Этот порт или путь — это конечная точка, использовать для проверки состояния службы работоспособности. Например микрослужбу каталога использует / HC путь.

### <a name="caching-health-check-responses"></a>Кэширование ответов проверки работоспособности

Поскольку вы не хотите вызвать отказ в обслуживании (DoS) в службах или просто не хотите повлиять на производительность службы, проверьте ресурсы слишком часто, можно кэшировать возвращает и настроить длительность кэширования для каждой проверки работоспособности.

По умолчанию длительность кэширования внутренне устанавливается в 5 минут, но вы можете изменить этот интервал кэша на каждом проверки работоспособности, как показано в следующем коде:

```csharp
checks.AddUrlCheck(Configuration["CatalogUrl"],1); // 1 min as cache duration
```

### <a name="querying-your-microservices-to-report-about-their-health-status"></a>Запросы к микрослужбами отчет о состоянии работоспособности

После настройки проверки работоспособности, как описано здесь, поскольку микрослужбу работает в Docker, можно напрямую проверять из браузера, если он находится в работоспособном состоянии. (Это нужно, чтобы доступ к контейнеру через localhost или внешний IP-адрес узла Docker публикации порт контейнера из узла Docker.) На рис. 10-7 показан запрос в веб-браузер и соответствующие ответные меры.

![](./media/image7.png)

**На рис. 10-7**. Проверка состояния работоспособности службы единого из браузера

В этом тесте видно, catalog.api микрослужбу, (работающий в порте 5101) находится в работоспособном состоянии, возвращая код состояния HTTP 200 и сведения о состоянии в формате JSON. Это также означает, что внутри службы также проверка работоспособности его зависимости базы данных SQL Server и что проверки работоспособности было получено сообщение о неполадках работоспособен.

## <a name="using-watchdogs"></a>С помощью watchdogs

Контрольный является отдельной службе, можно посмотреть работоспособности и загрузка различных служб и отчет о работоспособности о микрослужбами путем запроса с библиотекой HealthChecks, представленный ранее. Это поможет предотвратить ошибки, которые не будут обнаружены на основе представления одной службы. Watchdogs также могут лучше всего узла код, который можно выполнять действия по исправлению известных причин без вмешательства пользователя.

Образец eShopOnContainers содержит веб-страницы, отображающий образцов отчетов проверку работоспособности, как показано на рисунке 10-8. Это простейший наблюдения, можно создать, поскольку он осуществляет — отображает состояние микрослужбами и веб-приложений в eShopOnContainers. Обычно контрольного также выполняет действия при обнаружении неработоспособности состояний.

![](./media/image8.png)

**На рис. 10-8**. Отчет о проверке работоспособности образец в eShopOnContainers

Таким образом по промежуточного слоя ASP.NET библиотеки ASP.NET Core HealthChecks предоставляет конечную точку проверки работоспособности одной для каждого микрослужбы. Будет выполнять проверку работоспособности, определенных внутри него и вернуть состояние общей работоспособности в зависимости от этих проверок.

Библиотека HealthChecks расширить с помощью новых проверок работоспособности будущих внешних ресурсов. Например предполагается, что в будущем библиотека будет иметь проверки работоспособности для кэша Redis и для других баз данных. Библиотека позволяет работоспособности, создание отчетов с помощью несколько зависимостей службы или приложения и предпринимать действия в зависимости от этих проверок работоспособности.

## <a name="health-checks-when-using-orchestrators"></a>Проверку работоспособности при использовании orchestrators

Для наблюдения за доступностью вашей микрослужбами, orchestrators с помощью Docker Swarm, Kubernetes и Service Fabric периодически выполняет проверку работоспособности, отправляя запросы для проверки микрослужбами. Когда orchestrator определяет, что службе/контейнере неработоспособен, она перестает направлять запросы к этому экземпляру. Он также обычно создает новый экземпляр этого контейнера.

Например большинство orchestrators можно использовать проверки работоспособности для управления развертываниями простоев. Только при изменении службы или контейнера в работоспособное состояние будет orchestrator запустите перенаправляет трафик для экземпляров службы или контейнера.

Наблюдение за работоспособностью особенно важно при orchestrator выполняет обновление приложения. Некоторые orchestrators (например, Azure Service Fabric) обновление служб в этапах — например, может обновить пятая поверхности кластера для каждого обновления приложения. Набор узлов, которая обновляется в то же время называется *домен обновления*. После каждого обновления домена будет обновлен и становится доступным для пользователей, домен обновления прошла проверку работоспособности перед развертыванием перемещается к следующему домену обновления.

Другим аспектом службы работоспособности сообщает метрики из службы. Это расширенные возможности модели работоспособности некоторые orchestrators как Service Fabric. Метрики важны при использовании orchestrator, так как они используются для балансировки использования ресурсов. Также могут возникать метрик индикатора работоспособности системы. Например возможно, которое содержит много микрослужбами и каждый экземпляр сообщает метрика запросов в секунду (RPS). Если одна служба использует больше ресурсов (память, процессор, т. д.), чем другая служба, orchestrator может перемещаться экземпляров службы в кластере с целью поддержания даже использование ресурсов.

Обратите внимание, что при использовании Azure Service Fabric, он предоставляет собственный [наблюдение за работоспособностью модели](https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction), который является более сложной, чем простой проверок.

## <a name="advanced-monitoring-visualization-analysis-and-alerts"></a>Расширенный мониторинг: визуализации, анализ и предупреждения

Последняя часть мониторинга визуализируемый поток событий, отчеты о производительности для службы и оповещение при обнаружении проблемы. Можно использовать различные решения для наблюдения за данный аспект.

Можно использовать простые пользовательские приложения с состоянием служб, как пользовательскую страницу мы показали, когда было показано [ASP.NET Core HealthChecks](https://github.com/aspnet/HealthChecks). Или можно использовать более сложные средства, как Azure Application Insights и Operations Management Suite, чтобы создавать оповещения на основе потока событий.

Наконец Если хранить все потоки событий, можно использовать Microsoft Power BI или решения сторонних поставщиков, например Kibana или Splunk для визуализации данных.

## <a name="additional-resources"></a>Дополнительные ресурсы

-   **ASP.NET Core HealthChecks** (ранний выпуск) [ *https://github.com/aspnet/HealthChecks/*](https://github.com/aspnet/HealthChecks/)

-   **Введение в мониторинг работоспособности Service Fabric**
    [*https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction*](https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction)

-   **Приложения Azure Insights**
    [*https://azure.microsoft.com/services/application-insights/*](https://azure.microsoft.com/services/application-insights/)

-   **Microsoft Operations Management Suite**
    [*https://www.microsoft.com/en-us/cloud-platform/operations-management-suite*](https://www.microsoft.com/en-us/cloud-platform/operations-management-suite)

>[!div class="step-by-step"]
[Предыдущие] (реализация канала разбиения pattern.md) [Далее] (.. /Secure-NET-microservices-Web-Applications/index.MD)
