---
title: Мониторинг работоспособности
description: Изучите один из способов реализации мониторинга работоспособности.
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 10/16/2018
ms.openlocfilehash: 666b55608ca4e5d18448e1a0b4a1735f3e856474
ms.sourcegitcommit: 542aa405b295955eb055765f33723cb8b588d0d0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2019
ms.locfileid: "54362487"
---
# <a name="health-monitoring"></a>Мониторинг работоспособности

Мониторинг работоспособности позволяет практически в реальном времени получать сведения о состоянии ваших контейнеров и микрослужб. Мониторинг работоспособности очень важен для нескольких аспектов работы микрослужб и особенно важен, когда оркестраторы выполняют частичное многоэтапное обновление приложений, как описано ниже.

Приложения на основе микрослужб часто используют пульс или проверки работоспособности, чтобы системные мониторы, планировщики и оркестраторы могли отслеживать большое количество служб. Если службам не удается отправить сигнал "Я в порядке", ваше приложение может подвергнуться риску при развертывании обновлений или может просто обнаружить ошибки слишком поздно. Это приведет к каскадным сбоям, которые будет невозможно остановить, а они, в свою очередь, приведут к масштабным сбоям.

В обычной модели службы отправляют отчеты о своем состоянии, и эти сведения агрегируются для создания общего представления о состоянии работоспособности приложения. При использовании оркестратора можно предоставить сведения работоспособности кластеру оркестратора, чтобы кластер мог предпринять необходимые действия. Если воспользоваться высококачественными средствами создания отчетов о работоспособности, специально адаптированных для вашего приложения, вы сможете гораздо быстрее и эффективнее обнаруживать и устранять проблемы с приложением.

## <a name="implement-health-checks-in-aspnet-core-services"></a>Реализация проверки работоспособности в службах ASP.NET Core

При разработке микрослужбы или веб-приложения ASP.NET Core можно использовать экспериментальную библиотеку *HealthChecks* от команды ASP.NET (официально не входит в ASP.NET Core и является устаревшей). Эту библиотеку можно скачать в [репозитории GitHub dotnet-architecture](https://github.com/dotnet-architecture/HealthChecks). При этом релиз официальной версии библиотеки *HealthChecks* [будет входить в состав ASP.NET Core 2.2](https://github.com/aspnet/Announcements/issues/307) (официальный выпуск запланирован на конец 2018 года).

Эта библиотека проста в использовании и предоставляет функции, которые позволяют убедиться, что любой внешний ресурс, необходимый для вашего приложения (например, база данных SQL Server или удаленный API), работает правильно. При использовании этой библиотеки также можно определить критерии работоспособности ресурса, о которых мы расскажем ниже.

Чтобы использовать эту библиотеку, необходимо сначала использовать библиотеку в ваших микрослужбах. Во-вторых, вам понадобится клиентское приложение, которое запрашивает отчеты о работоспособности. Это клиентское приложение может быть пользовательским приложением для создания отчетов или оркестратором, который будет предпринимать необходимые действия в соответствии с состоянием работоспособности.

### <a name="use-the-healthchecks-library-in-your-back-end-aspnet-microservices"></a>Использование библиотеки HealthChecks в серверных микрослужбах ASP.NET

Вы видите, как библиотека HealthChecks используется в примере приложения eShopOnContainers. Для начала необходимо определить, что входит в состояние работоспособности для каждой микрослужбы. В примере приложения микрослужба находится в работоспособном состоянии, если API микрослужбы доступен через HTTP и соответствующая база данных SQL Server также доступна.

В будущем вы сможете установить библиотеку HealthChecks в виде пакета NuGet. Но на момент написания этой статьи необходимо скачать и скомпилировать код как часть решения. Клонируйте код, доступный по адресу <https://github.com/dotnet-architecture/HealthChecks>, и скопируйте следующие папки в ваше решение:

- src/common
- src/Microsoft.AspNetCore.HealthChecks
- src/Microsoft.Extensions.HealthChecks
- src/Microsoft.Extensions.HealthChecks.SqlServer

Также можно было бы использовать дополнительные проверки, например Microsoft.Extensions.HealthChecks.AzureStorage для Azure, но так как эта версия eShopOnContainers никак не зависит от Azure, это не требуется. Вам не требуется выполнять проверки работоспособности ASP.NET, так как решение eShopOnContainers основано на ASP.NET Core.

На рис. 8-7 показана библиотека HealthChecks в Visual Studio, которую можно использовать при разработке любых микрослужб.

![Представление обозревателя решений с папкой HealthChecks, содержащей три проекта.](./media/image6.png)

**Рис. 8-7**. Исходный код библиотеки HealthChecks ASP.NET Core в решении Visual Studio

Как описано выше, первое, что нужно сделать в проекте любой микрослужбы, — добавить ссылку на три библиотеки HealthChecks. После этого необходимо добавить действия проверки работоспособности, которые нужно выполнить в этой микрослужбе. Эти действия по сути являются зависимостями от других микрослужб (HttpUrlCheck) или баз данных (сейчас SqlCheck\* для баз данных SQL Server). Вы добавляете действие в класс Startup для каждой микрослужбы ASP.NET или веб-приложения ASP.NET.

Каждую службу и каждое веб-приложение следует настроить, добавив все зависимости HTTP и баз данных для этой службы или этого приложения в качестве одного метода AddHealthCheck. Например, веб-приложение MVC eShopOnContainers зависит от многих служб и поэтому имеет несколько методов AddCheck для проверки работоспособности.

Например, в следующем упрощенном коде вы увидите, как микрослужба каталога добавляет зависимость своей базы данных SQL Server.

```csharp
// Startup.cs from Catalog.api microservice
//
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        // Add framework services
        services.AddHealthChecks(checks =>
        {
            checks.AddSqlCheck("CatalogDb", Configuration["ConnectionString"]);
        });
        // Other services
    }
}
```

Однако у веб-приложения MVC eShopOnContainers есть несколько зависимостей от остальных микрослужб. Поэтому оно вызывает метод AddUrlCheck для каждой микрослужбы, как показано в следующем упрощенном примере:

```csharp
// Startup.cs from the MVC web app
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddMvc();
        services.Configure<AppSettings>(Configuration);
        services.AddHealthChecks(checks =>
        {
            checks.AddUrlCheck(Configuration["CatalogUrl"]);
            checks.AddUrlCheck(Configuration["OrderingUrl"]);
            checks.AddUrlCheck(Configuration["BasketUrl"]);
            checks.AddUrlCheck(Configuration["IdentityUrl"]);
        });
    }
}
```

Таким образом, микрослужба не будет возвращать состояние "Работоспособно", пока все ее проверки работоспособности не завершатся успешно.

Если у микрослужбы нет зависимости от службы или от SQL Server, просто добавьте проверку Healthy("Ok"). Приведенный ниже код взят из микрослужбы `basket.api` в решении eShopOnContainers. (Микрослужба корзины использует кэш Redis, но библиотека еще не содержит поставщика проверки работоспособности Redis.)

```csharp
services.AddHealthChecks(checks =>
{
    checks.AddValueTaskCheck("HTTP Endpoint", () => new
        ValueTask<IHealthCheckResult>(HealthCheckResult.Healthy("Ok")));
});
```

Чтобы служба или веб-приложение предоставили конечную точку проверки работоспособности, в них необходимо включить метод расширения `UseHealthChecks([*url_for_health_checks*])`. Этот метод переходит на уровень `WebHostBuilder` метода main класса `Program` службы ASP.NET Core или веб-приложения, сразу после <xref:Microsoft.AspNetCore.WebHost.CreateDefaultBuilder>, как показано в следующем упрощенном коде:

```csharp
namespace Microsoft.eShopOnContainers.WebMVC
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var host = WebHost.CreateDefaultBuilder(args)
                .UseHealthChecks("/hc")
                .UseContentRoot(Directory.GetCurrentDirectory())
                .UseStartup<Startup>()
                .Build();

            host.Run();
        }
    }
}
```

Процесс выглядит следующим образом: каждая микрослужба предоставляет конечную точку /hc. Эта конечная точка создается ПО промежуточного слоя ASP.NET Core для библиотеки HealthChecks. При вызове этой конечной точки она запускает все проверки работоспособности, которые были настроены в методе AddHealthChecks в классе Startup.

Метод UseHealthChecks получает в качестве параметра порт или путь. Это порт или путь к конечной точке, которая используется для проверки состояния работоспособности службы. Например, микрослужба каталога использует путь /hc.

### <a name="cache-health-check-responses"></a>Кэширование ответов проверки работоспособности

Поскольку вы не хотите создать атаку типа "отказ в обслуживании" (DoS) для своих служб или просто не хотите влиять на работоспособность службы, проверяя ресурсы слишком часто, вы можете кэшировать результаты проверки работоспособности и настроить длительность кэширования для каждой проверки.

По умолчанию длительность кэширования устанавливается в 5 минут, но вы можете изменить ее для каждой проверки работоспособности, как показано в следующем коде:

```csharp
checks.AddUrlCheck(Configuration["CatalogUrl"],1); // 1 min as cache duration
```

### <a name="query-your-microservices-to-report-about-their-health-status"></a>Отправка запроса состояния работоспособности у микрослужб

Настроив проверки работоспособности, описанные в этой статье, вы можете непосредственно проверить работоспособность микрослужбы из браузера, если эта микрослужба запущена в Docker.

Для этого необходимо опубликовать порт контейнера в узле Docker, чтобы вы могли обращаться к контейнеру по внешнему IP-адресу узла Docker или через `localhost`, как показано на рисунке 8-8.

![Представление ответа в формате JSON, полученного при проверке работоспособности, в браузере](./media/image7.png)

**Рис. 8-8**. Проверка состояния работоспособности для одной службы из браузера

В этом тесте видно, что микрослужба catalog.api (которая запущена на порте 5101) находится в работоспособном состоянии. Она возвращает код HTTP 200 и сведения о состоянии в формате JSON. Это также означает, что внутри службы также осуществляется проверка работоспособности зависимой базы данных SQL Server для этой микрослужбы и что проверка работоспособности возвратила результат, свидетельствующий о нарушении работоспособности.

## <a name="use-watchdogs"></a>Использование наблюдателей

Наблюдатель — это отдельная служба, которая отслеживает работоспособность и загрузку различных служб и отправляет отчет о работоспособности микрослужб, опрашивая библиотеку `HealthChecks`, о которой мы рассказывали ранее. Это помогает предотвратить ошибки, которые не будут обнаружены для представления одной службы. В наблюдателях также можно размещать код, который может выполнять действия по исправлению для известных условий без вмешательства пользователя.

Пример eShopOnContainers содержит веб-страницу с примерами отчетов о проверке работоспособности, как показано на рис. 8-9. Это простейший наблюдатель, который можно создать, так как он только отображает состояние микрослужб и веб-приложений в eShopOnContainers. Обычно наблюдатель предпринимает необходимые действия при обнаружении состояний неработоспособности.

![Представление приложения WebStatus с состоянием работоспособности пяти микрослужб из eShopOnContainers](./media/image8.png)

**Рис. 8-9**. Пример отчета о проверке работоспособности в eShopOnContainers

ПО промежуточного слоя ASP.NET Core для библиотеки HealthChecks предоставляет по одной конечной точке проверки работоспособности для каждой микрослужбы. При этом будут выполнены все проверки работоспособности, определенные в этой конечной точке, и возвращено общее состояние работоспособности в зависимости от результатов этих проверок.

Библиотека HealthChecks является расширяемой. В нее могут быть добавлены новые проверки работоспособности или новые внешние ресурсы. Например, мы ожидаем, что в будущем в библиотеке появятся проверки работоспособности для кэша Redis и для других баз данных. Библиотека позволяет создавать отчеты о работоспособности для нескольких зависимых служб и приложений, и вы можете выполнять определенные действия в зависимости от этих проверок работоспособности.

## <a name="health-checks-when-using-orchestrators"></a>Проверка работоспособности при использовании оркестраторов

Для отслеживания доступности ваших микрослужб оркестраторы, такие как Kubernetes и Service Fabric, периодически выполняют проверки работоспособности, отправляя запросы для проверки микрослужб. Когда оркестратор определяет, что служба или контейнер неработоспособны, она перестает направлять запросы к этому экземпляру. Она также обычно создает новый экземпляр этого контейнера.

Например, большинство оркестраторов могут использовать проверки работоспособности для реализации развертываний без простоев. Оркестратор начинает направлять трафик к службе или контейнеру только после того, как состояние службы или контейнера изменится на работоспособное.

Мониторинг работоспособности особенно важен, когда оркестратор выполняет обновление приложения. Некоторые оркестраторы (например, Azure Service Fabric) обновляют службы поэтапно, например, они могут обновлять одну пятую поверхности кластера при каждом обновлении. Набор узлов, обновляемых одновременно, называется *доменом обновления*. После того как каждый домен обновления был обновлен и стал доступен для пользователей, этот домен обновления должен пройти проверку работоспособности перед тем, как развертывание перейдет к следующему домену обновления.

Другой аспект работоспособности службы — метрики отчетов из службы. Это сложная функция модели работоспособности для некоторых оркестраторов, например Service Fabric. Метрики важны при использовании оркестраторов, так как они применяются для балансировки использования ресурсов. Метрики также могут быть индикатором работоспособности системы. Например, у вас может быть приложение с несколькими микрослужбами, и каждый экземпляр микрослужбы передает метрику "Количество запросов в секунду" (RPS). Если одна служба использует больше ресурсов (память, процессор и т. д.), чем другая служба, оркестратор может переместить экземпляры служб в кластере для равномерного использования ресурсов.

Обратите внимание, что в Azure Service Fabric есть собственная [модель мониторинга работоспособности](/azure/service-fabric/service-fabric-health-introduction), которая является более сложной по сравнению с простыми решениями для проверки.

## <a name="advanced-monitoring-visualization-analysis-and-alerts"></a>Расширенный мониторинг: визуализация, анализ и предупреждения

Последний компонент мониторинга — визуализация потока событий, отчеты о производительности службы и оповещения при обнаружении проблем. Для реализации этого компонента мониторинга можно использовать различные решения.

Можно использовать простые пользовательские приложения, которые отображают состояние служб, например пользовательскую страницу, о которой идет речь в описании библиотеки [HealthChecks ASP.NET Core](https://github.com/dotnet-architecture/HealthChecks). Или можно использовать более сложные инструменты, такие как Azure Application Insights, которые будут создавать оповещения на основе потока событий.

Наконец, если вы сохраняете все потоки событий, для визуализации данных можно использовать Microsoft Power BI или решения других поставщиков, например Kibana или Splunk.

## <a name="additional-resources"></a>Дополнительные ресурсы

- **ASP.NET Core HealthChecks** (экспериментальный выпуск)
  [*https://github.com/dotnet-architecture/HealthChecks/*](https://github.com/dotnet-architecture/HealthChecks/)

- **Общие сведения о мониторинге работоспособности Service Fabric**\
  [*https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction*](/azure/service-fabric/service-fabric-health-introduction)

- **Azure Application Insights**\
  [*https://azure.microsoft.com/services/application-insights/*](https://azure.microsoft.com/services/application-insights/)

- **Microsoft Operations Management Suite**\
  [*https://www.microsoft.com/cloud-platform/operations-management-suite*](https://www.microsoft.com/cloud-platform/operations-management-suite)

>[!div class="step-by-step"]
>[Назад](implement-circuit-breaker-pattern.md)
>[Вперед](../secure-net-microservices-web-applications/index.md)