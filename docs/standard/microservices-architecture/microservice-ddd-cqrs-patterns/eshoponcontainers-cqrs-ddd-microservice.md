---
title: "Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers"
description: "Архитектура микрослужб .NET для контейнерных приложений .NET | Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers"
keywords: "Docker, микрослужбы, ASP.NET, контейнер"
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.prod: .net-core
ms.technology: dotnet-docker
ms.topic: article
ms.workload:
- dotnet
- dotnetcore
ms.openlocfilehash: 63e61a93aa2a162d7b48e0d423dab99dcea9d020
ms.sourcegitcommit: e7f04439d78909229506b56935a1105a4149ff3d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/23/2017
---
# <a name="applying-cqrs-and-cqs-approaches-in-a-ddd-microservice-in-eshoponcontainers"></a>Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers

Проект микрослужбы заказов эталонного приложения eShopOnContainers построен на принципах CQRS. Однако в нем применяется простейший подход, который просто разделяет запросы и команды и использует одну и ту же базу данных для обоих действий.

Суть этих шаблонов и важный момент заключается в том, что запросы идемпотентны: независимо от того, сколько раз запрашивается система, состояние этой системы не изменится. Можно даже использовать модель данных "чтения", отличную от модели предметной области "записи" транзакционной логики, несмотря на то, что микрослужба заказов использует ту же базу данных. Поэтому это упрощенный подход CQRS.

С другой стороны, команды, которые инициируют транзакции и обновления данных, изменяют состояние в системе. При использовании команд необходимо соблюдать осторожность, имея дело со сложными и постоянно меняющимися бизнес-правилами. Это наиболее подходящее место для применения методов DDD, чтобы получить наилучшим образом смоделированную систему.

Шаблоны DDD, представленные в настоящем руководстве, не должны применяться универсально. Они вводят в ваш проект ограничения. Эти ограничения обеспечивают такие преимущества, как повышение качества с течением времени, особенно в командах и другом коде, который изменяет состояние системы. Однако эти ограничения увеличивают сложность с минимумом преимуществ для чтения и запросов данных.

Одним из таких шаблонов является шаблон агрегата, который мы подробно рассмотрим в последующих разделах. Вкратце, в шаблоне агрегата (Aggregate) многие объекты предметной области обрабатываются как единое целое в результате их связей в предметной области. В запросах не всегда удается извлечь преимущества из этого шаблона; он может увеличить сложность логики запроса. В запросах только на чтение вы не получите никаких преимуществ от обработки нескольких объектов как единого агрегата. Вы получите только сложность.

Как показано на рисунке 9-2, в данном руководстве предлагается использовать шаблоны DDD только в области транзакций или обновлений вашей микрослужбы (то есть в том, что инициируется командами). Для запросов можно использовать более простой подход, и согласно концепции CQRS их следует отделить от команд.

Для реализации "стороны запросов" вы можете выбирать между подходами, включая полнофункциональные ORM, например EF Core, проекции AutoMapper, хранимые процедуры, представления, материализованные представления и micro ORM.

В данном руководстве и в приложении eShopOnContainers (в частности, в микрослужбе заказов) мы решили реализовать прямые запросы с помощью micro ORM, например [Dapper](https://github.com/StackExchange/dapper-dot-net). Это позволяет реализовать любой запрос на основе инструкций SQL для получения наилучшей производительности благодаря облегченной инфраструктуре с минимальными накладными расходами.

Обратите внимание, что при использовании этого подхода для любых обновлений модели, влияющих на то, как сущности сохраняются в базе данных SQL, также требуются отдельные обновления запросов SQL, используемых Dapper или любым другим отдельным (не EF) подходом к запросам.

## <a name="cqrs-and-ddd-patterns-are-not-top-level-architectures"></a>Шаблоны DDD и CQRS не относятся к архитектурам верхнего уровня

Важно понимать, что CQRS и большинство шаблонов DDD (например, слои DDD или модель предметной области с агрегатами) являются не архитектурными стилями, а лишь архитектурными шаблонами. Примерами архитектурных стилей являются микрослужбы, SOA и событийно-управляемая архитектура (EDA). Они описывают систему, состоящую из множества компонентов, например из множества микрослужб. Шаблоны DDD и CQRS описывают нечто внутри одной системы или компонента; в данном случае — нечто внутри микрослужбы.

Разные ограниченные контексты (BC) будут использовать разные шаблоны. Они имеют разные сферы ответственности, что ведет к разным решениям. Стоит подчеркнуть, что повсеместное применение одного и того же шаблона приводит к неудаче. Не используйте шаблоны DDD и CQRS повсюду. Многие подсистемы, ограниченные контексты или микрослужбы довольно простые, и их можно реализовать более просто с помощью служб CRUD или другого метода.

Имеется только одна архитектура приложения: архитектура разрабатываемой системы или комплексного приложения (например, архитектура микрослужб). Однако структура каждого ограниченного контекста или микрослужбы в этом приложении отражает их собственные компромиссы и внутренние проектные решения на уровне архитектурных шаблонов. Не пытайтесь везде применять одни и те же архитектурные шаблоны, такие как CQRS или DDD.

####  <a name="additional-resources"></a>Дополнительные ресурсы

-   **Мартин Фоулер (Martin Fowler). CQRS**
    [*https://martinfowler.com/bliki/CQRS.html*](https://martinfowler.com/bliki/CQRS.html)

-   **Грег Янг (Greg Young). CQS и CQRS**
    [*http://codebetter.com/gregyoung/2009/08/13/command-query-separation/*](http://codebetter.com/gregyoung/2009/08/13/command-query-separation/)

-   **Грег Янг (Greg Young). Документы CQRS**
    [*https://cqrs.files.wordpress.com/2010/11/cqrs\_documents.pdf*](https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf)

-   **Грег Янг (Greg Young). CQRS, пользовательские интерфейсы на основе задач и порождение событий**
    [*http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/*](http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/)

-   **Уди Дахан (Udi Dahan). Пояснение по CQRS**
    [*http://udidahan.com/2009/12/09/clarified-cqrs/*](http://udidahan.com/2009/12/09/clarified-cqrs/)

-   **CQRS**
    [*http://udidahan.com/2009/12/09/clarified-cqrs/*](http://udidahan.com/2009/12/09/clarified-cqrs/)

-   **Порождение событий (ES)**
    [*http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/*](http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/)


>[!div class="step-by-step"]
[Назад] (apply-simplified-microservice-cqrs-ddd-patterns.md) [Далее] (cqrs-microservice-reads.md)
