---
title: "Практическое руководство. Использование JoinBlock для чтения данных из нескольких источников"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Task Parallel Library, dataflows
- TPL dataflow library, joining blocks in
- dataflow blocks, joining in TPL
ms.assetid: e9c1ada4-ac57-4704-87cb-2f5117f8151d
caps.latest.revision: "7"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.openlocfilehash: 41445e4874b94809840ecf9ebda6f27ccc955c9b
ms.sourcegitcommit: bd1ef61f4bb794b25383d3d72e71041a5ced172e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/18/2017
---
# <a name="how-to-use-joinblock-to-read-data-from-multiple-sources"></a><span data-ttu-id="acffe-102">Практическое руководство. Использование JoinBlock для чтения данных из нескольких источников</span><span class="sxs-lookup"><span data-stu-id="acffe-102">How to: Use JoinBlock to Read Data From Multiple Sources</span></span>
<span data-ttu-id="acffe-103">В этом документе объясняется, как использовать класс <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> для выполнения операции, если данные доступны из нескольких источников.</span><span class="sxs-lookup"><span data-stu-id="acffe-103">This document explains how to use the <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> class to perform an operation when data is available from multiple sources.</span></span> <span data-ttu-id="acffe-104">Также здесь показано, как использовать нежадный режим, чтобы разрешить нескольким блокам соединения совместно использовать источник данных более эффективно.</span><span class="sxs-lookup"><span data-stu-id="acffe-104">It also demonstrates how to use non-greedy mode to enable multiple join blocks to share a data source more efficiently.</span></span>  
  
> [!TIP]
>  <span data-ttu-id="acffe-105">Библиотека потоков данных TPL (пространство имен <xref:System.Threading.Tasks.Dataflow?displayProperty=nameWithType>) не поставляется с [!INCLUDE[net_v45](../../../includes/net-v45-md.md)].</span><span class="sxs-lookup"><span data-stu-id="acffe-105">The TPL Dataflow Library (<xref:System.Threading.Tasks.Dataflow?displayProperty=nameWithType> namespace) is not distributed with the [!INCLUDE[net_v45](../../../includes/net-v45-md.md)].</span></span> <span data-ttu-id="acffe-106">Чтобы установить <xref:System.Threading.Tasks.Dataflow> пространства имен, откройте проект в [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], выберите **управление пакетами NuGet** меню проекта и выполните поиск в Интернете `Microsoft.Tpl.Dataflow` пакета.</span><span class="sxs-lookup"><span data-stu-id="acffe-106">To install the <xref:System.Threading.Tasks.Dataflow> namespace, open your project in [!INCLUDE[vs_dev11_long](../../../includes/vs-dev11-long-md.md)], choose **Manage NuGet Packages** from the Project menu, and search online for the `Microsoft.Tpl.Dataflow` package.</span></span>  
  
## <a name="example"></a><span data-ttu-id="acffe-107">Пример</span><span class="sxs-lookup"><span data-stu-id="acffe-107">Example</span></span>  
 <span data-ttu-id="acffe-108">В следующем примере определяется три типа ресурсов: `NetworkResource`, `FileResource` и `MemoryResource`, и выполняются операции, когда ресурсы становятся доступными.</span><span class="sxs-lookup"><span data-stu-id="acffe-108">The following example defines three resource types, `NetworkResource`, `FileResource`, and `MemoryResource`, and performs operations when resources become available.</span></span> <span data-ttu-id="acffe-109">В этом примере требуется пара `NetworkResource` и `MemoryResource` для выполнения первой операции и пара `FileResource` и `MemoryResource` для выполнения второй операции.</span><span class="sxs-lookup"><span data-stu-id="acffe-109">This example requires a `NetworkResource` and `MemoryResource` pair in order to perform the first operation and a `FileResource` and `MemoryResource` pair in order to perform the second operation.</span></span> <span data-ttu-id="acffe-110">Чтобы позволить выполнение этих операций, когда доступны все необходимые ресурсы, в этом примере используется класс <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="acffe-110">To enable these operations to occur when all required resources are available, this example uses the <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> class.</span></span> <span data-ttu-id="acffe-111">Если объект <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> получает данные из всех источников, он распространяет эти данные по целевым объектам, в этом примере — объекту <xref:System.Threading.Tasks.Dataflow.ActionBlock%601>.</span><span class="sxs-lookup"><span data-stu-id="acffe-111">When a <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> object receives data from all sources, it propagates that data to its target, which in this example is an <xref:System.Threading.Tasks.Dataflow.ActionBlock%601> object.</span></span> <span data-ttu-id="acffe-112">Оба объекта <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> выполняют чтение из общего пула объектов `MemoryResource`.</span><span class="sxs-lookup"><span data-stu-id="acffe-112">Both <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> objects read from a shared pool of `MemoryResource` objects.</span></span>  
  
 [!code-csharp[TPLDataflow_NonGreedyJoin#1](../../../samples/snippets/csharp/VS_Snippets_Misc/tpldataflow_nongreedyjoin/cs/nongreedyjoin.cs#1)]
 [!code-vb[TPLDataflow_NonGreedyJoin#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpldataflow_nongreedyjoin/vb/nongreedyjoin.vb#1)]  
  
 <span data-ttu-id="acffe-113">Чтобы включить рациональное использование общего пула объектов `MemoryResource`, в этом примере определяется объект <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions>, у которого свойству <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions.Greedy%2A> задано значение `False`, для создания объектов <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>, действующих в нежадном режиме.</span><span class="sxs-lookup"><span data-stu-id="acffe-113">To enable efficient use of the shared pool of `MemoryResource` objects, this example specifies a <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions> object that has the <xref:System.Threading.Tasks.Dataflow.GroupingDataflowBlockOptions.Greedy%2A> property set to `False` to create <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> objects that act in non-greedy mode.</span></span> <span data-ttu-id="acffe-114">Нежадный блок соединения откладывает все входящие сообщения до тех пор, пока значение не станет доступно из каждого источника.</span><span class="sxs-lookup"><span data-stu-id="acffe-114">A non-greedy join block postpones all incoming messages until one is available from each source.</span></span> <span data-ttu-id="acffe-115">Если какое-либо из отложенных сообщений, принято другим блоком, блок соединения перезапускает процесс.</span><span class="sxs-lookup"><span data-stu-id="acffe-115">If any of the postponed messages were accepted by another block, the join block restarts the process.</span></span> <span data-ttu-id="acffe-116">Нежадный режим позволяет блокам соединения, которые совместно используют один или несколько блоков источника, выполнять работу, пока другие блоки ожидают данных.</span><span class="sxs-lookup"><span data-stu-id="acffe-116">Non-greedy mode enables join blocks that share one or more source blocks to make forward progress as the other blocks wait for data.</span></span> <span data-ttu-id="acffe-117">В этом примере, если объект `MemoryResource` добавляется в пул `memoryResources`, первый блок соединения для получения его второго источника данных может выполняться.</span><span class="sxs-lookup"><span data-stu-id="acffe-117">In this example, if a `MemoryResource` object is added to the `memoryResources` pool, the first join block to receive its second data source can make forward progress.</span></span> <span data-ttu-id="acffe-118">Если бы в этом примере использовался жадный режим, устанавливаемый по умолчанию, один блок соединения мог бы занять объект `MemoryResource` и ожидать, пока второй ресурс не станет доступным.</span><span class="sxs-lookup"><span data-stu-id="acffe-118">If this example were to use greedy mode, which is the default, one join block might take the `MemoryResource` object and wait for the second resource to become available.</span></span> <span data-ttu-id="acffe-119">Однако, если для другого блока соединения доступен второй источник данных, он не может выполняться, поскольку объект `MemoryResource` был занят другим блоком соединения.</span><span class="sxs-lookup"><span data-stu-id="acffe-119">However, if the other join block has its second data source available, it cannot make forward progress because the `MemoryResource` object has been taken by the other join block.</span></span>  
  
## <a name="compiling-the-code"></a><span data-ttu-id="acffe-120">Компиляция кода</span><span class="sxs-lookup"><span data-stu-id="acffe-120">Compiling the Code</span></span>  
 <span data-ttu-id="acffe-121">Скопируйте код примера и вставьте его в проект Visual Studio или в файл с именем `DataflowNonGreedyJoin.cs` (`DataflowNonGreedyJoin.vb` для [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), затем выполните в окне командной строки Visual Studio следующую команду.</span><span class="sxs-lookup"><span data-stu-id="acffe-121">Copy the example code and paste it in a Visual Studio project, or paste it in a file that is named `DataflowNonGreedyJoin.cs` (`DataflowNonGreedyJoin.vb` for [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]), and then run the following command in a Visual Studio Command Prompt window.</span></span>  
  
 [!INCLUDE[csprcs](../../../includes/csprcs-md.md)]  
  
 <span data-ttu-id="acffe-122">**CSC.exe /r:System.Threading.Tasks.Dataflow.dll DataflowNonGreedyJoin.cs**</span><span class="sxs-lookup"><span data-stu-id="acffe-122">**csc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowNonGreedyJoin.cs**</span></span>  
  
 [!INCLUDE[vbprvb](../../../includes/vbprvb-md.md)]  
  
 <span data-ttu-id="acffe-123">**vbc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowNonGreedyJoin.vb**</span><span class="sxs-lookup"><span data-stu-id="acffe-123">**vbc.exe /r:System.Threading.Tasks.Dataflow.dll DataflowNonGreedyJoin.vb**</span></span>  
  
## <a name="robust-programming"></a><span data-ttu-id="acffe-124">Отказоустойчивость</span><span class="sxs-lookup"><span data-stu-id="acffe-124">Robust Programming</span></span>  
 <span data-ttu-id="acffe-125">Использование нежадных соединений также может помочь предотвратить взаимоблокировку в приложении.</span><span class="sxs-lookup"><span data-stu-id="acffe-125">The use of non-greedy joins can also help you prevent deadlock in your application.</span></span> <span data-ttu-id="acffe-126">В приложении программного обеспечения *взаимоблокировки* возникает, когда два или несколько процессов каждая удерживает ресурс и ожидает освобождения другого ресурса другим процессом.</span><span class="sxs-lookup"><span data-stu-id="acffe-126">In a software application, *deadlock* occurs when two or more processes each hold a resource and mutually wait for another process to release some other resource.</span></span> <span data-ttu-id="acffe-127">Рассмотрим приложение, определяющее два объекта <xref:System.Threading.Tasks.Dataflow.JoinBlock%602>.</span><span class="sxs-lookup"><span data-stu-id="acffe-127">Consider an application that defines two <xref:System.Threading.Tasks.Dataflow.JoinBlock%602> objects.</span></span> <span data-ttu-id="acffe-128">Оба объекта считывают данные из двух общих блоков источника.</span><span class="sxs-lookup"><span data-stu-id="acffe-128">Both objects each read data from two shared source blocks.</span></span> <span data-ttu-id="acffe-129">В жадном режиме, если один блок соединения считывает из первого источника, а второй блок соединения считывает из второго источника, в приложении может произойти взаимоблокировка, поскольку оба блока соединения ожидают освобождения ресурса другим блоком.</span><span class="sxs-lookup"><span data-stu-id="acffe-129">In greedy mode, if one join block reads from the first source and the second join block reads from the second source, the application might deadlock because both join blocks mutually wait for the other to release its resource.</span></span> <span data-ttu-id="acffe-130">В нежадном режиме каждый блок соединения считывает из своих источников, только если все данные доступны, и таким образом устраняется риск взаимоблокировки.</span><span class="sxs-lookup"><span data-stu-id="acffe-130">In non-greedy mode, each join block reads from its sources only when all data is available, and therefore, the risk of deadlock is eliminated.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="acffe-131">См. также</span><span class="sxs-lookup"><span data-stu-id="acffe-131">See Also</span></span>  
 [<span data-ttu-id="acffe-132">Поток данных</span><span class="sxs-lookup"><span data-stu-id="acffe-132">Dataflow</span></span>](../../../docs/standard/parallel-programming/dataflow-task-parallel-library.md)
