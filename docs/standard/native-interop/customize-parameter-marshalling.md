---
title: Настройка маршалинга параметров — .NET
description: Из этой статьи вы узнаете, как настроить способ, с помощью которого .NET маршалирует ваши параметры в собственное представление.
author: jkoritzinsky
ms.author: jekoritz
ms.date: 01/18/2019
ms.openlocfilehash: 7821da546e0ed0ab5fa97d00a638aa5cc1a3089c
ms.sourcegitcommit: b56d59ad42140d277f2acbd003b74d655fdbc9f1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/19/2019
ms.locfileid: "56411426"
---
# <a name="customizing-parameter-marshalling"></a><span data-ttu-id="e60d8-103">Настройка маршалинга параметров</span><span class="sxs-lookup"><span data-stu-id="e60d8-103">Customizing parameter marshalling</span></span>

<span data-ttu-id="e60d8-104">Если маршалинг параметров по умолчанию в среде выполнения .NET не отвечает вашим требованиям, можно настроить маршалинг параметров с помощью атрибута <xref:System.Runtime.InteropServices.MarshalAsAttribute?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e60d8-104">When the .NET runtime's default parameter marshalling behavior doesn't do what you want, use can use the <xref:System.Runtime.InteropServices.MarshalAsAttribute?displayProperty=nameWithType> attribute to customize how your parameters are marshaled.</span></span>

## <a name="customizing-string-parameters"></a><span data-ttu-id="e60d8-105">Настройка параметров строки</span><span class="sxs-lookup"><span data-stu-id="e60d8-105">Customizing string parameters</span></span>

<span data-ttu-id="e60d8-106">Среда выполнения .NET предусматривает различные форматы для маршалинга строк.</span><span class="sxs-lookup"><span data-stu-id="e60d8-106">.NET has a variety of formats for marshalling strings.</span></span> <span data-ttu-id="e60d8-107">Эти методы разбиты на две группы: строки в стиле C и форматы строк, ориентированные на Windows.</span><span class="sxs-lookup"><span data-stu-id="e60d8-107">These methods are split into distinct sections on C-style strings and Windows-centric string formats.</span></span>

### <a name="c-style-strings"></a><span data-ttu-id="e60d8-108">Строки в стиле C</span><span class="sxs-lookup"><span data-stu-id="e60d8-108">C-Style strings</span></span>

<span data-ttu-id="e60d8-109">Каждый из этих форматов передает строку, которая оканчивается значением NULL, в машинный код.</span><span class="sxs-lookup"><span data-stu-id="e60d8-109">Each of these formats passes a null-terminated string to native code.</span></span> <span data-ttu-id="e60d8-110">Они различаются кодировкой собственной строки.</span><span class="sxs-lookup"><span data-stu-id="e60d8-110">They differ by the encoding of the native string.</span></span>

| <span data-ttu-id="e60d8-111">Значение`System.Runtime.InteropServices.UnmanagedType` </span><span class="sxs-lookup"><span data-stu-id="e60d8-111">`System.Runtime.InteropServices.UnmanagedType` value</span></span> | <span data-ttu-id="e60d8-112">кодировка</span><span class="sxs-lookup"><span data-stu-id="e60d8-112">Encoding</span></span> |
|------------------------------------------------------|----------|
| <span data-ttu-id="e60d8-113">LPStr</span><span class="sxs-lookup"><span data-stu-id="e60d8-113">LPStr</span></span> | <span data-ttu-id="e60d8-114">ANSI</span><span class="sxs-lookup"><span data-stu-id="e60d8-114">ANSI</span></span> |
| <span data-ttu-id="e60d8-115">LPUTF8Str</span><span class="sxs-lookup"><span data-stu-id="e60d8-115">LPUTF8Str</span></span> | <span data-ttu-id="e60d8-116">UTF-8</span><span class="sxs-lookup"><span data-stu-id="e60d8-116">UTF-8</span></span> | 
| <span data-ttu-id="e60d8-117">LPWSTR</span><span class="sxs-lookup"><span data-stu-id="e60d8-117">LPWStr</span></span> | <span data-ttu-id="e60d8-118">UTF-16</span><span class="sxs-lookup"><span data-stu-id="e60d8-118">UTF-16</span></span> |

<span data-ttu-id="e60d8-119">Формат <xref:System.Runtime.InteropServices.UnmanagedType.VBByRefStr?displayProperty=nameWithType> немного отличается.</span><span class="sxs-lookup"><span data-stu-id="e60d8-119">The <xref:System.Runtime.InteropServices.UnmanagedType.VBByRefStr?displayProperty=nameWithType> format is slightly different.</span></span> <span data-ttu-id="e60d8-120">Как и `LPWStr`, он маршалирует строку в собственную строку в стиле C с кодировкой UTF-16.</span><span class="sxs-lookup"><span data-stu-id="e60d8-120">Like `LPWStr`, it marshals the string to a native C-style string encoded in UTF-16.</span></span> <span data-ttu-id="e60d8-121">Но управляемая сигнатура требует передавать строку по ссылке, а соответствующая собственная сигнатура принимает строку по значению.</span><span class="sxs-lookup"><span data-stu-id="e60d8-121">However, the managed signature has you pass in the string by reference and the matching native signature takes the string by value.</span></span> <span data-ttu-id="e60d8-122">Это различие позволяет использовать собственный API, который принимает строку по значению и меняет ее на месте без необходимости использования `StringBuilder`.</span><span class="sxs-lookup"><span data-stu-id="e60d8-122">This distinction allows you to use a native API that takes a string by value and modifies it in-place without having to use a `StringBuilder`.</span></span> <span data-ttu-id="e60d8-123">Мы не рекомендуем использовать этот формат вручную, так как он может вызывать путаницу из-за несоответствия собственных и управляемых сигнатур.</span><span class="sxs-lookup"><span data-stu-id="e60d8-123">We recommend against manually using this format since it's prone to cause confusion with the mismatching native and managed signatures.</span></span>

### <a name="windows-centric-string-formats"></a><span data-ttu-id="e60d8-124">Форматы строк, ориентированные на Windows</span><span class="sxs-lookup"><span data-stu-id="e60d8-124">Windows-centric string formats</span></span>

<span data-ttu-id="e60d8-125">Взаимодействуя с интерфейсами COM или OLE, вы, скорее всего, заметите, что собственные функции принимают строки как аргументы `BSTR`.</span><span class="sxs-lookup"><span data-stu-id="e60d8-125">When interacting with COM or OLE interfaces, you'll likely find that the native functions take strings as `BSTR` arguments.</span></span> <span data-ttu-id="e60d8-126">Вы можете использовать неуправляемый тип <xref:System.Runtime.InteropServices.UnmanagedType.BStr?displayProperty=nameWithType>, чтобы маршалировать строку как `BSTR`.</span><span class="sxs-lookup"><span data-stu-id="e60d8-126">You can use the <xref:System.Runtime.InteropServices.UnmanagedType.BStr?displayProperty=nameWithType> unmanaged type to marshal a string as a `BSTR`.</span></span>

<span data-ttu-id="e60d8-127">Если вы взаимодействуете с API WinRT, вы можете использовать формат <xref:System.Runtime.InteropServices.UnmanagedType.HString?displayProperty=nameWithType>, чтобы маршалировать строку как `HSTRING`.</span><span class="sxs-lookup"><span data-stu-id="e60d8-127">If you're interacting with WinRT APIs, you can use the <xref:System.Runtime.InteropServices.UnmanagedType.HString?displayProperty=nameWithType> format to marshal a string as an `HSTRING`.</span></span>

## <a name="customizing-array-parameters"></a><span data-ttu-id="e60d8-128">Настройка параметров массива</span><span class="sxs-lookup"><span data-stu-id="e60d8-128">Customizing array parameters</span></span>

<span data-ttu-id="e60d8-129">В среде выполнения .NET можно маршалировать параметры массива несколькими способами.</span><span class="sxs-lookup"><span data-stu-id="e60d8-129">.NET also provides you multiple ways to marshal array parameters.</span></span> <span data-ttu-id="e60d8-130">При вызове API, который принимает массив в стиле C, используйте неуправляемый тип <xref:System.Runtime.InteropServices.UnmanagedType.LPArray?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e60d8-130">If you're calling an API that takes a C-style array, use the <xref:System.Runtime.InteropServices.UnmanagedType.LPArray?displayProperty=nameWithType> unmanaged type.</span></span> <span data-ttu-id="e60d8-131">Если для значений в массиве необходимо настроить маршалинг, используйте для этого поле <xref:System.Runtime.InteropServices.MarshalAsAttribute.ArraySubType> в атрибуте `[MarshalAs]`.</span><span class="sxs-lookup"><span data-stu-id="e60d8-131">If the values in the array need customized marshalling, you can use the <xref:System.Runtime.InteropServices.MarshalAsAttribute.ArraySubType> field on the `[MarshalAs]` attribute for that.</span></span>

<span data-ttu-id="e60d8-132">Если вы используете API COM, вам, скорее всего, придется маршалировать свои параметры массивов как `SAFEARRAY*`.</span><span class="sxs-lookup"><span data-stu-id="e60d8-132">If you're using COM APIs, you'll likely have to marshal your array parameters as `SAFEARRAY*`s.</span></span> <span data-ttu-id="e60d8-133">Для этого можно использовать неуправляемый тип <xref:System.Runtime.InteropServices.UnmanagedType.SafeArray?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e60d8-133">To do so, you can use the <xref:System.Runtime.InteropServices.UnmanagedType.SafeArray?displayProperty=nameWithType> unmanaged type.</span></span> <span data-ttu-id="e60d8-134">Тип по умолчанию для элементов `SAFEARRAY` можно посмотреть в таблице с информацией по [настройке полей `object`](./customize-struct-marshalling.md#marshalling-systemobjects).</span><span class="sxs-lookup"><span data-stu-id="e60d8-134">The default type of the elements of the `SAFEARRAY` can be seen in the table on [customizing `object` fields](./customize-struct-marshalling.md#marshalling-systemobjects).</span></span> <span data-ttu-id="e60d8-135">Чтобы настроить точный тип элемента для `SAFEARRAY`, используйте поля <xref:System.Runtime.InteropServices.MarshalAsAttribute.SafeArraySubType?displayProperty=nameWithType> и <xref:System.Runtime.InteropServices.MarshalAsAttribute.SafeArrayUserDefinedSubType?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e60d8-135">You can use the <xref:System.Runtime.InteropServices.MarshalAsAttribute.SafeArraySubType?displayProperty=nameWithType> and <xref:System.Runtime.InteropServices.MarshalAsAttribute.SafeArrayUserDefinedSubType?displayProperty=nameWithType> fields to customize the exact element type of the `SAFEARRAY`.</span></span>

## <a name="customizing-boolean-or-decimal-parameters"></a><span data-ttu-id="e60d8-136">Настройка параметров логических значений или десятичных чисел</span><span class="sxs-lookup"><span data-stu-id="e60d8-136">Customizing boolean or decimal parameters</span></span>

<span data-ttu-id="e60d8-137">Сведения о маршалинге параметров логических значений или десятичных чисел см. в статье [Customizing structure marshalling](customize-struct-marshalling.md) (Настройка маршалинга структуры).</span><span class="sxs-lookup"><span data-stu-id="e60d8-137">For information on marshalling boolean or decimal parameters, see [Customizing structure marshalling](customize-struct-marshalling.md).</span></span>

## <a name="customizing-object-parameters-windows-only"></a><span data-ttu-id="e60d8-138">Настройка параметров объекта (только для Windows)</span><span class="sxs-lookup"><span data-stu-id="e60d8-138">Customizing object parameters (Windows-only)</span></span>

<span data-ttu-id="e60d8-139">В системе Windows среда выполнения .NET предусматривает несколько способов маршалинга параметров объекта в машинный код.</span><span class="sxs-lookup"><span data-stu-id="e60d8-139">On Windows, the .NET runtime provides a number of different ways to marshal object parameters to native code.</span></span>

### <a name="marshalling-as-specific-com-interfaces"></a><span data-ttu-id="e60d8-140">Маршалинг в виде конкретных COM-интерфейсов</span><span class="sxs-lookup"><span data-stu-id="e60d8-140">Marshalling as specific COM interfaces</span></span>

<span data-ttu-id="e60d8-141">Если ваш API принимает указатель на COM-объект, вы можете использовать любой из следующих форматов `UnmanagedType` с параметром типа `object`, чтобы среда выполнения .NET выполняла маршалинг в виде этих конкретных интерфейсов:</span><span class="sxs-lookup"><span data-stu-id="e60d8-141">If your API takes a pointer to a COM object, you can use any of the following `UnmanagedType` formats on an `object`-typed parameter to tell .NET to marshal as these specific interfaces:</span></span>

- `IUnknown`
- `IDispatch`
- `IInspectable`

<span data-ttu-id="e60d8-142">Кроме того, если тип обозначен как `[ComVisible(true)]` или маршалируется тип `object`, можно использовать формат <xref:System.Runtime.InteropServices.UnmanagedType.Interface?displayProperty=nameWithType>, чтобы маршалировать объект как вызываемую оболочку COM для просмотра типа из COM.</span><span class="sxs-lookup"><span data-stu-id="e60d8-142">Additionally, if your type is marked `[ComVisible(true)]` or you're marshalling the `object` type, you can use the <xref:System.Runtime.InteropServices.UnmanagedType.Interface?displayProperty=nameWithType> format to marshal your object as a COM callable wrapper for the COM view of your type.</span></span>

### <a name="marshalling-to-a-variant"></a><span data-ttu-id="e60d8-143">Маршалинг в `VARIANT`</span><span class="sxs-lookup"><span data-stu-id="e60d8-143">Marshalling to a `VARIANT`</span></span>

<span data-ttu-id="e60d8-144">Если ваш собственный API принимает `VARIANT` Win32, можно использовать формат <xref:System.Runtime.InteropServices.UnmanagedType.Struct?displayProperty=nameWithType> с параметром `object` для маршалинга объектов в виде `VARIANT`.</span><span class="sxs-lookup"><span data-stu-id="e60d8-144">If your native API takes a Win32 `VARIANT`, you can use the <xref:System.Runtime.InteropServices.UnmanagedType.Struct?displayProperty=nameWithType> format on your `object` parameter to marshal your objects as `VARIANT`s.</span></span> <span data-ttu-id="e60d8-145">Дополнительные сведения о сопоставлении типов NET и `VARIANT` см. в документации по [настройке полей `object`](customize-struct-marshalling.md#marshalling-systemobjects).</span><span class="sxs-lookup"><span data-stu-id="e60d8-145">See the documentation on [customizing `object` fields](customize-struct-marshalling.md#marshalling-systemobjects) for a mapping between .NET types and `VARIANT` types.</span></span>

### <a name="custom-marshalers"></a><span data-ttu-id="e60d8-146">Пользовательские маршалеры</span><span class="sxs-lookup"><span data-stu-id="e60d8-146">Custom marshalers</span></span>

<span data-ttu-id="e60d8-147">Если необходимо проецировать собственный COM-интерфейс в другой управляемый тип, используйте формат `UnmanagedType.CustomMarshaler` и реализацию <xref:System.Runtime.InteropServices.ICustomMarshaler>, чтобы указать свой пользовательский код маршалинга.</span><span class="sxs-lookup"><span data-stu-id="e60d8-147">If you want to project a native COM interface into a different managed type, you can use the `UnmanagedType.CustomMarshaler` format and an implementation of <xref:System.Runtime.InteropServices.ICustomMarshaler> to provide your own custom marshalling code.</span></span>
