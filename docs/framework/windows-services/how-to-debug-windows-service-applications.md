---
title: "How to: Debug Windows Service Applications | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-clr"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "debugging Windows Service applications"
  - "debugging [Visual Studio], Windows services"
  - "Windows NT services, debugging"
  - "Windows Service applications, debugging"
  - "services, debugging"
ms.assetid: 63ab0800-0f05-4f1e-88e6-94c73fd920a2
caps.latest.revision: 16
author: "ghogen"
ms.author: "ghogen"
manager: "douge"
caps.handback.revision: 16
---
# How to: Debug Windows Service Applications
Служба должна запускаться из диспетчера управления службами, а не из Visual Studio.  Поэтому, процесс отладки службы сложнее, чем отладка приложений Visual Studio других типов.  Для отладки службы необходимо запустить службу, а затем подключить отладчик к процессу, в котором она выполняется.  Приложение можно отлаживать с помощью всех стандартных средств отладки Visual Studio.  
  
> [!CAUTION]
>  Не следует присоединять к процессу, если неизвестно, что собой представляет данный процесс, и неясны последствия подключения к процессу \(включая даже уничтожение этого процесса\).  Например, при подключении к процессу WinLogon и последующей остановке процесса отладки система будет остановлена, так как она не может работать без данного процесса.  
  
 Отладчик можно прикреплять только к выполняющейся службе.  Процесс подключения прерывает текущую работу службы \(фактически он не останавливает и не приостанавливает ее\).  То есть, если служба уже выполнялась на момент запуска процесса отладки, она по\-прежнему технически находится в состоянии "Started" в ходе отладки, однако ее работа приостанавливается.  
  
 После присоединения к процессу можно установить точки останова и использовать их для отладки кода.  После выхода из диалогового окна, используемого для подключения к процессу, вы продолжаете оставаться в режиме отладки.  Для запуска, остановки, приостановки и продолжения работы служб \(то есть, попадания в заданные точки\) можно использовать диспетчер управления службами.  Позднее эту фиктивную службу можно удалить после успешного завершения отладки.  
  
 В этой статье рассматривается процесс отладки службы, выполняемой на локальном компьютере \(также можно выполнять отладку служб Windows, которые выполняются на удаленном компьютере\).  См. раздел [Удаленная отладка](../Topic/Remote%20Debugging.md).  
  
> [!NOTE]
>  Процесс отладки метода <xref:System.ServiceProcess.ServiceBase.OnStart%2A> может быть сложным, так как диспетчер управления службами накладывает ограничение в 30 секунд на все попытки запуска службы.  Дополнительные сведения см. в разделе [Troubleshooting: Debugging Windows Services](../../../docs/framework/windows-services/troubleshooting-debugging-windows-services.md).  
  
> [!WARNING]
>  Для получения значимой информации для отладки отладчик Visual Studio должен найти файлы символов для двоичных файлов, для которых выполняется отладка.  При отладке службы, созданной в Visual Studio, файлы символов \(PDB\-файлы\) находятся в той же папке, что и исполняемый файл или библиотека, и отладчик загружает их автоматически.  При отладке службы, которая не была построена, сначала следует найти символы для службы и убедиться, что они могут быть найдены отладчиком.  См. раздел [Указание файлов символов \(.pdb\) и файлов с исходным кодом](../Topic/Specify%20Symbol%20\(.pdb\)%20and%20Source%20Files%20in%20the%20Visual%20Studio%20Debugger.md).  Если вы выполняете отладку системного процесса или хотите иметь символы для системных вызовов в своих службах, то необходимо добавить серверы символов Майкрософт.  См. раздел [Символы отладки](http://msdn.microsoft.com/windows/desktop/ee416588.aspx).  
  
### Отладка службы  
  
1.  Постройте службу в конфигурации отладки.  
  
2.  Установите службу.  Дополнительные сведения см. в разделе [How to: Install and Uninstall Services](../../../docs/framework/windows-services/how-to-install-and-uninstall-services.md).  
  
3.  Запустите службу из **диспетчера управления службами**, **обозревателя серверов** или из кода.  Дополнительные сведения см. в разделе [How to: Start Services](../../../docs/framework/windows-services/how-to-start-services.md).  
  
4.  Запустите Visual Studio с учетными данными администратора, чтобы вы могли подключиться к системным процессам.  
  
5.  \(Необязательно\) В строке меню Visual Studio выберите **Инструменты**, **Параметры**.  В диалоговом окне **Параметры** выберите **Отладка**, **Символы**, установите флажок **Серверы символов Microsoft** и нажмите кнопку **OK**.  
  
6.  В строке меню выберите пункт **Присоединиться к процессу** в меню **Отладка** или **Инструменты**.  \(Комбинация клавиш: Ctrl\+Alt\+P\)  
  
     Появляется диалоговое окно **Процессы**.  
  
7.  Установите флажок **Показать процессы, запущенные всеми пользователями**.  
  
8.  В секции **Доступные процессы** выберите процесс для службы и нажмите кнопку **Присоединение**.  
  
    > [!TIP]
    >  Процесс будет иметь то же имя, что и исполняемый файл для службы.  
  
     Откроется диалоговое окно **Присоединение к процессу**.  
  
9. Выберите соответствующие параметры, а затем нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.  
  
    > [!NOTE]
    >  Теперь вы находитесь в режиме отладки.  
  
10. Установите точки останова, которые буден нужно использовать в коде.  
  
11. Откройте диспетчер управления службами и выполните несколько операций со своей службой \(выполните команды остановки, приостановки и продолжения\), чтобы обнаружить свои точки останова.  Дополнительные сведения о запуске диспетчера управления службами см. в разделе [How to: Start Services](../../../docs/framework/windows-services/how-to-start-services.md).  Также см. раздел [Troubleshooting: Debugging Windows Services](../../../docs/framework/windows-services/troubleshooting-debugging-windows-services.md).  
  
## Советы по отладке для служб Windows  
 Присоединение к процессу службы позволяет отлаживать основную часть кода \(но не весь код\) для этой службы.  Например, так как служба уже была запущена, нельзя выполнять отладку кода в методе <xref:System.ServiceProcess.ServiceBase.OnStart%2A> службы или кода в методе `Main`, который используется для загрузки службы подобным образом.  Одним из способов обхода этого ограничения является создание временной второй службы в приложении службы, которая предназначена только для отладки.  Можно установить обе службы,а затем запустить эту фиктивную службу для загрузки процесса службы.  После того, как временная служба запустит процесс, можно использовать меню **Отладка** в Visual Studio для присоединения к процессу службы.  
  
 Попробуйте добавлять вызовы в метод <xref:System.Threading.Thread.Sleep%2A> с целью задержки выполнения действия, пока вы не присоединитесь к процессу.  
  
 Попробуйте заменить программу на обычное консольное приложение.  Для этого измените метод `Main` следующим образом, чтобы он мог быть запущен и как служба Windows, и как консольное приложение \(в зависимости от способа запуска\).  
  
#### Запуск службы Windows как консольного приложения  
  
1.  Добавьте метод в свою службу, которая запускает методы <xref:System.ServiceProcess.ServiceBase.OnStart%2A> и <xref:System.ServiceProcess.ServiceBase.OnStop%2A>:  
  
    ```  
    internal void TestStartupAndStop(string[] args)  
    {  
        this.OnStart(args);  
        Console.ReadLine();  
        this.OnStop();  
    }  
    ```  
  
2.  Перепишите метод `Main` следующим образом:  
  
    ```  
    static void Main(string[] args)  
            {  
                if (Environment.UserInteractive)  
                {  
                    MyNewService service1 = new MyNewService(args);  
                    service1.TestStartupAndStop(args);  
                }  
                else  
                {  
                    // Put the body of your old Main method here.  
                }  
    ```  
  
3.  На вкладке **Приложение** свойств проекта для параметра **Тип выходных данных** установите значение **Консольное приложение**.  
  
4.  Нажмите **Начать отладку** \(F5\).  
  
5.  Чтобы снова запустить программу как службу Windows, установите ее и запустите обычным образом \(для службы Windows\).  Отменять эти изменения необязательно.  
  
 В некоторых случаях, например, если требуется устранить некоторую проблему, которая возникает только при запуске системы, необходимо использовать отладчик Windows.  Установите [Инструменты отладки для Windows](http://msdn.microsoft.com/windows/hardware/hh852365) и прочтите раздел [Отладка служб Windows](http://support.microsoft.com/kb/824344).  
  
## См. также  
 [Introduction to Windows Service Applications](../../../docs/framework/windows-services/introduction-to-windows-service-applications.md)   
 [How to: Install and Uninstall Services](../../../docs/framework/windows-services/how-to-install-and-uninstall-services.md)   
 [How to: Start Services](../../../docs/framework/windows-services/how-to-start-services.md)   
 [Отладка службы](http://msdn.microsoft.com/library/windows/desktop/ms682546.aspx)