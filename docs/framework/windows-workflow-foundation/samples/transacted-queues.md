---
title: Транзакционные очереди
ms.date: 03/30/2017
ms.assetid: b1b011dd-5e0b-482c-9bb0-9d8727038f14
ms.openlocfilehash: db6a9686334eefb02b9360827a23ca8363127eb5
ms.sourcegitcommit: 2eceb05f1a5bb261291a1f6a91c5153727ac1c19
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/04/2018
ms.locfileid: "43535508"
---
# <a name="transacted-queues"></a><span data-ttu-id="277cd-102">Транзакционные очереди</span><span class="sxs-lookup"><span data-stu-id="277cd-102">Transacted Queues</span></span>
<span data-ttu-id="277cd-103">В этом примере показано, как объединить очереди и транзакции в Windows Workflow Foundation (WF) для создания надежных и масштабируемых служб.</span><span class="sxs-lookup"><span data-stu-id="277cd-103">This sample shows how to integrate queues and transactions in Windows Workflow Foundation (WF) to create reliable and scalable services.</span></span> <span data-ttu-id="277cd-104">Объект <!--zz <xref:System.Activities.TransactionScope>--> `System.Activities.TransactionScope` используется в рабочем процессе клиента для отправки сообщения в очередь в рамках транзакции с помощью <xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="277cd-104">A <!--zz <xref:System.Activities.TransactionScope>--> `System.Activities.TransactionScope` is used in the client workflow to send message to a queue under a transaction using the <xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="277cd-105">Область <xref:System.ServiceModel.Activities.TransactedReceiveScope> используется на сервере для получения сообщений из очереди и обновления состояния рабочего процесса в рамках той же транзакции.</span><span class="sxs-lookup"><span data-stu-id="277cd-105">A <xref:System.ServiceModel.Activities.TransactedReceiveScope> is used on the server to receive messages from the queue and update the state of the workflow under the same transaction.</span></span>  
  
## <a name="demonstrates"></a><span data-ttu-id="277cd-106">Демонстрации</span><span class="sxs-lookup"><span data-stu-id="277cd-106">Demonstrates</span></span>  
 <span data-ttu-id="277cd-107">Объекты <xref:System.Activities.Statements.TransactionScope>, <xref:System.ServiceModel.Activities.TransactedReceiveScope>, <xref:System.ServiceModel.NetMsmqBinding>, <xref:System.ServiceModel.Activities.Receive>, а также корреляция на основе содержимого.</span><span class="sxs-lookup"><span data-stu-id="277cd-107"><xref:System.Activities.Statements.TransactionScope>, <xref:System.ServiceModel.Activities.TransactedReceiveScope>, <xref:System.ServiceModel.NetMsmqBinding>, <xref:System.ServiceModel.Activities.Receive>, and content-based correlation.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="277cd-108">Обсуждение</span><span class="sxs-lookup"><span data-stu-id="277cd-108">Discussion</span></span>  
 <span data-ttu-id="277cd-109">Для демонстрации функциональности, рассматриваемой в этом образце, создается служба рабочего процесса `RewardsPoints`, которая следит за точками, приобретенными и используемыми для данной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="277cd-109">To demonstrate the features covered in this sample, a `RewardsPoints` workflow service is created, which keeps track of the points earned and used for a given account.</span></span> <span data-ttu-id="277cd-110">Клиент использует <xref:System.Activities.WorkflowInvoker> для моделирования вывода различных запросов в очередь.</span><span class="sxs-lookup"><span data-stu-id="277cd-110">The client uses <xref:System.Activities.WorkflowInvoker> to simulate posting various requests to the queue.</span></span> <span data-ttu-id="277cd-111">Для вывода сообщения в очередь в рамках транзакции действие <xref:System.ServiceModel.Activities.Send> может быть помещено в тело <xref:System.Activities.Statements.TransactionScope.Body%2A> области <xref:System.Activities.Statements.TransactionScope>.</span><span class="sxs-lookup"><span data-stu-id="277cd-111">To post a message to the queue under a transaction, the <xref:System.ServiceModel.Activities.Send> activity can be placed inside the <xref:System.Activities.Statements.TransactionScope.Body%2A> of a <xref:System.Activities.Statements.TransactionScope>.</span></span> <span data-ttu-id="277cd-112">В этом образце сначала запускается клиент, а затем сервер, что позволяет показать, как обеспечить развязку клиентских и серверных приложений с помощью сообщений, поставленных в очередь.</span><span class="sxs-lookup"><span data-stu-id="277cd-112">In this sample, the client runs first, followed by the server, to demonstrate how queued messages can decouple the client and server applications.</span></span>  
  
 <span data-ttu-id="277cd-113">После завершения работы клиента служба настраивается и размещается.</span><span class="sxs-lookup"><span data-stu-id="277cd-113">Once the client completes, the service is configured and hosted.</span></span> <span data-ttu-id="277cd-114">Как только служба открывается, она начинает обработку сообщений, которые были уже помещены в очередь.</span><span class="sxs-lookup"><span data-stu-id="277cd-114">As soon as it opens, it starts processing the messages that have already been placed in the queue.</span></span> <span data-ttu-id="277cd-115">Получение и обработка каждого сообщения происходит в рамках одной и той же серверной транзакции.</span><span class="sxs-lookup"><span data-stu-id="277cd-115">Each message is received and processed under the same server transaction.</span></span> <span data-ttu-id="277cd-116">В этом образце первым полученным сообщением является запрос `CreateAccount`, который создает экземпляр и инициализирует корреляцию содержимого на основе имени учетной записи, переданной как часть сообщения запроса.</span><span class="sxs-lookup"><span data-stu-id="277cd-116">In this sample, the first message received is a `CreateAccount` request that creates the instance and initializes the content correlation based on the account name passed as part of the request message.</span></span> <span data-ttu-id="277cd-117">Для моделирования разновидности службы, которая могла бы встретиться в реальном мире, ниже приведены два действия <xref:System.ServiceModel.Activities.TransactedReceiveScope>, которые обрабатывают сообщения `AddPoints` и `UsePoints`, помещенные в параллельные ветви цикла `while`, чтобы с их помощью можно было неоднократно обрабатывать указанные сообщения в любом порядке.</span><span class="sxs-lookup"><span data-stu-id="277cd-117">To model the kind of service you might expect in the real world, the following two <xref:System.ServiceModel.Activities.TransactedReceiveScope> activities that process the `AddPoints` and `UsePoints` messages are placed in parallel branches within a `while` loop so that they can process these messages repeatedly in any order.</span></span>  
  
 <span data-ttu-id="277cd-118">Каждый из объектов <xref:System.Activities.Statements.TransactionScope> и <xref:System.ServiceModel.Activities.TransactedReceiveScope> имеет неявную точку сохраняемости в конце своей области, поэтому использование этих действий в [!INCLUDE[wf1](../../../../includes/wf1-md.md)] в сочетании с очередями представляет собой надежный способ перемещения рабочего процесса из одного согласованного состояния в следующее с гарантией того, что сообщения никогда не потеряются.</span><span class="sxs-lookup"><span data-stu-id="277cd-118"><xref:System.Activities.Statements.TransactionScope> and <xref:System.ServiceModel.Activities.TransactedReceiveScope> each have an implicit persistence point at the end of their scopes, so using these activities in [!INCLUDE[wf1](../../../../includes/wf1-md.md)] combined with queues is a reliable way to move your workflow from one consistent state to the next, while ensuring that messages are never lost.</span></span>  
  
#### <a name="to-set-up-build-and-run-the-sample"></a><span data-ttu-id="277cd-119">Настройка, сборка и выполнение образца</span><span class="sxs-lookup"><span data-stu-id="277cd-119">To set up, build, and run the sample</span></span>  
  
1.  <span data-ttu-id="277cd-120">Установите и настройте MSMQ.</span><span class="sxs-lookup"><span data-stu-id="277cd-120">Install and configure MSMQ.</span></span> <span data-ttu-id="277cd-121">См. в разделе [сообщений](https://go.microsoft.com/fwlink/?LinkId=178526) подробные сведения.</span><span class="sxs-lookup"><span data-stu-id="277cd-121">See [Installing Message Queuing](https://go.microsoft.com/fwlink/?LinkId=178526) for details.</span></span>  
  
2.  <span data-ttu-id="277cd-122">Убедитесь, что MSDTC работает, выполнив следующую команду в командной строке.</span><span class="sxs-lookup"><span data-stu-id="277cd-122">Ensure that MSDTC is running by executing the following command on a command line.</span></span> `net start msdtc`  
  
3.  <span data-ttu-id="277cd-123">Откомпилируйте проект и откройте исполняемый файл или откройте проект в [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] и выберите параметр запуска в меню отладки.</span><span class="sxs-lookup"><span data-stu-id="277cd-123">Compile the project and open the executable, or open the project in [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] and select a start option from the debug menu.</span></span> <span data-ttu-id="277cd-124">Сначала создается очередь, затем запускается клиент и выводит сообщения в очередь, и, наконец, запускается служба, и производится обработка сообщений.</span><span class="sxs-lookup"><span data-stu-id="277cd-124">First, the queue is created, then the client runs and posts messages to the queue, and finally the service starts and the messages are processed.</span></span> <span data-ttu-id="277cd-125">Чтобы выйти из программы, нажмите клавишу ВВОД.</span><span class="sxs-lookup"><span data-stu-id="277cd-125">To exit the program, press ENTER.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="277cd-126">Образцы уже могут быть установлены на компьютере.</span><span class="sxs-lookup"><span data-stu-id="277cd-126">The samples may already be installed on your machine.</span></span> <span data-ttu-id="277cd-127">Перед продолжением проверьте следующий каталог (по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="277cd-127">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="277cd-128">Если этот каталог не существует, перейдите к [Windows Communication Foundation (WCF) и образцы Windows Workflow Foundation (WF) для .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) для загрузки всех Windows Communication Foundation (WCF) и [!INCLUDE[wf1](../../../../includes/wf1-md.md)] примеры.</span><span class="sxs-lookup"><span data-stu-id="277cd-128">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="277cd-129">Этот образец расположен в следующем каталоге.</span><span class="sxs-lookup"><span data-stu-id="277cd-129">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WF\Scenario\Transactions\TransactedQueues`
