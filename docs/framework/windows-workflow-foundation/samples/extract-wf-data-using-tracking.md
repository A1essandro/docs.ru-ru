---
title: "Извлечение данных WF с использованием отслеживания | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-4.6"
ms.reviewer: ""
ms.suite: ""
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: e30c68f5-8c6a-495a-bd20-667a4364c68e
caps.latest.revision: 14
author: "Erikre"
ms.author: "erikre"
manager: "erikre"
caps.handback.revision: 14
---
# Извлечение данных WF с использованием отслеживания
Этот образец демонстрирует использование отслеживания рабочего процесса для получения переменных и аргументов рабочего процесса из действий.Также показывается добавление заметок к записям отслеживания и извлечение полезной нагрузки данных из пользовательских записей отслеживания.В этом образце для извлечения данных из рабочего процесса используется участник отслеживания трассировки событий Windows \(ETW\).  
  
## Подробные сведения об образце  
 [!INCLUDE[wf](../../../../includes/wf-md.md)] предоставляет отслеживание для обеспечения видимости выполнения экземпляра рабочего процесса.Среда выполнения отслеживания выдает записи отслеживания рабочего процесса в ходе его выполнения.Помимо записей отслеживания рабочего процесса, из рабочего процесса можно извлекать данные, имеющиеся в экземпляре рабочего процесса.В следующем списке приводятся сведения о типах данных, которые могут быть извлечены из записей отслеживания.  
  
1.  Переменные рабочего процесса из действия и записей отслеживания во время выполнения действия.  
  
     Для извлечения переменных рабочего процесса все переменные, подлежащие извлечению, указываются в профиле.Извлекаемые переменные могут быть указаны только с использованием `ActivityStateQueries`.Следующий пример кода показывает профиль отслеживания, используемый для извлечения переменной рабочего процесса из действия.  
  
    ```xml  
    <activityStateQuery activityName="StockPriceService">  
         <states>  
              <state name="Closed"/>  
         </states>  
         <variables>  
              <variable name="symbol"/>  
         </variables>  
    </activityStateQuery>  
    ```  
  
2.  Аргументы действия и записи отслеживания состояния действия.  
  
     Аргументы определяют то, как данные попадают в действие и выходят из него.Извлекаемые аргументы задаются с использованием <xref:System.Activities.Tracking.ActivityStateQuery>. Следующий пример кода является профилем отслеживания, извлекающим аргумент `Value`.  
  
    ```xml  
    <activityStateQuery activityName="GetStockPrice">  
         <states>  
              <state name="Closed"/>  
         </states>  
         <arguments>  
              <argument name="Value"/>  
         </arguments>  
    </activityStateQuery>  
    ```  
  
3.  Заметки — это пары «ключ\-значение», которые можно добавить к любой выдаваемой записи отслеживания.  
  
     С помощью заметок записи отслеживания помечаются.Заметки добавляются к записям отслеживания через профиль отслеживания.Заметки можно добавлять к запросу отслеживания рабочего процесса любого типа.Следующий пример кода является профилем отслеживания, показывающим добавление заметки к записи отслеживания.  
  
    ```xml  
    <workflowInstanceQuery>  
         <states>  
              <state name="Started"/>  
         </states>  
         <annotations>  
              <annotation name="StockPriceWorkflow" value="Begin"/>  
         </annotations>  
    </workflowInstanceQuery>  
    ```  
  
4.  Пользовательские записи отслеживания выдаются пользовательскими действиями.  
  
     Пользовательские записи отслеживания могут переносить полезные данные, определенные в этом действии.Подписка на пользовательские записи отслеживания в профиле отслеживания позволяет извлекать полезные данные из записи отслеживания.Пользовательские записи отслеживания могут быть извлечены с помощью пользовательского запроса <xref:System.Activities.Tracking.TrackingQuery>.Следующий пример кода — это профиль отслеживания, извлекающий пользовательскую запись отслеживания вместе с ее полезными данными.  
  
    ```  
    <customTrackingQuery name="QuoteLookupEvent" activityName="GetStockPrice"/>  
    ```  
  
 Этот образец демонстрирует извлечение переменных, аргументов, пользовательских записей, а также добавление заметок с помощью профиля, заданного в файле Web.config.Отслеживание включается в образце службы рабочего процесса путем добавления элемента поведения `<etwTracking>`.Следующий пример кода включает отслеживание для профиля отслеживания `ExtractWorkflowVariables`.  
  
```  
<serviceBehaviors>  
     <behavior>  
               <etwTracking profileName="ExtractWorkflowVariables"/>  
     </behavior>  
</serviceBehaviors>  
```  
  
#### Использование этого образца  
  
1.  Откройте файл решения WFStockPriceApplication.sln в среде [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)].  
  
2.  Для построения решения нажмите CTRL\+SHIFT\+B.  
  
3.  Чтобы запустить решение, нажмите клавишу F5.  
  
     Откроется окно браузера со списком каталогов для приложения.  
  
4.  Щелкните файл StockPriceService.xamlx в браузере.  
  
5.  В браузере отображается страница StockPriceService, содержащая адрес WSDL локальной службы.Скопируйте этот адрес.  
  
     В следующем примере показывается адрес WSDL локальной службы.`http://localhost:53797/StockPriceService.xamlx?wsdl`  
  
6.  Перед запуском службы запустите средство просмотра событий и убедитесь, что журнал событий ожидает получение событий отслеживания от службы рабочего процесса.  
  
7.  В меню **Пуск** выберите пункт **Администрирование**, а затем пункт **Просмотр событий**.  
  
8.  В представлении дерева в средстве просмотра событий откройте пункт **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**.Правой кнопкой мыши щелкните пункт **Microsoft** и выберите пункт **Просмотр**, а затем **Отобразить аналитический и отладочный журналы**.  
  
     Установите флажок **Отобразить аналитический и отладочный журналы**.  
  
9. В древовидном представлении средства просмотра событий перейдите на вкладку **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows**, **Сервер приложений — приложения**.Щелкните правой кнопкой мыши пункт **Аналитический** и выберите команду **Включить журнал**.  
  
10. С помощью [!INCLUDE[fileExplorer](../../../../includes/fileexplorer-md.md)] откройте тестовый клиент WCF.  
  
     Тестовый клиент WCF \(WcfTestClient.exe\) расположен в папке \<[!INCLUDE[vs2010](../../../../includes/vs2010-md.md)]папка\_установки \>\\Common7\\IDE\\.  
  
     По умолчанию папка установки [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] имеет вид C:\\Program Files\\Microsoft Visual Studio 10.0.  
  
11. В тестовом клиенте WCF выберите в меню **Файл** команду **Добавить службу**.  
  
     Вставьте скопированный ранее адрес WSDL локальной службы в поле ввода.  
  
12. В тестовом клиенте WCF дважды щелкните `GetStockPrice`.  
  
     Откроется метод `GetStockPrice`.Запрос принимает один параметр.Используйте значение **Contoso**.  
  
13. Нажмите кнопку **Вызвать**.  
  
14. Вернитесь в средство просмотра событий и перейдите к окну **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows**, **Сервер приложений — приложения**.Щелкните правой кнопкой мыши пункт **Аналитический** и выберите команду **Обновить**.События рабочего процесса находятся в диапазонах идентификатора события 100–199.  
  
     События содержат заметки, переменные, аргументы и пользовательские записи отслеживания, которые можно просматривать в средстве просмотра событий.  
  
## Очистка в средстве просмотра событий  
 Канал аналитики в журнале событий можно очистить в средстве просмотра событий с помощью следующих действий.  
  
#### Очистка \(необязательно\)  
  
1.  Откройте средство просмотра событий.  
  
2.  Перейдите к окну **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows**, **Сервер приложений — приложения**.Щелкните правой кнопкой мыши пункт **Аналитический** и выберите команду **Отключить журнал**.  
  
3.  Перейдите к окну **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows**, **Сервер приложений — приложения**.Щелкните правой кнопкой мыши пункт **Аналитический** и выберите команду **Очистить журнал**.  
  
     Установите флажок **Очистить**, чтобы очистить события.  
  
## Известная проблема  
  
> [!NOTE]
>  В средстве просмотра событий есть известная проблема, связанная с ошибкой декодирования событий трассировки событий Windows.Может выводиться следующее сообщение об ошибке.  
>   
>  `Не удалось найти описание идентификатора события <id> в источнике Microsoft-Windows-Application Server-Applications.Возможно, компонент, вызывающий это событие, не установлен на локальном компьютере, либо установка повреждена.Компонент может быть установлен или восстановлен на локальном компьютере.`  
>   
>  При появлении этой ошибки нажмите кнопку **Обновить** в области действий.Теперь декодирование события должно выполняться правильно.  
  
> [!IMPORTANT]
>  Образцы уже могут быть установлены на компьютере.Перед продолжением проверьте следующий каталог \(по умолчанию\).  
>   
>  `<диск_установки>:\WF_WCF_Samples`  
>   
>  Если этот каталог не существует, перейдите на страницу [Образцы Windows Communication Foundation \(WCF\) и Windows Workflow Foundation \(WF\) для .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780), чтобы загрузить все образцы [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] и [!INCLUDE[wf1](../../../../includes/wf1-md.md)].Этот образец расположен в следующем каталоге.  
>   
>  `<диск_установки>:\WF_WCF_Samples\WF\Basic\Tracking\ExtractWfData`  
  
## См. также  
 [Образцы наблюдения за AppFabric](http://go.microsoft.com/fwlink/?LinkId=193959)