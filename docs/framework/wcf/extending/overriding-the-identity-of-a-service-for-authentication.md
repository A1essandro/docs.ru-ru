---
title: "Переопределение идентификатора службы для проверки подлинности"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
ms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d
caps.latest.revision: "9"
author: Erikre
ms.author: erikre
manager: erikre
ms.openlocfilehash: 6a3125504326f2cb129fef6f1f3e01dba577f599
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2017
---
# <a name="overriding-the-identity-of-a-service-for-authentication"></a><span data-ttu-id="b5b28-102">Переопределение идентификатора службы для проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="b5b28-102">Overriding the Identity of a Service for Authentication</span></span>
<span data-ttu-id="b5b28-103">Как правило, нет необходимости задавать удостоверение в службе, поскольку выбор типа учетных данных клиента определяет тип удостоверения, предоставляемого в метаданных службы.</span><span class="sxs-lookup"><span data-stu-id="b5b28-103">Typically, you do not have to set the identity on a service because the selection of a client credential type dictates the type of identity exposed in the service metadata.</span></span> <span data-ttu-id="b5b28-104">Например, следующий код конфигурации используется [ \<wsHttpBinding >](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md) элемент и задает `clientCredentialType` атрибут Windows.</span><span class="sxs-lookup"><span data-stu-id="b5b28-104">For example, the following configuration code uses the [\<wsHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md) element and sets the `clientCredentialType` attribute to Windows.</span></span>  
  
  
  
 <span data-ttu-id="b5b28-105">В следующем фрагменте WSDL (Web Services Description Language) показано удостоверение для ранее определенной конечной точки.</span><span class="sxs-lookup"><span data-stu-id="b5b28-105">The following Web Services Description Language (WSDL) fragment shows the identity for the endpoint previously defined.</span></span> <span data-ttu-id="b5b28-106">В этом примере служба выполняется под резидентной службы с учетной записью определенного пользователя (username@contoso.com) и, следовательно, удостоверение пользователя имя участника (UPN) содержится имя учетной записи.</span><span class="sxs-lookup"><span data-stu-id="b5b28-106">In this example, the service is running as a self-hosted service under a particular user account (username@contoso.com) and therefore the user principal name (UPN) identity contains the account name.</span></span> <span data-ttu-id="b5b28-107">UPN также известно как имя для входа в систему в домене Windows.</span><span class="sxs-lookup"><span data-stu-id="b5b28-107">The UPN is also known as the user logon name in a Windows domain.</span></span>  
  
  
  
 <span data-ttu-id="b5b28-108">Образец приложения, демонстрирующий удостоверение, в разделе [образец идентификации службы](../../../../docs/framework/wcf/samples/service-identity-sample.md).</span><span class="sxs-lookup"><span data-stu-id="b5b28-108">For a sample application that demonstrates identity setting, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md).</span></span> [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="b5b28-109">удостоверения службы см. в разделе [службы удостоверений и проверки подлинности](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="b5b28-109"> service identity, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span></span>  
  
## <a name="kerberos-authentication-and-identity"></a><span data-ttu-id="b5b28-110">Проверка подлинности Kerberos и удостоверение</span><span class="sxs-lookup"><span data-stu-id="b5b28-110">Kerberos Authentication and Identity</span></span>  
 <span data-ttu-id="b5b28-111">По умолчанию, когда служба настроена для использования учетных данных Windows [ \<удостоверение >](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md) элемент, содержащий [ \<userPrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md) или [ \<servicePrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md) элемент создается в WSDL.</span><span class="sxs-lookup"><span data-stu-id="b5b28-111">By default, when a service is configured to use a Windows credential, an [\<identity>](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md) element that contains a [\<userPrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md) or [\<servicePrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md) element is generated in the WSDL.</span></span> <span data-ttu-id="b5b28-112">Если служба выполняется под `LocalSystem`, `LocalService`, или `NetworkService` учетной записи, имя участника (SPN) создается по умолчанию в виде службы `host/` \< *hostname*> так как Эти учетные записи имеют доступ к данным компьютера имя участника-службы.</span><span class="sxs-lookup"><span data-stu-id="b5b28-112">If the service is running under the `LocalSystem`, `LocalService`, or `NetworkService` account, a service principal name (SPN) is generated by default in the form of `host/`\<*hostname*> because those accounts have access to the computer's SPN data.</span></span> <span data-ttu-id="b5b28-113">Если служба выполняется под другой учетной записи, [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] создает имя участника-пользователя в виде \< *username*>@<*domainName*`>`.</span><span class="sxs-lookup"><span data-stu-id="b5b28-113">If the service is running under a different account, [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] generates a UPN in the form of \<*username*>@<*domainName*`>`.</span></span> <span data-ttu-id="b5b28-114">Это происходит потому, что проверка подлинности Kerberos требует предоставления клиенту имени участника-пользователя или имени участника-службы для проверки подлинности службы.</span><span class="sxs-lookup"><span data-stu-id="b5b28-114">This occurs because Kerberos authentication requires that a UPN or SPN be supplied to the client to authenticate the service.</span></span>  
  
 <span data-ttu-id="b5b28-115">Также для регистрации дополнительного имени участника-службы с учетной записью службы в домене можно использовать средство Setspn.exe.</span><span class="sxs-lookup"><span data-stu-id="b5b28-115">You can also use the Setspn.exe tool to register an additional SPN with a service's account in a domain.</span></span> <span data-ttu-id="b5b28-116">В этом случае имя участника-службы можно использовать в качестве удостоверения службы.</span><span class="sxs-lookup"><span data-stu-id="b5b28-116">You can then use the SPN as the identity of the service.</span></span> <span data-ttu-id="b5b28-117">Загрузить средство [инструмент из комплекта ресурсов Windows 2000: Setspn.exe](http://go.microsoft.com/fwlink/?LinkId=91752).</span><span class="sxs-lookup"><span data-stu-id="b5b28-117">To download the tool, see [Windows 2000 Resource Kit Tool : Setspn.exe](http://go.microsoft.com/fwlink/?LinkId=91752).</span></span> [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="b5b28-118">средство, в разделе [Общие сведения о Setspn](http://go.microsoft.com/fwlink/?LinkId=61374).</span><span class="sxs-lookup"><span data-stu-id="b5b28-118"> the tool, see [Setspn Overview](http://go.microsoft.com/fwlink/?LinkId=61374).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="b5b28-119">Чтобы использовать тип учетных данных Windows без согласования, учетная запись пользователя службы должна иметь доступ к имени участника службы (SPN), зарегистрированному с доменом Active Directory.</span><span class="sxs-lookup"><span data-stu-id="b5b28-119">To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain.</span></span> <span data-ttu-id="b5b28-120">Это можно сделать следующими способами:</span><span class="sxs-lookup"><span data-stu-id="b5b28-120">You can do this in the following ways:</span></span>  
  
-   <span data-ttu-id="b5b28-121">Используйте учетную запись NetworkService или LocalSystem для запуска службы.</span><span class="sxs-lookup"><span data-stu-id="b5b28-121">Use the NetworkService or LocalSystem account to run your service.</span></span> <span data-ttu-id="b5b28-122">Поскольку у этих учетных записей есть право доступа к SPN компьютера, устанавливаемое при присоединении компьютера к домену Active Directory, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] автоматически создает соответствующий элемент SPN внутри конечной точки службы в метаданных службы (WSDL).</span><span class="sxs-lookup"><span data-stu-id="b5b28-122">Because those accounts have access to the machine SPN that is established when the machine joins the Active Directory domain, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] automatically generates the proper SPN element inside the service's endpoint in the service's metadata (WSDL).</span></span>  
  
-   <span data-ttu-id="b5b28-123">Запустите службу из любой учетной записи домена Active Directory.</span><span class="sxs-lookup"><span data-stu-id="b5b28-123">Use an arbitrary Active Directory domain account to run your service.</span></span> <span data-ttu-id="b5b28-124">В данном случае с помощью служебного средства Setspn.exe необходимо установить имя участника-службы для этой учетной записи домена.</span><span class="sxs-lookup"><span data-stu-id="b5b28-124">In this case, establish an SPN for that domain account, which you can do by using the Setspn.exe utility tool.</span></span> <span data-ttu-id="b5b28-125">Создав SPN для учетной записи службы, настройте [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] на публикацию этого имени участника-службы в клиентах службы через ее метаданные (WSDL).</span><span class="sxs-lookup"><span data-stu-id="b5b28-125">Once you create the SPN for the service's account, configure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to publish that SPN to the service's clients through its metadata (WSDL).</span></span> <span data-ttu-id="b5b28-126">Для этого нужно настроить удостоверение конечной точки для предоставляемой конечной точки в файле конфигурации приложения или в коде.</span><span class="sxs-lookup"><span data-stu-id="b5b28-126">This is done by setting the endpoint identity for the exposed endpoint, either through an application configuration file or code.</span></span>  
  
 [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="b5b28-127">Имена участников-служб, протокол Kerberos и Active Directory в разделе [техническое дополнение Kerberos для Windows](http://go.microsoft.com/fwlink/?LinkId=88330).</span><span class="sxs-lookup"><span data-stu-id="b5b28-127"> SPNs, the Kerberos protocol, and Active Directory, see [Kerberos Technical Supplement for Windows](http://go.microsoft.com/fwlink/?LinkId=88330).</span></span>  
  
### <a name="when-spn-or-upn-equals-the-empty-string"></a><span data-ttu-id="b5b28-128">Если имя участника-службы или имя участника-пользователя равно пустой строке</span><span class="sxs-lookup"><span data-stu-id="b5b28-128">When SPN or UPN Equals the Empty String</span></span>  
 <span data-ttu-id="b5b28-129">Если задать имя участника-службы или имя участника-пользователя равным пустой строке, возможны разные варианты развития событий в зависимости от используемых уровня безопасности и режима проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b5b28-129">If you set the SPN or UPN equal to an empty string, a number of different things happen, depending on the security level and authentication mode being used:</span></span>  
  
-   <span data-ttu-id="b5b28-130">Если используется безопасность на уровне транспорта, выбирается проверка подлинности по протоколу NT LanMan (NTLM).</span><span class="sxs-lookup"><span data-stu-id="b5b28-130">If you are using transport level security, NT LanMan (NTLM) authentication is chosen.</span></span>  
  
-   <span data-ttu-id="b5b28-131">Если используется безопасность на уровне сообщения, при проверке подлинности в зависимости от используемого режима проверки подлинности может произойти сбой.</span><span class="sxs-lookup"><span data-stu-id="b5b28-131">If you are using message level security, authentication may fail, depending on the authentication mode:</span></span>  
  
-   <span data-ttu-id="b5b28-132">Если используется режим `spnego`, а атрибуту `AllowNtlm` задано значение `false`, произойдет сбой при проверке подлинности.</span><span class="sxs-lookup"><span data-stu-id="b5b28-132">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `false`, authentication fail.</span></span>  
  
-   <span data-ttu-id="b5b28-133">Если используется режим `spnego`, а атрибуту `AllowNtlm` задано значение `true`, произойдет сбой проверки подлинности, если пусто имя участника-пользователя, и проверку подлинности удастся завершить успешно, если пусто имя участника-службы.</span><span class="sxs-lookup"><span data-stu-id="b5b28-133">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `true`, authentication fails if the UPN is empty, but succeeds if the SPN is empty.</span></span>  
  
-   <span data-ttu-id="b5b28-134">При использовании протокола Kerberos напрямую (этот процесс также известен как "одноступенчатая" проверка) происходит сбой проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="b5b28-134">If you are using Kerberos direct (also known as "one-shot"), authentication fails.</span></span>  
  
### <a name="using-the-identity-element-in-configuration"></a><span data-ttu-id="b5b28-135">С помощью \<identity > в конфигурации</span><span class="sxs-lookup"><span data-stu-id="b5b28-135">Using the \<identity> Element in Configuration</span></span>  
 <span data-ttu-id="b5b28-136">Если изменить тип учетных данных клиента в привязке, ранее показанной сертификату Certificate`,` созданный WSDL будет содержать сериализованный сертификат X.509 в кодировке Base64, соответствующий значению удостоверения, как показано в следующем примере кода.</span><span class="sxs-lookup"><span data-stu-id="b5b28-136">If you change the client credential type in the binding previously shown to Certificate`,` then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code.</span></span> <span data-ttu-id="b5b28-137">Используется по умолчанию для всех типов учетных данных клиентов, за исключением Windows.</span><span class="sxs-lookup"><span data-stu-id="b5b28-137">This is the default for all client credential types other than Windows.</span></span>  
  
  
  
 <span data-ttu-id="b5b28-138">Изменить значение заданного по умолчанию удостоверения службы или тип удостоверения можно с использованием элемента <`identity`> в конфигурации или задав удостоверение в коде.</span><span class="sxs-lookup"><span data-stu-id="b5b28-138">You can change the value of the default service identity or change the type of the identity by using the <`identity`> element in configuration or by setting the identity in code.</span></span> <span data-ttu-id="b5b28-139">В следующем коде конфигурации задается идентификатор DNS со значением `contoso.com`.</span><span class="sxs-lookup"><span data-stu-id="b5b28-139">The following configuration code sets a domain name system (DNS) identity with the value `contoso.com`.</span></span>  
  
  
  
### <a name="setting-identity-programmatically"></a><span data-ttu-id="b5b28-140">Задание удостоверения программным способом</span><span class="sxs-lookup"><span data-stu-id="b5b28-140">Setting Identity Programmatically</span></span>  
 <span data-ttu-id="b5b28-141">В службе не требуется явным образом задавать удостоверение, так как [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] определяет его автоматически.</span><span class="sxs-lookup"><span data-stu-id="b5b28-141">Your service does not have to explicitly specify an identity, because [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] automatically determines it.</span></span> <span data-ttu-id="b5b28-142">Однако при необходимости [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] позволяет задавать удостоверение в конечной точке.</span><span class="sxs-lookup"><span data-stu-id="b5b28-142">However, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] allows you to specify an identity on an endpoint, if required.</span></span> <span data-ttu-id="b5b28-143">В приведенном ниже примере кода добавляется новая конечная точка службы с определенным идентификатором DNS.</span><span class="sxs-lookup"><span data-stu-id="b5b28-143">The following code adds a new service endpoint with a specific DNS identity.</span></span>  
  
 [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]
 [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  
  
## <a name="see-also"></a><span data-ttu-id="b5b28-144">См. также</span><span class="sxs-lookup"><span data-stu-id="b5b28-144">See Also</span></span>  
 [<span data-ttu-id="b5b28-145">Как: создать средство проверки удостоверения настраиваемые</span><span class="sxs-lookup"><span data-stu-id="b5b28-145">How to: Create a Custom Client Identity Verifier</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-client-identity-verifier.md)  
 [<span data-ttu-id="b5b28-146">Службы идентификации и проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="b5b28-146">Service Identity and Authentication</span></span>](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)
