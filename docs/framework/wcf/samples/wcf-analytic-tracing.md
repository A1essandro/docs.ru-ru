---
title: "Аналитическая трассировка WCF | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-4.6"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-clr"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: 6029c7c7-3515-4d36-9d43-13e8f4971790
caps.latest.revision: 21
author: "Erikre"
ms.author: "erikre"
manager: "erikre"
caps.handback.revision: 21
---
# Аналитическая трассировка WCF
Этот образец демонстрирует способы добавления собственных событий трассировки к потоку аналитически отслеживаемых событий, которые [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] записывает в трассировке событий Windows в [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)].Аналитически отслеживаемые события предназначены для упрощения добавления видимости в службы без ущерба для производительности.Этот образец показывает, как с помощью интерфейсов <xref:System.Diagnostics.Eventing?displayProperty=fullName> API писать события, которые интегрируются со службами [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)].  
  
 [!INCLUDE[crabout](../../../../includes/crabout-md.md)] об интерфейсах <xref:System.Diagnostics.Eventing?displayProperty=fullName> API см. в разделе <xref:System.Diagnostics.Eventing?displayProperty=fullName>.  
  
 Дополнительные сведения о трассировке событий в Windows см. в разделе [Усовершенствованная отладка и настройка производительности с помощью приложения трассировки событий Windows](http://go.microsoft.com/fwlink/?LinkId=166488).  
  
## Удаление EventProvider  
 В этом образце используется класс <xref:System.Diagnostics.Eventing.EventProvider?displayProperty=fullName>, который реализует <xref:System.IDisposable?displayProperty=fullName>.При реализации трассировки для службы [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], вероятнее всего, во время существования службы будут использоваться ресурсы <xref:System.Diagnostics.Eventing.EventProvider>.По этой причине, а также для удобочитаемости, этот образец никогда не удаляет упакованный <xref:System.Diagnostics.Eventing.EventProvider>.Если по какой\-либо причине ваша служба имеет другие требования для трассировки и вы должны удалить этот ресурс, то вы должны изменить этот пример в соответствии с подходящими рекомендациями по удалению неуправляемых ресурсов.[!INCLUDE[crabout](../../../../includes/crabout-md.md)] удалении неуправляемых ресурсов см. в разделе [Реализация метода Dispose](http://go.microsoft.com/fwlink/?LinkId=166436).  
  
## Резидентное размещение в сравнении сразмещением на веб\-сервере  
 Для служб, размещенных на веб\-сервере, аналитически отслеживаемые трассировки WCF предоставляют поле «HostReference», которое используется для идентификации службы, выдающей трассировки.В этой модели могут участвовать расширяемые пользовательские трассировки, а в данном образце демонстрируются рекомендации, как это сделать.В качестве формата ссылки на веб\-узел, когда в итоговой строке имеется символ вертикальной черты «&#124;», можно использовать любой из следующих форматов.  
  
-   Если приложение находится не в корне.  
  
     \<SiteName\>\<ApplicationVirtualPath\>&#124;\<ServiceVirtualPath\>&#124;\<ServiceName\>  
  
-   Если приложение находится в корне.  
  
     \<SiteName\>&#124;\<ServiceVirtualPath\>&#124;\<ServiceName\>  
  
 Для резидентных служб аналитически отслеживаемые трассировки [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] не заполняют поле «HostReference».В этом образце класс `WCFUserEventProvider` ведет себя согласованно при использовании резидентной службой.  
  
## Данные пользовательских событий  
 Манифест поставщика событий для трассировки событий Windows [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] определяет три события, которые предназначены для выдачи авторами служб [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] из кода службы.В следующей таблице приведена разбивка этих трех событий.  
  
|Событие|Описание|Идентификатор события|  
|-------------|--------------|---------------------------|  
|UserDefinedInformationEventOccurred|Это событие выдается, когда в службе происходит что\-то примечательное, что не является проблемой.Например, можно выдать событие после успешного вызова базы данных.|301|  
|UserDefinedWarningOccurred|Это событие выдается, когда возникает проблема, которая в будущем может привести к сбою.Например, можно выдавать событие предупреждения, когда вызов базы данных завершается неудачей, но удалось выполнить восстановление, переключившись на резервное хранилище данных.|302|  
|UserDefinedErrorOccurred|Это событие выдается, когда служба не ведет себя, как положено.Например, можно выдавать событие, если вызов базы данных завершается неудачей и данные не удалось получить из другого источника.|303|  
  
#### Использование этого образца  
  
1.  Откройте файл решения WCFAnalyticTracingExtensibility.sln с помощью [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)].  
  
2.  Для построения решения нажмите CTRL\+SHIFT\+B.  
  
3.  Чтобы запустить решение, нажмите клавиши CTRL\+F5.  
  
     В веб\-браузере щелкните файл **Calculator.svc**.В браузере должен появиться URI WSDL\-документа для службы.Скопируйте этот URI.  
  
4.  Запустите тестовый клиент [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] \(WcfTestClient.exe\).  
  
     Тестовый клиент [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] \(WcfTestClient.exe\) расположен по адресу \<[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]каталог\_установки \>\\Common7\\IDE\\ WcfTestClient.exe \(по умолчанию каталог установки [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] имеет вид C:\\Program Files\\Microsoft Visual Studio 10.0\).  
  
5.  В тестовом клиенте [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] добавьте службу, выбрав в меню **Файл** команду **Добавить службу**.  
  
     Добавьте адрес конечной точки в поле ввода.  
  
6.  Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.  
  
     Служба ICalculator будет добавлена в область слева в пункт **Мои проекты служб**.  
  
7.  Откройте приложение просмотра событий.  
  
     Перед запуском службы запустите средство просмотра событий и убедитесь, что журнал событий прослушивает события отслеживания, создаваемые в службе [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)].  
  
8.  В меню **Пуск** выберите пункт **Администрирование**, а затем пункт **Просмотр событий**.Включите **Аналитический** и **Отладочный** журналы.  
  
9. В древовидном представлении средства просмотра событий перейдите последовательно к узлам **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows** и **Сервер приложений — приложения**.Щелкните правой кнопкой мыши пункт **Сервер приложений — приложения**, выберите пункт **Вид** и пункт **Отобразить аналитический и отладочный журналы**.  
  
     Установите флажок **Отобразить аналитический и отладочный журналы**.Включите **Аналитический** журнал.  
  
     В древовидном представлении средства просмотра событий перейдите на вкладку **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows** и **Сервер приложений — приложения**, а затем **Аналитика**.Щелкните правой кнопкой мыши пункт **Аналитический** и выберите команду **Включить журнал**.  
  
10. Проверьте службу с помощью тестового клиента WCF.  
  
    1.  В тестовом клиенте WCF дважды щелкните **Add\(\)** в узле службы ICalculator.  
  
         Метод **Add\(\)** с двумя параметрами появится в области справа.  
  
    2.  Введите 2 для первого параметра и 3 для второго.  
  
    3.  Нажмите кнопку **Вызвать**, чтобы вызвать метод.  
  
11. Перейдите в окно **Просмотр событий**, которое уже открыто.Перейдите к окну **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows**, **Сервер приложений — приложения**.  
  
12. Щелкните правой кнопкой мыши узел **Аналитика** и выберите команду **Обновить**.  
  
     События появятся в области справа.  
  
13. Найдите событие с идентификатором 303 и щелкните его дважды, чтобы открыть его и ознакомиться с его содержимым.  
  
     Это событие было выдано методом `Add()` службы ICalculator, и его полезная нагрузка равна «2\+3\=5».  
  
#### Очистка \(необязательно\)  
  
1.  Откройте окно **Просмотр событий**.  
  
2.  Перейдите последовательно к узлам **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows** и **Сервер приложений — приложения**.Щелкните правой кнопкой мыши пункт **Аналитический** и выберите команду **Отключить журнал**.  
  
3.  Перейдите к окну **Средство просмотра событий**, **Журналы приложений и служб**, **Microsoft**, **Windows** и **Сервер приложений — приложения**, а затем **Аналитический**.Щелкните правой кнопкой мыши пункт **Аналитический** и выберите команду **Очистить журнал**.  
  
4.  Нажмите кнопку **Очистить**, чтобы удалить события.  
  
## Известная проблема  
 В **Средстве просмотра событий** есть известная проблема, связанная с ошибкой декодирования событий трассировки событий Windows.Может появиться сообщение об ошибке: «Не удалось найти описание события с идентификатором \<id\> в исходном Microsoft\-Windows\-Application Server\-Applications.Возможно, компонент, вызывающий это событие, не установлен на локальном компьютере, либо установка повреждена.Можно установить или исправить компонент локального компьютера». При возникновении этой ошибки в меню **Действия** выберите команду **Обновить**.Теперь декодирование события должно выполняться правильно.  
  
> [!IMPORTANT]
>  Образцы уже могут быть установлены на компьютере.Перед продолжением проверьте следующий каталог \(по умолчанию\).  
>   
>  `<диск_установки>:\WF_WCF_Samples`  
>   
>  Если этот каталог не существует, перейдите на страницу [Образцы Windows Communication Foundation \(WCF\) и Windows Workflow Foundation \(WF\) для .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780), чтобы загрузить все образцы [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] и [!INCLUDE[wf1](../../../../includes/wf1-md.md)].Этот образец расположен в следующем каталоге.  
>   
>  `<диск_установки>:\WF_WCF_Samples\WCF\Basic\Management\ETWTrace`  
  
## См. также  
 [Образцы наблюдения за AppFabric](http://go.microsoft.com/fwlink/?LinkId=193959)