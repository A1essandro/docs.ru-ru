---
title: "Рекомендации по взаимодействию с использованием очередей | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-clr"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "рекомендации [WCF], взаимодействие с использованием очереди"
  - "очереди [WCF], рекомендации"
ms.assetid: 446a6383-cae3-4338-b193-a33c14a49948
caps.latest.revision: 14
author: "Erikre"
ms.author: "erikre"
manager: "erikre"
caps.handback.revision: 14
---
# Рекомендации по взаимодействию с использованием очередей
В этом разделе приведены рекомендации по взаимодействию с использованием очередей в [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)].В последующих разделах рассматриваются рекомендации с точки зрения сценариев.  
  
## Быстрый наилучший обмен сообщениями с использованием очередей  
 Для сценариев, в которых требуется разделение, обеспечиваемое обменом сообщений с использованием очередей, и быстрый высокоэффективный обмен сообщениями с гарантиями наилучшего из возможного, используйте нетранзакционную очередь и задайте для свойства <xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> значение `false`.  
  
 Дополнительно можно исключить затраты на запись на диск, задав для свойства <xref:System.ServiceModel.MsmqBindingBase.Durable%2A> значение `false`.  
  
 Безопасность влияет на производительность.[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Замечания о производительности](../../../../docs/framework/wcf/feature-details/performance-considerations.md).  
  
## Надежный сквозной обмен сообщениями с использованием очередей  
 В последующих разделах приводятся рекомендации для сценариев, требующих надежного сквозного обмена сообщениями.  
  
### Базовая надежная передача  
 Для сквозной надежности установите для свойства <xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> значение `true`, чтобы обеспечить передачу.Для свойства <xref:System.ServiceModel.MsmqBindingBase.Durable%2A> можно задать значение `true` или `false`, в зависимости от требований \(значение по умолчанию — `true`\).Как правило, для свойства <xref:System.ServiceModel.MsmqBindingBase.Durable%2A> задается значение `true` как составная часть сквозной надежности.Компромисс достигается за счет производительности, но сообщения становятся устойчивыми и не теряются в случае сбоя диспетчера очередей.  
  
### Использование транзакций  
 Необходимо использовать транзакции для обеспечения сквозной надежности.Гарантии `ExactlyOnce` обеспечивают только доставку сообщений в целевую очередь.Чтобы гарантировать получение сообщений, используйте транзакции.Без транзакций в случае сбоя службы будет потеряно сообщение, находящееся в процессе доставки, но фактически доставленное в приложение.  
  
### Использование очередей недоставленных сообщений  
 Очереди недоставленных сообщений обеспечивают уведомления в случаях, когда не удалось доставить сообщение в целевую очередь.Можно использовать системную очередь недоставленных сообщений или пользовательскую очередь недоставленных сообщений.Как правило, лучше использовать пользовательскую очередь недоставленных сообщений, так как она позволяет отправлять недоставленные сообщения из одного приложения в отдельную очередь недоставленных сообщений.В противном случае все недоставленные сообщения из всех работающих в системе приложений будут доставляться в одну очередь.Затем каждое приложение должно просматривать очередь недоставленных сообщений, чтобы найти недоставленные сообщения, относящиеся к этому приложению.Иногда использование пользовательской очереди недоставленных сообщений невозможно, например, при использовании MSMQ 3.0.  
  
 Для сквозной надежности связи не рекомендуется выключать очереди недоставленных сообщений.  
  
 [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] [Использование очередей недоставленных сообщений для обработки сбоев при передаче сообщений](../../../../docs/framework/wcf/feature-details/using-dead-letter-queues-to-handle-message-transfer-failures.md).  
  
### Использование обработки подозрительных сообщений  
 Обработка подозрительных сообщений обеспечивает возможность восстановления после сбоя при обработке сообщений.  
  
 При использовании функции обработки подозрительных сообщений убедитесь, что для свойства <xref:System.ServiceModel.MsmqBindingBase.ReceiveErrorHandling%2A> задано подходящее значение.Если свойству присвоено значение <xref:System.ServiceModel.ReceiveErrorHandling>, это означает потерю данных.С другой стороны, значение <xref:System.ServiceModel.ReceiveErrorHandling> этого свойства вызывает сбой узла службы в случае обнаружения подозрительного сообщения.При использовании MSMQ 3.0 значение <xref:System.ServiceModel.ReceiveErrorHandling> — это наилучший способ избежать потери данных и избавиться от подозрительного сообщения.Использование MSMQ 4.0, <xref:System.ServiceModel.ReceiveErrorHandling> является рекомендуемым способом.Операция <xref:System.ServiceModel.ReceiveErrorHandling> обеспечивает перемещение подозрительного сообщения из очереди, чтобы служба могла продолжать обрабатывать новые сообщения.Затем служба опасных сообщений может отдельно обработать подозрительное сообщение.  
  
 [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] [Обработка подозрительных сообщений](../../../../docs/framework/wcf/feature-details/poison-message-handling.md).  
  
## Достижение высокой пропускной способности  
 Чтобы добиться высокой пропускной способности в одной конечной точке, используйте перечисленные ниже средства.  
  
-   Пакетирование с поддержкой транзакций.Пакетирование с поддержкой транзакций обеспечивает возможность чтения нескольких сообщений в одной транзакции.При этом оптимизируются фиксации транзакции, что повышает общую производительность.Недостаток пакетирования заключается в том, что при сбое в одном сообщении из пакета производится откат всего пакета, и сообщения требуется обрабатывать по одному до тех пор, пока не появится возможность снова объединять их в пакет.В большинстве случаев подозрительные сообщения встречаются редко, поэтому пакетирование — это предпочтительный способ повышения производительности системы, особенно при наличии других диспетчеров ресурсов, участвующих в транзакции.[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Объединение сообщений в одну транзакцию](../../../../docs/framework/wcf/feature-details/batching-messages-in-a-transaction.md).  
  
-   Параллелизм.Параллелизм увеличивает пропускную способность, однако при этом влияет на состязание за общие ресурсы.[!INCLUDE[crdefault](../../../../includes/crdefault-md.md)][Параллельность](../../../../docs/framework/wcf/samples/concurrency.md).  
  
-   Регулирование.Для получения оптимальной производительности следует регулировать количество сообщений в конвейере диспетчера.Пример того, как это сделать, см. в разделе [Регулирование](../../../../docs/framework/wcf/samples/throttling.md).  
  
 При использовании пакетирования помните, что параллелизм и регулирование означает параллельные пакеты.  
  
 Чтобы повысить пропускную способность и доступность, используйте ферму служб [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], осуществляющих чтение из очереди.Для этого необходимо, чтобы все эти службы предоставляли один и тот же контракт в одной конечной точке.Использование ферм больше всего подходит для приложений, создающих много сообщений, так как это позволяет нескольким службам производить чтение из одной очереди.  
  
 При использовании ферм помните, что в MSMQ 3.0 удаленные чтения в транзакциях не поддерживаются.В MSMQ 4.0 удаленные чтения в транзакциях поддерживаются.  
  
 [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] [Объединение сообщений в одну транзакцию](../../../../docs/framework/wcf/feature-details/batching-messages-in-a-transaction.md) и [Различия в возможностях очередей в Windows Vista, Windows Server 2003 и Windows XP](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md).  
  
## Организация очереди с семантикой единицы работы  
 В некоторых сценариях очередь может содержать группу связанных между собой сообщений, для которых важен их порядок.В таких сценариях группу связанных сообщений следует обрабатывать вместе как одну единицу: либо все сообщения успешно обрабатываются, либо ни одно из сообщений не обрабатывается.Чтобы реализовать такое поведение, используйте сеансы с очередями.  
  
 [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] [Группирование сообщений в очереди в рамках сеанса](../../../../docs/framework/wcf/feature-details/grouping-queued-messages-in-a-session.md).  
  
## Коррелирование сообщений типа «запрос\-ответ»  
 Хотя очереди обычно являются однонаправленными, в некоторых сценариях может потребоваться корреляция полученного ответа с ранее переданным запросом.Если требуется такая корреляция, рекомендуется применять свой собственный заголовок сообщения SOAP, содержащий корреляционные сведения для сообщения.Обычно отправитель добавляет этот заголовок в сообщение, а получатель, после обработки сообщения и передачи нового ответного сообщения в очередь ответов, добавляет заголовок сообщения отправителя, содержащий корреляционную информацию, чтобы отправитель мог связать ответное сообщение с сообщением запроса.  
  
## Интеграция с приложениями, не являющимися приложениями WCF  
 При интеграции служб или клиентов [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] со службами и клиентами, отличными от служб и клиентов [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], используйте `MsmqIntegrationBinding`.Приложение, не являющееся приложением [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], может быть приложением MSMQ, написанным с использованием System.Messaging, COM\+, [!INCLUDE[vbprvb](../../../../includes/vbprvb-md.md)] или C\+\+.  
  
 При использовании `MsmqIntegrationBinding` помните следующее:  
  
-   Тело сообщения [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] не совпадает с телом сообщения MSMQ.При передаче сообщения [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] с использованием привязки, поддерживающей очередь, тело сообщения [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] помещается в сообщение MSMQ.Инфраструктура MSMQ не замечает эту дополнительную информацию — она видит только сообщение MSMQ.  
  
-   Класс `MsmqIntegrationBinding` поддерживает распространенные типы сериализации.На основе типа сериализации тип тела универсального сообщения, <xref:System.ServiceModel.MsmqIntegration.MsmqMessage%601>, принимает параметры разных типов.Например, для <xref:System.ServiceModel.MsmqIntegration.MsmqMessageSerializationFormat> требуется `MsmqMessage\<byte[]>`, а для <xref:System.ServiceModel.MsmqIntegration.MsmqMessageSerializationFormat> требуется `MsmqMessage<Stream>`.  
  
-   В случае сериализации XML можно задать известный тип с помощью атрибута `KnownTypes` элемента [\<поведение\>](../../../../docs/framework/configure-apps/file-schema/wcf/behavior-of-servicebehaviors.md), который затем используется для определения способа десериализации сообщения XML.  
  
## См. также  
 [Очереди в WCF](../../../../docs/framework/wcf/feature-details/queuing-in-wcf.md)   
 [Как обменяться сообщениями в очереди с конечными точками WCF](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md)   
 [Как обмениваться сообщениями с конечными точками WCF и приложениями очереди сообщений](../../../../docs/framework/wcf/feature-details/how-to-exchange-messages-with-wcf-endpoints-and-message-queuing-applications.md)   
 [Группирование сообщений в очереди в рамках сеанса](../../../../docs/framework/wcf/feature-details/grouping-queued-messages-in-a-session.md)   
 [Объединение сообщений в одну транзакцию](../../../../docs/framework/wcf/feature-details/batching-messages-in-a-transaction.md)   
 [Использование очередей недоставленных сообщений для обработки сбоев при передаче сообщений](../../../../docs/framework/wcf/feature-details/using-dead-letter-queues-to-handle-message-transfer-failures.md)   
 [Обработка подозрительных сообщений](../../../../docs/framework/wcf/feature-details/poison-message-handling.md)   
 [Различия в возможностях очередей в Windows Vista, Windows Server 2003 и Windows XP](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md)   
 [Защита сообщений с использованием средств обеспечения безопасности транспорта](../../../../docs/framework/wcf/feature-details/securing-messages-using-transport-security.md)   
 [Защита сообщений с использованием средств обеспечения безопасности сообщений](../../../../docs/framework/wcf/feature-details/securing-messages-using-message-security.md)   
 [Устранение неполадок обмена сообщениями с использованием очередей](../../../../docs/framework/wcf/feature-details/troubleshooting-queued-messaging.md)