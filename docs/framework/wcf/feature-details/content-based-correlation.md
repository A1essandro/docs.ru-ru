---
title: Корреляция по содержимому
ms.date: 03/30/2017
ms.assetid: f46a2b68-8d24-4122-bbee-9573fc3f9fb4
ms.openlocfilehash: 48009420788b8678f842c4368926e04f8a745a52
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
ms.locfileid: "33494219"
---
# <a name="content-based-correlation"></a><span data-ttu-id="001b7-102">Корреляция по содержимому</span><span class="sxs-lookup"><span data-stu-id="001b7-102">Content Based Correlation</span></span>
<span data-ttu-id="001b7-103">Когда службы рабочего процесса обмениваются данными с клиентами и другими службами, в сообщениях часто встречаются данные, уникальным образом направляющие сообщение в определенный экземпляр.</span><span class="sxs-lookup"><span data-stu-id="001b7-103">When workflow services communicate with clients and other services, often there is some data in the exchanged messages that uniquely relates a message to a particular instance.</span></span> <span data-ttu-id="001b7-104">При корреляции на основе содержимого эти данные в сообщении, например номер заказчика или идентификатор заказа, используются для маршрутизации сообщения в определенный экземпляр рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="001b7-104">Content-based correlation uses this data in the message, such as a customer number or order ID, to route messages to the proper workflow instance.</span></span> <span data-ttu-id="001b7-105">В этом разделе описывается использование корреляции на основе содержимого в рабочих процессах.</span><span class="sxs-lookup"><span data-stu-id="001b7-105">This topic explains how to use content-based correlation in workflows.</span></span>  
  
## <a name="using-content-based-correlation"></a><span data-ttu-id="001b7-106">Использование корреляции на основе содержимого</span><span class="sxs-lookup"><span data-stu-id="001b7-106">Using Content-Based Correlation</span></span>  
 <span data-ttu-id="001b7-107">Корреляция на основе содержимого применяется, если служба рабочего процесса имеет несколько методов, доступных одному клиенту, и некоторые данные в сообщениях идентифицируют нужный экземпляр.</span><span class="sxs-lookup"><span data-stu-id="001b7-107">Content-based correlation is used when a workflow service has multiple methods that are accessed by a single client and a piece of data in the exchanged messages identifies the desired instance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="001b7-108">Корреляция на основе содержимого полезна, если нельзя применить корреляцию на основе контекста, так как привязка не относится ни к одному поддерживаемому типу привязок для обмена контекстом.</span><span class="sxs-lookup"><span data-stu-id="001b7-108">Content-based correlation is useful when context correlation cannot be used because the binding is not one of the supported context exchange bindings.</span></span> <span data-ttu-id="001b7-109">Дополнительные сведения о корреляции контекста см. в разделе [обмен контекстом](../../../../docs/framework/wcf/feature-details/context-exchange-correlation.md).</span><span class="sxs-lookup"><span data-stu-id="001b7-109">For more information about context correlation, see [Context Exchange](../../../../docs/framework/wcf/feature-details/context-exchange-correlation.md).</span></span>  
  
 <span data-ttu-id="001b7-110">В каждом действии по обмену сообщениями при обмене данными должно быть указано расположение в сообщении данных, уникальным образом идентифицирующих экземпляр.</span><span class="sxs-lookup"><span data-stu-id="001b7-110">Each messaging activity used in these communications must specify the location of the data in the message that uniquely identifies the instance.</span></span> <span data-ttu-id="001b7-111">Это делается путем указания набора <xref:System.ServiceModel.MessageQuerySet> с помощью <xref:System.ServiceModel.Activities.QueryCorrelationInitializer> или <xref:System.ServiceModel.Activities.Receive.CorrelatesOn%2A>, выбирающих из сообщения данные, уникальным образом идентифицирующие экземпляр.</span><span class="sxs-lookup"><span data-stu-id="001b7-111">This is done by providing a <xref:System.ServiceModel.MessageQuerySet>, using either a <xref:System.ServiceModel.Activities.QueryCorrelationInitializer> or <xref:System.ServiceModel.Activities.Receive.CorrelatesOn%2A>, that queries the message for the piece or pieces of data that uniquely identify the instance.</span></span>  
  
> [!WARNING]
>  <span data-ttu-id="001b7-112">Данные, используемые для идентификации экземпляра, хэшируются в ключ корреляции.</span><span class="sxs-lookup"><span data-stu-id="001b7-112">The data that is used to identify the instance is hashed into a correlation key.</span></span> <span data-ttu-id="001b7-113">Необходимо убедиться, что данные, используемые для корреляции, являются уникальными. В противном случае в хэшированном ключе могут возникнуть конфликты, которые приведут к неправильной маршрутизации сообщения.</span><span class="sxs-lookup"><span data-stu-id="001b7-113">Care must be taken to ensure that the data used for correlation is unique or else collisions in the hashed key could occur and cause messages to be misrouted.</span></span> <span data-ttu-id="001b7-114">Например, корреляция на основе только имени заказчика может вызвать конфликт, так как могут иметься заказчики с одинаковыми именами.</span><span class="sxs-lookup"><span data-stu-id="001b7-114">For example, a correlation based solely on a customer name may cause a collision because there may be multiple customers with the same name.</span></span> <span data-ttu-id="001b7-115">Двоеточие (`:`) не должно встречаться в данных, используемых для корреляции сообщений, так как оно уже применяется в качестве разделителя ключа и значения в запросе к сообщению, формирующих строку, которая впоследствии хэшируется.</span><span class="sxs-lookup"><span data-stu-id="001b7-115">The colon (`:`) should not be used as part of the data used to correlate the message because it is already used to delimit the message query’s key and value to form the string that is subsequently hashed.</span></span>  
  
 <span data-ttu-id="001b7-116">В следующем примере первоначального <xref:System.ServiceModel.Activities.Receive> / <xref:System.ServiceModel.Activities.SendReply> в службе рабочего процесса возвращает `OrderId`, который затем передается обратно клиентом при вызове следующих <xref:System.ServiceModel.Activities.Receive> действия в службе рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="001b7-116">In the following example, the initial <xref:System.ServiceModel.Activities.Receive>/<xref:System.ServiceModel.Activities.SendReply> in a workflow service returns an `OrderId`, which is then passed back by the client on the call to the following <xref:System.ServiceModel.Activities.Receive> activity in the workflow service.</span></span>  
  
 [!code-csharp[CFX_ContentCorrelation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_contentcorrelation/cs/program.cs#1)]  
  
 <span data-ttu-id="001b7-117">В предыдущем примере показана корреляция на основе содержимого, инициализированная действием <xref:System.ServiceModel.Activities.SendReply>.</span><span class="sxs-lookup"><span data-stu-id="001b7-117">The previous example shows a content-based correlation that is initialized by the <xref:System.ServiceModel.Activities.SendReply>.</span></span> <span data-ttu-id="001b7-118">Набор <xref:System.ServiceModel.MessageQuerySet> указывает, что в качестве данных, применяемых для идентификации последующих сообщений для этой службы, используется `OrderId`.</span><span class="sxs-lookup"><span data-stu-id="001b7-118">The <xref:System.ServiceModel.MessageQuerySet> specifies that the data used to identify subsequent messages to this service is the `OrderId`.</span></span>  
  
 [!code-csharp[CFX_ContentCorrelation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_contentcorrelation/cs/program.cs#2)]  
  
 <span data-ttu-id="001b7-119">Действие <xref:System.ServiceModel.Activities.Receive>, следующее за действием <xref:System.ServiceModel.Activities.SendReply> в рабочем процессе, соответствует корреляции, инициализированной действием <xref:System.ServiceModel.Activities.SendReply>.</span><span class="sxs-lookup"><span data-stu-id="001b7-119">The <xref:System.ServiceModel.Activities.Receive> activity that follows the <xref:System.ServiceModel.Activities.SendReply> in the workflow follows the correlation that was initialized by the <xref:System.ServiceModel.Activities.SendReply>.</span></span> <span data-ttu-id="001b7-120">Оба действия используют один и тот же дескриптор <xref:System.ServiceModel.Activities.CorrelationHandle>, но для каждого из них используются отдельные <xref:System.ServiceModel.MessageQuerySet> и <xref:System.ServiceModel.XPathMessageQuery>, указывающие, где расположены идентифицирующие данные в определенном сообщении.</span><span class="sxs-lookup"><span data-stu-id="001b7-120">Both activities share the same <xref:System.ServiceModel.Activities.CorrelationHandle>, but each one has its own <xref:System.ServiceModel.MessageQuerySet> and <xref:System.ServiceModel.XPathMessageQuery> that specifies where the identifying data is in that particular message.</span></span> <span data-ttu-id="001b7-121">Для действия, инициализирующего корреляцию, <xref:System.ServiceModel.MessageQuerySet> указывается в свойстве <xref:System.ServiceModel.Activities.Receive.CorrelationInitializers%2A>, а для любого следующего действия <xref:System.ServiceModel.Activities.Receive> - в свойстве <xref:System.ServiceModel.Activities.Receive.CorrelatesOn%2A>.</span><span class="sxs-lookup"><span data-stu-id="001b7-121">On the activity that initializes the correlation, this <xref:System.ServiceModel.MessageQuerySet> is specified in the <xref:System.ServiceModel.Activities.Receive.CorrelationInitializers%2A> property, and for any following <xref:System.ServiceModel.Activities.Receive> activities, it is specified using the <xref:System.ServiceModel.Activities.Receive.CorrelatesOn%2A> property.</span></span>  
  
 [!code-csharp[CFX_ContentCorrelation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_contentcorrelation/cs/program.cs#3)]  
  
 <span data-ttu-id="001b7-122">Корреляция на основе содержимого может инициализироваться любым действием по обмену сообщениями (<xref:System.ServiceModel.Activities.Send>, <xref:System.ServiceModel.Activities.Receive>, <xref:System.ServiceModel.Activities.SendReply>, <xref:System.ServiceModel.Activities.ReceiveReply>), если данные передаются в составе сообщения.</span><span class="sxs-lookup"><span data-stu-id="001b7-122">A content-based correlation can be initialized by any messaging activity (<xref:System.ServiceModel.Activities.Send>, <xref:System.ServiceModel.Activities.Receive>, <xref:System.ServiceModel.Activities.SendReply>, <xref:System.ServiceModel.Activities.ReceiveReply>) when the data flows as part of a message.</span></span> <span data-ttu-id="001b7-123">Если определенные данные не являются частью сообщения, то корреляция может быть инициализирована явно с помощью действия <xref:System.ServiceModel.Activities.InitializeCorrelation>.</span><span class="sxs-lookup"><span data-stu-id="001b7-123">If the particular piece of data does not flow as part of a message, then it can be initialized explicitly by using the <xref:System.ServiceModel.Activities.InitializeCorrelation> activity.</span></span> <span data-ttu-id="001b7-124">Если для уникальной идентификации сообщения требуется несколько блоков данных, то в набор <xref:System.ServiceModel.MessageQuerySet> можно добавить несколько запросов.</span><span class="sxs-lookup"><span data-stu-id="001b7-124">If multiple pieces of data are required to uniquely identify the message, then multiple queries can be added to the <xref:System.ServiceModel.MessageQuerySet>.</span></span> <span data-ttu-id="001b7-125">В этих примерах <xref:System.ServiceModel.Activities.CorrelationHandle> был явно указан для каждого действия с помощью свойств `CorrelatesWith` или `CorrelationHandle`, но, если для всего рабочего процесса требуется только одна корреляция, как в примере с корреляцией на основе `OrderId`, достаточно неявного управления дескриптором взаимосвязи с помощью <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span><span class="sxs-lookup"><span data-stu-id="001b7-125">In these examples, a <xref:System.ServiceModel.Activities.CorrelationHandle> was explicitly provided to each of the activities using the `CorrelatesWith` or `CorrelationHandle` properties, but if there is only one correlation required for the entire workflow, such as in this example where everything correlates on `OrderId`, the implicit correlation handle management provided by <xref:System.ServiceModel.Activities.WorkflowServiceHost> is sufficient.</span></span>  
  
## <a name="using-the-initializecorrelation-activity"></a><span data-ttu-id="001b7-126">Использование действия InitializeCorrelation</span><span class="sxs-lookup"><span data-stu-id="001b7-126">Using the InitializeCorrelation Activity</span></span>  
 <span data-ttu-id="001b7-127">В предыдущем примере `OrderId` направлялся вызывающему объекту с помощью действия <xref:System.ServiceModel.Activities.SendReply>, которое служило для инициализации корреляции.</span><span class="sxs-lookup"><span data-stu-id="001b7-127">In the previous example, the `OrderId` flowed to the caller through the <xref:System.ServiceModel.Activities.SendReply> activity and this is where the correlation was initialized.</span></span> <span data-ttu-id="001b7-128">Это поведение может выполняться с помощью действия <xref:System.ServiceModel.Activities.InitializeCorrelation>.</span><span class="sxs-lookup"><span data-stu-id="001b7-128">The same behavior can be accomplished by using the <xref:System.ServiceModel.Activities.InitializeCorrelation> activity.</span></span> <span data-ttu-id="001b7-129">Действие <xref:System.ServiceModel.Activities.InitializeCorrelation> использует дескриптор <xref:System.ServiceModel.Activities.CorrelationHandle> и словарь элементов, представляющий данные для сопоставления сообщения с правильным экземпляром.</span><span class="sxs-lookup"><span data-stu-id="001b7-129">The <xref:System.ServiceModel.Activities.InitializeCorrelation> activity takes the <xref:System.ServiceModel.Activities.CorrelationHandle> and a dictionary of items that represent the data used to map the message to the correct instance.</span></span> <span data-ttu-id="001b7-130">Чтобы использовать действие <xref:System.ServiceModel.Activities.InitializeCorrelation>, описанное в предыдущем образце, удалите <xref:System.ServiceModel.Activities.SendReply.CorrelationInitializers%2A> из действия <xref:System.ServiceModel.Activities.SendReply> и инициализируйте корреляцию с помощью действия <xref:System.ServiceModel.Activities.InitializeCorrelation>.</span><span class="sxs-lookup"><span data-stu-id="001b7-130">To use the <xref:System.ServiceModel.Activities.InitializeCorrelation> activity in the preceding sample, remove the <xref:System.ServiceModel.Activities.SendReply.CorrelationInitializers%2A> from the <xref:System.ServiceModel.Activities.SendReply> activity and initialize the correlation using the <xref:System.ServiceModel.Activities.InitializeCorrelation> activity.</span></span>  
  
 [!code-csharp[CFX_ContentCorrelation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_contentcorrelation/cs/program.cs#4)]  
  
 <span data-ttu-id="001b7-131">Затем действие <xref:System.ServiceModel.Activities.InitializeCorrelation> используется в рабочем процессе, после того как заполняются переменные, содержащие данные, но перед действием <xref:System.ServiceModel.Activities.Receive>, связанным с инициализированным <xref:System.ServiceModel.Activities.CorrelationHandle>.</span><span class="sxs-lookup"><span data-stu-id="001b7-131">The <xref:System.ServiceModel.Activities.InitializeCorrelation> activity is then used in the workflow, after the variables that hold the data are populated but before the <xref:System.ServiceModel.Activities.Receive> activity that correlates with the initialized <xref:System.ServiceModel.Activities.CorrelationHandle>.</span></span>  
  
 [!code-csharp[CFX_ContentCorrelation#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_contentcorrelation/cs/program.cs#5)]  
  
## <a name="configuring-xpath-queries-using-the-workflow-designer"></a><span data-ttu-id="001b7-132">Настройка запросов XPath с помощью конструктора рабочих процессов</span><span class="sxs-lookup"><span data-stu-id="001b7-132">Configuring XPath Queries Using the Workflow Designer</span></span>  
 <span data-ttu-id="001b7-133">В предыдущих примерах действия и запросы XPath, используемые в запросах к сообщениям, были определены в коде.</span><span class="sxs-lookup"><span data-stu-id="001b7-133">In the previous examples, the activities and the XPath queries used in the message queries were specified in code.</span></span> <span data-ttu-id="001b7-134">Конструктор рабочих процессов в среде [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] также предоставляет возможность создавать выражения XPath из типов `DataContract` для корреляции на основе содержимого.</span><span class="sxs-lookup"><span data-stu-id="001b7-134">The workflow designer in [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] also provides the ability to generate XPaths from `DataContract` types for content-based correlation.</span></span> <span data-ttu-id="001b7-135">Первый запрос Xpath, настроенный в предыдущем примере, был настроен для действия <xref:System.ServiceModel.Activities.SendReply>.</span><span class="sxs-lookup"><span data-stu-id="001b7-135">The first XPath configured in the previous example was configured for the <xref:System.ServiceModel.Activities.SendReply>.</span></span>  
  
 [!code-csharp[CFX_ContentCorrelation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_contentcorrelation/cs/program.cs#2)]  
  
 <span data-ttu-id="001b7-136">Чтобы настроить выражение XPath для действия по обмену сообщениями в конструкторе рабочих процессов, выберите действие в конструкторе рабочих процессов.</span><span class="sxs-lookup"><span data-stu-id="001b7-136">To configure the XPath for a messaging activity in the workflow designer, select the activity in the workflow designer.</span></span> <span data-ttu-id="001b7-137">Если действие вызывает корреляцию, как в предыдущем примере, нажмите кнопку с многоточием для **CorrelationInitializers** свойство в **свойства** окна.</span><span class="sxs-lookup"><span data-stu-id="001b7-137">If the activity is initializing the correlation, as in the previous example, click the ellipsis button for the **CorrelationInitializers** property in the **Properties** window.</span></span> <span data-ttu-id="001b7-138">При этом отображаются **Добавление инициализаторов корреляции** диалоговое окно.</span><span class="sxs-lookup"><span data-stu-id="001b7-138">This displays the **Add Correlation Initializers** dialog window.</span></span> <span data-ttu-id="001b7-139">В этом диалоговом окне можно указать тип корреляции и выбрать содержимое, применяемое для корреляции.</span><span class="sxs-lookup"><span data-stu-id="001b7-139">From this dialog you can specify the correlation type and select the content that is used for the correlation.</span></span> <span data-ttu-id="001b7-140"><xref:System.ServiceModel.Activities.CorrelationHandle> Переменная, указанная в **добавить инициализатор** поле, а тип корреляции и данные, используемые для корреляции выбирается из **запросы XPath** раздел диалогового окна.</span><span class="sxs-lookup"><span data-stu-id="001b7-140">The <xref:System.ServiceModel.Activities.CorrelationHandle> variable is specified in the **Add initializer** box, and the correlation type and data used for the correlation is selected from the **XPath Queries** section of the dialog box.</span></span>  
  
 <span data-ttu-id="001b7-141">![Диалоговое окно CorrelationInitializer](../../../../docs/framework/wcf/feature-details/media/correlationinitializerdlg.jpg "CorrelationInitializerDlg")</span><span class="sxs-lookup"><span data-stu-id="001b7-141">![CorrelationInitializer Dialog](../../../../docs/framework/wcf/feature-details/media/correlationinitializerdlg.jpg "CorrelationInitializerDlg")</span></span>  
  
 <span data-ttu-id="001b7-142">Второй запрос XPath в предыдущем примере был настроен в действии <xref:System.ServiceModel.Activities.Receive>.</span><span class="sxs-lookup"><span data-stu-id="001b7-142">The second XPath query in the previous example was configured in the <xref:System.ServiceModel.Activities.Receive> activity.</span></span>  
  
 [!code-csharp[CFX_ContentCorrelation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/cfx_contentcorrelation/cs/program.cs#3)]  
  
 <span data-ttu-id="001b7-143">Чтобы настроить запрос XPath для действия по обмену сообщениями, не инициализирующего корреляцию, выберите действие в конструкторе рабочих процессов и нажмите кнопку с многоточием для **CorrelatesOn** свойство в  **Свойства** окна.</span><span class="sxs-lookup"><span data-stu-id="001b7-143">To configure the XPath query for a messaging activity that does not initialize the correlation, select the activity in the workflow designer and then click the ellipsis button for the **CorrelatesOn** property in the **Properties** window.</span></span> <span data-ttu-id="001b7-144">При этом отображаются **корреляция по определению** диалоговое окно.</span><span class="sxs-lookup"><span data-stu-id="001b7-144">This displays the **CorrelatesOn Definition** dialog window.</span></span>  
  
 <span data-ttu-id="001b7-145">![Корреляция по определению](../../../../docs/framework/wcf/feature-details/media/correlatesondialog.jpg "CorrelatesOnDialog")</span><span class="sxs-lookup"><span data-stu-id="001b7-145">![CorrelatesOn Definition](../../../../docs/framework/wcf/feature-details/media/correlatesondialog.jpg "CorrelatesOnDialog")</span></span>  
  
 <span data-ttu-id="001b7-146">В этом диалоговом окне укажите <xref:System.ServiceModel.Activities.CorrelationHandle> и выбрать элементы в **запросы XPath** списка, чтобы создать запрос XPath.</span><span class="sxs-lookup"><span data-stu-id="001b7-146">From this dialog you specify the <xref:System.ServiceModel.Activities.CorrelationHandle> and choose items in the **XPath Queries** list to build the XPath query.</span></span>
