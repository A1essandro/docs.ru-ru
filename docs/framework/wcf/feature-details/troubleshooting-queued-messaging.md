---
title: "Устранение неполадок обмена сообщениями с использованием очередей | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-4.6"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-clr"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: a5f2836f-018d-42f5-a571-1e97e64ea5b0
caps.latest.revision: 19
author: "Erikre"
ms.author: "erikre"
manager: "erikre"
caps.handback.revision: 19
---
# Устранение неполадок обмена сообщениями с использованием очередей
Данный раздел содержит наиболее распространенные вопросы и справку по устранению неполадок при использовании очередей в [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)].  
  
## Наиболее распространенные вопросы  
 **В.** Используется бета\-версия 1 [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] и установлено исправление MSMQ.Требуется ли удалять исправление?  
  
 **О.** Да.Это исправление больше не поддерживается.[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] теперь работает на MSMQ, не требуя установки исправления.  
  
 **В.** Имеется две привязки для MSMQ: <xref:System.ServiceModel.NetMsmqBinding> и <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.Какую необходимо использовать и когда?  
  
 **О.** Выберите <xref:System.ServiceModel.NetMsmqBinding>, если необходимо использовать MSMQ в качестве транспорта для взаимодействия с использованием очередей между двумя приложениями [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)].Выберите <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>, если необходимо использовать существующие приложения MSMQ для взаимодействия с новыми приложениями [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)].  
  
 **В.** Необходимо ли обновлять MSMQ, чтобы использовать привязки <xref:System.ServiceModel.NetMsmqBinding> и `MsmqIntegration`?  
  
 **А:** Нет.Обе привязки работают с MSMQ 3.0 в [!INCLUDE[wxp](../../../../includes/wxp-md.md)] и [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)].Некоторые возможности привязок будут доступны при обновлении до MSMQ 4.0 в [!INCLUDE[wv](../../../../includes/wv-md.md)].  
  
 **В.** Какие функции привязок <xref:System.ServiceModel.NetMsmqBinding> и <xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding> доступны в MSMQ 4.0, но отсутствуют в MSMQ 3.0?  
  
 **О.** Следующие функции доступны в MSMQ 4.0, но отсутствуют в MSMQ 3.0.  
  
-   Пользовательская очередь недоставленных сообщений поддерживается только в MSMQ 4.0.  
  
-   MSMQ 3.0 и 4.0 обрабатывают опасные сообщения по\-разному.  
  
-   Удаленные чтения в транзакциях поддерживаются только MSMQ 4.0.  
  
 [!INCLUDE[crdefault](../../../../includes/crdefault-md.md)] [Различия в возможностях очередей в Windows Vista, Windows Server 2003 и Windows XP](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md).  
  
 **В.** Можно ли использовать MSMQ 3.0 на одной стороне взаимодействия с использованием очередей, а MSMQ 4.0 — на другой стороне?  
  
 **О.** Да.  
  
 **В.** Необходимо интегрировать существующие приложения MSMQ с новыми клиентами или серверами [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)].Требуются ли обновления для обеих сторон инфраструктуры MSMQ?  
  
 **А:** Нет.Нет необходимости обновлять обе стороны до MSMQ 4.0.  
  
## Устранение неполадок  
 Данный раздел содержит ответы на вопросы, связанные с устранением распространенных неполадок.Некоторые вопросы, являющиеся известными ограничениями, описаны также в заметках о выпуске.  
  
 **В.** При попытке использовать частную очередь получено следующее исключение: `System.InvalidOperationException`: указан недопустимый URL\-адрес.URL\-адрес очереди не может содержать символ "$".Используйте синтаксис net.msmq:\/\/machine\/private\/queueName, чтобы адресовать частную очередь.  
  
 **О.** Проверьте универсальный код ресурса \(URI\) очереди в конфигурации и коде.Не используйте символ "$" в универсальном коде ресурса \(URI\).Например, чтобы адресовать частную очередь с именем OrdersQueue, задайте следующий универсальный код ресурса \(URI\): net.msmq:\/\/localhost\/private\/ordersQueue.  
  
 **В.** Вызов `ServiceHost.Open()` в приложении, поставленным в очередь, вызывает следующее исключение: `System.ArgumentException`: базовый адрес не может содержать строку запроса URI.Почему?  
  
 **О.** Проверьте универсальный код ресурса \(URI\) очереди в файле конфигурации и коде.Хотя очереди MSMQ поддерживают использование символа "?", универсальные коды ресурсов \(URI\) интерпретируют этот символ как начало строки запроса.Чтобы избежать этого, не используйте символ "?" в именах очередей.  
  
 **В.** Отправка выполнена успешно, но операция службы не вызвана на получателе.Почему?  
  
 **О.** Чтобы определиться с ответом, выполните следующие действия:  
  
-   Проверьте, совместимы ли требования транзакционной очереди с заданными гарантиями.Обратите внимание на следующие принципы.  
  
    -   Устойчивые сообщения \(датаграммы и сеансы\) можно отправлять с гарантиями доставки точно по одному разу \(<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> \= `true`\) только в транзакционную очередь.  
  
    -   Сеансы можно отправлять только с гарантиями доставки точно по одному разу.  
  
    -   Необходимо, чтобы в сеансе транзакция получала сообщения из транзакционной очереди.  
  
    -   Неустойчивые и устойчивые сообщения \(только датаграммы\) можно отправлять без гарантий \(<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> \= `false`\) только в нетранзакционную очередь.  
  
-   Проверьте очередь недоставленных писем.Если в этой очереди есть сообщения, определите причину, по которой они не были доставлены.  
  
-   Проверьте очереди исходящих сообщений на наличие проблем с подключением и адресацией.  
  
 **В.** Задана пользовательская очередь недоставленных сообщений, но при запуске приложения отправителя получается исключение о том, что очередь недоставленных сообщений не найдена, или у приложения отправителя отсутствуют права доступа к ней.Что происходит?  
  
 **О.** В первом сегменте универсального кода ресурса \(URI\) очереди недоставленных сообщений должно содержаться значение "localhost" или имя компьютера, например: net.msmq:\/\/localhost\/private\/myAppdead\-letter queue.  
  
 **В.** Необходимо ли всегда задавать пользовательскую очередь недоставленных сообщений или существует очередь недоставленных сообщений по умолчанию?  
  
 **О.** Если используются гарантии с доставкой точно один раз \(<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> \= `true`\) и не задана пользовательская очередь недоставленных сообщений, по умолчанию устанавливается транзакционная очередь недоставленных сообщений для всей системы.  
  
 Если гарантии отсутствуют \(<xref:System.ServiceModel.MsmqBindingBase.ExactlyOnce%2A> \= `false`\), по умолчанию функция очереди недоставленных сообщений не используется.  
  
 **В.** Служба вызывает исключение SvcHost.Open с сообщением "ListenerFactory не может удовлетворить требования к EndpointListener".Почему?  
  
 О.Проверьте контракт службы.Возможно, не было задано значение "IsOneWay\=`true`" для всех операций службы.Очереди поддерживают только односторонние операции службы.  
  
 **В.** В очереди имеются сообщения, но операции службы не вызываются.В чем суть проблемы?  
  
 **О.** Возможно, произошел сбой узла службы.Убедиться в этом можно, просмотрев трассировку или реализовав `IErrorHandler`.По умолчанию сбой узла службы происходит при обнаружении подозрительного сообщения.  
  
 **В.** В очереди имеются сообщения, но размещенная на веб\-узле служба в очереди не активируется.Почему?  
  
 **О.** Наиболее часто эта проблема связана с разрешениями.  
  
1.  Убедитесь в том, что выполняется процесс `NetMsmqActivator` и удостоверению процесса `NetMsmqActivator` предоставлено разрешение на чтение и поиск для данной очереди.  
  
2.  Если процесс `NetMsmqActivator` отслеживает очереди на удаленном компьютере, убедитесь в том, что `NetMsmqActivator` не выполняется с маркером ограниченного доступа.Чтобы выполнить процесс `NetMsmqActivator` с маркером неограниченного доступа, используется следующий код.  
  
    ```  
    sc sidtype NetMsmqActivator unrestricted  
    ```  
  
 Сведения о веб\-узлах, не связанные с безопасностью, см. в разделе [Размещение веб\-узлов в приложении, использующем очереди](../../../../docs/framework/wcf/feature-details/web-hosting-a-queued-application.md).  
  
 **В.** Какой способ доступа к сеансам является наиболее простым?  
  
 **О.** Задайте AutoComplete\=`true` для операции, соответствующей последнему сообщению в сеансе, а для всех остальных операций службы задайте AutoComplete\=`false`.  
  
 **В.** Где можно найти ответы на наиболее распространенные вопросы по MSMQ?  
  
 **О.** [!INCLUDE[crabout](../../../../includes/crabout-md.md)] MSMQ см. в разделе [Microsoft Message Queuing](http://go.microsoft.com/fwlink/?LinkId=87810).  
  
 **В.** Почему служба выдает исключение `ProtocolException` при чтении из очереди, содержащей как сообщения сеанса, так и сообщения датаграммы?  
  
 **О.** Существует фундаментальное различие между тем, как формируются сообщения для сеансов и датаграмм из очереди.Вследствие этого, служба, ожидающая чтения сообщения сеанса из очереди не может получить сообщение датаграммы из очереди, а служба, ожидающая чтения сообщения датаграммы из очереди не может получить сообщения сеанса.При попытке чтения сообщений обоих типов из одной очереди будет получено следующее исключение.  
  
```  
System.ServiceModel.MsmqPoisonMessageException: The transport channel detected a poison message. This occurred because the message exceeded the maximum number of delivery attempts or because the channel detected a fundamental problem with the message. The inner exception may contain additional information.   
---> System.ServiceModel.ProtocolException: An incoming MSMQ message contained invalid or unexpected .NET Message Framing information in its body. The message cannot be received. Ensure that the sender is using a compatible service contract with a matching SessionMode.  
```  
  
 Системная очередь недоставленных сообщений, а также любая пользовательская очередь недоставленных сообщений особенно чувствительна к этой проблеме, если приложение отправляет с одного компьютера как сообщения сеанса в очереди, так и сообщения датаграммы.Если сообщение не удается отправить, оно перемещается в очередь недоставленных сообщений.При этих обстоятельствах в очереди недоставленных сообщений могут быть как сообщения сеанса, так и сообщения датаграмм.При чтении из очереди во время выполнения отсутствует возможность разделения двух типов сообщений, поэтому приложения не должны отправлять сообщения сеанса в очереди и сообщения датаграмм в очереди с одного компьютера.  
  
### Интеграция MSMQ: устранение конкретных неполадок  
 **В.** При отправке сообщения или открытии узла службы появляется сообщение об ошибке, указывающее на то, что схема неверна.Почему?  
  
 **О.** При использовании привязки интеграции MSMQ необходимо применять схему msmq.formatname.Например, msmq.formatname:DIRECT\=OS:.\\private$\\OrdersQueue.Однако если задана пользовательская очередь недоставленных сообщений, необходимо использовать схему net.msmq.  
  
 **В.** При использовании имени в открытом или закрытом формате и открытии узла службы в [!INCLUDE[wv](../../../../includes/wv-md.md)] выводится сообщение об ошибке.Почему?  
  
 **О.** Канал интеграции [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] в [!INCLUDE[wv](../../../../includes/wv-md.md)] проверяет, можно ли для основной очереди приложения открыть вложенную очередь для обработки подозрительных сообщений.Имя вложенной очереди является производным от универсального кода ресурса \(URI\) msmq.formatname, передаваемого прослушивателю.Имя вложенной очереди в MSMQ может быть только непосредственным именем формата.Из\-за этого возникает ошибка.Измените URI очереди на непосредственное имя формата.  
  
 **В.** При получении сообщения из приложения MSMQ оно остается в очереди и не читается принимающим приложением [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)].Почему?  
  
 **О.** Проверьте, если в сообщении тело.Если в сообщении отсутствует тело, канал интеграции MSMQ игнорирует его.Реализуйте интерфейс `IErrorHandler`, чтобы получать уведомления об исключениях, и проверьте трассировки.  
  
### Устранение неполадок, связанных с безопасностью  
 **В.** При выполнении образца, использующего привязку по умолчанию в режиме рабочей группы, сообщения отправляются, но они не доходят до получателя.  
  
 **О.** По умолчанию сообщения подписываются с помощью внутреннего сертификата MSMQ, для которого требуется служба каталогов Active Directory.В режиме рабочей группы происходит сбой подписи сообщения, так как служба каталогов Active Directory недоступна.Поэтому сообщение попадает в очередь недоставленных сообщений с указанием причины сбоя, например "Неверная сигнатура".  
  
 Чтобы обойти эту проблему, можно отключить систему безопасности.Для этого задайте свойство <xref:System.ServiceModel.NetMsmqSecurity.Mode%2A> \= <xref:System.ServiceModel.NetMsmqSecurityMode>, чтобы оно работало в режиме рабочей группы.  
  
 Как вариант можно получить <xref:System.ServiceModel.MsmqTransportSecurity> из свойства <xref:System.ServiceModel.NetMsmqSecurity.Transport%2A> и присвоить ему значение <xref:System.ServiceModel.MsmqAuthenticationMode>, а затем задать сертификат клиента.  
  
 Еще одним обходным путем является установка MSMQ с интеграцией Active Directory.  
  
 **В.** При отправке в очередь сообщения с привязкой по умолчанию \(безопасность транспорта включена\) в Active Directory появляется сообщение "внутренний сертификат не найден".Как устранить эту проблему?  
  
 **О.** Это значит, что необходимо обновить для отправителя сертификат в Active Directory.Для этого откройте **Панель управления**, **Администрирование**, **Управление компьютером**, щелкните правой кнопкой мыши **MSMQ** и выберите **Свойства**.Выберите вкладку **Сертификат пользователя** и нажмите кнопку **Обновить**.  
  
 **В.** При отправке сообщения с помощью <xref:System.ServiceModel.MsmqAuthenticationMode> и задании используемого сертификата выводится сообщение "Недопустимый сертификат".Как устранить эту проблему?  
  
 **О.** Хранилище сертификатов локального компьютера нельзя использовать в режиме сертификатов.Необходимо скопировать сертификат из хранилища сертификатов компьютера в хранилище текущего пользователя с помощью оснастки сертификатов.Чтобы получить оснастку сертификатов, выполните следующие действия.  
  
1.  Нажмите кнопку **Пуск**, выберите пункт **Выполнить**, введите команду `mmc` и нажмите кнопку **ОК**.  
  
2.  В **Консоли управления \(MMC\)** откройте меню **Файл** и выберите пункт **Добавить или удалить оснастку**.  
  
3.  В диалоговом окне **Добавление или удаление оснастки** нажмите кнопку **Добавить**.  
  
4.  В диалоговом окне **Добавить изолированную оснастку** выберите "Сертификаты" и щелкните **Добавить**.  
  
5.  В диалоговом окне оснастки **Сертификаты** выберите **моей учетной записи пользователя** и щелкните **Готово**.  
  
6.  Затем добавьте вторую оснастку сертификатов с помощью шагов, описанных выше, но в этом случае выберите **учетной записи компьютера** и щелкните **Далее**.  
  
7.  Выберите **Локальный компьютер** и нажмите кнопку **Готово**.Теперь сертификаты можно перетаскивать из хранилища сертификатов компьютера в хранилище текущего пользователя.  
  
 **В.** Когда служба считывает из очереди на другом компьютере в режиме рабочей группы, получается исключение "в доступе отказано".  
  
 **О.** Чтобы удаленное приложение могло получить доступ к очереди в режиме рабочей группы, у данного приложения должно быть разрешение на доступ к очереди.Добавьте "Анонимный вход" в список управления доступом \(ACL\) очереди и предоставьте ему разрешение на чтение.  
  
 **В.** Когда клиент сетевой службы \(или любой другой клиент, не имеющий учетной записи домена\) отправляет сообщения из очереди, происходит сбой отправки с недопустимым сертификатом.Как устранить эту проблему?  
  
 **О.** Проверьте конфигурацию привязки.В привязке по умолчанию включена безопасность транспорта MSMQ для подписи сообщения.Отключите ее.  
  
### Удаленное получение транзакций  
 **В.** При наличии очереди на компьютере A и службы [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)], считывающей сообщения из очереди на компьютере B \(сценарий удаленного получения транзакций\), считывание сообщений из очереди не выполняется.Сведения трассировки указывают на сбой получения с сообщением «Не удается импортировать транзакцию». Как решить эту проблему?  
  
 **О.** Существуют три возможные причины этой ошибки.  
  
-   В режиме домена для удаленного получения транзакций требуется доступ к сети координатора распределенных транзакций \(Майкрософт\) \(MSDTC\).Его можно включить с помощью консоли **Добавление и удаление компонентов**.  
  
     ![Включение сетевого доступа DTC](../../../../docs/framework/wcf/feature-details/media/applicationserveraddcomps.jpg "ApplicationServerAddComps")  
  
-   Проверьте режим проверки подлинности для взаимодействия с диспетчером транзакций.В режиме рабочей группы необходимо выбрать параметр "Проверка подлинности не требуется".В режиме домена необходимо выбрать параметр "Требуется взаимная проверка подлинности".  
  
     ![Включение транзакций XA](../../../../docs/framework/wcf/feature-details/media/4f3695e0-fb0b-4c5b-afac-75f8860d2bb0.jpg "4f3695e0\-fb0b\-4c5b\-afac\-75f8860d2bb0")  
  
-   Убедитесь, что MSDTC находится в списке исключений в настройках **Брандмауэра подключения к Интернету**.  
  
-   Убедитесь, что используется [!INCLUDE[wv](../../../../includes/wv-md.md)].MSMQ в [!INCLUDE[wv](../../../../includes/wv-md.md)] поддерживает удаленное чтение в транзакциях.MSMQ в более ранних версиях Windows не поддерживает удаленное чтение в транзакциях.  
  
 **В.** Когда чтение из очереди выполняется сетевой службой, например размещенной на веб\-узле, почему при попытке чтения из очереди получается исключение "в доступе отказано"?  
  
 **О.** Доступ для чтения сетевой службы необходимо добавить в список ACL, чтобы сетевая служба могла читать из очереди.  
  
 **В.** Можно ли использовать службу активации MSMQ, чтобы активировать приложения, основанные на сообщениях в очереди на удаленном компьютере?  
  
 **О.** Да.Для этого необходимо настроить службу активации MSMQ для выполнения в качестве сетевой службы, а также добавить доступ сетевой службы к очереди на удаленном компьютере.  
  
## Использование пользовательских привязок MSMQ с включенным ReceiveContext  
 При использовании пользовательских привязок MSMQ с включенным <xref:System.ServiceModel.Channels.ReceiveContext> для обработки входящего сообщения будет использоваться поток из пула потоков, поскольку собственная MSMQ не поддерживает завершение ввода\-вывода для асинхронного получения <xref:System.ServiceModel.Channels.ReceiveContext>.Причина этого в том, что при обработке такого сообщения для <xref:System.ServiceModel.Channels.ReceiveContext> используются внутренние транзакции, а MSMQ не поддерживает асинхронной обработки.Эту проблему можно обойти, добавив <xref:System.ServiceModel.Description.SynchronousReceiveBehavior> к конечной точке для принудительной асинхронной обработки или установив для параметра <xref:System.ServiceModel.Description.DispatcherSynchronizationBehavior.MaxPendingReceives%2A> значение 1.