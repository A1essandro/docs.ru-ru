---
title: Работа с сертификатами
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- certificates [WCF]
ms.assetid: 6ffb8682-8f07-4a45-afbb-8d2487e9dbc3
ms.openlocfilehash: f5566eacaabb5d3eb5579d015fad8149a2ed4f3c
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
---
# <a name="working-with-certificates"></a>Работа с сертификатами
Программирование безопасности Windows Communication Foundation (WCF), цифровые сертификаты X.509, часто используются для проверки подлинности клиентов и серверов, шифрования и цифровой подписи сообщения. В этом разделе Краткое описание возможностей цифровой сертификат X.509 и способ их использования в WCF и содержит ссылки на разделы, подробным объяснением основных понятий и порядка выполнения общих задач с помощью WCF и сертификаты.  
  
 Вкратце, цифровой сертификат является частью *инфраструктуры открытых ключей* (PKI), который представляет собой систему цифровых сертификатов, центров сертификации и других центров регистрации, которые производит проверку допустимости и каждой стороны, участвующей в электронной транзакции, посредством использования асимметричного шифрования. Центр сертификации выдает сертификаты и каждый сертификат имеет набор полей, которые содержат данные, такие как *субъекта* (сущность, которому выдан сертификат), срока действия (если сертификат является действительным) издателя ( сущности, выдавшего сертификат) и открытый ключ. В WCF, каждое из этих свойств обрабатывается как <xref:System.IdentityModel.Claims.Claim>, и каждое утверждение затем подразделяется на два типа: удостоверение и право. Дополнительные сведения о X.509 см. [сертификаты открытого ключа X.509](http://go.microsoft.com/fwlink/?LinkId=209952)Дополнительные сведения об утверждениях и авторизации см. в разделе WCF [управление утверждениями и авторизацией с помощью модели удостоверения](../../../../docs/framework/wcf/feature-details/managing-claims-and-authorization-with-the-identity-model.md). Дополнительные сведения о реализации инфраструктуры открытых КЛЮЧЕЙ см. в разделе [Windows Server 2008 R2 — службы сертификации](http://go.microsoft.com/fwlink/?LinkId=209949).  
  
 Основной функцией сертификата является удостоверение подлинности владельца сертификата для других сторон. В сертификате содержится *открытый ключ* владельца, пока закрытый ключ хранится владельца. Открытый ключ можно использовать для зашифровывания сообщений, передаваемых владельцу сертификата. Доступ к закрытому ключу имеет только владелец сертификата, поэтому только он может расшифровать эти сообщения.  
  
 Сертификаты должны выдаваться центром сертификации, который обычно является сторонним издателем сертификатов. Домен Windows содержит центр сертификации, который можно использовать для выдачи сертификатов компьютерам домена.  
  
## <a name="viewing-certificates"></a>Просмотр сертификатов  
 При работе с сертификатами зачастую необходимо просматривать их и проверять определенные свойства. Это легко выполняется с помощью консоли управления (MMC). Дополнительные сведения см. в разделе [как: Просмотр сертификатов с помощью оснастки MMC](../../../../docs/framework/wcf/feature-details/how-to-view-certificates-with-the-mmc-snap-in.md).  
  
## <a name="certificate-stores"></a>Хранилища сертификатов  
 Сертификаты хранятся в хранилищах. Существует два основных хранилища, которые подразделяются на вложенные хранилища. Администратор компьютера может просматривать оба основных хранилища с помощью средства MMC. Пользователи, не являющиеся администраторами, могут просматривать только хранилище текущего пользователя.  
  
-   **Хранилище локального компьютера**. Содержит сертификаты, доступ к которым осуществляется выполняющимися на компьютере процессами, такими как [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]. Это расположение используется для хранения сертификатов, удостоверяющих подлинность сервера для клиентов.  
  
-   **В хранилище текущего пользователя**. Интерактивные приложения обычно помещают сертификаты в это хранилище для текущего пользователя компьютера. В случае клиентского приложения в это хранилище обычно помещаются сертификаты, используемые для проверки подлинности пользователя при подключении к службе.  
  
 Эти два хранилища подразделяются на вложенные хранилища. Наиболее важные из них при программировании с использованием WCF включают:  
  
-   **Доверенные корневые центры сертификации**. Сертификаты из этого хранилища можно использовать для создания цепочки сертификатов, которую можно проследить до сертификата центра сертификации в этом хранилище.  
  
    > [!IMPORTANT]
    >  Локальный компьютер полностью доверяет любому сертификату, помещенному в это хранилище, даже если он поступил не из доверенного стороннего центра сертификации. Поэтому в данное хранилище не следует помещать сертификаты, к издателям которых нет полного доверия, или если последствия не до конца ясны.  
  
-   **Личные**. Это хранилище используется для хранения сертификатов, связанных с пользователем компьютера. Обычно в этом хранилище хранятся сертификаты, выданные одним из центров сертификации, сертификаты которых находятся в хранилище «Доверенные корневые центры сертификации». С другой стороны, сертификат, находящийся в этом хранилище, может быть самостоятельно выданным, и ему будет доверять приложение.  
  
 Дополнительные сведения о хранилищах сертификатов см. в разделе [хранилищ сертификатов](http://go.microsoft.com/fwlink/?LinkId=88912).  
  
### <a name="selecting-a-store"></a>Выбор хранилища  
 Выбор расположения для хранения сертификата зависит от режима и места выполнения клиента или службы. Действуют следующие общие правила.  
  
-   Если служба WCF размещается в службе Windows, используйте **локального компьютера** хранения. Обратите внимание, что для установки сертификатов в хранилище локального компьютера требуются привилегии администратора.  
  
-   Если служба или клиент является приложение, которое выполняется под учетной записью пользователя, используйте **текущего пользователя** хранения.  
  
### <a name="accessing-stores"></a>Доступ к хранилищам  
 Хранилища защищаются с помощью списков управления доступом (ACL) аналогично папкам на компьютере. При создании службы, размещаемой в IIS, процесс [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] выполняется от имени учетной записи [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)]. Эта учетная запись должна иметь доступ к хранилищу, в котором содержатся используемые службой сертификаты. Каждое основное хранилище защищается с помощью списка управления доступом по умолчанию, однако списки можно изменять. При создании отдельной роли для доступа к хранилищу необходимо предоставить ей разрешение на доступ. Узнайте, как изменить список доступа, с помощью средства WinHttpCertConfig.exe, см. [как: создание временных сертификатов для использования во время разработки](../../../../docs/framework/wcf/feature-details/how-to-create-temporary-certificates-for-use-during-development.md). Дополнительные сведения об использовании сертификатов с IIS см. в разделе [способ вызова веб-службы с помощью сертификата клиента для проверки подлинности в веб-приложение ASP.NET](http://go.microsoft.com/fwlink/?LinkId=88914).  
  
## <a name="chain-trust-and-certificate-authorities"></a>Цепочка доверия и центры сертификации  
 Сертификаты создаются в иерархии, где каждый отдельный сертификат связан с выдавшим его органом сертификации. Эта ссылка указывает на сертификат органа сертификации. Далее сертификат органа сертификации связан с органом сертификации, выдавшим исходный сертификат. Процесс повторяется до тех пор, пока не будет достигнут корневой сертификат органа сертификации. Сертификат корневого органа сертификации является изначально доверенным.  
  
 Цифровые сертификаты используются для проверки подлинности сущности на основе этой иерархии, также называемый *цепочка доверия*. Можно просмотреть цепочку любого сертификата, с помощью оснастки MMC, дважды щелкнув сертификат и выбрав **путь к сертификату** вкладки. Дополнительные сведения об импорте цепочек сертификатов центра сертификации см. в разделе [как: Укажите сертификат центра сертификатов цепочки использовать для проверки подписи](../../../../docs/framework/wcf/feature-details/specify-the-certificate-authority-chain-verify-signatures-wcf.md).  
  
> [!NOTE]
>  Любой издатель может быть сделан доверенным корневым центром; для этого необходимо поместить сертификат издателя в хранилище сертификатов доверенных корневых центров.  
  
### <a name="disabling-chain-trust"></a>Отключение механизма проверки цепочки доверия  
 При создании новой службы пользователь может использовать сертификат, который был выдан центром сертификации, отличным от доверенного, или сертификат издателя может отсутствовать в хранилище «Доверенные корневые центры сертификации». Предусмотрена возможность временного отключения механизма, проверяющего цепочку сертификатов для заданного сертификата; эта возможность должна использоваться только в процессе разработки. Чтобы отключить данный механизм, задайте для свойства `CertificateValidationMode` значение `PeerTrust` или `PeerOrChainTrust`. Эти режимы определяют, что сертификат может быть либо самостоятельно выданным (доверие одноранговой группы), либо являться частью цепочки доверия. Указанное свойство можно задать для любого из следующих классов.  
  
|Класс|Свойство.|  
|-----------|--------------|  
|<xref:System.ServiceModel.Security.X509ClientCertificateAuthentication>|<xref:System.ServiceModel.Security.X509ClientCertificateAuthentication.CertificateValidationMode%2A?displayProperty=nameWithType>|  
|<xref:System.ServiceModel.Security.X509PeerCertificateAuthentication>|<xref:System.ServiceModel.Security.X509PeerCertificateAuthentication.CertificateValidationMode%2A?displayProperty=nameWithType>|  
|<xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication>|<xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication.CertificateValidationMode%2A?displayProperty=nameWithType>|  
|<xref:System.ServiceModel.Security.IssuedTokenServiceCredential>|<xref:System.ServiceModel.Security.IssuedTokenServiceCredential.CertificateValidationMode%2A?displayProperty=nameWithType>|  
  
 Свойство также можно задать с использованием конфигурации. Для задания режима проверки используются следующие элементы.  
  
-   [\<Проверка подлинности >](../../../../docs/framework/configure-apps/file-schema/wcf/authentication-of-servicecertificate-element.md)  
  
-   [\<peerAuthentication >](../../../../docs/framework/configure-apps/file-schema/wcf/peerauthentication-element.md)  
  
-   [\<messageSenderAuthentication >](../../../../docs/framework/configure-apps/file-schema/wcf/messagesenderauthentication-element.md)  
  
## <a name="custom-authentication"></a>Пользовательская проверка подлинности  
 Свойство `CertificateValidationMode` также позволяет настроить способ проверки сертификатов. По умолчанию задано значение `ChainTrust`. Чтобы использовать значение <xref:System.ServiceModel.Security.X509CertificateValidationMode.Custom>, необходимо также установить атрибут `CustomCertificateValidatorType` для сборки и типа, которые используются при проверке сертификата. Для создания пользовательского проверяющего элемента управления необходимо наследование от абстрактного класса <xref:System.IdentityModel.Selectors.X509CertificateValidator>.  
  
 При создании пользовательской структуры проверки подлинности наиболее важным методом, который необходимо переопределить, является метод <xref:System.IdentityModel.Selectors.X509CertificateValidator.Validate%2A>. Пример пользовательской проверки подлинности см. в разделе [проверки подлинности сертификатов X.509](../../../../docs/framework/wcf/samples/x-509-certificate-validator.md) образца. Дополнительные сведения см. в разделе [пользовательских учетных данных и проверки учетных данных](../../../../docs/framework/wcf/extending/custom-credential-and-credential-validation.md).  
  
## <a name="using-makecertexe-to-build-a-certificate-chain"></a>Использование программы Makecert.exe для создания цепочки сертификатов  
 Средство создания сертификатов (Makecert.exe) позволяет создавать сертификаты X.509, а также пары открытого и закрытого ключей. Закрытый ключ можно сохранить на диск, а затем использовать его для выдачи и подписи новых сертификатов, что позволяет имитировать иерархию цепочки сертификатов. Данное средство предназначено для использования только в качестве вспомогательного инструмента при разработке служб; его не следует использовать с целью создания сертификатов для фактического развертывания. При разработке службы WCF, используйте следующие шаги для создания цепочки доверия с помощью Makecert.exe.  
  
#### <a name="to-build-a-chain-of-trust-with-makecertexe"></a>Создание цепочки доверия с помощью программы Makecert.exe  
  
1.  Создайте временный сертификат корневого центра (самозаверяющий) с помощью программы MakeCert.exe. Сохраните закрытый ключ на диск.  
  
2.  Воспользуйтесь новым сертификатом для выдачи другого сертификата, содержащего открытый ключ.  
  
3.  Импортируйте сертификат корневого центра в хранилище «Доверенные корневые центры сертификации».  
  
4.  Пошаговые инструкции см. в разделе [как: создание временных сертификатов для использования во время разработки](../../../../docs/framework/wcf/feature-details/how-to-create-temporary-certificates-for-use-during-development.md).  
  
## <a name="which-certificate-to-use"></a>Выбор сертификата для использования  
 Наиболее распространенными вопросами о сертификатах являются следующие: какой сертификат использовать и почему? Ответ зависит от того, что программирует пользователь - клиент или службу. Ниже представлены общие рекомендации; следует иметь виду, что они не являются исчерпывающими ответами на поставленные вопросы.  
  
### <a name="service-certificates"></a>Сертификаты служб  
 Основной задачей сертификатов служб является удостоверение подлинности сервера для клиентов. Один из исходных проверок, когда клиент выполняет проверку подлинности сервера заключается в сравнении значение **субъекта** поле универсальный код ресурса (URI) используется для обращения к службе: DNS-имена должны совпадать. Например, если URL-адрес службы является «http://www.contoso.com/endpoint/» то **субъекта** должно также содержаться значение «www.contoso.com».  
  
 Обратите внимание, что в этом поле может содержаться несколько значений с отдельными префиксами. Чаще всего префикс "CN" используется для указания общего имени, например, "CN = www.contoso.com". Существует также возможность **субъекта** может быть пустым, в этом случае **альтернативное имя субъекта** поле может содержать **DNS-имя** значение.  
  
 Также Обратите внимание на значение **назначения** поле сертификата должно включать соответствующее значение, например «Server Authentication» или «Проверка подлинности клиента».  
  
### <a name="client-certificates"></a>Сертификаты клиентов  
 Сертификаты клиентов, как правило, выдаются не сторонними центрами сертификации. В хранилище «Личное» текущего пользователя обычно содержатся сертификаты, выданные корневым центром; в поле «Назначения» этих сертификатов задано значение «Проверка подлинности клиента». Клиент может использовать такой сертификат, когда требуется взаимная проверка подлинности.  
  
## <a name="online-revocation-and-offline-revocation"></a>Проверка отзыва сертификатов в режиме подключения к сети и автономном режиме  
  
### <a name="certificate-validity"></a>Срок действия сертификата  
 Каждый сертификат действителен только в течение заданного времени, который называется *срок*. Срок действия определяется **действителен с** и **действителен по** поля сертификата X.509. Во время проверки подлинности проверяется, не истек ли срок действия сертификата.  
  
### <a name="certificate-revocation-list"></a>Список отзыва сертификатов  
 Центр сертификации может отменить действующий сертификат в любой момент. Это может произойти по многим причинам, например при компрометации закрытого ключа сертификата.  
  
 В этом случае все цепочки, происходящие от отозванного сертификата, также становятся недействительными и механизмы проверки подлинности перестают им доверять. Чтобы узнать, какие сертификаты отозваны, каждый издатель публикует и даты меткой времени *список отзыва сертификатов* (CRL). Этот список можно проверить с помощью режима с подключением к сети или автономного режима, задав одно из значений перечисления `RevocationMode` для свойства `DefaultRevocationMode` или <xref:System.Security.Cryptography.X509Certificates.X509RevocationMode> следующих классов: <xref:System.ServiceModel.Security.X509ClientCertificateAuthentication>, <xref:System.ServiceModel.Security.X509PeerCertificateAuthentication>, <xref:System.ServiceModel.Security.X509ServiceCertificateAuthentication> и <xref:System.ServiceModel.Security.IssuedTokenServiceCredential>. Значение по умолчанию для всех свойств - `Online`.  
  
 Можно также задать режим в конфигурации с помощью `revocationMode` оба атрибута [ \<проверки подлинности >](../../../../docs/framework/configure-apps/file-schema/wcf/authentication-of-clientcertificate-element.md) (из [ \<serviceBehaviors >](../../../../docs/framework/configure-apps/file-schema/wcf/servicebehaviors.md)) и [ \<проверки подлинности >](../../../../docs/framework/configure-apps/file-schema/wcf/authentication-of-clientcertificate-element.md) (из [ \<endpointBehaviors >](../../../../docs/framework/configure-apps/file-schema/wcf/endpointbehaviors.md)).  
  
## <a name="the-setcertificate-method"></a>Метод SetCertificate  
 В WCF часто необходимо указать сертификат или набор сертификатов, служба или клиент будет использовать для проверки подлинности, шифрования и цифровой подписи сообщения. Это можно сделать программно с помощью метода `SetCertificate` различных классов, представляющих сертификаты X.509. Следующие классы используют метод `SetCertificate` для задания сертификата.  
  
|Класс|Метод|  
|-----------|------------|  
|<xref:System.ServiceModel.Security.PeerCredential>|<xref:System.ServiceModel.Security.PeerCredential.SetCertificate%2A>|  
|<xref:System.ServiceModel.Security.X509CertificateInitiatorClientCredential>|<xref:System.ServiceModel.Security.X509CertificateInitiatorClientCredential.SetCertificate%2A>|  
|<xref:System.ServiceModel.Security.X509CertificateRecipientServiceCredential>|<xref:System.ServiceModel.Security.X509CertificateRecipientServiceCredential.SetCertificate%2A>|  
|<xref:System.ServiceModel.Security.X509CertificateInitiatorServiceCredential>|  
|<xref:System.ServiceModel.Security.X509CertificateInitiatorServiceCredential.SetCertificate%2A>|  
  
 Метод `SetCertificate` позволяет задать хранилище и его расположение, тип поиска (параметр `x509FindType`), определяющий поле сертификата, и значение, которое требуется найти в данном поле. Например, следующий код создает <xref:System.ServiceModel.ServiceHost> экземпляра и задает сертификат службы, используемый для проверки подлинности службы для клиентов с `SetCertificate` метод.  
  
 [!code-csharp[c_WorkingWithCertificates#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_workingwithcertificates/cs/source.cs#1)]
 [!code-vb[c_WorkingWithCertificates#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_workingwithcertificates/vb/source.vb#1)]  
  
### <a name="multiple-certificates-with-the-same-value"></a>Несколько сертификатов с одинаковыми значениями полей  
 В хранилище может содержаться несколько сертификатов с одним и тем же именем субъекта. Это означает, что если указать, что `x509FindType` — <xref:System.Security.Cryptography.X509Certificates.X509FindType.FindBySubjectName> или <xref:System.Security.Cryptography.X509Certificates.X509FindType.FindBySubjectDistinguishedName>и более одного сертификата имеет то же значение, создается исключение, так как нет способа определить, какой сертификат является обязательным. Это можно подавить, задав для параметра `x509FindType` значение <xref:System.Security.Cryptography.X509Certificates.X509FindType.FindByThumbprint>. В поле отпечатка содержится уникальное значение, которое можно использовать для поиска конкретного сертификата в хранилище. Однако у данного подхода есть свой недостаток: если сертификат был отозван или обновлен, метод `SetCertificate` выполнить не удастся, поскольку исходный отпечаток на будет найден. А если сертификат является недействительным, проверка подлинности не будет пройдена. Это можно подавить, задав для параметра `x590FindType` значение <xref:System.Security.Cryptography.X509Certificates.X509FindType.FindByIssuerName> и указав имя издателя. Если указывать издателя не требуется, можно также задать одно из значений перечисления <xref:System.Security.Cryptography.X509Certificates.X509FindType>, например <xref:System.Security.Cryptography.X509Certificates.X509FindType.FindByTimeValid>.  
  
## <a name="certificates-in-configuration"></a>Сертификаты в конфигурации  
 Сертификаты также можно задать с использованием конфигурации. При создании службы, учетные данные, включая сертификаты, определены в разделе [ \<serviceBehaviors >](../../../../docs/framework/configure-apps/file-schema/wcf/servicebehaviors.md). При программировании клиента, сертификаты указанные в разделе [ \<endpointBehaviors >](../../../../docs/framework/configure-apps/file-schema/wcf/endpointbehaviors.md).  
  
## <a name="mapping-a-certificate-to-a-user-account"></a>Сопоставление сертификата с учетной записью пользователя  
 Службы IIS и Active Directory предусматривают возможность сопоставления сертификата с учетной пользовательской записью Windows. Дополнительные сведения о компоненте см. в разделе [сопоставить сертификаты для учетных записей пользователей](http://go.microsoft.com/fwlink/?LinkId=88917).  
  
 Дополнительные сведения об использовании сопоставление Active Directory см. в разделе [сопоставление сертификатов клиента с сопоставления службы каталогов](http://go.microsoft.com/fwlink/?LinkId=88918).  
  
 Если эта функция включена, можно задать для свойства <xref:System.ServiceModel.Security.X509ClientCertificateAuthentication.MapClientCertificateToWindowsAccount%2A> класса <xref:System.ServiceModel.Security.X509ClientCertificateAuthentication> значение `true`. В конфигурации, можно задать `mapClientCertificateToWindowsAccount` атрибут [ \<проверки подлинности >](../../../../docs/framework/configure-apps/file-schema/wcf/authentication-of-servicecertificate-element.md) элемента `true`, как показано в следующем коде.  
  
```xml  
<serviceBehaviors>  
 <behavior name="MappingBehavior">  
  <serviceCredentials>  
   <clientCertificate>  
    <authentication certificateValidationMode="None" mapClientCertificateToWindowsAccount="true" />  
   </clientCertificate>  
  </serviceCredentials>  
 </behavior>  
</serviceBehaviors>  
```  
  
 Сопоставление сертификата X.509 с маркером, представляющим учетную запись пользователя Windows, считается повышением привилегий, поскольку после сопоставления маркер Windows может использоваться для получения доступа к защищенным ресурсам. Поэтому перед сопоставлением необходимо проверить, что сертификат X.509 соответствует политике домена. *SChannel* пакет безопасности обеспечивает выполнение этого требования.  
  
 При использовании [!INCLUDE[netfx35_long](../../../../includes/netfx35-long-md.md)] или более поздней версии, WCF обеспечивает сертификат соответствует политике домена перед его сопоставлением с учетной записью Windows.  
  
 В первом выпуске WCF сопоставление выполняется без обращения к политике домена. Поэтому более старые приложения, которые работали при использовании первого выпуска, могут не работать, если включено сопоставление и сертификат X.509 не удовлетворяет требованиям политики домена.  
  
## <a name="see-also"></a>См. также  
 <xref:System.ServiceModel.Channels>  
 <xref:System.ServiceModel.Security>  
 <xref:System.ServiceModel>  
 <xref:System.Security.Cryptography.X509Certificates.X509FindType>  
 [Защита служб и клиентов](../../../../docs/framework/wcf/feature-details/securing-services-and-clients.md)
