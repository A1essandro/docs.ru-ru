---
title: "Настройка трассировки"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords: tracing [WCF]
ms.assetid: 82922010-e8b3-40eb-98c4-10fc05c6d65d
caps.latest.revision: "53"
author: Erikre
ms.author: erikre
manager: erikre
ms.openlocfilehash: d516d20144b40aa52a5b11177c6794a6935ba989
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2017
---
# <a name="configuring-tracing"></a>Настройка трассировки
В этом разделе описывается, как включить трассировку, настроить создание трассировки источниками трассировки и задать уровни трассировки, задать распространение и трассировку действий для поддержки сквозной корреляции трассировки, а также настроить доступ прослушивателей трассировки к трассировкам.  
  
 Рекомендации параметры трассировки в рабочей среде или среде отладки, см. в разделе [рекомендуемые параметры для трассировки и ведения журнала сообщений](../../../../../docs/framework/wcf/diagnostics/tracing/recommended-settings-for-tracing-and-message-logging.md).  
  
> [!IMPORTANT]
>  В Windows 8, чтобы приложение могло создавать журналы трассировки, необходимо запустить его с расширенными правами доступа (запуск от имени администратора).  
  
## <a name="enabling-tracing"></a>Включение трассировки  
 [!INCLUDE[indigo1](../../../../../includes/indigo1-md.md)] выдает следующие данные для диагностической трассировки:  
  
-   Трассировки основных этапов процесса по всем компонентам приложений, таких как вызовы операций, исключения кода, предупреждения и прочие значительные события обработки.  
  
-   События ошибок Windows при сбоях возможности трассировки. В разделе [ведение журнала событий](../../../../../docs/framework/wcf/diagnostics/event-logging/index.md).  
  
 Функция трассировки [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] является надстройкой к <xref:System.Diagnostics>. Чтобы воспользоваться трассировкой, необходимо определить источники трассировки в файле конфигурации или в коде. В [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] определяется источник трассировки для каждой сборки [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)]. Источник трассировки `System.ServiceModel` - наиболее общий источник трассировки [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)], записывающий основные этапы приложения по всему стеку связи [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)]: от входа и выхода из транспорта до входа и выхода из пользовательского кода. Источник трассировки `System.ServiceModel.MessageLogging` записывает все сообщения, проходящие через систему.  
  
 По умолчанию трассировка отключена. Чтобы включить трассировку, необходимо создать прослушиватель трассировки и задать уровень трассировки, отличный от "Выкл.", для выбранного источника трассировки в конфигурации. В противном случае [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] не создает трассировку. Если прослушиватель не указан, трассировка автоматически отключается. Если прослушиватель определен, но уровень не указан, по умолчанию устанавливается уровень «Off», при котором трассировка не создается.  
  
 Если используются точки расширяемости [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)], например средства вызова пользовательских операций, необходимо создавать свои собственные трассировки. Причина в том, что, если реализована точка расширяемости, [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] не сможет создавать стандартные трассировки в пути по умолчанию. Если поддержка трассировки вручную путем создания трассировки не реализована, можно не увидеть ожидаемые трассировки.  
  
 Трассировку можно настроить, внеся изменения в файл конфигурации приложения: Web.config (для веб-приложений) или Appname.exe.config (для резидентных приложений). Ниже приводится пример подобного изменения. Дополнительные сведения об этих параметрах см. в разделе «Настройка трассировки потребления трассировки прослушивателями».  
  
```xml  
<configuration>  
   <system.diagnostics>  
      <sources>  
            <source name="System.ServiceModel"   
                    switchValue="Information, ActivityTracing"  
                    propagateActivity="true">  
            <listeners>  
               <add name="traceListener"   
                   type="System.Diagnostics.XmlWriterTraceListener"   
                   initializeData= "c:\log\Traces.svclog" />  
            </listeners>  
         </source>  
      </sources>  
   </system.diagnostics>  
</configuration>  
```  
  
> [!NOTE]
>  Чтобы изменить файл конфигурации [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] проект службы в [!INCLUDE[vs_current_short](../../../../../includes/vs-current-short-md.md)], щелкните правой кнопкой мыши файл конфигурации приложения: Web.config для веб-приложений, либо Appname.exe.config для резидентных приложений в  **Обозреватель решений**. Выберите **изменить конфигурацию WCF** пункт контекстного меню. Будет запущен [средство редактирования конфигурации (SvcConfigEditor.exe)](../../../../../docs/framework/wcf/configuration-editor-tool-svcconfigeditor-exe.md), который позволяет изменять параметры конфигурации для [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] службы с помощью графического интерфейса пользователя.  
  
## <a name="configuring-trace-sources-to-emit-traces"></a>Настройка создания трассировки источниками трассировки  
 В [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] определяется источник трассировки для каждой сборки. Трассировки, созданные в пределах сборки, доступны прослушивателям, определенным для этого источника. Определяются следующие источники трассировки:  
  
-   System.ServiceModel: записывает в журнал все этапы обработки [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)], будь то чтение конфигурации, обработка сообщения в транспорте, обработка событий безопасности, отправка сообщения в пользовательском коде и т. д.  
  
-   System.ServiceModel.MessageLogging: записывает в журнал все сообщения, проходящие через систему.  
  
-   System.IdentityModel.  
  
-   System.ServiceModel.Activation.  
  
-   System.IO.Log: средство ведения журнала для интерфейса платформы .NET Framework для системы CLFS.  
  
-   System.Runtime.Serialization: регистрирует в журнале чтение и запись объектов.  
  
-   CardSpace.  
  
 Можно настроить все источники трассировки так, чтобы они использовали один и тот же (общий) прослушиватель, как показано в следующем примере конфигурации.  
  
```xml  
<configuration>  
    <system.diagnostics>  
        <sources>  
            <source name="System.ServiceModel"   
                    switchValue="Information, ActivityTracing"  
                    propagateActivity="true">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="CardSpace">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.IO.Log">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.Runtime.Serialization">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.IdentityModel">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
        </sources>  
  
        <sharedListeners>  
            <add name="xml"  
                 type="System.Diagnostics.XmlWriterTraceListener"  
                 initializeData="c:\log\Traces.svclog" />  
        </sharedListeners>  
    </system.diagnostics>  
</configuration>  
```  
  
 Кроме того, можно добавить пользовательские источники трассировки, создающие трассировки пользовательского кода, как показано в следующем примере.  
  
```xml  
<system.diagnostics>  
   <sources>  
       <source name="UserTraceSource" switchValue="Warning, ActivityTracing" >  
          <listeners>  
              <add name="xml"  
                 type="System.Diagnostics.XmlWriterTraceListener"  
                 initializeData="C:\logs\UserTraces.svclog" />  
          </listeners>  
       </source>  
   </sources>  
   <trace autoflush="true" />   
</system.diagnostics>  
```  
  
 [!INCLUDE[crabout](../../../../../includes/crabout-md.md)]Создание определяемых пользователем источники трассировки см. в разделе [расширение трассировки](../../../../../docs/framework/wcf/samples/extending-tracing.md).  
  
## <a name="configuring-trace-listeners-to-consume-traces"></a>Настройка потребления трассировки прослушивателями трассировки  
 Во время выполнения [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] передает данные трассировки прослушивателям, которые их обрабатывают. [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] предоставляет несколько стандартных прослушивателей для <xref:System.Diagnostics>, отличающихся друг от друга форматом выводимых данных. Можно добавлять пользовательские типы прослушивателей.  
  
 С помощью `add` можно задать имя и тип прослушивателя трассировки, который требуется использовать. В данном примере конфигурации создается прослушиватель с именем `traceListener` и добавляется стандартный прослушиватель трассировки .NET Framework (`System.Diagnostics.XmlWriterTraceListener`) в качестве типа, который требуется использовать. Для каждого источника можно добавить любое количество прослушивателей трассировки. Если прослушиватель трассировки выполняет трассировку в файл, необходимо указать расположение и имя выходного файла в файле конфигурации. Для этого необходимо указать имя файла для этого прослушивателя в качестве значения для `initializeData`. Если имя файла не указано, используется случайное имя, сгенерированное на основе используемого типа прослушивателя. Если используется <xref:System.Diagnostics.XmlWriterTraceListener>, создается имя файла без расширения. Если реализовать пользовательский прослушиватель, с помощью этого атрибута также можно получать другие данные инициализации, помимо имени файла. Например, с его помощью можно указать идентификатор базы данных.  
  
 Пользовательский прослушиватель трассировки можно настроить так, чтобы он отправлял трассировку по сети, например в удаленную базу данных. Разработчику приложения следует обеспечить надлежащее управление доступом к журналам трассировки на удаленном компьютере.  
  
 Также можно настроить прослушиватель трассировки программно. [!INCLUDE[crdefault](../../../../../includes/crdefault-md.md)][Как: Создание и инициализация прослушивателей трассировки](http://go.microsoft.com/fwlink/?LinkId=94648) и [Создание пользовательский прослушиватель трассировки](http://go.microsoft.com/fwlink/?LinkId=96239).  
  
> [!CAUTION]
>  Поскольку прослушиватель `System.Diagnostics.XmlWriterTraceListener` не является потокобезопасным, источник трассировки может монопольно блокировать ресурсы при выводе трассировки. Если несколько потоков выводят трассировку в источник трассировки, использующий (согласно заданным настройкам) этот прослушиватель, может возникнуть состязание за ресурсы, что приводит к существенному падению производительности. Чтобы устранить эту проблему, реализуйте потокобезопасный пользовательский прослушиватель.  
  
## <a name="trace-level"></a>Уровень трассировки  
 Уровень трассировки контролируется параметром `switchValue` источника трассировки. Доступные уровни трассировки приведены в следующей таблице.  
  
|Уровень трассировки|Характер отслеживаемых событий|Содержимое отслеживаемых событий|Отслеживаемые события|Целевая категория пользователей|  
|-----------------|----------------------------------|-----------------------------------|--------------------|-----------------|  
|Off|Н/Д|Н/Д|Трассировки не создаются.|Н/Д|  
|Critical|«Негативные» события: указывающие о непредвиденном состоянии обработки или об ошибке.||В журнал заносятся необработанные исключения, в том числе следующие:<br /><br /> -OutOfMemoryException<br />-ThreadAbortException (среда CLR вызывает ThreadAbortExceptionHandler)<br />-StackOverflowException (не может быть перехвачено)<br />-ConfigurationErrorsException<br />-SEHException<br />-Запуска ошибки<br />-События Failfast<br />-Система зависает<br />-Подозрительные сообщения: трассировки сообщений, которые приводят к сбою приложения.|Администраторы<br /><br /> Разработчики приложений|  
|Ошибка|«Негативные» события: указывающие о непредвиденном состоянии обработки или об ошибке.|Возникло непредвиденное состояние обработки. Приложению не удалось выполнить задачу требуемым образом. Впрочем, приложение все еще работает.|Все исключения заносятся в журнал.|Администраторы<br /><br /> Разработчики приложений|  
|Предупреждение|«Негативные» события: указывающие о непредвиденном состоянии обработки или об ошибке.|Возникла (или может возникнуть) проблема, но приложение все же работает надлежащим образом. Впрочем, его правильное выполнение может прекратиться.|-Приложение получает больше запросов, чем его параметрами регулирования.<br />-Принимающая очередь близка к заданному максимальному пределу емкости.<br />-Превышено время ожидания.<br />-Учетные данные не принимаются.|Администраторы<br /><br /> Разработчики приложений|  
|Сведения|«Позитивные» события: отмечающие успешно пройденные основные этапы|Успешно пройденные важные этапы выполнения приложения, вне зависимости от того, правильно ли работает приложение.|Как правило, создаются сообщения, полезные для мониторинга и диагностики состояния системы, измерений производительности или профилирования. Эту информацию можно использовать для планирования загрузки и управления производительностью.<br /><br /> -Создание каналов.<br />-Создание конечной точки прослушивателей.<br />-Сообщение вводит и оставляет транспорта.<br />-Извлечение маркера безопасности.<br />-Чтение параметра конфигурации.|Администраторы<br /><br /> Разработчики приложений<br /><br /> Разработчики программных продуктов.|  
|Verbose|«Позитивные» события: отмечающие успешно пройденные основные этапы.|Создаются события низкого уровня как для пользовательского кода, так и для обслуживания.|Как правило, этот уровень можно использовать для отладки или оптимизации приложения.<br /><br /> -Распознанный заголовок сообщения.|Администраторы<br /><br /> Разработчики приложений<br /><br /> Разработчики программных продуктов.|  
|ActivityTracing||События переходов между действиями по обработке и компонентами.|Этот уровень позволяет администраторам и разработчикам коррелировать приложения из одного домена приложений.<br /><br /> -Трассировки границ действий, таких как запуск и остановка.<br />-Трассировки для перенаправлений.|Все|  
|Все||Приложение может работать надлежащим образом. Создаются все события.|Все вышеперечисленные события.|Все|  
  
 Каждый уровень трассировки от Verbose до Critical включает все вышестоящие уровни, за исключением уровня "Off". Например, если прослушиватель прослушивает уровень Warning, он получает трассировки, имеющие уровень Critical, Error и Warning. Уровень All включает в себя все события уровней от Verbose до Critical, а также события ActivityTracing (прослеживание действий).  
  
> [!CAUTION]
>  Уровни Information, Verbose и ActivityTracing создают большое количество трассировок, что может негативно сказаться на производительности в отношении обработки сообщений, если все доступные ресурсы компьютера использованы.  
  
## <a name="configuring-activity-tracing-and-propagation-for-correlation"></a>Настройка распространения и трассировки действий для корреляции  
 Для атрибута `activityTracing` можно задать значение `switchValue`, чтобы включить трассировку действий, создающую трассировку для границ действий и передач в пределах конечных точек.  
  
> [!NOTE]
>  При использовании некоторых возможностей расширяемости [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] можно получить исключение <xref:System.NullReferenceException>, если включена трассировка действий. Чтобы устранить эту проблему, проверьте файл конфигурации своего приложения: атрибут `switchValue` для соответствующего источника трассировки не должен иметь значение `activityTracing`.  
  
 Атрибут `propagateActivity` указывает, должно ли действие распространяться на другие конечные точки, участвующие в обмене сообщениями. Если присвоить ему значение `true`, можно с помощью файлов трассировки, созданных любыми двумя конечными точками, проследить прохождение набора трассировок от одной конечной точки до набора трассировок на другой конечной точке.  
  
 [!INCLUDE[crabout](../../../../../includes/crabout-md.md)]Трассировка действий и распространение, см. [распространения](../../../../../docs/framework/wcf/diagnostics/tracing/propagation.md).  
  
 Оба `propagateActivity` и `ActivityTracing` логические значения применяются к источнику трассировки System.ServiceModel. `ActivityTracing` Значение также применяется к любому источнику трассировки, включая [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] или определенные пользователем.  
  
 Атрибут `propagateActivity` нельзя использовать для пользовательских источников трассировок. Для распространения идентификатора действия пользовательского кода необходимо убедиться, что ServiceModel `ActivityTracing` не задано, тогда как ServiceModel `propagateActivity` имеет значение `true`.  
  
## <a name="see-also"></a>См. также  
 [Трассировка](../../../../../docs/framework/wcf/diagnostics/tracing/index.md)  
 [Администрирование и диагностика](../../../../../docs/framework/wcf/diagnostics/index.md)  
 [Как: Создание и инициализация прослушивателей трассировки](http://go.microsoft.com/fwlink/?LinkId=94648)  
 [Создание пользовательский прослушиватель трассировки](http://go.microsoft.com/fwlink/?LinkId=96239)
