---
title: "Вопросы безопасности (платформа Entity Framework) | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-4.6"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-ado"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
  - "C++"
ms.assetid: 84758642-9b72-4447-86f9-f831fef46962
caps.latest.revision: 4
author: "JennieHubbard"
ms.author: "jhubbard"
manager: "jhubbard"
caps.handback.revision: 4
---
# Вопросы безопасности (платформа Entity Framework)
В этом разделе приводятся сведения по безопасности, связанные с разработкой, развертыванием и запуском приложений [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  Необходимо также следовать инструкциям по созданию безопасных приложений [!INCLUDE[dnprdnshort](../../../../../includes/dnprdnshort-md.md)].  Для получения дополнительной информации см. [Общие сведения о безопасности](../../../../../docs/framework/data/adonet/security-overview.md).  
  
## Общие соображения безопасности  
 Следующие вопросы безопасности актуальны для всех приложений [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  
  
#### Использование только доверенных поставщиков источников данных.  
 Для обеспечения связи с источником данных поставщик должен выполнить следующие действия:  
  
-   получить строку соединения от [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)];  
  
-   перевести дерево команд на собственный язык запросов источника данных;  
  
-   собрать и возвратить результирующие наборы.  
  
 Во время операции входа в систему сведения, полученные с помощью пароля пользователя, передаются на сервер через сетевые библиотеки базового источника данных.  Злонамеренный поставщик может похитить учетные данные пользователя, сформировать вредоносные запросы или внести несанкционированные изменения в результирующий набор.  
  
#### Шифрование соединения для защиты конфиденциальных данных  
 В [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] непосредственно не выполняется шифрование данных.  Если пользователи получают доступ к данным через открытую сеть, то в приложении для повышения безопасности необходимо устанавливать зашифрованное соединение с источником данных.  Дополнительные сведения см. в документации источника данных, связанной с безопасностью.  Сведения об источнике данных SQL Server см. в разделе [Шифрование соединений с SQL Server](http://go.microsoft.com/fwlink/?LinkId=119544).  
  
#### Защита строки соединения  
 Защита доступа к источникам данным \- одна из важнейших целей защиты приложения.  Строка соединения потенциально уязвима, если не защищена или не сформирована должным образом.  Хранение сведений о соединении в виде простого текста или хранение их в памяти представляет угрозу безопасности для всей системы.  Ниже представлены рекомендуемые методы защиты строки соединения.  
  
-   При соединении с источником данных SQL Server используйте проверку подлинности Windows.  
  
     При использовании проверки подлинности Windows для соединения с источником данных SQL Server строка соединения не содержит сведений об имени входа и пароле.  
  
-   Шифрование разделов файла конфигурации с использованием защищенной конфигурации.  
  
     В ASP.NET 2.0 предоставляется возможность, известная как защищенная конфигурация, которая позволяет шифровать конфиденциальные сведения в файле конфигурации.  Безусловно, защищенная конфигурация разрабатывалась в первую очередь для ASP.NET, но ее можно также использовать для шифрования разделов файлов конфигурации в приложениях Windows.  Подробное описание новых возможностей защищенной конфигурации см. в разделе [Encrypting Configuration Information Using Protected Configuration](../Topic/Encrypting%20Configuration%20Information%20Using%20Protected%20Configuration.md).  
  
-   Хранение строк соединения в защищенных файлах конфигурации.  
  
     Строку соединения ни в коем случае нельзя внедрять в исходный код.  Строки соединения можно хранить в файлах конфигурации, что исключает необходимость внедрять их в код приложения.  По умолчанию мастер моделей EDM хранит строки соединения в файле конфигурации приложения.  Этот файл необходимо защитить от несанкционированного доступа.  
  
-   Использование построителей строки соединения при динамическом создании соединений.  
  
     Если строки соединения необходимо конструировать во время выполнения, используется класс <xref:System.Data.EntityClient.EntityConnectionStringBuilder>.  Этот класс построителя строк соединения помогает предотвратить атаки внедрения кода путем проверки входных данных и экранирования недопустимых данных.  Для получения дополнительной информации см. [Как построить строку соединения EntityConnection](../../../../../docs/framework/data/adonet/ef/how-to-build-an-entityconnection-connection-string.md).  Соответствующий класс построителя используется также для создания строки соединения с источником данных, являющейся частью строки соединения [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  Сведения о построителях строк соединения для поставщиков ADO.NET см. в разделе [Построители строк подключения](../../../../../docs/framework/data/adonet/connection-string-builders.md).  
  
 Для получения дополнительной информации см. [Защита сведений о соединении](../../../../../docs/framework/data/adonet/protecting-connection-information.md).  
  
#### Не следует предоставлять доступ к объекту EntityConnection пользователям, не заслуживающим доверия  
 Объект <xref:System.Data.EntityClient.EntityConnection> отображает строку соединения базового соединения.  Пользователь, получивший доступ к объекту <xref:System.Data.EntityClient.EntityConnection>, может также изменить <xref:System.Data.ConnectionState> базового соединения.  Класс <xref:System.Data.EntityClient.EntityConnection> не является потокобезопасным.  
  
#### Не следует передавать соединения за пределы контекста безопасности  
 После установки соединения его нельзя передавать за пределы контекста безопасности.  Например, один поток с разрешением открыть соединение не должен хранить это соединение в глобальном местоположении.  Если соединение доступно в глобальном местонахождении, то другой вредоносный поток может использовать открытое соединение, не имея на это явно предоставленного разрешения.  
  
#### Следует учитывать, что сведения о входе в систему и пароли могут быть обнаружены в дампе памяти  
 Если данные о входе в систему и пароль передаются в строке соединения, эти сведения хранятся в памяти до тех пор, пока операция сборки мусора не освободит ресурсы.  В результате этого становится невозможным определение того, с какого момента строка пароля перестает находиться в памяти.  После сбоя приложения файл дампа памяти может содержать конфиденциальные данные, а возможность просматривать этот файл дампа памяти способен получить пользователь, эксплуатирующий это приложение, а также любой другой пользователь с административным доступом к компьютеру.  Для соединения с Microsoft SQL Server используйте проверку подлинности Windows.  
  
#### Предоставление пользователям только необходимых разрешений на доступ к источнику данных  
 Администратор источника данных должен предоставлять пользователям только необходимые разрешения.  Язык [!INCLUDE[esql](../../../../../includes/esql-md.md)] не поддерживает такие инструкции DML изменяющие данные, как INSERT, UPDATE или DELETE; тем не менее пользователи могут получить доступ к соединению с источником данных.  Злонамеренный пользователь может с помощью этого соединения выполнять инструкции DML на собственном языке источника данных.  
  
#### Запуск приложения с минимально возможными разрешениями  
 Если разрешена эксплуатация управляемого приложения с полным набором разрешений, то [!INCLUDE[dnprdnshort](../../../../../includes/dnprdnshort-md.md)] не ограничивает доступ этого приложения к компьютеру.  Это может стать предпосылкой появления в приложении потенциально уязвимого места, что представляет угрозу для всей системы.  Чтобы использовать средства управления доступом к коду и другие механизмы безопасности в [!INCLUDE[dnprdnshort](../../../../../includes/dnprdnshort-md.md)], следует запускать приложения с использованием частичного уровня доверия и с минимальным набором разрешений, необходимым для выполнения всех задач приложения.  Ниже приведены минимальные разрешения, необходимые для работы приложения [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  
  
-   <xref:System.Security.Permissions.FileIOPermission>. Разрешение <xref:System.Security.Permissions.FileIOPermissionAccess> на открытие заданных файлов метаданных или разрешение <xref:System.Security.Permissions.FileIOPermissionAccess> на поиск в каталоге файлов метаданных.  
  
-   <xref:System.Security.Permissions.ReflectionPermission>. Разрешение <xref:System.Security.Permissions.ReflectionPermissionFlag> на поддержку запросов LINQ to Entities.  
  
-   <xref:System.Transactions.DistributedTransactionPermission>. Разрешение <xref:System.Security.Permissions.PermissionState> на участие в транзакции <xref:System.Transactions> <xref:System.Transactions.Transaction>.  
  
-   <xref:System.Security.Permissions.SecurityPermission>. Разрешение <xref:System.Security.Permissions.SecurityPermissionFlag> на сериализацию исключений с помощью интерфейса <xref:System.Runtime.Serialization.ISerializable>.  
  
-   Разрешение на открытие соединения с базой данных и выполнение в ней команд, таких как <xref:System.Data.SqlClient.SqlClientPermission> для базы данных [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)].  
  
 Для получения дополнительной информации см. [Управление доступом для кода и ADO.NET](../../../../../docs/framework/data/adonet/code-access-security.md).  
  
#### Не устанавливайте приложения, не заслуживающие доверия  
 Платформа [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] не требует применения каких\-либо прав доступа и вызовет любой объектный код в процессе, переданный пользователем, независимо от того, надежен он или нет  Убедитесь, что проверка подлинности и авторизация клиента выполняются хранилищем данных и приложением.  
  
#### Ограничьте доступ ко всем файлам конфигурации  
 Администратор должен ограничить доступ для записи ко всем файлам, в которых указывается конфигурация приложения, в том числе enterprisesec.config, security.config, machine.conf, и файл конфигурации приложения \<*приложение*\>.exe.config.  
  
 В файле app.config можно указать другое значение неизменяемого имени поставщика.  Клиентское приложение должно обеспечивать доступ к базовому поставщику через фабричную модель стандартного поставщика с использованием строгого имени.  
  
#### Ограничьте разрешения на файлы модели и сопоставления.  
 Администратор должен предоставлять доступ для записи к файлам модели и сопоставления \(EDMX\-файлы, CSDL\-файлы, SSDL\-файлы и MSL\-файлы\) только тем пользователям, которые изменяют модель или сопоставления.  В [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] к этим файлам во время выполнения требуется доступ только для чтения.  Администратор должен также ограничить доступ к уровню объектов и предварительно компилируемым файлам просмотра исходного кода, которые формируются средствами [!INCLUDE[adonet_edm](../../../../../includes/adonet-edm-md.md)].  
  
## Вопросы безопасности применительно к запросам  
 При запросах к концептуальной модели применимы следующие рекомендации по безопасности.  Эти рекомендации по безопасности применимы к запросам [!INCLUDE[esql](../../../../../includes/esql-md.md)], использующим EntityClient, и к объектным запросам, использующим LINQ, [!INCLUDE[esql](../../../../../includes/esql-md.md)] и методы построителя запросов.  
  
#### Предотвращение атак путем внедрения кода SQL  
 Приложения часто получают внешние входные данные \(от пользователя или другого внешнего агента\) и выполняют действия над этими входными данными.  Любые входные данные, прямо или косвенно полученные от пользователя или внешнего агента, могут иметь содержимое, в котором используется синтаксис целевого языка для выполнения несанкционированных действий.  Если целевым языком является один из диалектов языка SQL, например [!INCLUDE[tsql](../../../../../includes/tsql-md.md)], такие действия называются атакой путем внедрения кода SQL.  Злонамеренный пользователь может внедрить данные непосредственно в запрос и удалить таблицу базы данных, вызвать отказ в обслуживании или другим образом изменить характер выполняемой операции.  
  
-   Атаки путем внедрения кода [!INCLUDE[esql](../../../../../includes/esql-md.md)]:  
  
     Атаки путем внедрения кода SQL осуществляются на языке [!INCLUDE[esql](../../../../../includes/esql-md.md)] путем предоставления вредоносных входных значений в составе предикатов запросов и имен параметров.  Для предотвращения атак путем внедрения кода SQL ни в коем случае нельзя объединять входные данные пользователя с текстом команд [!INCLUDE[esql](../../../../../includes/esql-md.md)].  
  
     Запросы [!INCLUDE[esql](../../../../../includes/esql-md.md)] принимают параметры во всех случаях, где допускаются литералы.  Необходимо использовать параметризированные запросы, а не внедрять литералы из внешних агентов непосредственно в запрос. Необходимо также рассмотреть использование методов построителя запросов для безопасного создания [Entity SQL](http://msdn.microsoft.com/ru-ru/05685434-05e6-41c2-8d5e-8933b88a40b0).  
  
-   Атаки путем внедрения кода [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)]:  
  
     Хотя [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)] позволяет строить композиции запросов, но для этого применяется API объектной модели. В отличие от запросов [!INCLUDE[esql](../../../../../includes/esql-md.md)], запросы [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)] не строятся с помощью манипулирования строками или объединения строк, поэтому не подвержены обычным атакам путем внедрения кода SQL.  
  
#### Предотвращение создания очень больших результирующих наборов  
 Слишком большой результирующий набор может вызвать завершение работы клиентской системы, если клиент выполняет операции, для которых потребность в ресурсах пропорциональна размеру результирующего набора.  Непредвиденное появление больших результирующих наборов может происходить при следующих условиях:  
  
-   в запросах к большим базам данных, не включающих соответствующих условий фильтрации;  
  
-   в запросах, создающих декартовы соединения на сервере;  
  
-   во вложенных запросах [!INCLUDE[esql](../../../../../includes/esql-md.md)].  
  
 Принимая ввод от пользователя, необходимо убедиться в том, что входные данные не могут привести к созданию слишком больших результирующих наборов, которые не сможет обработать система.  Можно также использовать метод <xref:System.Linq.Queryable.Take%2A> в [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)] или оператор [LIMIT](../../../../../docs/framework/data/adonet/ef/language-reference/limit-entity-sql.md) в [!INCLUDE[esql](../../../../../includes/esql-md.md)] для ограничения размера результирующего набора.  
  
#### Старайтесь не возвращать результаты IQueryable, если методы доступны потенциально ненадежным вызывающим объектам.  
 Старайтесь не возвращать типы <xref:System.Linq.IQueryable%601> из методов, которые доступны потенциально ненадежным вызывающим объектам, по следующим причинам.  
  
-   Объект\-получатель запроса, обеспечивающего доступ к типу <xref:System.Linq.IQueryable%601>, может вызвать метод, предоставляющий доступ к защищенным данным или увеличивающий размер результирующего набора.  Например, рассмотрим следующую сигнатуру метода.  
  
    ```  
    public IQueryable<Customer> GetCustomer(int customerId)  
    ```  
  
     Объект\-получатель этого запроса может вызвать метод `.Include("Orders")`, возвращающий `IQueryable<Customer>`, по которому можно извлечь данные, доступ к которым через этот запрос не планировался.  Этого можно избежать, если изменить возвращаемый тип метода на <xref:System.Collections.Generic.IEnumerable%601> и вызвать метод \(например, `.ToList()`\) для материализации результатов.  
  
-   Поскольку запросы <xref:System.Linq.IQueryable%601> выполняются при переборе результатов, объект\-получатель запроса, обеспечивающего доступ к типу <xref:System.Linq.IQueryable%601>, может обработать возникшие исключения.  Исключения могут содержать информацию, не предназначенную объекту\-получателю.  
  
## Вопросы безопасности применительно к сущностям  
 Следующие рекомендации по безопасности применимы при формировании типов сущностей и работе с ними.  
  
#### Не следует совместно использовать контекст ObjectContext во всех доменах приложений  
 Совместное использование <xref:System.Data.Objects.ObjectContext> в нескольких доменах приложений может создать предпосылки получения доступа к данным в строке соединения.  Вместо этого следует передать сериализованные объекты или графы объектов в домен другого приложения, а затем присоединить эти объекты к <xref:System.Data.Objects.ObjectContext> в этом домене приложения.  Для получения дополнительной информации см. [Serializing Objects](http://msdn.microsoft.com/ru-ru/06c77f9b-5b2e-4c78-b3e3-8c148ba0ea99).  
  
#### Предотвращение нарушений безопасности типов  
 При нарушении безопасности типов [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] не может гарантировать целостность данных в объектах.  Нарушения безопасности типов могут происходить, если разрешается эксплуатация ненадежных приложений с полным уровнем доверия для управления доступом для кода.  
  
#### Обработка исключений.  
 Доступ к методам и свойствам <xref:System.Data.Objects.ObjectContext> в блоке try\-catch.  Обработка исключений предотвращает их попадание в пользовательское приложение, и поэтому пользователи приложения не смогут получить доступ к записям в <xref:System.Data.Objects.ObjectStateManager> или к данным модели \(например, именам таблиц\).  
  
## Вопросы безопасности применительно к приложениям ASP.NET  
 При работе с приложениями [!INCLUDE[vstecasp](../../../../../includes/vstecasp-md.md)] необходимо учитывать следующее.  
  
#### Убедиться в том, что узел выполняет проверку путей  
 Если используется строка подстановки `|DataDirectory|` \(заключенная в символы вертикальной черты\), то [!INCLUDE[vstecado](../../../../../includes/vstecado-md.md)] проверяет, поддерживается ли путь, полученный путем преобразования этой строки.  Например, недопустима подстрока ".." после `DataDirectory`.  Та же проверка преобразования оператора задания корневого каталога веб\-приложения \(`~`\) выполняется процессом, предоставляющим услуги размещения [!INCLUDE[vstecasp](../../../../../includes/vstecasp-md.md)].  Эту проверку выполняют службы IIS, однако узлы, отличные от IIS, могут не проверять, поддерживается ли преобразованный путь.  Необходимо знать, как действует узел, на котором развертывается приложение [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  
  
#### Не следует делать предположений в отношении преобразованных имен путей  
 Безусловно, значения, в которые преобразуются оператор задания корневого каталога \(`~`\) и строка подстановки `DataDirectory`, должны оставаться неизменными во время выполнения приложения, но [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] не налагает ограничения на изменение узлом этих значений.  
  
#### Проверить длину пути перед развертыванием.  
 Перед развертыванием приложения [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] необходимо убедиться, что значения оператора задания корневого каталога \(~\) и строки подстановки `DataDirectory` не превышают ограничений, налагаемых операционной системой на длину пути.  Поставщики данных [!INCLUDE[vstecado](../../../../../includes/vstecado-md.md)] не гарантируют того, что длина пути останется в допустимых пределах.  
  
## Вопросы безопасности применительно к метаданным ADO.NET  
 При формировании и работе с файлами модели и сопоставления применимы следующие рекомендации по безопасности.  
  
#### Не следует представлять доступ к конфиденциальным сведениям с помощью средств ведения журнала  
 Служебные компоненты метаданных [!INCLUDE[vstecado](../../../../../includes/vstecado-md.md)] не записывают в журнал конфиденциальные сведения.  Если имеются результаты, которые не удается возвратить из\-за ограничений доступа, то системы управления базами данных и файловые системы должны возвращать нулевой результат, а не активизировать исключение, которое может содержать конфиденциальные данные.  
  
#### Не следует принимать объекты MetadataWorkspace из ненадежных источников  
 Приложения не должны принимать экземпляры объектов класса <xref:System.Data.Metadata.Edm.MetadataWorkspace> из ненадежных источников.  Вместо этого необходимо явно создать и заполнить рабочую область из такого источника.  
  
## См. также  
 [Защита приложений ADO.NET](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)   
 [Требования к развертыванию](../../../../../docs/framework/data/adonet/ef/deployment-considerations.md)   
 [Вопросы переноса](../../../../../docs/framework/data/adonet/ef/migration-considerations.md)