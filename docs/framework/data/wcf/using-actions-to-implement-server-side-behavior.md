---
title: "Использование действий для реализации поведения на стороне сервера | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-oob"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-clr"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: 11a372db-7168-498b-80d2-9419ff557ba5
caps.latest.revision: 3
author: "Erikre"
ms.author: "erikre"
manager: "erikre"
caps.handback.revision: 3
---
# Использование действий для реализации поведения на стороне сервера
Действия OData предоставляют способ реализации поведения, срабатывающего при получении ресурса из службы OData.  Рассмотрим для примера цифровой фильм в качестве ресурса. С цифровым фильмом можно совершить множество различных действий: извлекать, оценивать, комментировать или возвращать.  Приведенные варианты являются примерами действий, которые могут выполняться службой данных WCF, управляющей цифровыми фильмами.  Действия описываются в ответе OData, содержащим ресурс, для которого может быть вызвано это действие.  Если пользователь запрашивает ответ, который представляет цифровой фильм, то ответ, возвращаемый службой данных WCF, содержит сведения о действиях, которые могут быть применены к этому ресурсу.  Доступность действия зависит от состояния службы данных или ресурса.  Например, цифровой фильм, извлеченный одним пользователем, не может быть извлечен другим пользователем.  Для вызова действий клиентам достаточно указать URL\-адрес.  Например, http:\/\/MyServer\/MovieService.svc\/Movies\(6\) будет обозначать определенный цифровой фильм, а http:\/\/MyServer\/MovieService.svc\/Movies\(6\)\/Checkout вызовет действие с этим фильмом.  Действия позволяют применять модель службы, не обращаясь к модели данных.  Продолжим рассмотрение примера с фильмом. Например, вы можете разрешить пользователям оценивать фильм, но не предоставлять доступ к данным оценок как к ресурсу.  Вы можете реализовать действие оценки, чтобы разрешить пользователям оценивать фильм, при этом у них не будет прямого доступа к данным оценок как к ресурсу.  
  
 Полный пример реализации действия службы данных WCF см. в разделе [Поставщик действия службы данных WCF для платформы Entity Framework](http://efactionprovider.codeplex.com/)  
  
## Реализация действия  
 Для реализации действия службы необходимо реализовать интерфейсы <xref:System.IServiceProvider>, <xref:System.Data.Services.Providers.IDataServiceActionProvider> и <xref:System.Data.Services.Providers.IDataServiceInvokable>.  Интерфейс <xref:System.IServiceProvider> позволяет службе данных WCF получить вашу реализацию интерфейса <xref:System.Data.Services.Providers.IDataServiceActionProvider>.  Интерфейс <xref:System.Data.Services.Providers.IDataServiceActionProvider> позволяет службе WCF создавать, находить, описывать и вызывать действия службы.  Интерфейс <xref:System.Data.Services.Providers.IDataServiceInvokable> позволяет вызывать код, который реализует поведение действий службы, и возвращать результаты \(при их наличии\).  Помните, что службы данных WCF являются службами с предварительным вызовом, то есть новый экземпляр службы создается при каждом вызове службы.  Удостоверьтесь в том, что при создании службы выполняется только необходимая работа.  
  
### IServiceProvider  
 Интерфейс <xref:System.IServiceProvider> содержит метод <xref:System.IServiceProvider.GetService%2A>.  Службы данных WCF вызывают этот метод для получения числа поставщиков служб, включая поставщиков служб метаданных и поставщиков действий служб данных.  При запросе поставщика действий службы данных возвращайте свою реализацию интерфейса <xref:System.Data.Services.Providers.IDataServiceActionProvider>.  
  
### IDataServiceActionProvider  
 Интерфейс <xref:System.Data.Services.Providers.IDataServiceActionProvider> содержит методы, позволяющие получать сведения о доступных действиях.  При реализации интерфейса <xref:System.Data.Services.Providers.IDataServiceActionProvider> увеличивается объем метаданных службы, что определяется вашей реализацией интерфейса <xref:System.Data.Services.Providers.IDataServiceMetadataProvider> службы, за счет действий и обработки их отправки.  
  
#### AdvertiseServiceAction  
 Метод <xref:System.Data.Services.Providers.IDataServiceActionProvider.AdvertiseServiceAction%2A> вызывается, чтобы определить, какие действия можно применить к указанному ресурсу.  Этот метод вызывается только для действий, которые не всегда доступны.  Он используется для проверки того, следует ли включать действие в ответ OData, исходя из состояния запрашиваемого ресурса или службы.  Способ выполнения этой проверки полностью зависит от вас.  Если вычислять доступность затратно, а текущий ресурс находится в веб\-канале, можно просто пропустить проверку и объявить о доступности действия.  Если текущий ресурс в данный момент возвращается в рамках веб\-канала, параметру `inFeed` задается значение `true`.  
  
#### CreateInvokable  
 Метод [M:System.Data.Services.Providers.IDataServiceActionProvider.CreateInvokable\(System.Data.Services.DataServiceOperationContext,System.Data.Services.Providers.ServiceAction,System.Object\<xref:System.Data.Services.Providers.IDataServiceActionProvider.CreateInvokable%2A> вызывается для создания интерфейса <xref:System.Data.Services.Providers.IDataServiceInvokable>, который содержит делегата, инкапсулирующего код поведения действия.  При этом создается экземпляр <xref:System.Data.Services.Providers.IDataServiceInvokable>, но само действие не вызывается.  У действий службы данных WCF имеются побочные эффекты, они должны выполняться в сочетании с поставщиком обновлений для сохранения этих изменений на диске.  Метод <xref:System.Data.Services.Providers.IDataServiceInvokable.Invoke%2A> вызывается из вызова метода SaveChanges\(\) поставщика обновлений.  
  
#### GetServiceActions  
 Этот метод возвращает коллекцию экземпляров <xref:System.Data.Services.Providers.ServiceAction>, представляющих все действия, реализованные службой данных WCF.  <xref:System.Data.Services.Providers.ServiceAction> является представлением метаданных действия, которое содержит такие сведения, как имя действия, его параметры и тип возвращаемых результатов.  
  
#### GetServiceActionsByBindingParameterType  
 Этот метод возвращает коллекцию всех экземпляров <xref:System.Data.Services.Providers.ServiceAction>, которые могут быть привязаны к указанному типу параметра привязки.  Другими словами, все действия <xref:System.Data.Services.Providers.ServiceAction>, которые могут выполняться c указанным типом ресурсов \(который также называется типом параметра привязки\). Используется при возврате службой ресурса с тем, чтобы включить сведения о действиях, который можно вызвать для этого ресурса.  Этот метод должен возвращать только действия, которые могут быть привязаны к указанному типу параметра привязки \(а не производным типам\).  Этот метод вызывается один раз для каждого запроса и каждого типа, а результат его работы кэшируется службами данных WCF.  
  
#### TryResolveServiceAction  
 Данный метод выполняет поиск указанного действия <xref:System.Data.Services.Providers.ServiceAction> и возвращает значение `true`, если действие <xref:System.Data.Services.Providers.ServiceAction> найдено.  Если оно найдено, действие <xref:System.Data.Services.Providers.ServiceAction> возвращается в параметре `serviceAction` `out`.  
  
### IDataServiceInvokable  
 Этот интерфейс обеспечивает способ выполнения действия службы данных WCF.  При реализации интерфейса IDataServiceInvokable необходимо учесть три вещи.  
  
1.  Отслеживание и, потенциально, маршалинг параметров.  
  
2.  Передача параметров коду, который фактически реализует действие при вызове метода Invoke\(\).  
  
3.  Сохранение результатов работы метода Invoke\(\) с тем, чтобы их можно было получить с помощью метода GetResult\(\).  
  
 Параметры могут передаваться в виде токенов.  Это так, потому что можно написать поставщика службы данных, работающего с токенами, которые представляют ресурсы. При реализации такой схемы может потребоваться преобразование \(маршалинг\) этих токенов в сами ресурсы до их отправки собственно действию.  После преобразования параметра он должен находиться в состоянии, допускающем редактирование с тем, чтобы любые изменения ресурса, происходящие при вызове действия, сохранялись и записывались на диск.  
  
 Этому интерфейсу требуется два метода: Invoke и GetResult.  Метод Invoke вызывает делегата, который реализует поведение действия, а метод GetResult возвращает результат выполнения действия.  
  
## Вызов действия службы данных WCF  
 Действия вызываются с помощью запроса HTTP POST.  В URL\-адресе указывается ресурс, за которым следует имя действия.  Параметры передаются в тексте запроса.  Например, при наличии службы MovieService, которая выполняла действие Rate.  Для вызова действия Rate в отношении определенного фильма можно использовать следующий URL\-адрес:  
  
 http:\/\/MovieServer\/MovieService.svc\/Movies\(1\)\/Rate  
  
 Movies\(1\) обозначает фильм, который требуется оценить, а Rate обозначает действие Rate.  Само значение оценки будет приведено в тексте HTTP\-запроса, как показано в следующем примере:  
  
```  
POST http://MovieServer/MoviesService.svc/Movies(1)/Rate HTTP/1.1   
Content-Type: application/json   
Content-Length: 20   
Host: localhost:15238  
{   
   "rating": 4   
}  
  
```  
  
> [!WARNING]
>  Приведенный выше образец кода будет работать только со службами данных WCF 5.2 и более поздней версии, которые поддерживают облегченный формат JSON.  При использовании более ранней версии служб данных WCF необходимо указать подробный тип содержимого json следующим образом: `application/json;odata=verbose`.  
  
 Также можно вызывать действия с помощью клиента служб данных WCF, как показано в следующем фрагменте кода:  
  
```  
MoviesModel context = new MoviesModel (new Uri("http://MyServer/MoviesService.svc/"));  
            //...  
            context.Execute(new Uri("http://MyServer/MoviesService.svc/Movies(1)/Rate"), "POST", new BodyOperationParameter("rating",4) );           
```  
  
 В приведенном выше фрагменте кода класс `MoviesModel` был сформирован с помощью Visual Studio для добавления ссылки на службу данных WCF.  
  
## См. также  
 [Службы WCF Data Services 4.5](../../../../docs/framework/data/wcf/index.md)   
 [Определение службы WCF Data Services](../../../../docs/framework/data/wcf/defining-wcf-data-services.md)   
 [Разработка и развертывание служб WCF Data Services](../../../../docs/framework/data/wcf/developing-and-deploying-wcf-data-services.md)   
 [Специализированные поставщики служб данных](../../../../docs/framework/data/wcf/custom-data-service-providers-wcf-data-services.md)