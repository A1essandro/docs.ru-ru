---
title: Выполнение восстановления
ms.date: 03/30/2017
ms.assetid: 6dd17bf6-ba42-460a-a44b-8046f52b10d0
ms.openlocfilehash: 149ac6b6162893de830f59b3d18008d8298eab56
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2018
ms.locfileid: "33363934"
---
# <a name="performing-recovery"></a><span data-ttu-id="3c9de-102">Выполнение восстановления</span><span class="sxs-lookup"><span data-stu-id="3c9de-102">Performing Recovery</span></span>
<span data-ttu-id="3c9de-103">Диспетчер ресурсов обеспечивает разрешение зачислений устойчивых ресурсов в транзакции, повторно зачисляя участника транзакции после сбоя ресурса.</span><span class="sxs-lookup"><span data-stu-id="3c9de-103">A resource manager facilitates resolution of durable enlistments in a transaction by reenlisting the transaction participant after resource failure.</span></span>  
  
## <a name="the-recovery-process"></a><span data-ttu-id="3c9de-104">Процесс восстановления</span><span class="sxs-lookup"><span data-stu-id="3c9de-104">The Recovery Process</span></span>  
 <span data-ttu-id="3c9de-105">Для зачисления устойчивого ресурса (описываемого реализацией интерфейса <xref:System.Transactions.IEnlistmentNotification>), который способен к восстановлению, необходимо вызвать метод <xref:System.Transactions.Transaction.EnlistDurable%2A>.</span><span class="sxs-lookup"><span data-stu-id="3c9de-105">To durably enlist a resource (described by an implementation of the <xref:System.Transactions.IEnlistmentNotification> interface) that can later be eligible for recovery, you should call the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="3c9de-106">Кроме того, необходимо предоставить метод <xref:System.Transactions.Transaction.EnlistDurable%2A> с идентификатором диспетчера ресурсов (<xref:System.Guid>), который используется для постоянной отметки участника транзакции в событии сбоя ресурса.</span><span class="sxs-lookup"><span data-stu-id="3c9de-106">In addition, you must provide the <xref:System.Transactions.Transaction.EnlistDurable%2A> method with a resource manager identifier (a <xref:System.Guid>) that is used to consistently label the participant of the transaction in the event of a resource failure.</span></span> <span data-ttu-id="3c9de-107">По этой причине <xref:System.Guid> , предоставляется для начальной Enlist вызов должен быть идентичен *resourceManagerIdentifier* параметр в <xref:System.Transactions.TransactionManager.Reenlist%2A> вызова во время восстановления.</span><span class="sxs-lookup"><span data-stu-id="3c9de-107">For this reason, the <xref:System.Guid> that is provided to the initial Enlist call should be identical to the *resourceManagerIdentifier* parameter in the <xref:System.Transactions.TransactionManager.Reenlist%2A> call during recovery.</span></span> <span data-ttu-id="3c9de-108">В противном случае возникает исключение <xref:System.Transactions.TransactionException>.</span><span class="sxs-lookup"><span data-stu-id="3c9de-108">Otherwise, <xref:System.Transactions.TransactionException> is thrown.</span></span> <span data-ttu-id="3c9de-109">Дополнительные сведения о долговременным присоединением к транзакции. в разделе [прикрепление ресурсов в качестве участников в транзакции](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md) .</span><span class="sxs-lookup"><span data-stu-id="3c9de-109">For more information on durable enlistments, see [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md) .</span></span>  
  
 <span data-ttu-id="3c9de-110">Если в фазе подготовки (фазе 1) протокола двухфазной фиксации пользовательская реализация диспетчера ресурсов получает уведомление <xref:System.Transactions.IEnlistmentNotification.Prepare%2A>, она должна создать запись о подготовке в журнале.</span><span class="sxs-lookup"><span data-stu-id="3c9de-110">In the prepare phase (phase 1) of the 2PC protocol, when your implementation of a durable resource manager receives the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification, it should log its prepare record during this phase.</span></span> <span data-ttu-id="3c9de-111">Запись должна включать всю необходимую информацию для завершения транзакции фиксацией.</span><span class="sxs-lookup"><span data-stu-id="3c9de-111">The record should contain all the information that is necessary to complete the transaction on commit.</span></span> <span data-ttu-id="3c9de-112">Подготовка записи позже могут быть доступны при восстановления путем извлечения <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> свойство *preparingEnlistment* обратного вызова.</span><span class="sxs-lookup"><span data-stu-id="3c9de-112">The prepare record can later be accessed during recovery by retrieving the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the *preparingEnlistment* callback.</span></span> <span data-ttu-id="3c9de-113">Создание этой записи в рамках метода <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> не требуется, поскольку диспетчер ресурсов может сделать это в рабочем потоке.</span><span class="sxs-lookup"><span data-stu-id="3c9de-113">The record logging does not need to be performed within the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> method as the RM can do this on a worker thread.</span></span>  
  
 <span data-ttu-id="3c9de-114">Процесс восстановления состоит из следующих двух шагов.</span><span class="sxs-lookup"><span data-stu-id="3c9de-114">The recovery process consists of the following two steps:</span></span>  
  
### <a name="step-1---reenlist"></a><span data-ttu-id="3c9de-115">Шаг 1 - повторное зачисление</span><span class="sxs-lookup"><span data-stu-id="3c9de-115">Step 1 - ReEnlist</span></span>  
 <span data-ttu-id="3c9de-116">Диспетчер ресурсов проверяет запись о подготовке для каждого зачисления, которое находится под сомнением.</span><span class="sxs-lookup"><span data-stu-id="3c9de-116">The resource manager examines the prepare information record for each enlistment that is in-doubt.</span></span> <span data-ttu-id="3c9de-117">Это выполняется путем проверки свойства <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> обратного вызова <xref:System.Transactions.PreparingEnlistment>, переданного диспетчеру ресурсов в уведомлении <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> в фазе 1.</span><span class="sxs-lookup"><span data-stu-id="3c9de-117">This is done by examining the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> property of the <xref:System.Transactions.PreparingEnlistment> callback, which is passed to the resource manager in the <xref:System.Transactions.IEnlistmentNotification.Prepare%2A> notification during phase 1.</span></span>  
  
 <span data-ttu-id="3c9de-118">Для каждого проверяемого зачисления диспетчер ресурсов вызывает метод <xref:System.Transactions.TransactionManager.Reenlist%2A> для диспетчера транзакций.</span><span class="sxs-lookup"><span data-stu-id="3c9de-118">For each such enlistment it examines, it invokes <xref:System.Transactions.TransactionManager.Reenlist%2A> on the transaction manager.</span></span> <span data-ttu-id="3c9de-119">Этот метод передает уникальный <xref:System.Guid>, идентифицирующий диспетчер ресурсов, а также данные перечисления в массиве байтов.</span><span class="sxs-lookup"><span data-stu-id="3c9de-119">This method passes on a unique <xref:System.Guid> that identifies the resource manager, as well as the enlistment's information in a byte array.</span></span> <span data-ttu-id="3c9de-120">Возвращается новый объект <xref:System.Transactions.Enlistment>.</span><span class="sxs-lookup"><span data-stu-id="3c9de-120">A new <xref:System.Transactions.Enlistment> object is returned.</span></span> <span data-ttu-id="3c9de-121">Если в результате повторного зачисления возникает исключение, диспетчеру необходимо повторить попытку через некоторое время.</span><span class="sxs-lookup"><span data-stu-id="3c9de-121">If the reenlistment fails with an exception, the resource manager will need to retry at a later time.</span></span>  
  
 <span data-ttu-id="3c9de-122">Метод <xref:System.Transactions.TransactionManager.Reenlist%2A> следует вызывать только после перезапуска диспетчера ресурсов после сбоя.</span><span class="sxs-lookup"><span data-stu-id="3c9de-122">You should only call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method when a resource manager restarts from failure.</span></span> <span data-ttu-id="3c9de-123">Кроме того, повторное зачисление следует выполнить только для неразрешенных транзакций, зарегистрированных диспетчером ресурсов в ходе начальной фазы подготовки двухфазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="3c9de-123">In addition, you should only reenlist unresolved transactions logged by a resource manager during the initial Prepare phase of a two-phase commit.</span></span> <span data-ttu-id="3c9de-124">Любая попытка вызова этого метода в недопустимое время может привести к ошибочным результатам.</span><span class="sxs-lookup"><span data-stu-id="3c9de-124">Any attempt to call this method at invalid times can produce erroneous results.</span></span>  
  
 <span data-ttu-id="3c9de-125">При повторном зачислении участника с помощью этого метода в зависимости от результата транзакции вызывается соответствующий метод фазы 2 интерфейса <xref:System.Transactions.IEnlistmentNotification> (<xref:System.Transactions.IEnlistmentNotification.Commit%2A>, <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> или <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A>).</span><span class="sxs-lookup"><span data-stu-id="3c9de-125">When a participant is reenlisted using this method, the phase 2 methods of <xref:System.Transactions.IEnlistmentNotification> that correspond to the transaction's outcome (that is, <xref:System.Transactions.IEnlistmentNotification.Commit%2A> , <xref:System.Transactions.IEnlistmentNotification.Rollback%2A> or <xref:System.Transactions.IEnlistmentNotification.InDoubt%2A> ) are called as appropriate.</span></span>  
  
### <a name="step-2---completing-the-recovery"></a><span data-ttu-id="3c9de-126">Шаг 2 - завершение восстановления</span><span class="sxs-lookup"><span data-stu-id="3c9de-126">Step 2 - Completing the recovery</span></span>  
 <span data-ttu-id="3c9de-127">После завершения всех повторных зачислений диспетчер транзакций вызывает метод <xref:System.Transactions.TransactionManager.RecoveryComplete%2A>.</span><span class="sxs-lookup"><span data-stu-id="3c9de-127">When all the reenlistments are finished, the resource manager calls the <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> method.</span></span> <span data-ttu-id="3c9de-128">Этот метод завершает восстановление и информирует диспетчер транзакций о том, что у диспетчера ресурсов больше нет транзакций, находящихся под сомнением.</span><span class="sxs-lookup"><span data-stu-id="3c9de-128">This method completes the recovery and informs the transaction manager that the resource manager has no more in-doubt transactions.</span></span> <span data-ttu-id="3c9de-129">Это позволяет гарантировать, что диспетчер ресурсов не вызовет метод <xref:System.Transactions.TransactionManager.Reenlist%2A> повторно.</span><span class="sxs-lookup"><span data-stu-id="3c9de-129">By doing so, the resource manager guarantees that it will not invoke the <xref:System.Transactions.TransactionManager.Reenlist%2A> method again.</span></span>  
  
 <span data-ttu-id="3c9de-130">От диспетчера ресурсов не требуется разрешения всех транзакций, находящихся по сомнением, перед повторным зачислением в новые транзакции.</span><span class="sxs-lookup"><span data-stu-id="3c9de-130">A resource manager is not required to resolve all in-doubt transactions before enlisting in new transactions.</span></span> <span data-ttu-id="3c9de-131">Сначала можно выполнить в любое время после диспетчера ресурсов устанавливает связь с диспетчером транзакций, но после <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> был вызван (шаг 2); шаг 1 не может выполняться снова.</span><span class="sxs-lookup"><span data-stu-id="3c9de-131">The first step can be performed at any time after the resource manager establishes a relationship with the transaction manager, but after <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> has been invoked (step 2); step 1 cannot be performed again.</span></span> <span data-ttu-id="3c9de-132">Шаг 2 можно выполнить несколько раз без воздействия на результат транзакций.</span><span class="sxs-lookup"><span data-stu-id="3c9de-132">Step 2 can be repeated multiple times without affecting the outcome of transactions.</span></span>
