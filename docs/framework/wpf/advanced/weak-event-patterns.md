---
title: "Шаблоны слабых событий | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-4.6"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-wpf"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "обработчики событий, шаблон слабых событий"
  - "IWeakEventListener - интерфейс"
  - "реализация шаблона слабых событий"
  - "WeakEventManager - класс"
ms.assetid: e7c62920-4812-4811-94d8-050a65c856f6
caps.latest.revision: 18
author: "dotnet-bot"
ms.author: "dotnetcontent"
manager: "wpickett"
caps.handback.revision: 18
---
# Шаблоны слабых событий
В приложениях существует возможность того, что обработчики, присоединенные к источнику событий, не будут уничтожены в соответствии с объектом\-прослушивателем, который присоединил обработчик к источнику.  Такая ситуация может привести к утечке памяти.  [!INCLUDE[TLA#tla_winclient](../../../../includes/tlasharptla-winclient-md.md)] представляет шаблон, который можно использовать для решения этой проблемы путем предоставления выделенного класса диспетчера для конкретных событий и реализации интерфейса прослушивателей для данного события.  Этот шаблон разработки называется *шаблоном слабых событий*.  
  
## Почему следует реализовать шаблон слабых событий?  
 Ожидание событий может привести к утечке памяти.  Обычным методом для прослушивания событий является использование синтаксиса конкретного языка, который присоединяет обработчик к событию на источнике.  Например, в [!INCLUDE[TLA#tla_cshrp](../../../../includes/tlasharptla-cshrp-md.md)] такой синтаксис имеет вид: `source.SomeEvent += new SomeEventHandler(MyEventHandler)`.  
  
 Этот метод создает строгую ссылку от источника событий к слушателю событий.  Обычно присоединение обработчика событий к прослушивателю служит причиной того, что прослушиватель имеет время жизни объекта, на которое влияет время жизни объекта источника \(если обработчик событий не удаляется явным образом\).  Однако в некоторых случаях может требоваться, чтобы время жизни объекта\-прослушивателя управлялось другими факторами \(например, текущей принадлежностью к визуальному дереву приложения\), а не временем жизни источника.  Всякий раз, когда время жизни объекта\-источника превосходит время жизни объекта\-слушатель, обычный шаблон события приводит к утечке памяти: слушатель хранится дольше, чем ожидается.  
  
 Шаблон слабых событий предназначен для решения проблемы утечки памяти.  Шаблон слабых событий может использоваться, если прослушивателю необходимо зарегистрироваться для события, а момент отмены регистрации явно неизвестен.  Шаблон слабых событий может также использоваться всякий раз, когда время жизни объекта\-источника превосходит полезное время жизни объекта\-прослушивателя.  \(В этом случае *полезность* определяется автором.\) Шаблон слабых событий позволяет прослушивателю регистрировать и получать события, никак не затрагивая характеристики времени жизни объекта прослушивателя.  В результате неявная ссылка от источника не определяет, подлежит ли прослушиватель обработке при сборке мусора.  Эта ссылка является слабой, с чем и связано название шаблона слабых событий и соответствующих [!INCLUDE[TLA2#tla_api#plural](../../../../includes/tla2sharptla-apisharpplural-md.md)].  Слушатель может быть собран как мусор или, в противном случае, уничтожен, а источник может продолжить свое существование без сохранения не входящих в коллекцию ссылок ресурса на только что уничтоженный объект.  
  
## Кто должен реализовывать шаблон слабых событий?  
 Реализация шаблона слабых событий будет интересна главным образом авторам элементов управления.  Как автор элемента управления, вы в значительной мере отвечаете за поведение и включения элемента управления и за то влияние, которое этот элемент оказывает на приложения, в которые он вставлен.  Сюда входит и поведение времени жизни объекта элемента управления, в частности, обработка описанной проблемы утечки памяти.  
  
 Некоторые сценарии изначально подходят для применения шаблона слабых событий.  Один из таких сценариев — это привязка данных.  В привязке данных часто исходный объект полностью независим от объекта прослушивателя, являющегося целевых объектом привязки.  Многие аспекты привязки данных [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] уже имеют шаблон слабых событий, примененный в способе реализации событий.  
  
## Как реализовать шаблон слабых событий  
 3 Способа реализовать шаблон слабых событий.  В следующей таблице перечислены 3 подхода и предоставляет некоторые рекомендации, если необходимо использовать каждый.  
  
|Подход|При реализации|  
|------------|--------------------|  
|Использовать существующий простой класс диспетчера событий|Если событие следует подписаться имеет сопоставления <xref:System.Windows.WeakEventManager>используйте существующий простой диспетчера событий.  Список слабых событий, входящих в состав WPF диспетчеров см. в разделе в иерархии наследования <xref:System.Windows.WeakEventManager> класс.  Обратите внимание, что относительно небольшое количество слабых событий, входящих в состав WPF диспетчеров, поэтому, скорее всего, будет необходимо выбрать один из прочих подходов.|  
|Использование класса диспетчера универсальный шаблон слабых событий|Использование универсальных <xref:System.Windows.WeakEventManager%602> если существовать  <xref:System.Windows.WeakEventManager> недоступен, необходимо простой способ реализации, а не управлять эффективности.  Универсальный шаблон <xref:System.Windows.WeakEventManager%602> менее эффективна, чем существовать или пользовательский диспетчер слабых событий.  Например, универсальный шаблон класс выполняет несколько отражения для обнаружения событие заданное имя события.  Кроме того, код, чтобы зарегистрировать событие с помощью универсального <xref:System.Windows.WeakEventManager%602> verboseее, чем использование существовать или пользовательский  <xref:System.Windows.WeakEventManager>.|  
|Создание пользовательского класса диспетчера слабых событий|Создайте пользовательский <xref:System.Windows.WeakEventManager> если существовать  <xref:System.Windows.WeakEventManager> недоступна и нужно наилучшую производительность.  Использование пользовательский интерфейс <xref:System.Windows.WeakEventManager> подписаться на событие будет более эффективным, но создании стоимость записи дополнительных в начале кода.|  
  
 Следующие разделы описывают, как реализовать шаблон слабых событий.  Для данного обсуждения, событие для подписки имеет следующие характеристики.  
  
-   Имя события `SomeEvent`.  
  
-   Вызывается событие `EventSource` класс.  
  
-   Обработчик событий имеет тип: `SomeEventEventHandler` \(или  `EventHandler<SomeEventEventArgs>`\).  
  
-   Событие передает параметр типа `SomeEventEventArgs` к обработчикам событий.  
  
### Простой класс с помощью существующего диспетчера событий  
  
1.  Найдите существующий простой диспетчера событий.  
  
     Список слабых событий, входящих в состав WPF диспетчеров см. в разделе в иерархии наследования <xref:System.Windows.WeakEventManager> класс.  
  
2.  Используйте новый диспетчер событий слабых вместо обычного hookup события.  
  
     Например, если в коде используется следующий шаблон, чтобы подписаться на событие.  
  
    ```  
    source.SomeEvent += new SomeEventEventHandler(OnSomeEvent);  
    ```  
  
     Измените ее к следующему шаблону:  
  
    ```  
    SomeEventWeakEventManager.AddHandler(source, OnSomeEvent);  
    ```  
  
     Аналогично, если в коде используется следующий шаблон для отказа от подписки на событие.  
  
    ```  
    source.SomeEvent -= new SomeEventEventHandler(OnSome);  
    ```  
  
     Измените ее к следующему шаблону:  
  
    ```  
    SomeEventWeakEventManager.RemoveHandler(source, OnSomeEvent);  
    ```  
  
### Использование класса диспетчера универсальный шаблон слабых событий  
  
1.  Использование универсальных <xref:System.Windows.WeakEventManager%602> класс вместо обычного hookup события.  
  
     При использовании <xref:System.Windows.WeakEventManager%602> для регистрации прослушивателей события, и указать источник события  <xref:System.EventArgs> введите в качестве параметров типа к классу и вызовите  <xref:System.Windows.WeakEventManager%602.AddHandler%2A> как показано в следующем коде:  
  
    ```  
    WeakEventManager<EventSource, SomeEventEventArgs>.AddHandler(source, "SomeEvent", source_SomeEvent);  
    ```  
  
### Создание пользовательского класса диспетчера слабых событий  
  
1.  Скопируйте следующий шаблон класса в проект.  
  
     Этот класс наследуется из класса <xref:System.Windows.WeakEventManager>.  
  
     [!code-csharp[WeakEvents#WeakEventManagerTemplate](../../../../samples/snippets/csharp/VS_Snippets_Wpf/WeakEvents/CSharp/WeakEventManagerTemplate.cs#weakeventmanagertemplate)]  
  
2.  Заменить `SomeEventWeakEventManager` имя с вашими имя.  
  
3.  Замените 3 имени, описанного ранее с соответствующими именами для события.  \(`SomeEvent`"  `EventSource`и  `SomeEventEventArgs`\)  
  
4.  Задайте видимость \(открытую\/внутреннюю и закрытой\) слабого класса диспетчера событий к одной и той же видимости, какое событие он управляет.  
  
5.  Используйте новый диспетчер событий слабых вместо обычного hookup события.  
  
     Например, если в коде используется следующий шаблон, чтобы подписаться на событие.  
  
    ```  
    source.SomeEvent += new SomeEventEventHandler(OnSomeEvent);  
    ```  
  
     Измените ее к следующему шаблону:  
  
    ```  
    SomeEventWeakEventManager.AddHandler(source, OnSomeEvent);  
    ```  
  
     Аналогично, если в коде используется следующий шаблон для отказа от подписки на событие.  
  
    ```  
    source.SomeEvent -= new SomeEventEventHandler(OnSome);  
    ```  
  
     Измените ее к следующему шаблону:  
  
    ```  
    SomeEventWeakEventManager.RemoveHandler(source, OnSomeEvent);  
    ```  
  
## См. также  
 <xref:System.Windows.WeakEventManager>   
 <xref:System.Windows.IWeakEventListener>   
 [Общие сведения о перенаправленных событиях](../../../../docs/framework/wpf/advanced/routed-events-overview.md)   
 [Общие сведения о связывании данных](../../../../docs/framework/wpf/data/data-binding-overview.md)