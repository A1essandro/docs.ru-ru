---
title: "Пошаговое руководство. Кэширование данных приложения WPF | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-wpf"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "кэширование [платформа .NET Framework]"
  - "кэширование [WPF]"
  - "пошаговые руководства [WPF], кэширование"
ms.assetid: dac2c9ce-042b-4d23-91eb-28f584415cef
caps.latest.revision: 25
author: "dotnet-bot"
ms.author: "dotnetcontent"
manager: "wpickett"
caps.handback.revision: 25
---
# Пошаговое руководство. Кэширование данных приложения WPF
Кэширование позволяет хранить данные в памяти для быстрого доступа.  При повторном доступе к данным приложения могут получать данные из кэша вместо их извлечения из исходного источника.  Это может повысить производительность и масштабируемость.  Кроме того, кэширование обеспечивает доступность данных при временной недоступности источника данных.  
  
 [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] предоставляет классы, которые позволяют использовать кэширования в приложениях [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] .  Эти классы находятся в пространстве имен <xref:System.Runtime.Caching> .  
  
> [!NOTE]
>  Пространство имен <xref:System.Runtime.Caching> — это новое пространство имен в платформе [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)].  Это пространство имен обеспечивает доступность кэширования для всех приложений платформы [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)].  В предыдущих версиях [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] кэширование было доступно только в пространстве имен <xref:System.Web> и поэтому требовало зависимости от классов ASP.NET.  
  
 В данном пошаговом руководстве показано использование функции кэширования, которая доступна в платформе [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] в качестве компонента приложения [!INCLUDE[TLA#tla_winclient](../../../../includes/tlasharptla-winclient-md.md)].  В этом руководстве кэшируется содержимое текстового файла.  
  
 В данном пошаговом руководстве представлены следующие задачи:  
  
-   Создание нового проекта приложения WPF.  
  
-   Добавление ссылки на платформу [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)].  
  
-   Инициализация кэша.  
  
-   Добавление записи кэша, в которой кэшируется содержимое текстового файла.  
  
-   Реализация политики вытеснения записи кэша.  
  
-   Отслеживание пути к кэшированному файлу и уведомление экземпляра кэша об изменениях отслеживаемого элемента.  
  
## Обязательные компоненты  
 Для выполнения этого пошагового руководства потребуется следующее.  
  
-   Microsoft [!INCLUDE[vs_dev10_long](../../../../includes/vs-dev10-long-md.md)].  
  
-   Текстовый файл с небольшим объемом текста.  \(Содержимое текстового файла будет отображаться в окне сообщения.\) В коде, который иллюстрирует действия данного пошагового руководства, предполагается, что работа выполняется со следующим файлом:  
  
     `c:\cache\cacheText.txt`  
  
     Однако после внесения незначительных изменений в пошаговое руководство можно использовать любой текстовый файл.  
  
## Создание нового проекта приложения WPF  
 Для начала необходимо создать проект приложения WPF.  
  
#### Создание приложения WPF  
  
1.  Запустите [!INCLUDE[vsprvs](../../../../includes/vsprvs-md.md)].  
  
2.  В меню **Файл** выберите последовательно пункты **Создать** и **Новый проект**.  
  
     Откроется диалоговое окно **Новый проект**.  
  
3.  В разделе **Установленные шаблоны** выберите используемый язык программирования \(**Visual Basic** или **Visual C\#**\).  
  
4.  В диалоговом окне **Новый проект** выберите **Приложение WPF**.  
  
    > [!NOTE]
    >  Если шаблон **Приложение WPF** отсутствует, убедитесь, что выбранная версия платформы [!INCLUDE[dnprdnshort](../../../../includes/dnprdnshort-md.md)] поддерживает WPF.  В диалоговом окне **Новый проект** выберите в списке значение [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)].  
  
5.  В текстовом поле **Имя** введите имя проекта.  Например, можно ввести WPFCaching.  
  
6.  Установите флажок **Создать каталог для решения**.  
  
7.  Нажмите кнопку **ОК**.  
  
     Откроется представление **Проектирование** конструктора WPF, в котором отображается файл MainWindow.xaml.  Среда [!INCLUDE[vsprvs](../../../../includes/vsprvs-md.md)] создает папку **Мой проект** и файлы Application.xaml и MainWindow.xaml.  
  
## Определение требуемой версии .NET Framework и добавление ссылки на сборки кэширования  
 По умолчанию приложения WPF предназначены для платформы [!INCLUDE[net_client_v40_long](../../../../includes/net-client-v40-long-md.md)].  Чтобы использовать пространство имен <xref:System.Runtime.Caching> в приложении WPF, это приложение должно быть предназначено для платформы [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] \(а не платформы [!INCLUDE[net_client_v40_long](../../../../includes/net-client-v40-long-md.md)]\). Кроме того, оно должно включать ссылку на данное пространство имен.  
  
 Поэтому следующий шаг состоит в изменении требуемой версии .NET Framework и добавлении ссылки на пространство имен <xref:System.Runtime.Caching>.  
  
> [!NOTE]
>  Процедура изменения требуемой версии .NET Framework отличается в проектах Visual Basic и Visual C\#.  
  
#### Изменение требуемой версии .NET Framework в Visual Basic  
  
1.  В **обозревателе решений** щелкните правой кнопкой мыши имя проекта и выберите пункт **Свойства**.  
  
     Откроется окно свойств для приложения.  
  
2.  Перейдите на вкладку **Compile**.  
  
3.  В нижней части окна нажмите кнопку **Дополнительные параметры компиляции…**.  
  
     Откроется диалоговое окно **Дополнительные параметры компилятора**.  
  
4.  В списке **Заданная исполняющая среда \(все конфигурации\)** выберите [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)].  \(Не устанавливайте [!INCLUDE[net_client_v40_long](../../../../includes/net-client-v40-long-md.md)].\)  
  
5.  Нажмите кнопку **ОК**.  
  
     Откроется диалоговое окно **Изменение целевой рабочей среды**.  
  
6.  В диалоговом окне **Изменение целевой рабочей среды** нажмите кнопку **Да**.  
  
     Проект будет закрыт и вновь открыт.  
  
7.  Добавьте ссылку на сборку кэширования, выполнив следующие действия.  
  
    1.  В **обозревателе решений** щелкните правой кнопкой мыши имя проекта и выберите команду **Добавить ссылку**.  
  
    2.  Перейдите на вкладку **.NET**, щелкните `System.Runtime.Caching` и нажмите кнопку **ОК**.  
  
#### Изменение требуемой версии .NET Framework в Visual C\#  
  
1.  В окне **Обозреватель решений** щелкните правой кнопкой мыши имя проекта и выберите пункт **Свойства**.  
  
     Откроется окно свойств для приложения.  
  
2.  Перейдите на вкладку **Приложение**.  
  
3.  В списке **Требуемая версия .NET Framework** выберите значение [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] \(не выбирайте **клиентский профиль .NET Framework 4**\).  
  
4.  Добавьте ссылку на сборку кэширования, выполнив следующие действия.  
  
    1.  Щелкните правой кнопкой мыши папку **Ссылки**, а затем выберите команду **Добавить ссылку**.  
  
    2.  Перейдите на вкладку **.NET**, щелкните `System.Runtime.Caching` и нажмите кнопку **ОК**.  
  
## Добавление кнопки в окно WPF  
 Далее необходимо добавить элемент управления "Кнопка" и создать обработчик событий `Click` для кнопки.  Позже будет добавлен код, обеспечивающий кэширование и отображение содержимого текстового файла при нажатии кнопки.  
  
#### Добавление элемента управления "Кнопка"  
  
1.  В **обозревателе решений** дважды щелкните файл MainWindow.xaml, чтобы открыть его.  
  
2.  Из группы **Типовые элементы управления WPF** **панели элементов** перетащите элемент управления `Button` в окно `MainWindow`.  
  
3.  В окне **Свойства** задайте для свойства `Content` элемента управления `Button` значение "Получить кэш".  
  
## Инициализация кэша и кэширование записи  
 Теперь будет добавлен код для выполнения следующих задач.  
  
-   Создание экземпляра класса кэша \(будет создан экземпляр нового объекта <xref:System.Runtime.Caching.MemoryCache>\).  
  
-   Указание того, что для отслеживания изменений в текстовом файле кэш использует объект <xref:System.Runtime.Caching.HostFileChangeMonitor>.  
  
-   Чтение текстового файла и кэширование его содержимого в виде записи кэша.  
  
-   Отображение содержимого кэшированного текстового файла.  
  
#### Создание объекта кэша  
  
1.  Дважды нажмите только что созданную кнопку, чтобы создать обработчик событий в файле MainWindow.xaml.cs или MainWindow.Xaml.vb.  
  
2.  В верхней части файла \(перед объявлением класса\) добавьте указанные ниже операторы `Imports` \(Visual Basic\) или `using` \(C\#\).  
  
    ```csharp  
    using System.Runtime.Caching;  
    using System.IO;  
    ```  
  
    ```vb  
    Imports System.Runtime.Caching  
    Imports System.IO  
    ```  
  
3.  В обработчике событий добавьте следующий код для создания экземпляра объекта кэша:  
  
    ```csharp  
    ObjectCache cache = MemoryCache.Default;  
    ```  
  
    ```vb  
    Dim cache As ObjectCache = MemoryCache.Default  
    ```  
  
     Класс <xref:System.Runtime.Caching.ObjectCache> — это встроенный класс, который предоставляет кэш объектов памяти.  
  
4.  Добавьте следующий код для чтения содержимого записи кэша с именем `filecontents`:  
  
    ```vb  
    Dim fileContents As String = TryCast(cache("filecontents"), String)  
    ```  
  
    ```csharp  
    string fileContents = cache["filecontents"] as string;  
    ```  
  
5.  Добавьте следующий код для проверки наличия записи кэша с именем `filecontents`:  
  
    ```vb  
    If fileContents Is Nothing Then  
  
    End If  
    ```  
  
    ```csharp  
    if (fileContents == null)  
    {  
  
    }  
    ```  
  
     Если указанная запись кэша отсутствует, необходимо выполнить чтение текстового файла и добавить его в кэш в виде записи кэша.  
  
6.  В блоке `if/then` добавьте следующий код, чтобы создать новый объект <xref:System.Runtime.Caching.CacheItemPolicy>, указывающий, что срок действия записи кэша истекает через 10 секунд.  
  
    ```vb  
    Dim policy As New CacheItemPolicy()  
    policy.AbsoluteExpiration = DateTimeOffset.Now.AddSeconds(10.0)  
    ```  
  
    ```csharp  
    CacheItemPolicy policy = new CacheItemPolicy();  
    policy.AbsoluteExpiration = DateTimeOffset.Now.AddSeconds(10.0);  
    ```  
  
     Если сведения о вытеснении или сроке действия не предоставляются, по умолчанию используется значение <xref:System.Runtime.Caching.ObjectCache.InfiniteAbsoluteExpiration>, которое указывает, что срок действия записей кэша истекает не на основе абсолютного времени,  а только при нехватке памяти.  Рекомендуется всегда явно предоставлять абсолютный или скользящий срок действия.  
  
7.  Внутри блока `if/then` после кода, добавленного на предыдущем шаге, добавьте следующий код, чтобы создать коллекцию для отслеживаемых путей к файлам и добавить в нее путь к текстовому файлу:  
  
    ```vb  
    Dim filePaths As New List(Of String)()  
    filePaths.Add("c:\cache\cacheText.txt")  
    ```  
  
    ```csharp  
    List<string> filePaths = new List<string>();  
    filePaths.Add("c:\\cache\\cacheText.txt");  
    ```  
  
    > [!NOTE]
    >  Если используется файл, отличный от `c:\cache\cacheText.txt`, укажите путь к используемому текстовому файлу.  
  
8.  После кода, добавленного на предыдущем шаге, добавьте следующий код, чтобы добавить новый объект <xref:System.Runtime.Caching.HostFileChangeMonitor> в коллекцию мониторов изменений для записи кэша:  
  
    ```vb  
    policy.ChangeMonitors.Add(New HostFileChangeMonitor(filePaths))  
    ```  
  
    ```csharp  
    policy.ChangeMonitors.Add(new HostFileChangeMonitor(filePaths));  
    ```  
  
     Объект <xref:System.Runtime.Caching.HostFileChangeMonitor> отслеживает путь к текстовому файлу и при появлении изменений уведомляет кэш.  В этом примере срок действия записи кэша истекает при изменении содержимого файла.  
  
9. После кода, добавленного на предыдущем шаге, добавьте следующий код для чтения содержимого текстового файла:  
  
    ```vb  
    fileContents = File.ReadAllText("c:\cache\cacheText.txt") & vbCrLf & DateTime.Now.ToString()  
    ```  
  
    ```csharp  
    fileContents = File.ReadAllText("c:\\cache\\cacheText.txt") + + "\n" + DateTime.Now;   
    ```  
  
     Отметка даты и времени добавляется для определения времени окончания срока действия записи кэша.  
  
10. После кода, добавленного на предыдущем шаге, добавьте следующий код, чтобы вставить содержимое файла в объект кэша в качестве экземпляра <xref:System.Runtime.Caching.CacheItem>:  
  
    ```vb  
    cache.Set("filecontents", fileContents, policy)  
    ```  
  
    ```csharp  
    cache.Set("filecontents", fileContents, policy);  
    ```  
  
     Сведения о способе удаления записи кэша задаются путем передачи ранее созданного объекта <xref:System.Runtime.Caching.CacheItemPolicy> в качестве параметра.  
  
11. Добавьте после блока `if/then` следующий код, чтобы отобразить кэшированное содержимое файла в окне сообщения:  
  
    ```vb  
    MessageBox.Show(fileContents)  
    ```  
  
    ```csharp  
    MessageBox.Show(fileContents);  
    ```  
  
12. В меню **Построение** выберите команду **Построить WPFCaching**, чтобы выполнить построение проекта.  
  
## Проверка кэширования в приложении WPF  
 Теперь приложение можно протестировать.  
  
#### Проверка кэширования в приложении WPF  
  
1.  Нажмите CTRL\+F5, чтобы запустить приложение.  
  
     Откроется окно `MainWindow`.  
  
2.  Нажмите кнопку **Получить кэш**.  
  
     В окне сообщения отображается кэшированное содержимое текстового файла.  Обратите внимание на отметку времени в файле.  
  
3.  Закройте окно сообщения и нажмите кнопку **Получить кэш** еще раз**.**  
  
     Отметка времени не изменилась.  Это означает, что отображается кэшированное содержимое.  
  
4.  Подождите 10 секунд или более и снова нажмите кнопку **Получить кэш**.  
  
     Теперь отображается новая отметка времени.  Это означает, что в силу политики срок действия кэша истек и отображается новое кэшированное содержимое.  
  
5.  Откройте созданный текстовый файл в текстовом редакторе.  Пока не вносите никаких изменений.  
  
6.  Закройте окно сообщения и нажмите кнопку **Получить кэш** еще раз**.**  
  
     Снова обратите внимание на отметку времени.  
  
7.  Внесите изменение в текстовый файл и сохраните файл.  
  
8.  Закройте окно сообщения и нажмите кнопку **Получить кэш** еще раз.  
  
     В окне сообщения отображается обновленное содержимое текстового файла и новая отметка времени.  Это означает, что монитор изменений основного файла удалил запись кэша сразу после внесения изменений, хотя абсолютный период срока действия еще не истек.  
  
    > [!NOTE]
    >  Время вытеснения можно увеличить до 20 секунд или более, чтобы было больше времени для внесения изменений в файл.  
  
## Пример кода  
 После выполнения инструкций данного пошагового руководства код для созданного проекта будет иметь вид, подобный представленному в следующем примере.  
  
 [!code-csharp[CachingWPFApplications#1](../../../../samples/snippets/csharp/VS_Snippets_Wpf/CachingWPFApplications/CSharp/MainWindow.xaml.cs#1)]
 [!code-vb[CachingWPFApplications#1](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/CachingWPFApplications/VisualBasic/MainWindow.xaml.vb#1)]  
  
## См. также  
 <xref:System.Runtime.Caching.MemoryCache>   
 <xref:System.Runtime.Caching.ObjectCache>   
 <xref:System.Runtime.Caching>   
 [Кэширование в приложениях платформы .NET Framework](../../../../docs/framework/performance/caching-in-net-framework-applications.md)