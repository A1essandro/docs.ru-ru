---
title: "Приоритет значения свойств зависимостей | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-wpf"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "классы, владельцы свойств зависимостей"
  - "свойства зависимостей, классы в качестве владельцев"
  - "свойства зависимостей, метаданные"
  - "метаданные, свойства зависимостей"
ms.assetid: 1fbada8e-4867-4ed1-8d97-62c07dad7ebc
caps.latest.revision: 27
author: "dotnet-bot"
ms.author: "dotnetcontent"
manager: "wpickett"
caps.handback.revision: 26
---
# Приоритет значения свойств зависимостей
<a name="introduction"></a> В этом разделе объясняется, как работа системы свойств [!INCLUDE[TLA#tla_winclient](../../../../includes/tlasharptla-winclient-md.md)] может повлиять на значение [свойства зависимостей](GTMT), и описывает приоритет, по которому аспекты системы свойств применяются к действительному значению свойства.  
  
 [!INCLUDE[autoOutline](../Token/autoOutline_md.md)]  
  
<a name="prerequisites"></a>   
## Предварительные требования  
 В этом разделе предполагается, что пользователь понимает свойства зависимостей с точки зрения потребителя существующих свойств зависимостей классов [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] и ознакомился с разделом [Общие сведения о свойствах зависимости](../../../../docs/framework/wpf/advanced/dependency-properties-overview.md).  Для понимания примеров в этом разделе также требуется понимать [!INCLUDE[TLA#tla_xaml](../../../../includes/tlasharptla-xaml-md.md)] и знать порядок написания приложений [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)].  
  
<a name="intro"></a>   
## Система свойств WPF  
 Система свойств [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] предлагает мощный способ определения значений свойств зависимостей с помощью множества факторов, включая такие возможности, как проверка свойства в режиме реального времени, позднее связывание и уведомление связанных свойств об изменениях значений других свойств.  Точный порядок и логика, используемые для определения значений свойств зависимостей, являются достаточно сложными.  Знание этого порядка поможет избежать ненужной настройки свойств и путаницы относительно того, почему некоторые попытки повлиять или предугадать значение свойства зависимостей не приводят к ожидаемому результату.  
  
<a name="multiple_sets"></a>   
## Свойства зависимостей могут быть "установлены" в нескольких местах  
 Ниже приведен пример [!INCLUDE[TLA2#tla_xaml](../../../../includes/tla2sharptla-xaml-md.md)], где одно и то же свойство \(<xref:System.Windows.Controls.Control.Background%2A>\) имеет три различные операции "установки", которые могут повлиять на значение.  
  
 [!code-xml[PropertiesOvwSupport#DPPrecedence](../../../../samples/snippets/csharp/VS_Snippets_Wpf/PropertiesOvwSupport/CSharp/page4.xaml#dpprecedence)]  
  
 Какой цвет будет применен — красный, зеленый или синий?  
  
 С помощью исключения динамических значений и приведения наборы локальных свойств получают наивысший приоритет.  Если значение задается локально, оно будет иметь более высокий приоритет, по сравнению с любым стилем или элементом управления.  В этом примере <xref:System.Windows.Controls.Control.Background%2A> устанавливается локально в значение Red.  Таким образом, стиль, определенный в этой области \(даже если это неявный стиль, который в противном случае будет применен ко всем элементам этого типа в этой области\) не имеет наивысшего приоритета для присваивания его значения свойству <xref:System.Windows.Controls.Control.Background%2A>.  Если удалить локальное значение Red из этого экземпляра Button, то стиль получит приоритет, и кнопка получит значение Background из стиля.  Внутри стиля приоритет получают триггеры, поэтому кнопка будет синей, если указатель мыши находится на ней. В противном случае кнопка будет зеленой.  
  
<a name="listing"></a>   
## Список приоритетов параметров свойства зависимостей  
 Ниже приведен точный порядок, который использует система обработки свойств при присваивании значений свойств зависимостей во время выполнения.  Первым указан наиболее приоритетный параметр.  Этот список включает некоторые обобщения, сделанные в [Общие сведения о свойствах зависимости](../../../../docs/framework/wpf/advanced/dependency-properties-overview.md).  
  
1.  **Приведение системы свойств.** Сведения о приведении см. в подразделе [Приведение, анимация и базовое значение](#animations) данного раздела.  
  
2.  **Активные анимации или анимации с поведением Hold.** Для реализации анимация свойства должна быть способной получить приоритет над базовым \(неанимированным\) значением, даже если это значение было задано локально.  Дополнительные сведения см. в подразделе [Приведение, анимация и базовое значение](#animations) данного раздела.  
  
3.  **Локальное значение.** Локальное значение может быть установлено с помощью свойства "обертка", которое также приравнивается к установке в качестве атрибута или элемента свойства в [!INCLUDE[TLA2#tla_xaml](../../../../includes/tla2sharptla-xaml-md.md)], или путем вызова <xref:System.Windows.DependencyObject.SetValue%2A> [!INCLUDE[TLA#tla_api](../../../../includes/tlasharptla-api-md.md)] с использованием свойства конкретного экземпляра.  Если локальное значение задается с использованием привязки или ресурса, то в каждом из этих случаев действие выполняется в той же последовательности, как и при задании прямого значения.  
  
4.  **Свойства шаблона TemplatedParent.** Элемент имеет <xref:System.Windows.FrameworkElement.TemplatedParent%2A>, если он был создан как часть шаблона \(<xref:System.Windows.Controls.ControlTemplate> или <xref:System.Windows.DataTemplate>\).  Сведения о том, когда это применяется, см. в подразделе [TemplatedParent](#templatedparent) данного раздела.  В шаблоне применяется следующий приоритет.  
  
    1.  Триггеры из шаблона <xref:System.Windows.FrameworkElement.TemplatedParent%2A>.  
  
    2.  Свойство задается \(обычно через атрибуты [!INCLUDE[TLA2#tla_xaml](../../../../includes/tla2sharptla-xaml-md.md)]\) в шаблоне <xref:System.Windows.FrameworkElement.TemplatedParent%2A>.  
  
5.  **Неявный стиль.** Применяется только к свойству `Style`.  Свойство `Style` заполняется любым ресурсом стиля с ключом, который соответствует типу данного элемента.  Ресурс стиля должен существовать либо на странице, либо в приложении. Поиск ресурса неявного стиля в темах не выполняется.  
  
6.  **Триггеры стиля.** Триггеры в стилях из страницы или приложения \(эти стили могут быть либо явными, либо неявными, но не могут относиться к стилям по умолчанию, которые имеют более низкий приоритет\).  
  
7.  **Триггеры шаблона.** Любой триггер из шаблона внутри стиля или непосредственно применяемый шаблон.  
  
8.  **Способы установки стиля.** Значения из <xref:System.Windows.Setter> внутри стилей из страницы или приложения.  
  
9. **Стиль по умолчанию \(тематический\).** Сведения о применении стилей, а также их связи с шаблонами внутри стилей темы, содержатся в подразделе [Стили по умолчанию \(тематические\)](#themestyles) этого раздела.  В стиле по умолчанию применяется следующий порядок приоритетов.  
  
    1.  Активные триггеры в тематическом стиле.  
  
    2.  Способы установки в тематическом стиле.  
  
10. **Наследование.** Некоторые свойства зависимостей наследуют свои значения от родительского элемента к дочерним элементам, поэтому их не нужно специально задавать для каждого элемента внутри приложения.  Дополнительные сведения см. в разделе [Наследование значения свойства](../../../../docs/framework/wpf/advanced/property-value-inheritance.md).  
  
11. **Значение по умолчанию из метаданных свойства зависимостей.** Любое заданное свойство зависимостей может иметь значение по умолчанию, установленное регистрацией этого конкретного свойства в системе обработки свойств.  Кроме того, производные классы, которые наследуют свойство зависимостей, имеют возможность переопределить эти метаданные \(включая значение по умолчанию\) для каждого типа.  Дополнительные сведения см. в разделе [Метаданные свойства зависимости](../../../../docs/framework/wpf/advanced/dependency-property-metadata.md).  Поскольку наследование проверяется до значения по умолчанию, для наследуемого свойства значение по умолчанию родительского элемента имеет приоритет перед дочерним элементом.  Следовательно, если наследуемое свойство нигде не задано, вместо значения по умолчанию дочернего элемента используется значение по умолчанию, указанное в корневом или родительском элементе.  
  
<a name="templatedparent"></a>   
## TemplatedParent  
 TemplatedParent как приоритетный элемент не применяется ни к какому свойству элемента, объявляемому непосредственно в стандартной разметке приложения.  Понятие TemplatedParent существует только для дочерних элементов в пределах визуального дерева, которые создаются в результате применения шаблона.  Когда система обработки свойств выполняет поиск шаблона <xref:System.Windows.FrameworkElement.TemplatedParent%2A> для значения, она выполняет поиск шаблона, создавшего этот элемент.  Значения свойств из шаблона <xref:System.Windows.FrameworkElement.TemplatedParent%2A> обычно реализуются, как если бы они были установлены в качестве локальных значений в дочернем элементе, но это имеет меньший приоритет относительно локального значения существует, поскольку шаблоны, как правило, являются совместно используемыми.  Дополнительные сведения см. в разделе <xref:System.Windows.FrameworkElement.TemplatedParent%2A>.  
  
<a name="style_property"></a>   
## Свойство Style  
 Порядок поиска, описанный выше, применяется ко всем возможным свойствам зависимостей, за исключением свойства <xref:System.Windows.FrameworkElement.Style%2A> Свойство <xref:System.Windows.FrameworkElement.Style%2A> является уникальным в том, что оно не может применять стиль к себе, поэтому элементы 5 — 8 в списке приоритета не применяются.  Кроме того, не рекомендуется анимация или преобразование <xref:System.Windows.FrameworkElement.Style%2A> \(для анимации <xref:System.Windows.FrameworkElement.Style%2A> потребуется пользовательский класс анимации\).  При этом остается три способа, с помощью которых может быть установлено свойство <xref:System.Windows.FrameworkElement.Style%2A>:  
  
-   **Явный стиль.** Свойство <xref:System.Windows.FrameworkElement.Style%2A> задается напрямую.  В большинстве случаев стиль не определяется как встроенный. Вместо этого явный ключ ссылается на него как на ресурс.  В этом случае само свойство Style действует как локальное значение с приоритетом 3.  
  
-   **Неявный стиль.** Свойство <xref:System.Windows.FrameworkElement.Style%2A> напрямую не задается.  Однако <xref:System.Windows.FrameworkElement.Style%2A> существует на определенном уровне в последовательности поиска ресурсов \(уровне страницы, приложения\) и шифруется с помощью ключа ресурса, который соответствует типу стиля, к которому он будет применяться.  В этом случае само свойство <xref:System.Windows.FrameworkElement.Style%2A> действует под приоритетом, определенным в последовательности как элемент 5.  Это условие может быть обнаружено при использовании <xref:System.Windows.DependencyPropertyHelper> по свойству <xref:System.Windows.FrameworkElement.Style%2A> и при поиске <xref:System.Windows.BaseValueSource> в результатах.  
  
-   **Стиль по умолчанию**, также известный как **тематический стиль.** Свойство <xref:System.Windows.FrameworkElement.Style%2A> не задается напрямую и будет считываться как `null` до времени выполнения.  В этом случае стиль поступает из оценки темы времени выполнения, которая является частью механизма представления [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)].  
  
 Для неявных стилей не в темах должно быть точное соответствие типа — `MyButton`. Производный класс от `Button` не будет неявно использовать стиль для `Button`.  
  
<a name="themestyles"></a>   
## Стили по умолчанию \(тематические\).  
 Каждый элемент управления, которые поставляется с [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)], имеет стиль по умолчанию.  Этот стиль по умолчанию зависит от темы, поэтому этот стиль по умолчанию иногда называют тематическим стилем.  
  
 Наиболее важная информация в стиле по умолчанию для элемента управления — это его шаблон элемента управления, который существует в тематическом стиле как механизм установки его свойства <xref:System.Windows.Controls.Control.Template%2A>.  При отсутствии шаблона из стилей по умолчанию элемент управления, который не имеет пользовательского шаблона в качестве части пользовательского стиля, не будет иметь визуального представления.  Шаблон из стиля по умолчанию предоставляет основную структуру для визуального представления каждого элемента управления, а также определяет связи между свойствами, определенными в визуальном дереве шаблона и классе соответствующего элемента управления.  Каждый элемент управления предоставляет набор свойств, которые могут изменить внешний вид элемента управления без полной замены шаблона.  Рассмотрим внешний вид элемента управления <xref:System.Windows.Controls.Primitives.Thumb> по умолчанию, который является компонентом <xref:System.Windows.Controls.Primitives.ScrollBar>.  
  
 <xref:System.Windows.Controls.Primitives.Thumb> имеет определенные настраиваемые свойства.  Шаблон по умолчанию <xref:System.Windows.Controls.Primitives.Thumb> создает основную структуру \/ визуальное дерево с несколькими вложенными компонентами <xref:System.Windows.Controls.Border> для придания наклонного вида.  Если свойство, которое является частью шаблона, должно быть предоставлено для настройки с помощью класса <xref:System.Windows.Controls.Primitives.Thumb>, то это свойство должно быть предоставлено [TemplateBinding](../../../../docs/framework/wpf/advanced/templatebinding-markup-extension.md) внутри шаблона.  Применительно к <xref:System.Windows.Controls.Primitives.Thumb> различные свойства этих границ совместно используют привязку шаблона к таким свойствам, как <xref:System.Windows.Controls.Border.Background%2A> или <xref:System.Windows.Controls.Border.BorderThickness%2A>.  Однако некоторые другие свойства или параметры визуального представления жестко запрограммированы в шаблоне элемента управления или привязаны к значениям, полученным непосредственно из темы, и не могут быть изменены иным способом, кроме как путем замены всего шаблона.  Как правило, если свойство происходит из шаблонного родительского элемента и не предоставляется привязкой шаблона, оно не может быть изменено стилями, поскольку отсутствует простой способ указать его.  Однако это свойство также может зависеть от наследования значения свойства в примененном шаблоне или значения по умолчанию.  
  
 Тематические стили используют тип в качестве ключа в своих определениях.  Однако при применении тем к экземпляру данного элемента поиск тем для данного типа выполняется путем проверки свойства <xref:System.Windows.FrameworkElement.DefaultStyleKey%2A> в элементе управления.  В неявных стилях, в свою очередь, используется литерал Type.  Значение <xref:System.Windows.FrameworkElement.DefaultStyleKey%2A> наследуется производными классами, даже если разработчик не изменяет его \(рекомендуется изменять свойство, не переопределяя его на уровне свойства, а изменяя его значение по умолчанию в метаданных свойства\).  Это позволяет базовым классам определять тематические стили для производных элементов, которые в противном случае не имеют стиля \(или, что более важно, не имеют шаблон внутри стиля и поэтому не имеют по умолчанию визуального представления\).  Таким образом, можно получать производный элемент `MyButton` из <xref:System.Windows.Controls.Button> и по\-прежнему использовать шаблон по умолчанию <xref:System.Windows.Controls.Button>.  Если при создании элемента управления `MyButton` требуются различные варианты поведения элемента, можно переопределить метаданные свойства зависимостей для <xref:System.Windows.FrameworkElement.DefaultStyleKey%2A> в элементе `MyButton`, чтобы он возвращал другой ключ, а затем определить подходящие тематические стили, включая шаблон для `MyButton`, который нужно включить в комплектацию элемента управления `MyButton`.  Дополнительные сведения о темах, стилях и элементах управления см. в разделе [Общие сведения о разработке управления](../../../../docs/framework/wpf/controls/control-authoring-overview.md).  
  
<a name="resources"></a>   
## Привязка и ссылки на динамические ресурсы  
 Ссылки на динамические ресурсы и операции привязки учитывают приоритет расположения, в котором они заданы.  Например, динамический ресурс, примененный к локальному значению, действует как элемент с приоритетом 3, привязка для метода задания свойства внутри тематического стиля применяется как элемент с приоритетом 9 и т. д.  Поскольку ссылки на динамические ресурсы и привязка должны иметь возможность получения значений из состояния времени выполнения приложения, фактический процесс определения приоритета значения свойства для любого заданного свойства также расширяется во времени выполнения.  
  
 Ссылки на динамические ресурсы, строго говоря, не являются частью системы обработки свойств, но они имеют свой собственный порядок поиска, который взаимодействует с перечисленной выше последовательностью.  Этот приоритет описан более подробно в разделе [Ресурсы XAML](../../../../docs/framework/wpf/advanced/xaml-resources.md).  Основная последовательность приоритетов: элемент, корневая страница, приложение, тема, система.  
  
 Динамические ресурсы и привязки получают приоритет расположения, в котором они заданы, однако это значение является откладываемым.  Следствием этого является то, что если задать для динамического ресурса или привязки локальное значение, любое изменение этого локального значения полностью заменяет динамический ресурс или привязку.  Даже при вызове метода <xref:System.Windows.DependencyObject.ClearValue%2A> для очистки локально установленного значения динамический ресурс или привязка не восстанавливаются.  Фактически при вызове метода <xref:System.Windows.DependencyObject.ClearValue%2A> для свойства, которое содержит динамический ресурс или привязку \(без литерального локального значения\), они также очищаются посредством вызова метода <xref:System.Windows.DependencyObject.ClearValue%2A>.  
  
<a name="setcurrentvalue"></a>   
## SetCurrentValue  
 Метод <xref:System.Windows.DependencyObject.SetCurrentValue%2A> предоставляет еще один способ задания свойства, однако он не поддерживает порядок приоритетов.  Вместо этого метод <xref:System.Windows.DependencyObject.SetCurrentValue%2A> позволяет изменять значение свойства, не перезаписывая источник предыдущего значения.  <xref:System.Windows.DependencyObject.SetCurrentValue%2A> можно использовать всякий раз, когда необходимо задать значение, не предоставляя ему приоритет локального значения.  Например, если свойству, которое задается триггером, впоследствии присваивается другое значение с помощью метода <xref:System.Windows.DependencyObject.SetCurrentValue%2A>, система свойств по\-прежнему учитывает этот триггер и свойство изменится при возникновении действия триггера.  Метод <xref:System.Windows.DependencyObject.SetCurrentValue%2A> позволяет изменять значение свойства, не предоставляя ему источник с более высоким приоритетом.  Аналогичным образом, метод <xref:System.Windows.DependencyObject.SetCurrentValue%2A> можно использовать для изменения значения свойства без перезаписи привязки.  
  
<a name="animations"></a>   
## Приведение, анимация и базовое значение  
 Приведение и анимация используют значение, которое определяется как "базовое значение" для всего [!INCLUDE[TLA2#tla_sdk](../../../../includes/tla2sharptla-sdk-md.md)].  Таким образом, базовым значением является любое значение, определяемое с помощью оценки элементов от менее приоритетного к более приоритетному, пока не будет достигнут элемент 2.  
  
 Базовое значение может оказывать воздействие на анимированное значение, если эта анимация не задает параметры "From" и "To" для определенных вариантов поведения или если анимация специально восстанавливает базовое значение по завершении.  Чтобы увидеть это на практике, запустите [Пример целевых значений анимации From, To и By](http://go.microsoft.com/fwlink/?LinkID=159988).  Попробуйте установить локальные значения высоты прямоугольника, так чтобы начальное локальное значение отличалось от любого значения "From" в анимации.  Станет очевидно, что анимации начинают выполняться с использованием значения "From" и базовое значение заменяется сразу после запуска.  Можно указать, чтобы анимация возвращалась к значению, указанному до анимации, после ее завершения путем задания <xref:System.Windows.Media.Animation.FillBehavior> Stop.  Впоследствии для определения базового значения используется обычный приоритет.  
  
 Несколько анимаций могут быть применены к одному свойству, причем каждая из них может быть определена в разных точках в списке приоритетов значений.  Однако эти анимации вероятно будут объединять свои значения, а не просто применять анимацию с более высоким приоритетом.  Это зависит от того, каким образом анимации определены, и от типа анимируемого значения.  Дополнительные сведения об анимации свойств см. в разделе [Общие сведения об эффектах анимации](../../../../docs/framework/wpf/graphics-multimedia/animation-overview.md).  
  
 Приведение применяется для самого высокого приоритета.  Даже в уже выполняющейся анимации можно выполнить приведение значения.  Некоторые существующие свойства зависимостей в [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] имеют встроенные приведения.  Для пользовательского свойства зависимостей поведение приведения определяется путем написания <xref:System.Windows.CoerceValueCallback> и передачи обратного вызова как части метаданных при создании свойства.  Также можно переопределить поведение приведения существующих свойств путем переопределения метаданных для этого свойства в производном классе.  Приведение взаимодействует с базовым значением таким образом, что ограничения на приведение применяются без изменений, а базовое значение по\-прежнему сохраняется.  Таким образом, если ограничения в приведении впоследствии снимаются, приведение возвратит ближайшее к базовому значению, и воздействие приведения на свойство прекратится, как только все ограничения будут сняты.  Дополнительные сведения о поведении приведения см. в разделе [Проверка и обратные вызовы свойства зависимостей](../../../../docs/framework/wpf/advanced/dependency-property-callbacks-and-validation.md).  
  
<a name="triggers"></a>   
## Поведения триггера  
 Элементы управления часто определяют поведение триггера в темах как часть своего стиля по умолчанию.  Установка локальных свойств для элементов управления может помешать триггерам отвечать на события, вызываемые пользователем, визуально или своими действиями.  Триггер свойства наиболее часто используется для свойств элемента управления или состояния, таких как <xref:System.Windows.Controls.Primitives.Selector.IsSelected%2A>.  Например, по умолчанию при отключенном элементе управления <xref:System.Windows.Controls.Button> \(триггер для <xref:System.Windows.UIElement.IsEnabled%2A> — `false`\) значение свойства <xref:System.Windows.Controls.Control.Foreground%2A> в тематическом стиле приводит к выделению элемента управления серым цветом.  Но если значение <xref:System.Windows.Controls.Control.Foreground%2A> устанавливается локально, этот обычный серый цвет не будет приниматься во внимание в приоритетах для набора локальных свойств даже в этом сценарии триггера свойства.  Следует быть осторожным при установке значений для свойств, которые имеют триггер на уровне темы, и убедиться, что не происходит неоправданного изменения определенного для этого элемента управления поведения.  
  
<a name="clearvalue"></a>   
## Приоритет значений и ClearValue  
 Метод <xref:System.Windows.DependencyObject.ClearValue%2A> предоставляет соответствующие средства для очистки любого локально применяемого значения из [свойства зависимостей](GTMT), установленного для элемента.  Однако вызов <xref:System.Windows.DependencyObject.ClearValue%2A> не гарантирует, что значение по умолчанию, установленное в метаданных во время регистрации свойства, будет являться новым действительным значением.  Все другие элементы приоритета значения остаются активными.  Только локально заданное значение удаляется из последовательности приоритетов.  Например, если вызвать метод <xref:System.Windows.DependencyObject.ClearValue%2A> для свойства, в котором это свойство также задается тематическим стилем, то значение темы применяется как новое значение вместо значения по умолчанию на основе метаданных.  Если необходимо извлечь все элементы значения свойства из процесса и установить значение в значение, зарегистрированное по умолчанию в метаданных, можно получить это значение по умолчанию путем запроса метаданных свойства зависимостей, а затем использовать это значение по умолчанию, чтобы локально задать для свойства вызов <xref:System.Windows.DependencyObject.SetValue%2A>.  
  
## См. также  
 <xref:System.Windows.DependencyObject>   
 <xref:System.Windows.DependencyProperty>   
 [Общие сведения о свойствах зависимости](../../../../docs/framework/wpf/advanced/dependency-properties-overview.md)   
 [Пользовательские свойства зависимостей](../../../../docs/framework/wpf/advanced/custom-dependency-properties.md)   
 [Проверка и обратные вызовы свойства зависимостей](../../../../docs/framework/wpf/advanced/dependency-property-callbacks-and-validation.md)