---
title: "Проверка попадания на визуальном уровне | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-wpf"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "функциональность проверки нажатия"
  - "визуальный слой, функциональность проверки нажатия"
ms.assetid: b1a64b61-14be-4d75-b89a-5c67bebb2c7b
caps.latest.revision: 42
author: "dotnet-bot"
ms.author: "dotnetcontent"
manager: "wpickett"
caps.handback.revision: 41
---
# Проверка попадания на визуальном уровне
В этом разделе представлены общиесведения о функциональных возможностях проверки попадания, предоставляемых на визуальном уровне.  Поддержка проверки попадания позволяет определить, попадает ли геометрический объект или точка в отображаемое содержимое <xref:System.Windows.Media.Visual>, что позволяет реализовать поведение пользовательского интерфейса, например выделение прямоугольником для выбора нескольких объектов.  
  
   
  
<a name="hit_testing_scenarios"></a>   
## Сценарии проверки попадания  
 В классе <xref:System.Windows.UIElement> представлен метод <xref:System.Windows.UIElement.InputHitTest%2A>, который позволяет проверить попадание элемента с использованием заданного значения координат.  Метод <xref:System.Windows.UIElement.InputHitTest%2A> в большинстве случаях обеспечивает реализацию проверки попадания элементов.  Однако в некоторых скриптах может потребоваться реализация проверки попадания на визуальном уровне.  
  
-   Проверка попадания для объектов, не принадлежащих классу <xref:System.Windows.UIElement>. Применяется при проверке попадания объектов, не принадлежащих классу <xref:System.Windows.UIElement>, например <xref:System.Windows.Media.DrawingVisual> или графических объектов.  
  
-   Проверка попадания с использованием геометрического объекта. Применяется для проверки попадания с использованием геометрического объекта вместо значения координат точки.  
  
-   Проверка попадания для нескольких объектов. Применяется при проверке попадания для нескольких, например перекрывающихся, объектов.  Можно получить результаты для всех визуальных объектов, пересекающихся с геометрическим объектом или точкой \(а не только для первого из них\).  
  
-   Игнорирование политики проверки попадания класса <xref:System.Windows.UIElement>. Применяется, если необходимо игнорировать политику проверки попадания класса <xref:System.Windows.UIElement>, в которой учитываются такие факторы, как отключение или невидимость элемента.  
  
> [!NOTE]
>  Полный код примера проверки нажатия на визуальном уровне см. на веб\-страницах [Пример проверки нажатия с помощью DrawingVisuals](http://go.microsoft.com/fwlink/?LinkID=159994) и [Пример проверки нажатий, включающий взаимодействие с Win32](http://go.microsoft.com/fwlink/?LinkID=159995).  
  
<a name="hit_testing_support"></a>   
## Поддержка проверки попадания  
 Методы <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A> класса <xref:System.Windows.Media.VisualTreeHelper> используются, чтобы определить, попадает ли геометрический объект или значение координат точки в отображаемое содержимое заданного объекта, например элемента управления или графического элемента.  Например, можно использовать проверку попадания, чтобы определить, попадает ли точка, в которой нажата кнопка мыши в ограничивающем прямоугольнике, в геометрический объект "круг".  Можно также переопределить реализацию проверки попадания по умолчанию для выполнения собственных вычислений по проверке попадания.  
  
 На следующем рисунке показана связь между областью непрямоугольного объекта и его ограничивающим прямоугольником.  
  
 ![Допустимая область проверки попадания](../../../../docs/framework/wpf/graphics-multimedia/media/wcpsdk-mmgraphics-visuals-hittest-1.png "wcpsdk\_mmgraphics\_visuals\_hittest\_1")  
Допустимая область проверки попадания  
  
<a name="hit_testing_and_z-order"></a>   
## Проверка попадания и z\-порядок  
 На визуальном уровне в [!INCLUDE[TLA#tla_winclient](../../../../includes/tlasharptla-winclient-md.md)] поддерживается проверка попадания для всех объектов, расположенных под точкой или геометрическим объектом, а не только для объекта верхнего уровня.  Результаты возвращаются в виде [z\-порядка](GTMT).  Однако визуальный объект, передаваемый в качестве параметра для метода <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A>, определяет, для какой части [визуального дерева](GTMT) будет проведена проверка попадания.  Можно провести проверку попадания для всего визуального дерева или любой его части.  
  
 На следующем рисунке объект круг расположен поверх квадрата и треугольника.  Чтобы выполнить проверку попадания только для визуального объекта, имеющего максимальное значение [z\-порядка](GTMT), установите нумерацию проверки попадания визуальных объектов, чтобы возвращать <xref:System.Windows.Media.HitTestResultBehavior> из <xref:System.Windows.Media.HitTestResultCallback> для остановки прохождения проверки попадания после первого элемента.  
  
 ![Z&#45;порядок для визуального дерева](../../../../docs/framework/wpf/graphics-multimedia/media/wcpsdk-mmgraphics-visuals-hittest-2.png "wcpsdk\_mmgraphics\_visuals\_hittest\_2")  
Z\-порядок для визуального дерева  
  
 Если необходимо перечислить все визуальные объекты, расположенные под определенной точкой или геометрическим объектом, необходимо возвращать <xref:System.Windows.Media.HitTestResultBehavior> из <xref:System.Windows.Media.HitTestResultCallback>.  Это означает, что можно проводить проверку попадания для визуальных объектов, находящихся под другими объектами, даже если они полностью не видны.  Дополнительные сведения см. в примере кода в разделе "Использование обратного вызова результатов проверки попадания".  
  
> [!NOTE]
>  Для прозрачного визуального объекта также может быть проведена проверка попадания.  
  
<a name="using_default_hit_testing"></a>   
## Использование проверки попадания по умолчанию  
 Чтобы определить, расположена ли точка внутри визуального объекта, используйте метод <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A> для указания визуального объекта и значения координат точки, которые следует проверить.  Параметр визуального объекта определяет начальную точку в визуальном дереве для поиска при проверке попадания.  При обнаружении в визуальном дереве объекта, геометрическая форма которого включает координату, этот объект присваивается свойству <xref:System.Windows.Media.HitTestResult.VisualHit%2A> объекта <xref:System.Windows.Media.HitTestResult>.  После этого значение <xref:System.Windows.Media.HitTestResult> возвращается из метода <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A>.  Если точка не содержится в проверяемом визуальном поддереве, метод <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A> возвращает `null`.  
  
> [!NOTE]
>  Проверка попадания по умолчанию всегда возвращает самый верхний объект в [z\-порядке](GTMT).  Чтобы определить все визуальные объекты, включая те, которые могут быть частично или полностью закрыты, используйте обратный вызов результатов проверки попадания.  
  
 Значение координат, передаваемое как параметр точки для метода <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A>, должно задаваться относительно пространства координат визуального объекта, для которого выполняется проверка попадания.  Например, при наличии вложенных визуальных объектов, определенных в точке \(100, 100\) пространства координат родительского элемента проверка попадания дочернего визуального объекта в точке \(0, 0\) эквивалентна проверке попадания в точке \(100, 100\) пространства координат родительского элемента.  
  
 В следующем коде показана настройка обработчиков событий мыши для объекта <xref:System.Windows.UIElement>, применяемого для регистрации событий, которые используются для проверки попадания.  
  
 [!code-csharp[HitTestingOverview#100](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#100)]
 [!code-vb[HitTestingOverview#100](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#100)]  
  
### Влияние визуального дерева на проверку попадания  
 Начальная точка в визуальном дереве определяет, какие объекты возвращаются во время перечисления объектов проверки попадания.  Если проверка попадания проводится для нескольких объектов, визуальный объект, используемый в качестве начальной точки в визуальном дереве, должен быть общим предком всех проверяемых объектов.  Например, если необходимо проверить элемент "кнопка" и визуальный объект, представленные на следующем рисунке, в качестве начальной точки в визуальном дереве следует установить объект, являющийся общим предком для обоих элементов.  В этом случае элемент полотна является общим предком как для элемента "кнопка", так и для визуального объекта.  
  
 ![Иерархия визуального дерева](../../../../docs/framework/wpf/graphics-multimedia/media/wcpsdk-mmgraphics-visuals-overview-01.png "wcpsdk\_mmgraphics\_visuals\_overview\_01")  
Иерархия визуального дерева  
  
> [!NOTE]
>  В свойстве <xref:System.Windows.UIElement.IsHitTestVisible%2A> возвращается или устанавливается значение, которое определяет возможность возвращения производного от <xref:System.Windows.UIElement> объекта в качестве результата проверки попадания для некоторой части отображаемого содержимого.  Это позволяет выборочно изменять визуальное дерево, чтобы определить, какие визуальные объекты участвуют в проверке попадания.  
  
<a name="using_a_hit_test_result_callback"></a>   
## Использование обратного вызова результатов проверки попадания  
 Можно перечислить все визуальные объекты в визуальном дереве, геометрическая область которых включает заданное значение координат.  Это позволяет определить все визуальные объекты, включая те, которые могут быть частично или полностью закрыты другими визуальными объектами.  Для перечисления визуальных объектов в визуальном дереве используется метод <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A> с функцией обратного вызова проверки попадания.  Функция обратного вызова проверки попадания вызывается системой, когда заданное значение координат содержится в визуальном объекте.  
  
 Во время перечисления результатов проверки попадания не следует выполнять какие\-либо операции по изменению визуального дерева.  Добавление или удаление объектов визуального дерева во время его проверки может привести к непредсказуемому поведению.  Можно безопасно изменить визуальное дерево после возврата метода <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A>.  Возможно, потребуется предоставить структуру данных, такую как <xref:System.Collections.ArrayList>, для хранения значений во время перечисления результатов проверки попадания.  
  
 [!code-csharp[HitTestingOverview#101](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#101)]
 [!code-vb[HitTestingOverview#101](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#101)]  
  
 Метод обратного вызова проверки попадания определяет действия, которые выполняются при определении проверки попадания для конкретного визуального объекта в визуальном дереве.  После выполнения этих действий возвращается значение <xref:System.Windows.Media.HitTestResultBehavior>, которое определяет необходимость продолжения перечисления других визуальных объектов.  
  
 [!code-csharp[HitTestingOverview#102](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#102)]
 [!code-vb[HitTestingOverview#102](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#102)]  
  
> [!NOTE]
>  Перечисление визуальных объектов выполняется в соответствии с [z\-порядком](GTMT).  Визуальный объект с максимальным значением [z\-порядка](GTMT) является первым объектом в перечислении.  Остальные визуальные объекты перечисляются по убыванию значения [z\-порядка](GTMT).  Этот порядок перечисления соответствует порядку отрисовки визуальных объектов.  
  
 Чтобы остановить перечисление визуальных объектов в любое время, следует возвратить <xref:System.Windows.Media.HitTestResultBehavior> в функции обратного вызова.  
  
 [!code-csharp[HitTestingOverview#103](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#103)]
 [!code-vb[HitTestingOverview#103](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#103)]  
  
<a name="using_a_hit_test_filter_callback"></a>   
## Использование обратного вызова фильтра проверки попадания  
 Можно использовать необязательный фильтр проверки попадания для ограничения объектов, которые передаются в качестве результатов проверки попадания.  Это позволяет пропустить части визуального дерева, которые не нужно возвращать в результатах проверки попадания.  Чтобы реализовать фильтр проверки попадания, определите функцию обратного вызова фильтра проверки попадания и передайте ее в качестве значения параметра при вызове метода <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A>.  
  
 [!code-csharp[HitTestingOverview#104](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#104)]
 [!code-vb[HitTestingOverview#104](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#104)]  
  
 Если не требуется использовать необязательную функцию обратного вызова фильтра проверки попадания, передайте значение `null` в качестве параметра для метода <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A>.  
  
 [!code-csharp[HitTestingOverview#105](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#105)]
 [!code-vb[HitTestingOverview#105](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#105)]  
  
 ![Создание визуального дерева, используя фильтр проверки нажатия](../../../../docs/framework/wpf/graphics-multimedia/media/filteredvisualtree-01.png "FilteredVisualTree\_01")  
Упрощение визуального дерева  
  
 Функция обратного вызова фильтра проверки попадания позволяет перечислять все визуальные объекты, отображаемое содержимое которых содержит указанные координаты.  Однако может потребоваться пропуск некоторых ветвей визуального дерева, которые не нужно обрабатывать в функции обратного вызова результатов проверки попадания.  Возвращаемое значение функции обратного вызова фильтра проверки попадания определяет, какие действия следует предпринять при перечислении визуальных объектов.  Например, если возвращается значение <xref:System.Windows.Media.HitTestFilterBehavior>, можно удалить текущий визуальный объект и его дочерние элементы из перечисления результатов проверки попадания.  Это означает, что эти объекты будут недоступны в перечислении для функции обратного вызова результатов проверки попадания.  Упрощение визуального дерева объектов позволяет уменьшить объем обработки во время этапа перечисления результатов проверки попадания.  В следующем примере кода фильтр пропускает объекты меток и их потомки и проверяет все остальные объекты.  
  
 [!code-csharp[HitTestingOverview#106](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#106)]
 [!code-vb[HitTestingOverview#106](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#106)]  
  
> [!NOTE]
>  Обратный вызов фильтра проверки попадания иногда происходит в тех случаях, когда не произведен обратный вызов результатов проверки попадания.  
  
<a name="overriding_default_hit_testing"></a>   
## Переопределение проверки попадания по умолчанию  
 Чтобы переопределить поддержку проверки попадания по умолчанию для визуального объекта, переопределите метод <xref:System.Windows.Media.Visual.HitTestCore%2A>.  Это означает, что при вызове метода <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A> вызывается переопределенная реализация метода <xref:System.Windows.Media.Visual.HitTestCore%2A>.  Переопределенный метод вызывается при попадании в ограничивающий прямоугольник визуального объекта, даже если координата не попадает в отображаемое содержимое визуального объекта.  
  
 [!code-csharp[HitTestingOverview#107](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#107)]
 [!code-vb[HitTestingOverview#107](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#107)]  
  
 Может возникнуть необходимость проверки попадания и для ограничивающего прямоугольника, и для отображаемого содержимого визуального объекта.  Используя значение параметра `PointHitTestParameters` в переопределенном методе <xref:System.Windows.Media.Visual.HitTestCore%2A> в качестве параметра для базового метода <xref:System.Windows.Media.Visual.HitTestCore%2A>, можно выполнять действия в зависимости от попадания в ограничивающий прямоугольник визуального объекта, а затем выполнять повторную проверку попадания для отображаемого содержимого визуального объекта.  
  
 [!code-csharp[HitTestingOverview#108](../../../../samples/snippets/csharp/VS_Snippets_Wpf/HitTestingOverview/CSharp/Window1.xaml.cs#108)]
 [!code-vb[HitTestingOverview#108](../../../../samples/snippets/visualbasic/VS_Snippets_Wpf/HitTestingOverview/visualbasic/window1.xaml.vb#108)]  
  
## См. также  
 <xref:System.Windows.Media.VisualTreeHelper.HitTest%2A>   
 <xref:System.Windows.Media.HitTestResult>   
 <xref:System.Windows.Media.HitTestResultCallback>   
 <xref:System.Windows.Media.HitTestFilterCallback>   
 <xref:System.Windows.UIElement.IsHitTestVisible%2A>   
 [Hit Test Using DrawingVisuals Sample](http://go.microsoft.com/fwlink/?LinkID=159994)   
 [Hit Test with Win32 Interoperation Sample](http://go.microsoft.com/fwlink/?LinkID=159995)   
 [Геометрия проверки нажатия в визуальном объекте](../../../../docs/framework/wpf/graphics-multimedia/how-to-hit-test-geometry-in-a-visual.md)   
 [Проверка нажатия с помощью основного контейнера Win32](../../../../docs/framework/wpf/graphics-multimedia/how-to-hit-test-using-a-win32-host-container.md)