---
title: Маршалинг взаимодействия
ms.date: 03/30/2017
helpviewer_keywords:
- marshaling, COM interop
- interop marshaling
- interop marshaling, about interop marshaling
ms.assetid: 115f7a2f-d422-4605-ab36-13a8dd28142a
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: b7dbba5161c1eeecef41e93c908752410acbd956
ms.sourcegitcommit: 30e2fe5cc4165aa6dde7218ec80a13def3255e98
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2019
ms.locfileid: "56221255"
---
# <a name="interop-marshaling"></a><span data-ttu-id="93e0c-102">Маршалинг взаимодействия</span><span class="sxs-lookup"><span data-stu-id="93e0c-102">Interop Marshaling</span></span>
<a name="top"></a> <span data-ttu-id="93e0c-103">Маршалинг взаимодействия определяет, как данные передаются в аргументах и возвращаемых значениях методов между управляемой и неуправляемой памятью во время вызовов.</span><span class="sxs-lookup"><span data-stu-id="93e0c-103">Interop marshaling governs how data is passed in method arguments and return values between managed and unmanaged memory during calls.</span></span> <span data-ttu-id="93e0c-104">Маршалинг взаимодействия — это процесс времени выполнения, выполняемый службой маршалинга среды CLR.</span><span class="sxs-lookup"><span data-stu-id="93e0c-104">Interop marshaling is a run-time activity performed by the common language runtime's marshaling service.</span></span>  
  
 <span data-ttu-id="93e0c-105">Представление большинства типов данных является общим как в управляемой, так и в неуправляемой памяти.</span><span class="sxs-lookup"><span data-stu-id="93e0c-105">Most data types have common representations in both managed and unmanaged memory.</span></span> <span data-ttu-id="93e0c-106">Эти типы обрабатываются упаковщиком взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="93e0c-106">The interop marshaler handles these types for you.</span></span> <span data-ttu-id="93e0c-107">Другие типы могут иметь неоднозначное представление или могут вообще не быть представленными в управляемой памяти.</span><span class="sxs-lookup"><span data-stu-id="93e0c-107">Other types can be ambiguous or not represented at all in managed memory.</span></span>  
  
 <span data-ttu-id="93e0c-108">У неоднозначного типа может либо быть несколько представлений в неуправляемом коде, сопоставленных с одним управляемым типом, либо у него могут отсутствовать сведения о типе, такие как размер массива.</span><span class="sxs-lookup"><span data-stu-id="93e0c-108">An ambiguous type can have either multiple unmanaged representations that map to a single managed type, or missing type information, such as the size of an array.</span></span> <span data-ttu-id="93e0c-109">Для неоднозначных типов упаковщик обеспечивает представление по умолчанию и альтернативные представления, если существует несколько представлений.</span><span class="sxs-lookup"><span data-stu-id="93e0c-109">For ambiguous types, the marshaler provides a default representation and alternative representations where multiple representations exist.</span></span> <span data-ttu-id="93e0c-110">Упаковщику можно предоставить явные инструкции по маршалингу неоднозначного типа.</span><span class="sxs-lookup"><span data-stu-id="93e0c-110">You can supply explicit instructions to the marshaler on how it is to marshal an ambiguous type.</span></span>  
  
 <span data-ttu-id="93e0c-111">Обзор включает следующие разделы.</span><span class="sxs-lookup"><span data-stu-id="93e0c-111">This overview contains the following sections:</span></span>  
  
-   [<span data-ttu-id="93e0c-112">Вызов платформы и модели взаимодействия COM</span><span class="sxs-lookup"><span data-stu-id="93e0c-112">Platform Invoke and COM Interop Models</span></span>](#platform_invoke_and_com_interop_models)  
  
-   [<span data-ttu-id="93e0c-113">Маршалинг и подразделения COM</span><span class="sxs-lookup"><span data-stu-id="93e0c-113">Marshaling and COM Apartments</span></span>](#marshaling_and_com_apartments)  
  
-   [<span data-ttu-id="93e0c-114">Маршалинг удаленных вызовов</span><span class="sxs-lookup"><span data-stu-id="93e0c-114">Marshaling Remote Calls</span></span>](#marshaling_remote_calls)  
  
-   [<span data-ttu-id="93e0c-115">Связанные разделы</span><span class="sxs-lookup"><span data-stu-id="93e0c-115">Related Topics</span></span>](#related_topics)  
  
-   [<span data-ttu-id="93e0c-116">Ссылки</span><span class="sxs-lookup"><span data-stu-id="93e0c-116">Reference</span></span>](#reference)  
  
<a name="platform_invoke_and_com_interop_models"></a>   
## <a name="platform-invoke-and-com-interop-models"></a><span data-ttu-id="93e0c-117">Вызов неуправляемого кода и модели взаимодействия COM</span><span class="sxs-lookup"><span data-stu-id="93e0c-117">Platform Invoke and COM Interop Models</span></span>  
 <span data-ttu-id="93e0c-118">Среда CLR предоставляет два механизма взаимодействия с неуправляемым кодом.</span><span class="sxs-lookup"><span data-stu-id="93e0c-118">The common language runtime provides two mechanisms for interoperating with unmanaged code:</span></span>  
  
-   <span data-ttu-id="93e0c-119">Вызов неуправляемого кода, позволяющий управляемому коду вызывать функции, экспортированные из неуправляемой библиотеки.</span><span class="sxs-lookup"><span data-stu-id="93e0c-119">Platform invoke, which enables managed code to call functions exported from an unmanaged library.</span></span>  
  
-   <span data-ttu-id="93e0c-120">COM-взаимодействие, позволяющее управляемому коду взаимодействовать с COM-объектами с помощью интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="93e0c-120">COM interop, which enables managed code to interact with Component Object Model (COM) objects through interfaces.</span></span>  
  
 <span data-ttu-id="93e0c-121">И вызов неуправляемого кода, и COM-взаимодействие используют механизм маршалинга взаимодействия для точной передачи аргументов метода между вызываемым и вызывающим объектами и при необходимости обратно.</span><span class="sxs-lookup"><span data-stu-id="93e0c-121">Both platform invoke and COM interop use interop marshaling to accurately move method arguments between caller and callee and back, if required.</span></span> <span data-ttu-id="93e0c-122">Как показано на схеме ниже, за исключением использования [функций обратного вызова](callback-functions.md) метод вызова неуправляемого кода всегда вызывается в направлении от управляемого к неуправляемому коду, а не наоборот.</span><span class="sxs-lookup"><span data-stu-id="93e0c-122">As the following illustration shows, a platform invoke method call flows from managed to unmanaged code and never the other way, except when [callback functions](callback-functions.md) are involved.</span></span> <span data-ttu-id="93e0c-123">Хотя вызовы неуправляемого кода могут выполняться только от управляемого к неуправляемому коду, данные могут передаваться в обоих направлениях в виде параметров ввода или вывода.</span><span class="sxs-lookup"><span data-stu-id="93e0c-123">Even though platform invoke calls can flow only from managed to unmanaged code, data can flow in both directions as input or output parameters.</span></span> <span data-ttu-id="93e0c-124">Вызовы метода COM-взаимодействия могут проходить в обоих направлениях.</span><span class="sxs-lookup"><span data-stu-id="93e0c-124">COM interop method calls can flow in either direction.</span></span>  
  
 <span data-ttu-id="93e0c-125">![Вызов платформы](./media/interopmarshaling.png "interopmarshaling")</span><span class="sxs-lookup"><span data-stu-id="93e0c-125">![Platform invoke](./media/interopmarshaling.png "interopmarshaling")</span></span>  
<span data-ttu-id="93e0c-126">Поток вызовов неуправляемого кода и COM-взаимодействия</span><span class="sxs-lookup"><span data-stu-id="93e0c-126">Platform invoke and COM interop call flow</span></span>  
  
 <span data-ttu-id="93e0c-127">На самом нижнем уровне оба механизма используют одну и ту же службу маршалинга. Однако некоторые типы данных поддерживаются только COM-взаимодействием или только вызовом неуправляемого кода.</span><span class="sxs-lookup"><span data-stu-id="93e0c-127">At the lowest level, both mechanisms use the same interop marshaling service; however, certain data types are supported exclusively by COM interop or platform invoke.</span></span> <span data-ttu-id="93e0c-128">Подробнее см. в разделе [Характеристики маршалинга по умолчанию](default-marshaling-behavior.md).</span><span class="sxs-lookup"><span data-stu-id="93e0c-128">For details, see [Default Marshaling Behavior](default-marshaling-behavior.md).</span></span>  
  
 [<span data-ttu-id="93e0c-129">К началу</span><span class="sxs-lookup"><span data-stu-id="93e0c-129">Back to top</span></span>](#top)  
  
<a name="marshaling_and_com_apartments"></a>   
## <a name="marshaling-and-com-apartments"></a><span data-ttu-id="93e0c-130">Маршалинг и подразделения COM</span><span class="sxs-lookup"><span data-stu-id="93e0c-130">Marshaling and COM Apartments</span></span>  
 <span data-ttu-id="93e0c-131">Упаковщик взаимодействия маршалирует данные между кучей среды CLR и неуправляемой кучей.</span><span class="sxs-lookup"><span data-stu-id="93e0c-131">The interop marshaler marshals data between the common language runtime heap and the unmanaged heap.</span></span> <span data-ttu-id="93e0c-132">Маршалинг происходит всегда, когда вызывающий и вызываемый объекты не могут работать с одним и тем же экземпляром данных.</span><span class="sxs-lookup"><span data-stu-id="93e0c-132">Marshaling occurs whenever the caller and callee cannot operate on the same instance of data.</span></span> <span data-ttu-id="93e0c-133">Благодаря упаковщику взаимодействия вызывающий и вызываемый объекты могут считать, что они работают с одними и теми же данными, даже если каждый из них использует собственную их копию.</span><span class="sxs-lookup"><span data-stu-id="93e0c-133">The interop marshaler makes it possible for the caller and callee to appear to be operating on the same data even if they have their own copy of the data.</span></span>  
  
 <span data-ttu-id="93e0c-134">В COM также имеется упаковщик, который маршалирует данные между подразделениями COM или различными процессами COM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-134">COM also has a marshaler that marshals data between COM apartments or different COM processes.</span></span> <span data-ttu-id="93e0c-135">При вызове между управляемым и неуправляемым кодом в пределах одного подразделения COM задействуется только упаковщик взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="93e0c-135">When calling between managed and unmanaged code within the same COM apartment, the interop marshaler is the only marshaler involved.</span></span> <span data-ttu-id="93e0c-136">При вызове между управляемым и неуправляемым кодом в разных подразделениях COM или разных процессах задействуются и упаковщик взаимодействия, и упаковщик COM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-136">When calling between managed code and unmanaged code in a different COM apartment or a different process, both the interop marshaler and the COM marshaler are involved.</span></span>  
  
### <a name="com-clients-and-managed-servers"></a><span data-ttu-id="93e0c-137">Клиенты COM и управляемые серверы</span><span class="sxs-lookup"><span data-stu-id="93e0c-137">COM Clients and Managed Servers</span></span>  
 <span data-ttu-id="93e0c-138">Для экспортированного управляемого сервера с библиотекой типов, зарегистрированной с помощью [средства регистрации сборок (Regasm.exe)](../tools/regasm-exe-assembly-registration-tool.md), существует запись реестра `ThreadingModel` со значением `Both`.</span><span class="sxs-lookup"><span data-stu-id="93e0c-138">An exported managed server with a type library registered by the [Regasm.exe (Assembly Registration Tool)](../tools/regasm-exe-assembly-registration-tool.md) has a `ThreadingModel` registry entry set to `Both`.</span></span> <span data-ttu-id="93e0c-139">Это значение показывает, что данный сервер можно активировать как в однопотоковом подразделении (STA), так и в многопотоковом подразделении (MTA).</span><span class="sxs-lookup"><span data-stu-id="93e0c-139">This value indicates that the server can be activated in a single-threaded apartment (STA) or a multithreaded apartment (MTA).</span></span> <span data-ttu-id="93e0c-140">Как показано в таблице ниже, серверный объект создается в том же подразделении, что и вызывающий объект.</span><span class="sxs-lookup"><span data-stu-id="93e0c-140">The server object is created in the same apartment as its caller, as shown in the following table.</span></span>  
  
|<span data-ttu-id="93e0c-141">Клиент COM</span><span class="sxs-lookup"><span data-stu-id="93e0c-141">COM client</span></span>|<span data-ttu-id="93e0c-142">Сервер .NET</span><span class="sxs-lookup"><span data-stu-id="93e0c-142">.NET server</span></span>|<span data-ttu-id="93e0c-143">Требования к маршалингу</span><span class="sxs-lookup"><span data-stu-id="93e0c-143">Marshaling requirements</span></span>|  
|----------------|-----------------|-----------------------------|  
|<span data-ttu-id="93e0c-144">STA</span><span class="sxs-lookup"><span data-stu-id="93e0c-144">STA</span></span>|<span data-ttu-id="93e0c-145">`Both` становится STA.</span><span class="sxs-lookup"><span data-stu-id="93e0c-145">`Both` becomes STA.</span></span>|<span data-ttu-id="93e0c-146">Маршалинг в том же подразделении.</span><span class="sxs-lookup"><span data-stu-id="93e0c-146">Same-apartment marshaling.</span></span>|  
|<span data-ttu-id="93e0c-147">MTA</span><span class="sxs-lookup"><span data-stu-id="93e0c-147">MTA</span></span>|<span data-ttu-id="93e0c-148">`Both` становится MTA.</span><span class="sxs-lookup"><span data-stu-id="93e0c-148">`Both` becomes MTA.</span></span>|<span data-ttu-id="93e0c-149">Маршалинг в том же подразделении.</span><span class="sxs-lookup"><span data-stu-id="93e0c-149">Same-apartment marshaling.</span></span>|  
  
 <span data-ttu-id="93e0c-150">Так как клиент и сервер находятся в одном и том же подразделении, служба маршалинга взаимодействия автоматически обрабатывает все маршалируемые данные.</span><span class="sxs-lookup"><span data-stu-id="93e0c-150">Because the client and server are in the same apartment, the interop marshaling service automatically handles all data marshaling.</span></span> <span data-ttu-id="93e0c-151">На рисунке ниже показана работа службы маршалинга взаимодействия между управляемой и неуправляемой кучами в одном и том же подразделении стиля COM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-151">The following illustration shows the interop marshaling service operating between managed and unmanaged heaps within the same COM-style apartment.</span></span>  
  
 <span data-ttu-id="93e0c-152">![Маршалинг взаимодействия](./media/interopheap.gif "interopheap")</span><span class="sxs-lookup"><span data-stu-id="93e0c-152">![Interop marshaling](./media/interopheap.gif "interopheap")</span></span>  
<span data-ttu-id="93e0c-153">Процесс маршалинга в одном и том же подразделении</span><span class="sxs-lookup"><span data-stu-id="93e0c-153">Same-apartment marshaling process</span></span>  
  
 <span data-ttu-id="93e0c-154">Если планируется экспортировать управляемый сервер, учтите, что клиент COM определяет подразделение сервера.</span><span class="sxs-lookup"><span data-stu-id="93e0c-154">If you plan to export a managed server, be aware that the COM client determines the apartment of the server.</span></span> <span data-ttu-id="93e0c-155">Управляемый сервер, вызванный клиентом COM, инициализированным в многопотоковом подразделении, должен обеспечить потокобезопасность.</span><span class="sxs-lookup"><span data-stu-id="93e0c-155">A managed server called by a COM client initialized in an MTA must ensure thread safety.</span></span>  
  
### <a name="managed-clients-and-com-servers"></a><span data-ttu-id="93e0c-156">Управляемые клиенты и COM-серверы</span><span class="sxs-lookup"><span data-stu-id="93e0c-156">Managed Clients and COM Servers</span></span>  
 <span data-ttu-id="93e0c-157">По умолчанию для управляемого клиента используется многопотоковое подразделение, однако тип приложения клиента .NET может изменить эту настройку.</span><span class="sxs-lookup"><span data-stu-id="93e0c-157">The default setting for managed client apartments is MTA; however, the application type of the .NET client can change the default setting.</span></span> <span data-ttu-id="93e0c-158">Например, настройкой для подразделения клиента [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] является однопотоковое подразделение.</span><span class="sxs-lookup"><span data-stu-id="93e0c-158">For example, a [!INCLUDE[vbprvblong](../../../includes/vbprvblong-md.md)] client apartment setting is STA.</span></span> <span data-ttu-id="93e0c-159">Для проверки и изменения настройки подразделения для управляемого клиента можно использовать атрибут <xref:System.STAThreadAttribute?displayProperty=nameWithType>, атрибут <xref:System.MTAThreadAttribute?displayProperty=nameWithType>, свойство <xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType> или свойство <xref:System.Web.UI.Page.AspCompatMode%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="93e0c-159">You can use the <xref:System.STAThreadAttribute?displayProperty=nameWithType>, the <xref:System.MTAThreadAttribute?displayProperty=nameWithType>, the <xref:System.Threading.Thread.ApartmentState%2A?displayProperty=nameWithType> property, or the <xref:System.Web.UI.Page.AspCompatMode%2A?displayProperty=nameWithType> property to examine and change the apartment setting of a managed client.</span></span>  
  
 <span data-ttu-id="93e0c-160">Автор компонента настраивает сходство потоков COM-сервера.</span><span class="sxs-lookup"><span data-stu-id="93e0c-160">The author of the component sets the thread affinity of a COM server.</span></span> <span data-ttu-id="93e0c-161">В таблице ниже показаны сочетания параметров подразделения для клиентов .NET и COM-серверов.</span><span class="sxs-lookup"><span data-stu-id="93e0c-161">The following table shows the combinations of apartment settings for .NET clients and COM servers.</span></span> <span data-ttu-id="93e0c-162">Для этих сочетаний также показаны итоговые требования к маршалингу.</span><span class="sxs-lookup"><span data-stu-id="93e0c-162">It also shows the resulting marshaling requirements for the combinations.</span></span>  
  
|<span data-ttu-id="93e0c-163">Клиент .NET</span><span class="sxs-lookup"><span data-stu-id="93e0c-163">.NET client</span></span>|<span data-ttu-id="93e0c-164">COM-сервер</span><span class="sxs-lookup"><span data-stu-id="93e0c-164">COM server</span></span>|<span data-ttu-id="93e0c-165">Требования к маршалингу</span><span class="sxs-lookup"><span data-stu-id="93e0c-165">Marshaling requirements</span></span>|  
|-----------------|----------------|-----------------------------|  
|<span data-ttu-id="93e0c-166">MTA (по умолчанию)</span><span class="sxs-lookup"><span data-stu-id="93e0c-166">MTA (default)</span></span>|<span data-ttu-id="93e0c-167">MTA</span><span class="sxs-lookup"><span data-stu-id="93e0c-167">MTA</span></span><br /><br /> <span data-ttu-id="93e0c-168">STA</span><span class="sxs-lookup"><span data-stu-id="93e0c-168">STA</span></span>|<span data-ttu-id="93e0c-169">Маршалинг взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="93e0c-169">Interop marshaling.</span></span><br /><br /> <span data-ttu-id="93e0c-170">Маршалинг взаимодействия и маршалинг COM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-170">Interop and COM marshaling.</span></span>|  
|<span data-ttu-id="93e0c-171">STA</span><span class="sxs-lookup"><span data-stu-id="93e0c-171">STA</span></span>|<span data-ttu-id="93e0c-172">MTA</span><span class="sxs-lookup"><span data-stu-id="93e0c-172">MTA</span></span><br /><br /> <span data-ttu-id="93e0c-173">STA</span><span class="sxs-lookup"><span data-stu-id="93e0c-173">STA</span></span>|<span data-ttu-id="93e0c-174">Маршалинг взаимодействия и маршалинг COM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-174">Interop and COM marshaling.</span></span><br /><br /> <span data-ttu-id="93e0c-175">Маршалинг взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="93e0c-175">Interop marshaling.</span></span>|  
  
 <span data-ttu-id="93e0c-176">Когда управляемый клиент и неуправляемый сервер находятся в одном и том же подразделении, служба маршалинга взаимодействия обрабатывает все маршалируемые данные.</span><span class="sxs-lookup"><span data-stu-id="93e0c-176">When a managed client and unmanaged server are in the same apartment, the interop marshaling service handles all data marshaling.</span></span> <span data-ttu-id="93e0c-177">Но если клиент и сервер инициализированы в разных подразделениях, также требуется маршалинг COM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-177">However, when client and server are initialized in different apartments, COM marshaling is also required.</span></span> <span data-ttu-id="93e0c-178">На схеме ниже показаны элементы вызова между подразделениями.</span><span class="sxs-lookup"><span data-stu-id="93e0c-178">The following illustration shows the elements of a cross-apartment call.</span></span>  
  
 <span data-ttu-id="93e0c-179">![Маршалинг COM](./media/singleprocessmultapt.gif "singleprocessmultapt")</span><span class="sxs-lookup"><span data-stu-id="93e0c-179">![COM marshaling](./media/singleprocessmultapt.gif "singleprocessmultapt")</span></span>  
<span data-ttu-id="93e0c-180">Вызов между клиентом .NET и COM-объектом, находящимися в разных подразделениях</span><span class="sxs-lookup"><span data-stu-id="93e0c-180">Cross-apartment call between a .NET client and COM object</span></span>  
  
 <span data-ttu-id="93e0c-181">Для маршалинга между подразделениями можно выполнить следующее:</span><span class="sxs-lookup"><span data-stu-id="93e0c-181">For cross-apartment marshaling, you can do the following:</span></span>  
  
-   <span data-ttu-id="93e0c-182">Согласиться на дополнительные издержки маршалинга между подразделениями, которые становятся заметными только в случае, когда границу пересекает много вызовов.</span><span class="sxs-lookup"><span data-stu-id="93e0c-182">Accept the overhead of the cross-apartment marshaling, which is noticeable only when there are many calls across the boundary.</span></span> <span data-ttu-id="93e0c-183">Чтобы вызовы успешно пересекали границу подразделения, необходимо зарегистрировать библиотеку типов COM-компонента.</span><span class="sxs-lookup"><span data-stu-id="93e0c-183">You must register the type library of the COM component for calls to successfully cross the apartment boundary.</span></span>  
  
-   <span data-ttu-id="93e0c-184">Изменить основной поток, выбрав для клиентского потока однопотоковое или многопотоковое подразделение.</span><span class="sxs-lookup"><span data-stu-id="93e0c-184">Alter the main thread by setting the client thread to STA or MTA.</span></span> <span data-ttu-id="93e0c-185">Например, если клиент C# вызывает много COM-компонентов однопотоковых подразделений, можно избежать маршалинга между подразделениями, задав для основного потока однопотоковое подразделение.</span><span class="sxs-lookup"><span data-stu-id="93e0c-185">For example, if your C# client calls many STA COM components, you can avoid cross-apartment marshaling by setting the main thread to STA.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="93e0c-186">Как только для потока клиента C# задается однопотоковое подразделение, для вызова COM-компонентов многопотоковых подразделений потребуется маршалинг между подразделениями.</span><span class="sxs-lookup"><span data-stu-id="93e0c-186">Once the thread of a C# client is set to STA, calls to MTA COM components will require cross-apartment marshaling.</span></span>  
  
 <span data-ttu-id="93e0c-187">Инструкции по выбору модели подразделения в явном виде см. в разделе [Управляемые и неуправляемые потоки](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/5s8ee185(v=vs.100)).</span><span class="sxs-lookup"><span data-stu-id="93e0c-187">For instructions on explicitly selecting an apartment model, see [Managed and Unmanaged Threading](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/5s8ee185(v=vs.100)).</span></span>  
  
 [<span data-ttu-id="93e0c-188">К началу</span><span class="sxs-lookup"><span data-stu-id="93e0c-188">Back to top</span></span>](#top)  
  
<a name="marshaling_remote_calls"></a>   
## <a name="marshaling-remote-calls"></a><span data-ttu-id="93e0c-189">Маршалинг удаленных вызовов</span><span class="sxs-lookup"><span data-stu-id="93e0c-189">Marshaling Remote Calls</span></span>  
 <span data-ttu-id="93e0c-190">При маршалинге между подразделениями маршалинг COM используется в каждом вызове между управляемым и неуправляемым кодом, если объекты находятся в отдельных процессах.</span><span class="sxs-lookup"><span data-stu-id="93e0c-190">As with cross-apartment marshaling, COM marshaling is involved in each call between managed and unmanaged code whenever the objects reside in separate processes.</span></span> <span data-ttu-id="93e0c-191">Например:</span><span class="sxs-lookup"><span data-stu-id="93e0c-191">For example:</span></span>  
  
-   <span data-ttu-id="93e0c-192">Клиент COM, обращающийся к управляемому серверу на удаленном компьютере, использует DCOM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-192">A COM client that invokes a managed server on a remote host uses distributed COM (DCOM).</span></span>  
  
-   <span data-ttu-id="93e0c-193">Управляемый клиент, обращающийся к СОМ-серверу на удаленном компьютере, использует DCOM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-193">A managed client that invokes a COM server on a remote host uses DCOM.</span></span>  
  
 <span data-ttu-id="93e0c-194">На схеме ниже показано, как маршалинг взаимодействия и маршалинг COM обеспечивают каналы связи через границы между процессами и узлами.</span><span class="sxs-lookup"><span data-stu-id="93e0c-194">The following illustration shows how interop marshaling and COM marshaling provide communications channels across process and host boundaries.</span></span>  
  
 <span data-ttu-id="93e0c-195">![Маршалинг COM](./media/interophost.gif "interophost")</span><span class="sxs-lookup"><span data-stu-id="93e0c-195">![COM marshaling](./media/interophost.gif "interophost")</span></span>  
<span data-ttu-id="93e0c-196">Маршалинг между процессами</span><span class="sxs-lookup"><span data-stu-id="93e0c-196">Cross-process marshaling</span></span>  
  
### <a name="preserving-identity"></a><span data-ttu-id="93e0c-197">Сохранение идентификаторов</span><span class="sxs-lookup"><span data-stu-id="93e0c-197">Preserving Identity</span></span>  
 <span data-ttu-id="93e0c-198">Среда CLR сохраняет идентификаторы управляемых и неуправляемых ссылок.</span><span class="sxs-lookup"><span data-stu-id="93e0c-198">The common language runtime preserves the identity of managed and unmanaged references.</span></span> <span data-ttu-id="93e0c-199">На схеме ниже показан поток прямых неуправляемых ссылок (верхняя строка) и прямых управляемых ссылок (нижняя строка) через границы между процессами и узлами.</span><span class="sxs-lookup"><span data-stu-id="93e0c-199">The following illustration shows the flow of direct unmanaged references (top row) and direct managed references (bottom row) across process and host boundaries.</span></span>  
  
 <span data-ttu-id="93e0c-200">![Вызываемая оболочка COM и вызываемая оболочка во время выполнения](./media/interopdirectref.gif "interopdirectref")</span><span class="sxs-lookup"><span data-stu-id="93e0c-200">![COM callable wrapper and runtime callable wrapper](./media/interopdirectref.gif "interopdirectref")</span></span>  
<span data-ttu-id="93e0c-201">Передача ссылок через границы между процессами и узлами</span><span class="sxs-lookup"><span data-stu-id="93e0c-201">Reference passing across process and host boundaries</span></span>  
  
 <span data-ttu-id="93e0c-202">На этой схеме:</span><span class="sxs-lookup"><span data-stu-id="93e0c-202">In this illustration:</span></span>  
  
-   <span data-ttu-id="93e0c-203">Неуправляемый клиент получает ссылку на COM-объект от управляемого объекта, получившего эту ссылку от удаленного узла.</span><span class="sxs-lookup"><span data-stu-id="93e0c-203">An unmanaged client gets a reference to a COM object from a managed object that gets this reference from a remote host.</span></span> <span data-ttu-id="93e0c-204">Механизмом удаленного взаимодействия является DCOM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-204">The remoting mechanism is DCOM.</span></span>  
  
-   <span data-ttu-id="93e0c-205">Управляемый клиент получает ссылку на управляемый объект от COM-объекта, получившего эту ссылку от удаленного узла.</span><span class="sxs-lookup"><span data-stu-id="93e0c-205">A managed client gets a reference to a managed object from a COM object that gets this reference from a remote host.</span></span> <span data-ttu-id="93e0c-206">Механизмом удаленного взаимодействия является DCOM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-206">The remoting mechanism is DCOM.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="93e0c-207">Экспортированная библиотека типов управляемого сервера должна быть зарегистрирована.</span><span class="sxs-lookup"><span data-stu-id="93e0c-207">The exported type library of the managed server must be registered.</span></span>  
  
 <span data-ttu-id="93e0c-208">Число границ процессов между вызывающим и вызываемым объектами несущественно; одни и те же прямые ссылки используются для вызовов, входящих в процессы и исходящих из них.</span><span class="sxs-lookup"><span data-stu-id="93e0c-208">The number of process boundaries between caller and callee is irrelevant; the same direct referencing occurs for in-process and out-of-process calls.</span></span>  
  
### <a name="managed-remoting"></a><span data-ttu-id="93e0c-209">Управляемое удаленное взаимодействие</span><span class="sxs-lookup"><span data-stu-id="93e0c-209">Managed Remoting</span></span>  
 <span data-ttu-id="93e0c-210">Среда выполнения также обеспечивает управляемое удаленное взаимодействие, которое можно использовать для установления канала связи между управляемыми объектами через границы между процессами и узлами.</span><span class="sxs-lookup"><span data-stu-id="93e0c-210">The runtime also provides managed remoting, which you can use to establish a communications channel between managed objects across process and host boundaries.</span></span> <span data-ttu-id="93e0c-211">Управляемое удаленное взаимодействие может предусматривать брандмауэр между связывающимися друг с другом компонентами, как показано на схеме ниже.</span><span class="sxs-lookup"><span data-stu-id="93e0c-211">Managed remoting can accommodate a firewall between the communicating components, as the following illustration shows.</span></span>  
  
 <span data-ttu-id="93e0c-212">![SOAP или TcpChannel](./media/interopremotesoap.gif "interopremotesoap")</span><span class="sxs-lookup"><span data-stu-id="93e0c-212">![SOAP or TcpChannel](./media/interopremotesoap.gif "interopremotesoap")</span></span>  
<span data-ttu-id="93e0c-213">Удаленные вызовы через брандмауэры с использованием SOAP или класса TcpChannel</span><span class="sxs-lookup"><span data-stu-id="93e0c-213">Remote calls across firewalls using SOAP or the TcpChannel class</span></span>  
  
 <span data-ttu-id="93e0c-214">Некоторые неуправляемые вызовы, например вызовы между обслуживаемыми COM-компонентами, могут проводиться через SOAP.</span><span class="sxs-lookup"><span data-stu-id="93e0c-214">Some unmanaged calls can be channeled through SOAP, such as the calls between serviced components and COM.</span></span>  
  
 [<span data-ttu-id="93e0c-215">К началу</span><span class="sxs-lookup"><span data-stu-id="93e0c-215">Back to top</span></span>](#top)  
  
<a name="related_topics"></a>   
## <a name="related-topics"></a><span data-ttu-id="93e0c-216">См. также</span><span class="sxs-lookup"><span data-stu-id="93e0c-216">Related Topics</span></span>  
  
|<span data-ttu-id="93e0c-217">Заголовок</span><span class="sxs-lookup"><span data-stu-id="93e0c-217">Title</span></span>|<span data-ttu-id="93e0c-218">Описание</span><span class="sxs-lookup"><span data-stu-id="93e0c-218">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="93e0c-219">Характеристики маршалинга по умолчанию</span><span class="sxs-lookup"><span data-stu-id="93e0c-219">Default Marshaling Behavior</span></span>](default-marshaling-behavior.md)|<span data-ttu-id="93e0c-220">Описываются правила, используемые службой маршалинга взаимодействия для маршалинга данных.</span><span class="sxs-lookup"><span data-stu-id="93e0c-220">Describes the rules that the interop marshaling service uses to marshal data.</span></span>|  
|[<span data-ttu-id="93e0c-221">Маршалинг данных при вызове неуправляемого кода</span><span class="sxs-lookup"><span data-stu-id="93e0c-221">Marshaling Data with Platform Invoke</span></span>](marshaling-data-with-platform-invoke.md)|<span data-ttu-id="93e0c-222">Описывается способ объявления параметров метода и передачи аргументов в функции, экспортируемые неуправляемыми библиотеками.</span><span class="sxs-lookup"><span data-stu-id="93e0c-222">Describes how to declare method parameters and pass arguments to functions exported by unmanaged libraries.</span></span>|  
|[<span data-ttu-id="93e0c-223">Маршалинг с помощью COM- взаимодействия</span><span class="sxs-lookup"><span data-stu-id="93e0c-223">Marshaling Data with COM Interop</span></span>](marshaling-data-with-com-interop.md)|<span data-ttu-id="93e0c-224">Описывается настройка оболочек COM для изменения характеристик маршалинга.</span><span class="sxs-lookup"><span data-stu-id="93e0c-224">Describes how to customize COM wrappers to alter marshaling behavior.</span></span>|  
|[<span data-ttu-id="93e0c-225">Практическое руководство. Миграция DCOM с управляемым кодом в WCF</span><span class="sxs-lookup"><span data-stu-id="93e0c-225">How to: Migrate Managed-Code DCOM to WCF</span></span>](how-to-migrate-managed-code-dcom-to-wcf.md)|<span data-ttu-id="93e0c-226">Описывается переход с модели DCOM на WCF.</span><span class="sxs-lookup"><span data-stu-id="93e0c-226">Describes how to migrate from DCOM to WCF.</span></span>|  
|[<span data-ttu-id="93e0c-227">Практическое руководство. Сопоставление значений HRESULT и исключений</span><span class="sxs-lookup"><span data-stu-id="93e0c-227">How to: Map HRESULTs and Exceptions</span></span>](how-to-map-hresults-and-exceptions.md)|<span data-ttu-id="93e0c-228">Описывается, как сопоставить настраиваемые исключения со значениями HRESULT, и приводится полный перечень сопоставлений значений HRESULT с соответствующими классами исключений платформы .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="93e0c-228">Describes how to map custom exceptions to HRESULTs and provides the complete mapping from each HRESULT to its comparable exception class in the .NET Framework.</span></span>|  
|<span data-ttu-id="93e0c-229">[Взаимодействие с помощью универсальных типов](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ms229590(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="93e0c-229">[Interoperating Using Generic Types](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ms229590(v=vs.100))</span></span>|<span data-ttu-id="93e0c-230">Описываются действия, поддерживаемые при использовании универсальных типов для взаимодействия COM.</span><span class="sxs-lookup"><span data-stu-id="93e0c-230">Describes which actions are supported when using generic types for COM interoperability.</span></span>|  
|[<span data-ttu-id="93e0c-231">Взаимодействие с неуправляемым кодом</span><span class="sxs-lookup"><span data-stu-id="93e0c-231">Interoperating with Unmanaged Code</span></span>](index.md)|<span data-ttu-id="93e0c-232">Описываются службы взаимодействия, предоставляемые средой CLR.</span><span class="sxs-lookup"><span data-stu-id="93e0c-232">Describes interoperability services provided by the common language runtime.</span></span>|  
|<span data-ttu-id="93e0c-233">[Расширенное COM-взаимодействие](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/bd9cdfyx(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="93e0c-233">[Advanced COM Interoperability](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/bd9cdfyx(v=vs.100))</span></span>|<span data-ttu-id="93e0c-234">Приводятся ссылки на дополнительные сведения о включении COM-компонентов в разрабатываемое приложение .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="93e0c-234">Provides links to more information about incorporating COM components into your .NET Framework application.</span></span>|  
|<span data-ttu-id="93e0c-235">[Вопросы разработки для взаимодействия](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/61aax4kh(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="93e0c-235">[Design Considerations for Interoperation](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/61aax4kh(v=vs.100))</span></span>|<span data-ttu-id="93e0c-236">Приводятся советы по написанию кода встроенных COM-компонентов.</span><span class="sxs-lookup"><span data-stu-id="93e0c-236">Provides tips for writing integrated COM components.</span></span>|  
  
 [<span data-ttu-id="93e0c-237">К началу</span><span class="sxs-lookup"><span data-stu-id="93e0c-237">Back to top</span></span>](#top)  
  
<a name="reference"></a>   
## <a name="reference"></a><span data-ttu-id="93e0c-238">Ссылка</span><span class="sxs-lookup"><span data-stu-id="93e0c-238">Reference</span></span>  
 <xref:System.Runtime.InteropServices?displayProperty=nameWithType>  
  
 [<span data-ttu-id="93e0c-239">К началу</span><span class="sxs-lookup"><span data-stu-id="93e0c-239">Back to top</span></span>](#top)
