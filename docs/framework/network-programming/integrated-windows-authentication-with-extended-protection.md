---
title: "Встроенная аутентификация Windows с расширенной защитой | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework"
ms.reviewer: ""
ms.suite: ""
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
  - "C++"
  - "jsharp"
ms.assetid: 81731998-d5e7-49e4-ad38-c8e6d01689d0
caps.latest.revision: 13
author: "mcleblanc"
ms.author: "markl"
manager: "markl"
caps.handback.revision: 13
---
# Встроенная аутентификация Windows с расширенной защитой
Усовершенствования выполненных этим аффектом как встроенная проверка подлинности Windows, которым регулируется <xref:System.Net.HttpWebRequest>, <xref:System.Net.HttpListener>, <xref:System.Net.Mail.SmtpClient>, <xref:System.Net.Security.SslStream>, <xref:System.Net.Security.NegotiateStream> и связанные классы в <xref:System.Net> и связанные пространствами имен.  Поддержка была добавлена для расширенной защиты для повышения безопасности.  
  
 Эти изменения могут повлиять на приложения, которые используют эти классы для выполнения запросов через интернет и получить ответы, где встроенная проверка подлинности Windows используется.  Эта сменная изменить также влияет на веб\-сервере, и клиентские приложения, настроитьы для использования встроенной проверки подлинности Windows.  
  
 Эти изменения могут повлиять на приложения, которые используют эти классы для выполнения других типов запросов и получить ответы, где встроенная проверка подлинности Windows используется.  
  
 Изменения для поддержки расширенной защиты доступны только для приложений Windows 7 и Windows Server 2008 R2.  Расширенные функции защиты недоступны в более ранних версиях Windows.  
  
## Общие сведения  
 Конструкция встроенной проверки подлинности Windows позволяет некоторым запросам учетных данных быть универсальными, что означает, что их можно использовать повторно или пересылать.  Ответы возможности должны быть построены как минимум с данными целевого объекта, определенный и лучше также с некоторыми данными, характерной для канала.  Службы могут обеспечить расширенную защиту, чтобы убедиться, что ответы возможности учетных данных содержат данные службы, определенные в качестве имени участника\-службы \(spn\).  Располагая этими сведениями в обменах учетных данных служб могут лучше защищать от злостой использования ответов возможности учетных данных, которые могут быть использованы неправильно.  
  
 Расширенная конструкция защиты улучшение к протоколам проверки подлинности конструированным, чтобы избежать атак relay проверки подлинности.  Она вращается вокруг понятия данных о привязке канала и службы.  
  
 Общие назначения следующие:  
  
1.  Если клиент обновления для поддержки расширенной защиты приложения должны предоставлять данные о привязке канала и привязки служб для всех поддерживаемых протоколов проверки подлинности.  Данные о привязке канала можно указать только если канал \(TLS\) для привязки.  Привязка данных службы должны всегда быть переданы.  
  
2.  Обновленные серверы, правильно настроитьы могут проверять данные о привязке канала и службы, когда они присутствуют в токене проверки подлинности клиента и отмене попытки проверки подлинности, если привязки канала не совпадают.  В зависимости от сценария развертывания серверы могут проверять привязку канала, привязка службы или то и другое.  
  
3.  Обновленные серверы имеют возможность принимать или отклонять запросы клиентов вниз\- уровня, которые не содержат данные о привязке канала на основе политики.  
  
 Сведения, используемые расширенной защитой состоит из одной или обеих из следующих частей: 2  
  
1.  Токен или cbt привязки канала.  
  
2.  Данные привязки службы в форме имени участника\-службы или имя участника\-службы.  
  
 Данные привязки службы указание назначения для проверки подлинности клиента к конкретной конечной точке службы.  Она связана с клиента на сервер со следующими свойствами.  
  
-   Значение имени участника\-службы должно быть доступны для сервера при проверке подлинности клиента в форме открытого текста.  
  
-   Значение имени участника\-службы public.  
  
-   Имя участника\-службы должно криптографически защиты при передаче те, что атака " злоумышленник в середине " не может вставлять, удалять или изменять ее значение.  
  
 Cbt свойство внешнего безопасного канала \(TLS\), используемого для связи \(привязка\) его к диалогу через внутренним, прошедшим проверку подлинности клиент\- каналом.  Cbt должно иметь следующие свойства \(также указанные стандарте IETF RFC 5056\):  
  
-   Если внешнего канала существует, значение cbt, то должно быть свойством внешнего канала или конечная точка сервера, независимо приезжанная и клиента и на стороне сервера диалога.  
  
-   Значение cbt, отправленного клиентом не должно иметь что\-то злоумышленник может повлиять на.  
  
-   Гарантии не вносятся о засекреченности значения cbt.  Однако это не означает, что значение привязки данных службы, а также привязки канала всегда может быть расмотрено любым другим но сервером, выполняющего проверку подлинности, например протокол, содержащим cbt может зашифровать его.  
  
-   Cbt должно быть криптографически целостностью, включаться защищенной при передаче те, что злоумышленник не может вставлять, удалять или изменять ее значение.  
  
 Привязка канала выполняется клиентом при передаче имени участника\-службы и cbt на сервер в tamperproof образом.  Сервер проверяет данные о привязке канала в соответствии с своей политикой и отклоняет попытки проверки подлинности, для которых не которое предположительно, предназначенным целевым объектом.  Этот способ \- 2 каналов становится привязанным криптографически.  
  
 Чтобы сохранить совместимость с существующими клиентами и приложениями, сервер может быть настроен для включения попытки проверки подлинности клиентами, которые еще не поддерживают расширенную защиту.  Это называется "частично затвердел" конфигурацию, в отличие от "полностью затвердетой" конфигурации.  
  
 Несколько компонентов в <xref:System.Net> и пространства имен <xref:System.Net.Security> выполняют встроенную проверку подлинности Windows, имя вызывающего приложения.  Этот раздел описывает изменения к компонентам System.Net для добавления расширенная защита в их использование встроенной проверки подлинности Windows.  
  
 Расширенная защита в настоящее время поддерживается в Windows 7.  Механизм предоставляется поэтому приложение может определить если операционная система поддерживает расширенную защиту.  
  
## Изменения для поддержки расширенной защиты  
 Процесс проверки подлинности, используемый с интегрированной проверкой подлинности Windows, в зависимости от используемого протокола проверки подлинности, часто включает в себя возможность выданную конечным компьютером и отправленную обратно клиентскому компьютеру.  Расширенная защита добавляет новых функций к этому процессу проверки подлинности  
  
 Пространство имен <xref:System.Security.Authentication.ExtendedProtection> обеспечивает поддержку проверки подлинности с помощью расширенной защиты приложений.  Класс <xref:System.Security.Authentication.ExtendedProtection.ChannelBinding> в этом пространстве имен, представляющий привязку канала.  Класс <xref:System.Security.Authentication.ExtendedProtection.ExtendedProtectionPolicy> в этом пространстве имен, представляющее расширенную политику защиты, используемая сервером для проверки входящих подключений клиента.  Другие члены класса используются с расширенной защитой.  
  
 Для серверных приложений эти классы включают следующее:  
  
 <xref:System.Security.Authentication.ExtendedProtection.ExtendedProtectionPolicy>, имеет следующие элементы:  
  
-   Свойство <xref:System.Security.Authentication.ExtendedProtection.ExtendedProtectionPolicy.OSSupportsExtendedProtection%2A>, показывающее, поддерживает ли операционная система встроенную проверку подлинности windows с расширенной защитой.  
  
-   Значение <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement>, которое указывает, когда следует применять расширенную политику защиты.  
  
-   Значение <xref:System.Security.Authentication.ExtendedProtection.ProtectionScenario>, указывающее скрипт развертывания.  Это влияния, как расширенная защита проверена.  
  
-   Необязательно <xref:System.Security.Authentication.ExtendedProtection.ServiceNameCollection>, содержащий список пользовательских имен участников\-служб, который используется для сопоставления с spn, предоставленное клиентом как предполагаемого целевой объект проверки подлинности.  
  
-   Необязательно <xref:System.Security.Authentication.ExtendedProtection.ChannelBinding>, содержащий пользовательскую привязку канала, используемый для проверки.  Этот сценарий не общего варианта  
  
 Пространство имен <xref:System.Security.Authentication.ExtendedProtection.Configuration> обеспечивает поддержку настройки проверки подлинности с помощью расширенной защиты приложений.  
  
 Некоторые изменения функции были изменены для поддержки расширенной защиты в существующем пространстве имен <xref:System.Net>.  Эти изменения относятся:  
  
-   Новый класс <xref:System.Net.TransportContext>, добавленное в <xref:System.Net> пространство имен, которое представляет контекст транспорта.  
  
-   Новое <xref:System.Net.HttpWebRequest.EndGetRequestStream%2A> и методы перегрузки <xref:System.Net.HttpWebRequest.GetRequestStream%2A> в <xref:System.Net.HttpWebRequest> классифицируют, позволяющие получить <xref:System.Net.TransportContext> для поддержки расширенной защиты для клиентских приложений.  
  
-   Добавление к классам <xref:System.Net.HttpListener> и <xref:System.Net.HttpListenerRequest> для поддержки серверных приложений.  
  
 Изменение функции было сделано для поддержки расширенной защиты для клиентских приложений SMTP в существующем пространстве имен <xref:System.Net.Mail>:  
  
-   Свойство <xref:System.Net.Mail.SmtpClient.TargetName%2A> в классе <xref:System.Net.Mail.SmtpClient>, представляющий имя участника\-службы \(spn\) для проверки подлинности при использовании расширенной защиты для клиентских приложений SMTP.  
  
 Некоторые изменения функции были изменены для поддержки расширенной защиты в существующем пространстве имен <xref:System.Net.Security>.  Эти изменения относятся:  
  
-   Новое <xref:System.Net.Security.NegotiateStream.BeginAuthenticateAsClient%2A> и методы перегрузки <xref:System.Net.Security.NegotiateStream.AuthenticateAsClient%2A> в <xref:System.Net.Security.NegotiateStream> классифицируют, которые допускают передачи cbt для поддержки расширенной защиты для клиентских приложений.  
  
-   Новое <xref:System.Net.Security.NegotiateStream.BeginAuthenticateAsServer%2A> и методы перегрузки <xref:System.Net.Security.NegotiateStream.AuthenticateAsServer%2A> в <xref:System.Net.Security.NegotiateStream> классифицируют, позволяющие передавать <xref:System.Security.Authentication.ExtendedProtection.ExtendedProtectionPolicy> для поддержки расширенной защиты для серверных приложений.  
  
-   Новое свойство <xref:System.Net.Security.SslStream.TransportContext%2A> в классе <xref:System.Net.Security.SslStream> для поддержки расширенной защиты для клиентских и серверных приложений.  
  
 Свойство <xref:System.Net.Configuration.SmtpNetworkElement> было добавлено в конфигурации поддержки расширенной защиты для клиентов SMTP в пространстве имен <xref:System.Net.Security>.  
  
## Расширенная защита для клиентских приложений  
 Поддержка расширенной защиты для большинства клиентских приложений происходит автоматически.  Поддержка классов <xref:System.Net.HttpWebRequest> и <xref:System.Net.Mail.SmtpClient> расширила защиту, когда базовая версия Windows поддерживает расширенную защиту.  Экземпляр <xref:System.Net.HttpWebRequest> передает имя участника\-службы, полученное из <xref:System.Uri>.  По умолчанию экземпляр <xref:System.Net.Mail.SmtpClient> передает имя участника\-службы, созданное из имени узла почтового smtp\-сервера.  
  
 Для пользовательской проверки подлинности клиентские приложения могут использовать <xref:System.Net.HttpWebRequest.EndGetRequestStream%28System.IAsyncResult%2CSystem.Net.TransportContext%40%29?displayProperty=fullName> или методы <xref:System.Net.HttpWebRequest.GetRequestStream%28System.Net.TransportContext%40%29?displayProperty=fullName> в <xref:System.Net.HttpWebRequest> классифицируют, позволяющие получить <xref:System.Net.TransportContext> и cbt с помощью метода <xref:System.Net.TransportContext.GetChannelBinding%2A>.  
  
 Имя участника\-службы, используемый для встроенной проверки подлинности Windows, отправленной экземпляром <xref:System.Net.HttpWebRequest> к данной службе может быть переопределено, присвоив свойству <xref:System.Net.AuthenticationManager.CustomTargetNameDictionary%2A>.  
  
 Свойство <xref:System.Net.Mail.SmtpClient.TargetName%2A> позволяет задать пользовательское имя участника\-службы для использования встроенной проверки подлинности Windows для соединения SMTP.  
  
## Расширенная защита для серверных приложений  
 <xref:System.Net.HttpListener> автоматически предоставляет механизмы для проверки привязки службы при проверке подлинности HTTP.  
  
 Протокол является наиболее безопасным сценарий включать расширенную защиту для префиксов HTTPS:\/\/.  В этом случае задайте <xref:System.Net.HttpListener.ExtendedProtectionPolicy%2A?displayProperty=fullName> к <xref:System.Security.Authentication.ExtendedProtection.ExtendedProtectionPolicy> с <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> значение <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> или <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> и <xref:System.Security.Authentication.ExtendedProtection.ProtectionScenario> установлено в значение <xref:System.Security.Authentication.ExtendedProtection.ProtectionScenario> a <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> помещает <xref:System.Net.HttpListener> в частично затвердетый режиме, пока полностью затвердетому <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> соответствует режиму.  
  
 В данной конфигурации, если запрос выполняется к серверу через внешний защищенный канал, внешнего канала запрашивается для привязки канала.  Эта привязка канала передается вызовы проверки подлинности SSPI, которые проверяют, что привязка канала в большом двоичном объекте проверки подлинности совпадают.  3 Возможных результатов:  
  
1.  Базовая операционная система не поддерживает расширенную защиту сервера.  Запрос не будет предоставлять к приложению, а неавторизованный \(401\) ответ будет возвращен клиенту.  Сообщение будет зарегистрировано в источник трассировки <xref:System.Net.HttpListener>, указывающий причину ошибки.  
  
2.  Вызов SSPI завершается ошибкой означает, что любой клиент, указанный в параметре привязку канала, которая не соответствовала ожидаемому значению восстановленному из внешнего канала или клиента не суменных, чтобы предоставить привязку канала, если расширенная политика защиты на сервере была настроитьа для <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement>.  В обоих случаях запрос не будет предоставлять к приложению, а неавторизованный \(401\) ответ будет возвращен клиенту.  Сообщение будет зарегистрировано в источник трассировки <xref:System.Net.HttpListener>, указывающий причину ошибки.  
  
3.  Клиент задает правильную привязку канала или разрешения для соединения, не указывая привязку канала, поскольку расширенная политика защиты на сервере настроитьа с <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> запрос возвращается приложению для обработки.  Никакой проверки имени службы не выполняется автоматически.  Приложение может выполнять собственную проверку имени службы с помощью свойства <xref:System.Net.HttpListenerRequest.ServiceName%2A>, но в следующих обстоятельствах он является избыточным.  
  
 Если приложение делает его, то собственные вызовы SSPI для проверки подлинности на основе больших двоичных объектов, переданных туда и обратно в теле HTTP\-запроса, но желания для поддержки привязки канала для этого необходимо извлечь ожидаемая привязка канала от внешнего безопасного канала с помощью <xref:System.Net.HttpListener> чтобы передать его функции собственного Win32 [AcceptSecurityContext](http://go.microsoft.com/fwlink/?LinkId=147021).  Для этого используется свойство <xref:System.Net.HttpListenerRequest.TransportContext%2A> и вызовите метод <xref:System.Net.TransportContext.GetChannelBinding%2A> для получения cbt.  Поддерживаются только привязки конечной точки.  Если что\-либо другое <xref:System.Security.Authentication.ExtendedProtection.ChannelBindingKind> указан, то будет вызвано исключение <xref:System.NotSupportedException>.  Если базовые поддержки операционной системы маршрутизации привязку, то метод <xref:System.Net.TransportContext.GetChannelBinding%2A> возвращает <xref:System.Security.Authentication.ExtendedProtection.ChannelBinding><xref:System.Runtime.InteropServices.SafeHandle> создавая программу\-оболочку указатель на привязку канала, подходящий для передачи в [AcceptSecurityContext](http://go.microsoft.com/fwlink/?LinkId=147021) функцию в качестве члена pvBuffer структуры SecBuffer, передаваемое в параметре `pInput`.  Свойство <xref:System.Security.Authentication.ExtendedProtection.ChannelBinding.Size%2A> содержащее длину в байтах для привязки канала.  Если базовая операционная система не поддерживает привязки каналов, то функция вернет `null`.  
  
 Другой возможный сценарий включать расширенную защиту для префиксов HTTP:\/\/, если учетные записи\-посредники не используются.  В этом случае задайте <xref:System.Net.HttpListener.ExtendedProtectionPolicy%2A?displayProperty=fullName> к <xref:System.Security.Authentication.ExtendedProtection.ExtendedProtectionPolicy> с <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> значение <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> или <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> и <xref:System.Security.Authentication.ExtendedProtection.ProtectionScenario> установлено в значение <xref:System.Security.Authentication.ExtendedProtection.ProtectionScenario> a <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> помещает <xref:System.Net.HttpListener> в частично затвердетый режиме, пока полностью затвердетому <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> соответствует режиму.  
  
 Создание по умолчанию список разрешенных имен службы на основе префиксов, которые были зарегистрированы с <xref:System.Net.HttpListener>.  По умолчанию этот список можно проверить с помощью свойства <xref:System.Net.HttpListener.DefaultServiceNames%2A>.  Если этот список не является исчерпывающим, то приложение может определить пользовательскую коллекцию имен службы в конструкторе для данного класса <xref:System.Security.Authentication.ExtendedProtection.ExtendedProtectionPolicy>, который будет использоваться вместо по умолчанию списка имя службы.  
  
 В данной конфигурации, если запрос будет выполнен на сервер без выручек внешних проверки подлинности безопасного канала без проверки привязки канала как обычно.  Если проверка подлинности завершается успешно, то контекст запрашивается имени службы, клиент подал и проверки на соответствие списка допустимых имен службы.  4 Возможных результатов:  
  
1.  Базовая операционная система не поддерживает расширенную защиту сервера.  Запрос не будет предоставлять к приложению, а неавторизованный \(401\) ответ будет возвращен клиенту.  Сообщение будет зарегистрировано в источник трассировки <xref:System.Net.HttpListener>, указывающий причину ошибки.  
  
2.  Клиента базовая операционная система не поддерживает расширенную защиту.  В конфигурации <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> попытка проверки подлинности завершится успешно и запрос будет возвращен к приложению.  В конфигурации <xref:System.Security.Authentication.ExtendedProtection.PolicyEnforcement> попытка проверки подлинности завершится ошибкой.  Запрос не будет предоставлять к приложению, а неавторизованный \(401\) ответ будет возвращен клиенту.  Сообщение будет зарегистрировано в источник трассировки <xref:System.Net.HttpListener>, указывающий причину ошибки.  
  
3.  Базовая операционная система клиента поддерживает расширенную защиту, однако приложение не привязки, указанной службы.  Запрос не будет предоставлять к приложению, а неавторизованный \(401\) ответ будет возвращен клиенту.  Сообщение будет зарегистрировано в источник трассировки <xref:System.Net.HttpListener>, указывающий причину ошибки.  
  
4.  Клиент, определенные привязки службы.  Привязка службы сравнитьа в список разрешенных привязки службы.  Если она соответствует, то запрос возвращается приложению.  В противном случае запрос не будет предоставлять к приложению, а неавторизованный \(401\) ответ будет автоматически возвращается клиенту.  Сообщение будет зарегистрировано в источник трассировки <xref:System.Net.HttpListener>, указывающий причину ошибки.  
  
 Если этот простой подход с использованием допустимый список допустимых имен службы недостаточны, приложение может предоставлять собственную проверку имени службы, запросив свойство <xref:System.Net.HttpListenerRequest.ServiceName%2A>.  В случаях 1 и 2 выше свойство возвратит `null`.  В случае если значение равно 3, оно возвратит пустую строку.  В случае если будут возвращены 4, указанное клиентом имя службы.  
  
 Эти расширенные функции защиты также могут быть использованы серверными приложениями для проверки подлинности других типов запросов, но при доверенные учетные записи используются.  
  
## См. также  
 <xref:System.Security.Authentication.ExtendedProtection>   
 <xref:System.Security.Authentication.ExtendedProtection.Configuration>