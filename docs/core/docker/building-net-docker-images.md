---
title: "Создание образов Docker для .NET Core"
description: "Общие сведения об образах Docker и .NET Core"
keywords: .NET, .NET Core, Docker
author: spboyer
ms.author: shboyer
ms.date: 09/06/2017
ms.topic: article
ms.prod: .net-core
ms.technology: dotnet-docker
ms.devlang: dotnet
ms.assetid: 03c28597-7e73-46d6-a9c3-f9cb55642739
ms.translationtype: HT
ms.sourcegitcommit: a0b6edbc13fddd8558f6677d25ce279147d761c3
ms.openlocfilehash: efec7e390f029d2f0ab952e316976ad1c6408b0f
ms.contentlocale: ru-ru
ms.lasthandoff: 09/06/2017

---

#<a name="building-docker-images-for-net-core-applications"></a>Создание образов Docker для приложений .NET Core

 
> [!IMPORTANT]
> Мы работаем над обновлением этой статьи в связи с выходом .NET Core 2.0. Приведенные ниже инструкции являются устаревшими. Приносим свои искренние извинения за неудобства.

Чтобы понять, как можно использовать .NET Core и Docker вместе, сначала нужно ознакомиться с различными образами Docker и подходящими ситуациями для их применения. В этой статье мы по порядку разберем предлагаемые варианты, создадим веб-интерфейс API ASP.NET Core, используем средства Yeoman Docker для создания отлаживаемого контейнера, а также посмотрим, как Visual Studio Code может помочь нам в решении этих задач. 

## <a name="docker-image-optimizations"></a>Оптимизация образов Docker

При создании образов Docker для разработчиков мы сосредоточились на трех основных сценариях:

- образы, используемые для разработки приложений .NET Core;
- образы, используемые для сборки приложений .NET Core;
- образы, используемые для выполнения приложений .NET Core.

Зачем нужны три образа
При разработке, сборке и выполнении приложений в контейнерах приоритеты будут разными.
- **Разработка**. Как быстро может осуществляться итерация и отладка изменений. Размер образа не так важен, как возможность быстро вносить изменения в код и просматривать их. Некоторые из наших средств, например [yo docker](https://aka.ms/yodocker) для использования в Visual Studio Code, применяют этот образ во время разработки. 
- **Сборка**. Что нужно для компиляции приложения. Сюда относятся компилятор и другие зависимости для оптимизации двоичных файлов. Это не тот образ, который вы развертываете, а образ, который вы используете для сборки содержимого, помещаемого в рабочий образ. Этот образ будет применяться при непрерывной интеграции или в среде сборки. Например, вместо установки всех зависимостей непосредственно в агенте сборки этот агент создаст экземпляр образа сборки, чтобы скомпилировать приложение со всеми зависимостями, которые необходимы для сборки приложения, содержащегося в образе. Агенту сборки необходимо знать только, как запускать этот образ Docker. 
- **Рабочая среда**. Как быстро можно развернуть и запустить образ. Этот образ имеет небольшой размер, поэтому может быстро передаваться по сети из реестра Docker на узлы Docker. Содержимое готово к запуску, поэтому период времени от запуска Docker до обработки результатов минимален. В неизменяемой модели Docker нет потребности в динамической компиляции кода. Содержимое, помещаемое в этот образ, ограничено двоичными файлами и содержимым, которые необходимы для работы приложения. Например, это могут быть выходные данные, опубликованные с помощью команды `dotnet publish` и содержащие скомпилированные двоичные файлы, изображения, файлы JS и CSS. Со временем появятся образы, которые содержат пакеты, предварительно скомпилированные JIT-компилятором.  

Хотя существует несколько версий образа .NET Core, они все имеют один или несколько общих уровней. Объем дискового пространства для хранения или размер разностных данных, которые нужно извлечь из реестра, гораздо меньше общего размера, так как все образы имеют общий базовый и, возможно, другие общие уровни.  

## <a name="docker-image-variations"></a>Варианты образов Docker

Для достижения указанных выше целей мы предоставляет варианты образов в [microsoft/dotnet](https://hub.docker.com/r/microsoft/dotnet/).

- `microsoft/dotnet:<version>-sdk`, то есть **microsoft/dotnet:1.0.0-preview2-sdk** — этот образ содержит пакет SDK для .NET Core, который включает платформу .NET Core и программы командной строки (CLI). Этот образ соответствует **сценарию развертывания**. Он используется для локальной разработки, отладки и модульного тестирования, например для всех задач разработки, выполняемых до возврата кода. Этот образ также можно использовать для сценариев **сборки**.

- `microsoft/dotnet:<version>-core`, то есть **microsoft/dotnet:1.0.0-core** — образ, который выполняет [переносимые приложения .NET Core](../deploying/index.md) и оптимизирован для выполнения приложений в **рабочей среде**. Он не содержит пакета SDK и предназначен для получения оптимизированных выходных данных команды `dotnet publish`. Переносимая среда выполнения хорошо подходит для сценариев с контейнерами Docker, так как использование нескольких контейнеров позволяет реализовать преимущество общих уровней образов.  

## <a name="alternative-images"></a>Альтернативные образы

Помимо образов, оптимизированных для разработки, сборки и рабочей среды, мы предоставляем дополнительные образы.

- `microsoft/dotnet:<version>-onbuild`, то есть **microsoft/dotnet:1.0.0-preview2-onbuild**, содержит триггеры [ONBUILD](https://docs.docker.com/engine/reference/builder/#/onbuild). Сборка копирует ([COPY](https://docs.docker.com/engine/reference/builder/#/copy)) приложение, выполняет команду `dotnet restore` и создает инструкцию [ENTRYPOINT](https://docs.docker.com/engine/reference/builder/#/entrypoint) `dotnet run` для запуска приложения при запуске образа Docker. Хотя этот образ не оптимизирован для рабочей среды, кому-то он может быть полезен для упрощения копирования исходного кода в образ и его выполнения. 

- `microsoft/dotnet:<version>-core-deps`, то есть **microsoft/dotnet:1.0.0-core-deps** — используйте этот образ для выполнения автономных приложений. Он содержит операционную систему со всеми собственными зависимостями, требуемыми платформе .NET Core. Кроме того, этот образ можно использовать в качестве базового для собственных сборок CoreFX или CoreCLR. Вариант **onbuild** оптимизирован для простого добавления кода в образ и его выполнения, а образ оптимизирован так, что вы получаете только те зависимости операционной системы, которые необходимы для выполнения приложений .NET Core, в состав которых входит упакованная среда выполнения .NET. Этот образ, как правило, не оптимизирован для запуска нескольких контейнеров .NET Core на одном узле, так как каждый образ содержит среду выполнения .NET Core в приложении и вы не получите преимущество от наличия общих уровней образов.   

Последние версии каждого варианта:

- `microsoft/dotnet` или `microsoft/dotnet:latest` (включает пакет SDK)
- `microsoft/dotnet:onbuild`
- `microsoft/dotnet:core`
- `microsoft/dotnet:core-deps`

Ниже приведен список образов после выполнения команды `docker pull <imagename>` на компьютере разработки и их размеры. Обратите внимание на то, что вариант для разработки и сборки (`microsoft/dotnet:1.0.0-preview2-sdk`) больше, так как он содержит пакет SDK для разработки и сборки приложения. Вариант для рабочей среды (`microsoft/dotnet:core`) меньше, так как он содержит только среду выполнения .NET Core. Минимальный образ `core-deps`, пригодный для использования в Linux, существенно меньше по размеру, но с ним вашему приложению нужно иметь собственную копию среды выполнения .NET. Так как контейнеры уже обеспечивают изоляцию, это преимущество теряется при выполнении нескольких контейнеров на основе .NET. 

```
REPOSITORY          TAG                     IMAGE ID            SIZE
microsoft/dotnet    1.0.0-preview2-onbuild  19b6a6c4b1db        540.4 MB
microsoft/dotnet    onbuild                 19b6a6c4b1db        540.4 MB
microsoft/dotnet    1.0.0-preview2-sdk      a92c3d9ad0e7        540.4 MB
microsoft/dotnet    core                    5224a9f2a2aa        253.2 MB
microsoft/dotnet    1.0.0-core-deps         c981a2eebe0e        166.2 MB
microsoft/dotnet    core-deps               c981a2eebe0e        166.2 MB
microsoft/dotnet    latest                  03c10abbd08a        540.4 MB
microsoft/dotnet    1.0.0-core              b8da4a1fd280        253.2 MB
```

## <a name="prerequisites"></a>Предварительные требования

Для сборки и запуска необходимо установить несколько компонентов.

- [.NET Core](http://dot.net)
- [Docker](https://www.docker.com/products/docker) для локального выполнения контейнеров Docker
- [Node.js](https://nodejs.org/)
- [Генератор Yeoman для ASP.NET](https://github.com/omnisharp/generator-aspnet) для создания приложения веб-интерфейса API
- [Генератор Yeoman для Docker](http://aka.ms/yodocker) от корпорации Майкрософт

Установите генераторы Yeoman для ASP.NET Core и Docker с помощью npm. 

```
npm install -g yo generator-aspnet generator-docker
```

> [!NOTE]
> В этом примере в качестве редактора будет использоваться [Visual Studio Code](http://code.visualstudio.com).

## <a name="creating-the-web-api-application"></a>Создание приложения веб-интерфейса API

Чтобы получить ориентир, перед упаковкой приложения в контейнер запустите его локально. 

Готовое приложение находится в [репозитории dotnet/docs на сайте GitHub](https://github.com/dotnet/docs/tree/master/samples/core/docker/building-net-docker-images). Инструкции по загрузке см. в разделе [Просмотр и скачивание примеров](../../samples-and-tutorials/index.md#viewing-and-downloading-samples).

Создайте каталог для приложения.

Откройте сеанс выполнения команд или сеанс терминала в этом каталоге и используйте генератор Yeoman для ASP.NET, введя следующую команду:
```
yo aspnet
```

Выберите **Приложение веб-интерфейса API**, введите **api** в качестве имени приложения и нажмите клавишу ВВОД.  После создания приложения по шаблону перейдите в каталог `/api` и восстановите зависимости NuGet с помощью команды `dotnet restore`.

```
cd api
dotnet restore
```

Протестируйте приложение, выполнив команду `dotnet run` и перейдя по адресу **http://localhost:5000/api/values**.

```javascript
[
    "value1",
    "value2"
]
```

Чтобы остановить приложение, нажмите клавишу `Ctrl+C`.

## <a name="adding-docker-support"></a>Добавление поддержки Docker

Добавление поддержки Docker в проект осуществляется посредством генератора Yeoman от корпорации Майкрософт. В настоящее время он поддерживает проекты .NET Core, Node.js и Go путем создания файла Dockerfile и скриптов, помогающих собирать и выполнять проекты в контейнерах. Также добавляются файлы, относящиеся к Visual Studio Code (launch.json, tasks.json), для поддержки отладки и палитры команд редактора.

```console
$ yo docker

     _-----_     ╭──────────────────────────╮
    |       |    │   Welcome to the Docker  │
    |--(o)--|    │        generator!        │
   `---------´   │     Let's add Docker     │
    ( _´U`_ )    │  container magic to your │
    /___A___\   /│           app!           │
     |  ~  |     ╰──────────────────────────╯
   __'.___.'__
 ´   `  |° ´ Y `

? What language is your project using? (Use arrow keys)
❯ .NET Core
  Golang
  Node.js
```

- В качестве типа проекта выберите `.NET Core`.
- `rtm` — версия .NET Core
- `Y` — проект использует веб-сервер
- `5000` — порт, который прослушивает приложение веб-интерфейса API (http://localhost:5000)
- `api` — имя образа
- `api` — имя службы
- `api` — составной проект 
- `Y` — перезапись текущего файла Dockerfile

Когда работа генератора завершится, в проект будут добавлены следующие файлы.

- .vscode/launch.json
- Dockerfile.debug
- Dockerfile
- docker-compose.debug.yml
- docker-compose.yml
- dockerTask.ps1
- dockerTask.sh
- .vscode/tasks.json

Генератор создает два файла Dockerfile.

**Dockerfile.debug** — этот файл основан на образе **microsoft/dotnet:1.0.0-preview2-sdk**, который, как можно видеть в списке вариантов образов, включает пакет SDK, интерфейс CLI и платформу .NET Core и будет образом, используемым для разработки и отладки (F5). Включение всех этих компонентов увеличивает размер образа приблизительно до 540 МБ.

**Dockerfile** — это образ выпуска, основанный на **microsoft/dotnet:1.0.0-core**, который следует использовать для рабочей среды. После сборки его размер составляет приблизительно 253 МБ.

### <a name="creating-the-docker-images"></a>Создание образов Docker
С помощью скрипта `dockerTask.sh` или `dockerTask.ps1` можно выполнить сборку или компоновку образа и контейнера для приложения **api** для определенной среды. Выполните сборку образа **debug**, выполнив приведенную ниже команду.

```bash
./dockerTask.sh build debug
```

Образ выполнит сборку приложения ASP.NET, вызовет команду `dotnet restore`, добавит отладчик в образ, задаст `ENTRYPOINT` и, наконец, скопирует приложение в образ. Результатом будет образ Docker с именем *api* и с тегом (`TAG`) *debug*.  Просмотреть образы на компьютере можно с помощью команды `docker images`.

```bash
docker images

REPOSITORY          TAG                  IMAGE ID            CREATED             SIZE
api                 debug                70e89fbc5dbe        a few seconds ago   779.8 MB
```

Другой способ создать образ и запустить приложение в контейнере Docker — открыть приложение в Visual Studio Code и воспользоваться средствами отладки. 

Щелкните значок отладки на панели представлений в левой части окна Visual Studio Code.

![Значок отладки VS Code](./media/building-net-docker-images/debugging_debugicon.png)

Затем щелкните значок воспроизведения или нажмите клавишу F5, чтобы создать образ и запустить приложение в контейнере. Приложение веб-интерфейса API будет запущено с помощью веб-браузера по умолчанию по адресу http://localhost:5000.

![Средства отладки VS Code для Docker](./media/building-net-docker-images/docker-tools-vscode-f5.png)

Вы можете устанавливать точки останова в приложении, выполнять его пошагово и выполнять другие действия, как если бы приложение выполнялось локально на компьютере разработки, а не в контейнере. Преимущество отладки в контейнере в том, что это тот же образ, который будет развертываться в рабочей среде.

Чтобы создать образ выпуска или рабочий образ, достаточно просто выполнить команду в терминале, указав имя среды `release`.

```bash
./dockerTask build release
```

Команда создает образ на основе базового образа **microsoft/dotnet:core** меньшего размера, открывает ([EXPOSE](https://docs.docker.com/engine/reference/builder/#/expose)) порт 5000, задает точку входа ([ENTRYPOINT](https://docs.docker.com/engine/reference/builder/#/entrypoint)) для `dotnet api.dll` и копирует ее в каталог `/app`. Нет отладчика, пакета SDK, и не выполняется команда `dotnet restore`, благодаря чему размер образа гораздо меньше. Образ имеет имя **api** и тег (`TAG`) **latest**.

```
REPOSITORY          TAG                  IMAGE ID            CREATED             SIZE
api                 debug                70e89fbc5dbe        1 hour ago        779.8 MB
api                 latest               ef17184c8de6        1 hour ago        260.7 MB
```

## <a name="summary"></a>Сводка

Использование генератора Docker для добавления необходимых файлов в приложение веб-интерфейса API упростило создание версий образов для разработки и рабочей среды.  Кроссплатформенность средств также достигается с помощью скрипта PowerShell, который позволяет получить те же результаты в Windows, а интеграция с Visual Studio Code дает возможность пошаговой отладки приложения в контейнере. Понимая назначение вариантов образов и целевые сценарии, вы можете оптимизировать внутренний цикл разработки и получить более эффективные образы для рабочих развертываний.  



